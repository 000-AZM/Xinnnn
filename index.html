<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Xinn Social</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<style>
  body, html {
    margin:0; padding:0; height:100%; font-family: Arial, sans-serif; background:#f0f2f5;
  }
  header {
    background:#2196F3; color:white; padding:10px; text-align:center;
  }
  .container {
    padding:20px; max-width:600px; margin: auto;
  }
  .card {
    background:white; padding:15px; margin:10px 0; border-radius:8px;
    box-shadow:0 2px 5px rgba(0,0,0,0.1);
  }
  input, textarea, button, select {
    width:100%; padding:10px; margin:5px 0; border:1px solid #ccc; border-radius:5px;
    box-sizing: border-box;
    font-size: 14px;
  }
  button {
    background:#2196F3; color:white; border:none; cursor:pointer;
    font-weight: 600;
  }
  button[disabled] {
    background: #ccc; cursor: default;
  }
  nav {
    position:fixed; bottom:0; left:0; right:0; background:white; display:flex; justify-content:space-around;
    border-top:1px solid #ccc; padding:10px 0; max-width:600px; margin: auto; width: 100%;
  }
  nav button {
    background:none; color:#555; border:none; font-size:24px; cursor:pointer;
  }
  nav button.active {
    color:#2196F3; font-weight:bold;
  }
  /* Feed post user name */
  .user-name {
    cursor:pointer; color:#2196F3; font-weight:600;
  }
  /* Chat bubbles */
  .chat-message {
    max-width: 70%; padding: 8px 12px; margin: 6px; border-radius: 16px; font-size: 14px;
    clear: both; word-wrap: break-word;
  }
  .chat-message.sent {
    background: #DCF8C6; float: right; text-align: right;
    border-bottom-right-radius: 2px;
  }
  .chat-message.received {
    background: #fff; float: left; border: 1px solid #ccc;
    border-bottom-left-radius: 2px;
  }
  /* Scroll chat messages */
  #chatMessages {
    height: 300px; overflow-y: auto; background: #eee; padding: 10px; border-radius: 8px; margin-bottom: 10px;
  }
  /* Buttons for friend request in profile */
  .friend-action-btn {
    background: #2196F3; color: white; border: none; border-radius: 5px;
    padding: 10px 15px; margin-right: 10px; cursor: pointer;
    font-weight: 600;
  }
  .friend-action-btn.cancel {
    background: #f44336;
  }
</style>
</head>
<body>

<header><h2>Xinn Social</h2></header>

<div id="app"></div>

<nav id="navBar" style="display:none;">
  <button id="navFeed" title="Feed" onclick="showPage('feed')"><span class="material-icons">home</span></button>
  <button id="navFriends" title="Friends" onclick="showPage('friends')"><span class="material-icons">group</span></button>
  <button id="navChat" title="Chat" onclick="showPage('chat')"><span class="material-icons">chat</span></button>
  <button id="navProfile" title="Profile" onclick="showPage('profile')"><span class="material-icons">person</span></button>
  <button id="navSettings" title="Settings" onclick="showPage('settings')"><span class="material-icons">settings</span></button>
</nav>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCGN7t5FjDeJ-ewm7S_9z0VJrRSggTaJ2Q",
    authDomain: "coin-base-by-hector.firebaseapp.com",
    databaseURL: "https://coin-base-by-hector-default-rtdb.firebaseio.com",
    projectId: "coin-base-by-hector",
    storageBucket: "coin-base-by-hector.firebasestorage.app",
    messagingSenderId: "398789890422",
    appId: "1:398789890422:web:ed6a928037b24be2e36a57",
    measurementId: "G-SGJJM5K3G9"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Current chat friend id & name
  let currentChatFriendId = null;
  let currentChatFriendName = '';

  // =============== AUTH ===============
  function renderLogin() {
    document.getElementById('app').innerHTML = `
      <div class="container card">
        <h3>Login to Xinn Social</h3>
        <input type="email" id="email" placeholder="Email (@xinn.lab only)" />
        <input type="password" id="password" placeholder="Password" />
        <button onclick="login()">Login</button>
        <p>Or <a href="#" onclick="renderRegister()">Register</a></p>
      </div>
    `;
  }

  function renderRegister() {
    document.getElementById('app').innerHTML = `
      <div class="container card">
        <h3>Create Account</h3>
        <input type="text" id="name" placeholder="Full Name" />
        <input type="number" id="age" placeholder="Age" />
        <textarea id="bio" placeholder="Bio"></textarea>
        <input type="email" id="email" placeholder="Email (@xinn.lab only)" />
        <input type="password" id="password" placeholder="Password" />
        <button onclick="register()">Register</button>
        <p>Already have an account? <a href="#" onclick="renderLogin()">Login</a></p>
      </div>
    `;
  }

  function login() {
    const email = document.getElementById('email').value.trim();
    const pass = document.getElementById('password').value.trim();
    if (!email.endsWith('@xinn.lab')) {
      alert('Email must end with @xinn.lab');
      return;
    }
    auth.signInWithEmailAndPassword(email, pass)
      .catch(e => alert(e.message));
  }

  function register() {
    const name = document.getElementById('name').value.trim();
    const age = document.getElementById('age').value.trim();
    const bio = document.getElementById('bio').value.trim();
    const email = document.getElementById('email').value.trim();
    const pass = document.getElementById('password').value.trim();

    if (!email.endsWith('@xinn.lab')) {
      alert('Email must end with @xinn.lab');
      return;
    }
    if (!name) {
      alert('Name is required');
      return;
    }

    auth.createUserWithEmailAndPassword(email, pass)
      .then(cred => {
        return db.collection('users').doc(cred.user.uid).set({
          name,
          nameLower: name.toLowerCase(),
          age,
          bio,
          email
        });
      })
      .catch(e => alert(e.message));
  }

  // =============== FEED ===============
  function renderFeed() {
    document.getElementById('app').innerHTML = `
      <div class="container">
        <div class="card">
          <textarea id="postContent" placeholder="What's on your mind?" style="resize:none;"></textarea>
          <button onclick="createPost()">Post</button>
        </div>
        <div id="feedPosts"></div>
      </div>
    `;
    loadPosts();
  }

  function createPost() {
    const content = document.getElementById('postContent').value.trim();
    if (!content) return;
    db.collection('posts').add({
      content,
      uid: auth.currentUser.uid,
      likes: [],
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById('postContent').value = '';
  }

  function loadPosts() {
    db.collection('posts').orderBy('timestamp', 'desc').onSnapshot(async snap => {
      let html = '';
      for (const doc of snap.docs) {
        const p = doc.data();
        const userDoc = await db.collection('users').doc(p.uid).get();
        const user = userDoc.data() || { name: "Unknown" };
        const time = p.timestamp ? p.timestamp.toDate().toLocaleString() : "Just now";

        html += `
          <div class="card" style="padding: 12px;">
            <div style="display:flex;align-items:center;margin-bottom:8px;">
              <span class="material-icons" style="font-size:36px;color:#2196F3;margin-right:10px;">account_circle</span>
              <div>
                <strong class="user-name" onclick="visitProfile('${p.uid}')">${user.name}</strong><br>
                <small style="color:gray;">${time}</small>
              </div>
            </div>
            <div style="margin:10px 0;font-size:15px;">${p.content}</div>
            <hr style="margin:8px 0;">
            <button onclick="toggleLike('${doc.id}')"
              style="background:none;color:#2196F3;border:none;cursor:pointer;">
              üëç Like (${p.likes.length})
            </button>
          </div>
        `;
      }
      document.getElementById('feedPosts').innerHTML = html;
    });
  }

  function toggleLike(postId) {
    const ref = db.collection('posts').doc(postId);
    ref.get().then(doc => {
      const data = doc.data();
      let likes = data.likes || [];
      if (likes.includes(auth.currentUser.uid)) {
        likes = likes.filter(id => id !== auth.currentUser.uid);
      } else {
        likes.push(auth.currentUser.uid);
      }
      ref.update({ likes });
    });
  }

  // =============== FRIENDS ===============
  function renderFriends() {
    document.getElementById('app').innerHTML = `
      <div class="container card">
        <h3>Friends & Search</h3>
        <input type="text" id="searchInput" placeholder="Search users by name..." oninput="searchFriends()" />
        <div id="friendList" style="margin-top:10px;"></div>
        <div id="searchResults" style="margin-top:20px;"></div>
      </div>
    `;
    loadFriendList();
  }

  async function loadFriendList() {
    const uid = auth.currentUser.uid;
    const friendListDiv = document.getElementById('friendList');
    friendListDiv.innerHTML = '<h4>Your Friends:</h4>';

    try {
      const friendsSnap = await db.collection('users').doc(uid).collection('friends').get();
      if (friendsSnap.empty) {
        friendListDiv.innerHTML += '<p>You have no friends yet.</p>';
        return;
      }

      let html = '';
      for (const doc of friendsSnap.docs) {
        const friendId = doc.id;
        const userDoc = await db.collection('users').doc(friendId).get();
        const friend = userDoc.data();
        if (!friend) continue;
        html += `
          <div style="padding:6px; border-bottom:1px solid #ccc; cursor:pointer;" onclick="visitProfile('${friendId}')">
            <strong>${friend.name}</strong> <small style="color:gray;">(Click to view profile)</small>
          </div>
        `;
      }
      friendListDiv.innerHTML += html;

    } catch (e) {
      friendListDiv.innerHTML += `<p style="color:red;">Error loading friends: ${e.message}</p>`;
    }
  }

  let searchTimeout;
  function searchFriends() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(async () => {
      const query = document.getElementById('searchInput').value.trim().toLowerCase();
      const searchResultsDiv = document.getElementById('searchResults');
      searchResultsDiv.innerHTML = '';

      if (!query) return;

      const uid = auth.currentUser.uid;

      try {
        const usersSnap = await db.collection('users')
          .orderBy('nameLower')
          .startAt(query)
          .endAt(query + '\uf8ff')
          .limit(10)
          .get();

        if (usersSnap.empty) {
          searchResultsDiv.innerHTML = '<p>No users found.</p>';
          return;
        }

        let html = '<h4>Search Results:</h4>';
        for (const doc of usersSnap.docs) {
          const user = doc.data();
          const userId = doc.id;

          if (userId === uid) continue; // skip yourself

          // Check if already friend
          const friendDoc = await db.collection('users').doc(uid).collection('friends').doc(userId).get();
          if (friendDoc.exists) continue;

          // Check if friend request sent by current user to this user
          const sentReqDoc = await db.collection('users').doc(userId).collection('friendRequests').doc(uid).get();
          if (sentReqDoc.exists) continue;

          // Check if friend request received from this user
          const receivedReqDoc = await db.collection('users').doc(uid).collection('friendRequests').doc(userId).get();
          if (receivedReqDoc.exists) continue;

          html += `
            <div style="padding:6px; border-bottom:1px solid #ccc; cursor:pointer;" onclick="visitProfile('${userId}')">
              <strong>${user.name}</strong> <small style="color:gray;">(Click to view profile)</small>
            </div>
          `;
        }

        if (html === '<h4>Search Results:</h4>') {
          html = '<p>No users found.</p>';
        }

        searchResultsDiv.innerHTML = html;

      } catch (e) {
        searchResultsDiv.innerHTML = `<p style="color:red;">Error searching users: ${e.message}</p>`;
      }
    }, 300);
  }

  // =============== PROFILE ===============
  // Shows profile, with friend request buttons or edit for self
  function visitProfile(userId) {
    if (!userId) return;
    if (userId === auth.currentUser.uid) {
      renderProfile();
      return;
    }

    // Load user data
    db.collection('users').doc(userId).get().then(async doc => {
      if (!doc.exists) {
        alert("User not found");
        return;
      }
      const u = doc.data();

      // Check friendship status and requests
      const currentUid = auth.currentUser.uid;

      const friendDoc = await db.collection('users').doc(currentUid).collection('friends').doc(userId).get();
      const isFriend = friendDoc.exists;

      const sentReqDoc = await db.collection('users').doc(userId).collection('friendRequests').doc(currentUid).get();
      const requestSent = sentReqDoc.exists;

      const receivedReqDoc = await db.collection('users').doc(currentUid).collection('friendRequests').doc(userId).get();
      const requestReceived = receivedReqDoc.exists;

      let actionButtons = '';

      if (isFriend) {
        actionButtons = `<button class="friend-action-btn" onclick="startChat('${userId}', '${u.name}')">Chat</button>`;
      } else if (requestReceived) {
        actionButtons = `
          <button class="friend-action-btn" onclick="acceptFriend('${userId}')">Accept</button>
          <button class="friend-action-btn cancel" onclick="declineFriend('${userId}')">Decline</button>
        `;
      } else if (requestSent) {
        actionButtons = `<button class="friend-action-btn cancel" onclick="cancelFriendRequest('${userId}')">Cancel Request</button>`;
      } else {
        actionButtons = `<button class="friend-action-btn" onclick="sendFriendRequest('${userId}')">Send Friend Request</button>`;
      }

      document.getElementById('app').innerHTML = `
        <div class="container card">
          <h3>${u.name}</h3>
          <p>Age: ${u.age || '-'}</p>
          <p>Bio: ${u.bio || '-'}</p>
          ${actionButtons}
          <button style="margin-top: 15px;" onclick="showPage('friends')">Back to Friends</button>
        </div>
      `;
    });
  }

  function renderProfile() {
    db.collection('users').doc(auth.currentUser.uid).get().then(uDoc => {
      const u = uDoc.data();
      document.getElementById('app').innerHTML = `
        <div class="container">
          <div class="card">
            <h3>${u.name}</h3>
            <p>Age: ${u.age || '-'}</p>
            <p>Bio: ${u.bio || '-'}</p>
            <button onclick="editProfile()">Edit Profile</button>
          </div>
        </div>
      `;
    });
  }

  function editProfile() {
    db.collection('users').doc(auth.currentUser.uid).get().then(doc => {
      const u = doc.data();
      document.getElementById('app').innerHTML = `
        <div class="container card">
          <input id="name" value="${u.name}" placeholder="Full Name" />
          <input id="age" value="${u.age}" placeholder="Age" />
          <textarea id="bio" placeholder="Bio">${u.bio}</textarea>
          <button onclick="saveProfile()">Save</button>
          <button onclick="renderProfile()" style="margin-top:10px; background:#777;">Cancel</button>
        </div>
      `;
    });
  }

  function saveProfile() {
    const name = document.getElementById('name').value.trim();
    const age = document.getElementById('age').value.trim();
    const bio = document.getElementById('bio').value.trim();

    if (!name) {
      alert('Name cannot be empty');
      return;
    }

    db.collection('users').doc(auth.currentUser.uid).update({
      name,
      nameLower: name.toLowerCase(),
      age,
      bio
    }).then(() => {
      renderProfile();
    });
  }

  // =============== FRIEND REQUEST ACTIONS ===============
  function sendFriendRequest(userId) {
    const currentUid = auth.currentUser.uid;
    // Add friendRequest document to target user from current user
    db.collection('users').doc(userId).collection('friendRequests').doc(currentUid).set({
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
      alert('Friend request sent');
      visitProfile(userId);
    }).catch(e => alert(e.message));
  }

  function cancelFriendRequest(userId) {
    const currentUid = auth.currentUser.uid;
    db.collection('users').doc(userId).collection('friendRequests').doc(currentUid).delete()
      .then(() => {
        alert('Friend request canceled');
        visitProfile(userId);
      }).catch(e => alert(e.message));
  }

  function acceptFriend(userId) {
    const currentUid = auth.currentUser.uid;
    // Add each other to friends subcollections and remove friend request
    const batch = db.batch();

    const currentUserFriendsRef = db.collection('users').doc(currentUid).collection('friends').doc(userId);
    const otherUserFriendsRef = db.collection('users').doc(userId).collection('friends').doc(currentUid);
    const friendRequestRef = db.collection('users').doc(currentUid).collection('friendRequests').doc(userId);

    batch.set(currentUserFriendsRef, { since: firebase.firestore.FieldValue.serverTimestamp() });
    batch.set(otherUserFriendsRef, { since: firebase.firestore.FieldValue.serverTimestamp() });
    batch.delete(friendRequestRef);

    batch.commit().then(() => {
      alert('Friend request accepted!');
      visitProfile(userId);
    }).catch(e => alert(e.message));
  }

  function declineFriend(userId) {
    const currentUid = auth.currentUser.uid;
    db.collection('users').doc(currentUid).collection('friendRequests').doc(userId).delete()
      .then(() => {
        alert('Friend request declined');
        visitProfile(userId);
      }).catch(e => alert(e.message));
  }

  // =============== CHAT ===============
  function renderChat() {
    if (!currentChatFriendId) {
      // Show message to select friend first
      document.getElementById('app').innerHTML = `
        <div class="container card">
          <p>Select a friend to start chatting from your Friends list.</p>
        </div>
      `;
      return;
    }

    document.getElementById('app').innerHTML = `
      <div class="container">
        <div class="card">
          <h3>Chat with ${currentChatFriendName}</h3>
          <div id="chatMessages"></div>
          <textarea id="chatInput" placeholder="Type a message..." rows="2"></textarea>
          <button onclick="sendMessage()">Send</button>
          <button style="margin-top:10px; background:#777;" onclick="closeChat()">Close Chat</button>
        </div>
      </div>
    `;

    loadChatMessages();
  }

  function startChat(friendId, friendName) {
    currentChatFriendId = friendId;
    currentChatFriendName = friendName;
    showPage('chat');
  }

  function closeChat() {
    currentChatFriendId = null;
    currentChatFriendName = '';
    showPage('friends');
  }

  let unsubscribeChat = null;
  function loadChatMessages() {
    const currentUid = auth.currentUser.uid;
    const friendId = currentChatFriendId;

    if (unsubscribeChat) unsubscribeChat();

    const chatId = currentUid < friendId ? currentUid + '_' + friendId : friendId + '_' + currentUid;

    const chatMessagesDiv = document.getElementById('chatMessages');
    chatMessagesDiv.innerHTML = 'Loading messages...';

    unsubscribeChat = db.collection('chats').doc(chatId).collection('messages')
      .orderBy('timestamp')
      .onSnapshot(snapshot => {
        let html = '';
        snapshot.forEach(doc => {
          const msg = doc.data();
          const cls = msg.sender === currentUid ? 'sent' : 'received';
          html += `<div class="chat-message ${cls}">${escapeHtml(msg.text)}</div>`;
        });
        chatMessagesDiv.innerHTML = html;
        chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
      });
  }

  function sendMessage() {
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if (!text) return;

    const currentUid = auth.currentUser.uid;
    const friendId = currentChatFriendId;

    const chatId = currentUid < friendId ? currentUid + '_' + friendId : friendId + '_' + currentUid;

    db.collection('chats').doc(chatId).collection('messages').add({
      text,
      sender: currentUid,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    input.value = '';
  }

  // Simple escape HTML for chat text display
  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, (m) => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    })[m]);
  }

  // =============== NAVIGATION ===============
  function showPage(page) {
    // Update active nav button style
    ['navFeed','navFriends','navChat','navProfile','navSettings'].forEach(id => {
      document.getElementById(id).classList.remove('active');
    });

    switch(page) {
      case 'feed': renderFeed(); document.getElementById('navFeed').classList.add('active'); break;
      case 'friends': renderFriends(); document.getElementById('navFriends').classList.add('active'); break;
      case 'chat': renderChat(); document.getElementById('navChat').classList.add('active'); break;
      case 'profile': renderProfile(); document.getElementById('navProfile').classList.add('active'); break;
      case 'settings': renderSettings(); document.getElementById('navSettings').classList.add('active'); break;
    }
  }

  // =============== SETTINGS ===============
  function renderSettings() {
    document.getElementById('app').innerHTML = `
      <div class="container card">
        <button onclick="auth.signOut()">Logout</button>
      </div>
    `;
  }

  // =============== ON AUTH STATE CHANGE ===============
  auth.onAuthStateChanged(user => {
    if (user) {
      showPage('feed');
      document.getElementById('navBar').style.display = 'flex';
    } else {
      renderLogin();
      document.getElementById('navBar').style.display = 'none';
      currentChatFriendId = null;
      currentChatFriendName = '';
    }
  });
</script>

</body>
</html>
