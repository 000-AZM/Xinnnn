<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Xinn Social</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<style>
  /* ==== BASE STYLE ==== */
  body, html {
    margin: 0; padding: 0; font-family: 'Roboto', Arial, sans-serif;
    background: var(--bg-color); color: var(--text-color);
    transition: background-color 0.3s, color 0.3s;
  }
  :root {
    --primary-color: #1976d2;
    --bg-color: #fff;
    --text-color: #222;
    --card-bg: #fefefe;
    --input-bg: #f5f5f5;
  }
  body.dark {
    --bg-color: #121212;
    --text-color: #ddd;
    --card-bg: #1e1e1e;
    --input-bg: #2c2c2c;
  }

  .material-icons { vertical-align: middle; }
  .card {
    background: var(--card-bg);
    border-radius: 6px;
    box-shadow: 0 2px 6px rgb(0 0 0 / 0.15);
    padding: 12px;
    margin-bottom: 12px;
  }
  button, input, textarea {
    font-family: inherit;
  }
  button.primary {
    background: var(--primary-color);
    border: none;
    color: #fff;
    padding: 10px 16px;
    border-radius: 4px;
    cursor: pointer;
    user-select: none;
  }
  button.primary:disabled {
    background: #999;
    cursor: default;
  }
  input, textarea {
    width: 100%;
    box-sizing: border-box;
    padding: 8px;
    margin: 6px 0 12px 0;
    border: 1px solid #ccc;
    border-radius: 4px;
    background: var(--input-bg);
    color: var(--text-color);
  }
  textarea {
    resize: vertical;
  }

  /* ==== NAV BAR ==== */
  #navBar {
    display: flex;
    background: var(--card-bg);
    padding: 10px 20px;
    box-shadow: 0 2px 4px rgb(0 0 0 / 0.1);
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  #navBar .nav-left, #navBar .nav-right {
    display: flex;
    align-items: center;
  }
  #navBar button.nav-btn {
    background: none;
    border: none;
    color: var(--primary-color);
    cursor: pointer;
    font-size: 24px;
    margin-right: 16px;
    position: relative;
  }
  #navBar button.nav-btn:last-child {
    margin-right: 0;
  }
  #notificationBadge {
    position: absolute;
    top: 2px; right: 2px;
    background: #e53935;
    color: white;
    border-radius: 50%;
    font-size: 10px;
    width: 16px; height: 16px;
    text-align: center;
    line-height: 16px;
    display: none;
  }
  #notificationDropdown {
    position: absolute;
    top: 42px; right: 10px;
    width: 280px;
    max-height: 320px;
    background: var(--card-bg);
    box-shadow: 0 4px 10px rgb(0 0 0 / 0.25);
    border-radius: 8px;
    overflow-y: auto;
    display: none;
    z-index: 15;
  }
  .notification-item {
    padding: 10px 16px;
    border-bottom: 1px solid #ccc;
    cursor: pointer;
  }
  .notification-item:last-child {
    border-bottom: none;
  }
  .notification-item:hover {
    background: var(--primary-color);
    color: white;
  }

  /* ==== AVATAR ==== */
  .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 12px;
    object-fit: cover;
  }
  .friend-list-btn {
    display: flex;
    align-items: center;
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px 0;
    width: 100%;
    text-align: left;
    font-size: 15px;
    color: var(--text-color);
  }
  .friend-list-btn:hover {
    background: var(--input-bg);
  }

  /* ==== FRIEND ACTION BUTTONS ==== */
  .friend-action-btn {
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 14px;
    margin-left: 8px;
    border: none;
    cursor: pointer;
  }
  .friend-action-btn.accept {
    background-color: #4caf50;
    color: white;
  }
  .friend-action-btn.decline {
    background-color: #f44336;
    color: white;
  }

  /* ==== CHAT UI ==== */
  .chat-window {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    background: var(--card-bg);
    border-radius: 6px;
    box-shadow: 0 2px 6px rgb(0 0 0 / 0.15);
    padding: 12px;
    overflow: hidden;
  }
  #chatMessages {
    flex-grow: 1;
    overflow-y: auto;
    margin-bottom: 8px;
  }
  .chat-message {
    max-width: 70%;
    margin-bottom: 6px;
    padding: 8px 12px;
    border-radius: 20px;
    word-wrap: break-word;
    font-size: 14px;
    line-height: 1.3;
  }
  .chat-message.sent {
    background-color: var(--primary-color);
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 0;
  }
  .chat-message.received {
    background-color: #e0e0e0;
    color: #222;
    align-self: flex-start;
    border-bottom-left-radius: 0;
  }
  #typingIndicator {
    font-size: 12px;
    color: #666;
    margin-bottom: 4px;
    min-height: 18px;
  }
  #chatInput {
    resize: none;
    border-radius: 20px;
    border: 1px solid #ccc;
    padding: 8px 12px;
  }

  /* ==== SETTINGS ==== */
  #settingsDarkModeToggle {
    margin-bottom: 16px;
  }
  #settingsDarkModeToggle label {
    cursor: pointer;
  }
  #settingsPasswordChange input {
    margin-bottom: 8px;
  }
  #settingsPasswordChange button {
    margin-top: 8px;
  }

  /* ==== PROFILE FRIENDS ==== */
  #profileFriends {
    margin-top: 16px;
  }
  #profileFriends h4 {
    margin-bottom: 8px;
  }
  #profileFriends .friend-item {
    display: inline-block;
    width: 70px;
    margin: 4px;
    cursor: pointer;
    text-align: center;
    color: var(--text-color);
  }
  #profileFriends .friend-item img {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
  }
  #profileFriends .friend-item span {
    display: block;
    font-size: 12px;
    margin-top: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
</style>
</head>
<body>
<div id="navBar" style="display:none;">
  <div class="nav-left">
    <button class="nav-btn" title="Feed" onclick="showPage('feed')">
      <span class="material-icons">home</span>
    </button>
    <button class="nav-btn" title="Friends" onclick="showPage('friends')">
      <span class="material-icons">people</span>
    </button>
    <button class="nav-btn" title="Chat" onclick="showPage('chat')">
      <span class="material-icons">chat</span>
    </button>
    <button class="nav-btn" title="Profile" onclick="showPage('profile'); renderProfile(auth.currentUser.uid)">
      <span class="material-icons">account_circle</span>
    </button>
    <button class="nav-btn" title="Settings" onclick="showPage('settings')">
      <span class="material-icons">settings</span>
    </button>
  </div>
  <div class="nav-right" style="position:relative;">
    <button id="notificationBtn" class="nav-btn" title="Notifications">
      <span class="material-icons">notifications</span>
      <span id="notificationBadge"></span>
    </button>
    <div id="notificationDropdown"></div>
  </div>
</div>

<div id="app" style="padding: 12px; max-width: 720px; margin: auto;"></div>

<!-- Firebase SDKs and initialize your firebase app -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script>
  // Your Firebase config (replace with your actual config)
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTHDOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_ID",
    appId: "YOUR_APP_ID"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // ==== GLOBALS ====
  let currentChatFriendId = null;
  let currentChatFriendName = '';
  let unsubscribeChat = null;
  let unsubscribeNotifications = null;

  // ==== UTILITIES ====
  function escapeHtml(text) {
    if (!text) return '';
    return text.replace(/[&<>"']/g, m => {
      switch(m) {
        case '&': return '&amp;';
        case '<': return '&lt;';
        case '>': return '&gt;';
        case '"': return '&quot;';
        case "'": return '&#39;';
      }
    });
  }

  function escapeJs(text) {
    if (!text) return '';
    return text.replace(/'/g, "\\'");
  }

  // ==== NAVIGATION ====

  function showPage(page) {
    switch(page) {
      case 'feed': renderFeed(); break;
      case 'friends': renderFriends(); break;
      case 'chat': renderChat(); break;
      case 'profile': renderProfile(auth.currentUser.uid); break;
      case 'settings': renderSettings(); break;
      default: renderFeed();
    }
  }

  // ==== LOGIN / REGISTER ====

  function showLogin() {
    document.getElementById('app').innerHTML = `
      <div class="card" style="max-width: 400px; margin: 40px auto;">
        <h2>Login / Register</h2>
        <input id="loginEmail" placeholder="Email" type="email" />
        <input id="loginPassword" placeholder="Password" type="password" />
        <button class="primary" onclick="login()">Login</button>
        <button class="primary" style="margin-left:8px;" onclick="register()">Register</button>
      </div>
    `;
  }

  async function login() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    if (!email.endsWith('@xinn.lab')) return alert('Email must end with @xinn.lab');
    if (!password) return alert('Password is required');
    try {
      await auth.signInWithEmailAndPassword(email, password);
    } catch(e) {
      alert('Login failed: ' + e.message);
    }
  }

  async function register() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    if (!email.endsWith('@xinn.lab')) return alert('Email must end with @xinn.lab');
    if (!password) return alert('Password is required');
    try {
      const res = await auth.createUserWithEmailAndPassword(email, password);
      // Create user doc
      await db.collection('users').doc(res.user.uid).set({
        email,
        name: email.split('@')[0],
        nameLower: email.split('@')[0].toLowerCase(),
        age: '',
        bio: '',
        avatarUrl: ''
      });
      alert('Registered! Please login.');
    } catch(e) {
      alert('Registration failed: ' + e.message);
    }
  }

  // ==== FEED ====

  // ... Your existing feed code here (not shown for brevity) ...

  // ==== PROFILE ====

  async function renderProfile(uid) {
    try {
      const userDoc = await db.collection('users').doc(uid).get();
      if (!userDoc.exists) throw new Error('User not found');
      const u = userDoc.data();

      const isCurrentUser = auth.currentUser.uid === uid;

      // Load friend list of this user
      const friendsSnap = await db.collection('friends').doc(uid).collection('userFriends').orderBy('since','desc').get();
      let friendsHtml = '';
      if (friendsSnap.empty) {
        friendsHtml = '<p>No friends yet.</p>';
      } else {
        friendsHtml = friendsSnap.docs.map(doc => {
          const fUid = doc.id;
          return `<div class="friend-item" onclick="visitProfile('${fUid}')">
            <img src="https://i.pravatar.cc/60?u=${fUid}" alt="Friend" />
            <span>${escapeHtml(doc.data().name || fUid)}</span>
          </div>`;
        }).join('');
      }

      document.getElementById('app').innerHTML = `
        <div class="card" style="max-width:400px; margin: 0 auto;">
          <div style="text-align:center; margin-bottom:12px;">
            <img src="${u.avatarUrl || 'https://i.pravatar.cc/120?u='+uid}" alt="Avatar" class="avatar" style="width:120px; height:120px; border-radius:50%; margin-bottom: 8px;" />
            ${isCurrentUser ? `<input type="file" id="avatarInput" accept="image/*" />` : ''}
          </div>
          <h2>${escapeHtml(u.name)}</h2>
          <p><strong>Age:</strong> ${escapeHtml(u.age)}</p>
          <p><strong>Bio:</strong> ${escapeHtml(u.bio)}</p>
          ${isCurrentUser ? `<button class="primary" onclick="editProfile()">Edit Profile</button>` : ''}
          <div id="profileFriends">
            <h4>Friends</h4>
            ${friendsHtml}
          </div>
          ${!isCurrentUser ? `<button class="primary" onclick="sendFriendRequest('${uid}')">Add Friend</button>` : ''}
          <div id="uploadStatus" style="margin-top:8px; color:#1976d2;"></div>
        </div>
      `;

      if (isCurrentUser) {
        document.getElementById('avatarInput').addEventListener('change', handleAvatarUpload);
      }
    } catch (e) {
      alert('Failed to load profile: ' + e.message);
    }
  }

  // ==== REST OF PROFILE EDIT, FRIENDS, CHAT CODE ====
  // ... Reuse your existing functions from previous full code with adjustments for new UI & logic ...

  // ==== NOTIFICATIONS ====

  document.getElementById('notificationBtn').addEventListener('click', () => {
    const dropdown = document.getElementById('notificationDropdown');
    dropdown.style.display = (dropdown.style.display === 'block') ? 'none' : 'block';
    if (dropdown.style.display === 'block') {
      loadNotifications();
    }
  });

  async function loadNotifications() {
    const dropdown = document.getElementById('notificationDropdown');
    dropdown.innerHTML = '<p style="padding:10px;">Loading notifications...</p>';

    try {
      const uid = auth.currentUser.uid;
      const notiSnap = await db.collection('notifications').doc(uid).collection('userNotifications').orderBy('timestamp', 'desc').limit(10).get();
      if (notiSnap.empty) {
        dropdown.innerHTML = '<p style="padding:10px;">No notifications</p>';
        setNotificationBadge(0);
        return;
      }
      let html = '';
      let unreadCount = 0;
      for (const doc of notiSnap.docs) {
        const n = doc.data();
        if (!n.read) unreadCount++;
        html += `<div class="notification-item" style="${!n.read ? 'font-weight:bold;' : ''}" onclick="markNotificationRead('${doc.id}')">${escapeHtml(n.text)}</div>`;
      }
      dropdown.innerHTML = html;
      setNotificationBadge(unreadCount);
    } catch(e) {
      dropdown.innerHTML = `<p style="color:red; padding:10px;">Failed to load notifications: ${e.message}</p>`;
    }
  }

  async function markNotificationRead(notiId) {
    const uid = auth.currentUser.uid;
    await db.collection('notifications').doc(uid).collection('userNotifications').doc(notiId).update({ read: true });
    loadNotifications();
  }

  function setNotificationBadge(count) {
    const badge = document.getElementById('notificationBadge');
    if (count > 0) {
      badge.style.display = 'inline-block';
      badge.textContent = count;
    } else {
      badge.style.display = 'none';
      badge.textContent = '';
    }
  }

  // ==== SETTINGS ====

  function renderSettings() {
    const darkMode = localStorage.getItem('darkMode') === 'true';
    document.getElementById('app').innerHTML = `
      <div class="card" style="max-width:400px; margin: 0 auto;">
        <h3>Settings</h3>
        <div id="settingsDarkModeToggle">
          <label>
            <input type="checkbox" id="darkModeCheckbox" ${darkMode ? 'checked' : ''} />
            Enable Dark Mode
          </label>
        </div>
        <div id="settingsPasswordChange">
          <h4>Change Password</h4>
          <input type="password" id="oldPassword" placeholder="Current Password" />
          <input type="password" id="newPassword" placeholder="New Password" />
          <input type="password" id="confirmPassword" placeholder="Confirm New Password" />
          <button class="primary" onclick="changePassword()">Change Password</button>
        </div>
      </div>
    `;

    document.getElementById('darkModeCheckbox').addEventListener('change', (e) => {
      if(e.target.checked) {
        document.body.classList.add('dark');
        localStorage.setItem('darkMode', 'true');
      } else {
        document.body.classList.remove('dark');
        localStorage.setItem('darkMode', 'false');
      }
    });
  }

  async function changePassword() {
    const oldPass = document.getElementById('oldPassword').value;
    const newPass = document.getElementById('newPassword').value;
    const confirmPass = document.getElementById('confirmPassword').value;

    if (!oldPass || !newPass || !confirmPass) {
      return alert('Please fill all fields');
    }
    if (newPass !== confirmPass) {
      return alert('New passwords do not match');
    }

    try {
      const user = auth.currentUser;
      const credential = firebase.auth.EmailAuthProvider.credential(user.email, oldPass);
      await user.reauthenticateWithCredential(credential);
      await user.updatePassword(newPass);
      alert('Password changed successfully');
      // Clear inputs
      document.getElementById('oldPassword').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
    } catch(e) {
      alert('Password change failed: ' + e.message);
    }
  }

  // ==== AUTH STATE ====

  auth.onAuthStateChanged(user => {
    if (user) {
      document.getElementById('navBar').style.display = 'flex';
      showPage('feed');
    } else {
      document.getElementById('navBar').style.display = 'none';
      showLogin();
    }
  });

  // ==== INITIAL DARK MODE ====

  if(localStorage.getItem('darkMode') === 'true') {
    document.body.classList.add('dark');
  }

  // ==== PROFILE FRIEND LIST VISIT ====

  function visitProfile(uid) {
    showPage('profile');
    renderProfile(uid);
  }

  // === You can continue to add your feed, friends list, friend requests, chat code here ===
  // Just make sure all UI follows the styling and navigation logic here
  // and uses the updated friend/friend request logic from previous versions.

</script>
</body>
</html>
