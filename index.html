<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Xinn Social</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<style>
  body, html {
    margin: 0; padding: 0; font-family: Arial, sans-serif; background: #f0f2f5; height: 100vh;
    display: flex; flex-direction: column;
  }
  header {
    background: #2196F3; color: white; padding: 12px; text-align: center; font-size: 24px; font-weight: bold;
  }
  #app {
    flex: 1; overflow-y: auto; padding: 12px;
  }
  .card {
    background: white; padding: 12px; margin-bottom: 12px; border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  input, textarea, button, select {
    width: 100%; padding: 10px; margin: 6px 0; border: 1px solid #ccc; border-radius: 5px;
    box-sizing: border-box;
  }
  button {
    background: #2196F3; color: white; border: none; cursor: pointer;
    transition: background-color 0.2s ease;
  }
  button:hover {
    background: #1976d2;
  }
  nav {
    background: white; border-top: 1px solid #ccc; padding: 8px 0;
    display: flex; justify-content: space-around; position: fixed; bottom: 0; left: 0; right: 0;
  }
  nav button {
    background: none; border: none; color: #555; font-size: 24px;
    cursor: pointer;
    display: flex; flex-direction: column; align-items: center;
  }
  nav button.active {
    color: #2196F3; font-weight: bold;
  }
  nav button span {
    font-size: 28px;
  }
  .friend-item, .request-item {
    display: flex; justify-content: space-between; align-items: center; margin: 8px 0;
  }
  .friend-item button, .request-item button {
    margin-left: 6px;
    padding: 6px 10px;
    font-size: 14px;
  }
  .chat-container {
    display: flex; flex-direction: column; height: 400px; border: 1px solid #ccc; border-radius: 8px;
    overflow: hidden;
  }
  .messages {
    flex: 1; overflow-y: auto; padding: 10px; background: #f9f9f9;
  }
  .message {
    margin-bottom: 10px; max-width: 70%; padding: 8px 12px; border-radius: 18px; position: relative;
    font-size: 14px;
  }
  .message.me {
    background: #DCF8C6; align-self: flex-end; border-bottom-right-radius: 0;
  }
  .message.friend {
    background: white; align-self: flex-start; border-bottom-left-radius: 0;
  }
  .message small {
    display: block; font-size: 10px; color: gray; margin-top: 2px;
  }
  .chat-input {
    display: flex; padding: 8px; border-top: 1px solid #ccc;
  }
  .chat-input textarea {
    flex: 1; resize: none; padding: 8px; font-size: 14px; border-radius: 18px; border: 1px solid #ccc;
  }
  .chat-input button {
    margin-left: 8px; width: 80px; border-radius: 18px;
  }
</style>
</head>
<body>

<header>Xinn Social</header>
<div id="app"></div>

<nav id="navBar" style="display:none;">
  <button id="btnFeed" onclick="showPage('feed')" title="Feed"><span class="material-icons">home</span></button>
  <button id="btnFriends" onclick="showPage('friends')" title="Friends"><span class="material-icons">group</span></button>
  <button id="btnChat" onclick="showPage('chat')" title="Chat"><span class="material-icons">chat</span></button>
  <button id="btnProfile" onclick="showPage('profile')" title="Profile"><span class="material-icons">person</span></button>
  <button id="btnSettings" onclick="showPage('settings')" title="Settings"><span class="material-icons">settings</span></button>
</nav>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCGN7t5FjDeJ-ewm7S_9z0VJrRSggTaJ2Q",
    authDomain: "coin-base-by-hector.firebaseapp.com",
    databaseURL: "https://coin-base-by-hector-default-rtdb.firebaseio.com",
    projectId: "coin-base-by-hector",
    storageBucket: "coin-base-by-hector.firebasestorage.app",
    messagingSenderId: "398789890422",
    appId: "1:398789890422:web:ed6a928037b24be2e36a57",
    measurementId: "G-SGJJM5K3G9"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // UI Navigation & Active button
  function setActiveNav(page) {
    ["btnFeed", "btnFriends", "btnChat", "btnProfile", "btnSettings"].forEach(id => {
      document.getElementById(id).classList.remove("active");
    });
    if(page === "feed") document.getElementById("btnFeed").classList.add("active");
    else if(page === "friends") document.getElementById("btnFriends").classList.add("active");
    else if(page === "chat") document.getElementById("btnChat").classList.add("active");
    else if(page === "profile") document.getElementById("btnProfile").classList.add("active");
    else if(page === "settings") document.getElementById("btnSettings").classList.add("active");
  }

  // Render login page
  function renderLogin() {
    document.getElementById('app').innerHTML = `
      <div class="card">
        <h3>Login to Xinn Social</h3>
        <input type="email" id="email" placeholder="Email (@xinn.lab only)" />
        <input type="password" id="password" placeholder="Password" />
        <button onclick="login()">Login</button>
        <p>Or <a href="#" onclick="renderRegister()">Register</a></p>
      </div>
    `;
  }

  // Render register page
  function renderRegister() {
    document.getElementById('app').innerHTML = `
      <div class="card">
        <h3>Create Account</h3>
        <input type="text" id="name" placeholder="Full Name" />
        <input type="number" id="age" placeholder="Age" />
        <textarea id="bio" placeholder="Bio"></textarea>
        <input type="email" id="email" placeholder="Email (@xinn.lab only)" />
        <input type="password" id="password" placeholder="Password" />
        <button onclick="register()">Register</button>
        <p>Already have an account? <a href="#" onclick="renderLogin()">Login</a></p>
      </div>
    `;
  }

  // Login
  function login() {
    const email = document.getElementById('email').value.trim();
    const pass = document.getElementById('password').value.trim();
    if (!email.endsWith('@xinn.lab')) {
      alert('Email must end with @xinn.lab');
      return;
    }
    auth.signInWithEmailAndPassword(email, pass).catch(e => alert(e.message));
  }

  // Register
  function register() {
    const name = document.getElementById('name').value.trim();
    const age = document.getElementById('age').value.trim();
    const bio = document.getElementById('bio').value.trim();
    const email = document.getElementById('email').value.trim();
    const pass = document.getElementById('password').value.trim();

    if (!email.endsWith('@xinn.lab')) {
      alert('Email must end with @xinn.lab');
      return;
    }

    auth.createUserWithEmailAndPassword(email, pass)
      .then(cred => {
        return db.collection('users').doc(cred.user.uid).set({
          name, age, bio, email,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      })
      .catch(e => alert(e.message));
  }

  // Show page main function
  function showPage(page) {
    setActiveNav(page);
    if (page === 'feed') renderFeed();
    else if (page === 'friends') renderFriends();
    else if (page === 'chat') renderChat();
    else if (page === 'profile') renderProfile();
    else if (page === 'settings') renderSettings();
  }

  // Feed page - show posts and new post box
  function renderFeed() {
    document.getElementById('app').innerHTML = `
      <div>
        <div class="card">
          <textarea id="postContent" placeholder="What's on your mind?" style="resize:none;"></textarea>
          <button onclick="createPost()">Post</button>
        </div>
        <div id="feedPosts"></div>
      </div>
    `;
    loadPosts();
  }

  // Create a new post
  function createPost() {
    const content = document.getElementById('postContent').value.trim();
    if (!content) return alert("Post content cannot be empty");

    db.collection('posts').add({
      content,
      uid: auth.currentUser.uid,
      likes: [],
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById('postContent').value = '';
  }

  // Load posts with user names and likes
  function loadPosts() {
    db.collection('posts').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
      let html = '';
      let promises = [];

      snapshot.forEach(doc => {
        const post = doc.data();
        promises.push(
          db.collection('users').doc(post.uid).get().then(userDoc => {
            const user = userDoc.data() || { name: "Unknown" };
            const time = post.timestamp ? post.timestamp.toDate().toLocaleString() : "Just now";
            html += `
              <div class="card" style="padding: 12px;">
                <div style="display:flex;align-items:center;margin-bottom:8px;">
                  <span class="material-icons" style="font-size:36px;color:#2196F3;margin-right:10px;">account_circle</span>
                  <div>
                    <strong>${user.name}</strong><br>
                    <small style="color:gray;">${time}</small>
                  </div>
                </div>
                <div style="margin:10px 0;font-size:15px;">${post.content}</div>
                <hr style="margin:8px 0;">
                <button onclick="toggleLike('${doc.id}')"
                  style="background:none;color:#2196F3;border:none;cursor:pointer;">
                  üëç Like (${post.likes.length})
                </button>
              </div>`;
          })
        );
      });

      Promise.all(promises).then(() => {
        document.getElementById('feedPosts').innerHTML = html;
      });
    });
  }

  // Toggle like/unlike post
  function toggleLike(postId) {
    const ref = db.collection('posts').doc(postId);
    ref.get().then(doc => {
      if (!doc.exists) return;
      let likes = doc.data().likes || [];
      if (likes.includes(auth.currentUser.uid)) {
        likes = likes.filter(id => id !== auth.currentUser.uid);
      } else {
        likes.push(auth.currentUser.uid);
      }
      ref.update({ likes });
    });
  }

  // Profile page with edit option
  function renderProfile() {
    db.collection('users').doc(auth.currentUser.uid).get().then(doc => {
      const u = doc.data();
      document.getElementById('app').innerHTML = `
        <div class="card">
          <h3>${u.name}</h3>
          <p>Age: ${u.age}</p>
          <p>Bio: ${u.bio}</p>
          <button onclick="editProfile()">Edit Profile</button>
        </div>`;
    });
  }

  // Edit profile page
  function editProfile() {
    db.collection('users').doc(auth.currentUser.uid).get().then(doc => {
      const u = doc.data();
      document.getElementById('app').innerHTML = `
        <div class="card">
          <input id="name" value="${u.name}" placeholder="Full Name" />
          <input id="age" type="number" value="${u.age}" placeholder="Age" />
          <textarea id="bio" placeholder="Bio">${u.bio}</textarea>
          <button onclick="saveProfile()">Save</button>
        </div>`;
    });
  }

  // Save profile changes
  function saveProfile() {
    const name = document.getElementById('name').value.trim();
    const age = document.getElementById('age').value.trim();
    const bio = document.getElementById('bio').value.trim();
    if (!name) return alert("Name cannot be empty");

    db.collection('users').doc(auth.currentUser.uid).update({ name, age, bio })
      .then(() => renderProfile())
      .catch(e => alert(e.message));
  }

  // FRIENDS PAGE ------------------------------------------------
  // Render friends list + requests + search + add friend
  function renderFriends() {
    document.getElementById('app').innerHTML = `
      <div>
        <div class="card">
          <input type="text" id="searchFriendInput" placeholder="Search users by name or email" oninput="searchUsers()" />
          <ul id="searchResults" style="list-style:none; padding-left:0; max-height: 200px; overflow-y:auto;"></ul>
        </div>
        <div class="card">
          <h3>Pending Friend Requests</h3>
          <ul id="pendingRequests" style="list-style:none; padding-left:0;"></ul>
        </div>
        <div class="card">
          <h3>Friends</h3>
          <ul id="friendList" style="list-style:none; padding-left:0;"></ul>
        </div>
      </div>
    `;
    loadFriends();
    loadPendingRequests();
  }

  // Search users by name or email excluding self and existing friends
  let currentSearchTimeout = null;
  function searchUsers() {
    const q = document.getElementById('searchFriendInput').value.trim().toLowerCase();
    const currentUserId = auth.currentUser.uid;

    if (currentSearchTimeout) clearTimeout(currentSearchTimeout);
    if (!q) {
      document.getElementById('searchResults').innerHTML = "";
      return;
    }

    currentSearchTimeout = setTimeout(() => {
      db.collection('users')
        .orderBy('name')
        .startAt(q)
        .endAt(q + '\uf8ff')
        .limit(20)
        .get()
        .then(snapshot => {
          const results = [];
          snapshot.forEach(doc => {
            const user = doc.data();
            if (doc.id === currentUserId) return; // exclude self
            results.push({ id: doc.id, ...user });
          });

          // Filter out existing friends and pending friend requests
          db.collection('users').doc(currentUserId).collection('friends').get()
            .then(friendSnap => {
              const friendIds = friendSnap.docs.map(d => d.id);
              db.collection('friendRequests')
                .where('from', '==', currentUserId)
                .get()
                .then(sentRequestsSnap => {
                  const sentRequestToIds = sentRequestsSnap.docs.map(d => d.data().to);
                  // Render filtered search results
                  let html = "";
                  results.forEach(user => {
                    if (friendIds.includes(user.id)) return; // skip friends
                    if (sentRequestToIds.includes(user.id)) {
                      html += `<li>${user.name} (${user.email}) - Request sent <button onclick="cancelFriendRequest('${user.id}')">Cancel</button></li>`;
                    } else {
                      html += `<li>${user.name} (${user.email}) <button onclick="sendFriendRequest('${user.id}', '${user.name}')">Add Friend</button></li>`;
                    }
                  });
                  document.getElementById('searchResults').innerHTML = html;
                });
            });
        });
    }, 500);
  }

  // Send friend request
  function sendFriendRequest(toId, toName) {
    const fromId = auth.currentUser.uid;
    const fromName = "";

    db.collection('users').doc(fromId).get().then(doc => {
      fromName = doc.data().name || "";
      // Create friend request doc
      db.collection('friendRequests').add({
        from: fromId,
        fromName,
        to: toId,
        toName,
        status: 'pending',
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        alert('Friend request sent');
        searchUsers();
        loadPendingRequests();
      }).catch(e => alert("Error sending friend request: "+e.message));
    });
  }

  // Cancel friend request sent
  function cancelFriendRequest(toId) {
    const fromId = auth.currentUser.uid;
    db.collection('friendRequests')
      .where('from', '==', fromId)
      .where('to', '==', toId)
      .where('status', '==', 'pending')
      .get()
      .then(snapshot => {
        snapshot.forEach(doc => {
          doc.ref.delete();
        });
        alert("Friend request canceled");
        searchUsers();
        loadPendingRequests();
      });
  }

  // Load pending friend requests to current user (to accept or decline)
  function loadPendingRequests() {
    const currentUserId = auth.currentUser.uid;
    db.collection('friendRequests')
      .where('to', '==', currentUserId)
      .where('status', '==', 'pending')
      .orderBy('timestamp', 'desc')
      .onSnapshot(snapshot => {
        const list = document.getElementById('pendingRequests');
        list.innerHTML = "";
        if (snapshot.empty) {
          list.innerHTML = "<li>No pending friend requests</li>";
          return;
        }
        snapshot.forEach(doc => {
          const data = doc.data();
          const li = document.createElement('li');
          li.className = 'request-item';
          li.innerHTML = `
            <span><strong>${data.fromName}</strong> wants to be your friend</span>
            <span>
              <button onclick="acceptFriendRequest('${doc.id}', '${data.from}')">Accept</button>
              <button onclick="declineFriendRequest('${doc.id}')">Decline</button>
            </span>
          `;
          list.appendChild(li);
        });
      });
  }

  // Accept friend request: add both users to friends subcollection, delete request
  function acceptFriendRequest(requestId, friendId) {
    const currentUserId = auth.currentUser.uid;
    const batch = db.batch();

    // Add friend for current user
    const myFriendRef = db.collection('users').doc(currentUserId).collection('friends').doc(friendId);
    batch.set(myFriendRef, { since: firebase.firestore.FieldValue.serverTimestamp() });

    // Add current user to friend's friend list
    const friendFriendRef = db.collection('users').doc(friendId).collection('friends').doc(currentUserId);
    batch.set(friendFriendRef, { since: firebase.firestore.FieldValue.serverTimestamp() });

    // Remove friend request
    const requestRef = db.collection('friendRequests').doc(requestId);
    batch.delete(requestRef);

    batch.commit().then(() => {
      alert("Friend request accepted");
      loadPendingRequests();
      loadFriends();
    });
  }

  // Decline friend request (just delete the request doc)
  function declineFriendRequest(requestId) {
    db.collection('friendRequests').doc(requestId).delete().then(() => {
      alert("Friend request declined");
      loadPendingRequests();
    });
  }

  // Load friend list
  function loadFriends() {
    const currentUserId = auth.currentUser.uid;
    db.collection('users').doc(currentUserId).collection('friends')
      .onSnapshot(snapshot => {
        const list = document.getElementById('friendList');
        if (!list) return;
        list.innerHTML = "";
        if (snapshot.empty) {
          list.innerHTML = "<li>No friends yet</li>";
          return;
        }
        snapshot.forEach(doc => {
          const friendId = doc.id;
          db.collection('users').doc(friendId).get().then(friendDoc => {
            const friendData = friendDoc.data() || { name: "Unknown" };
            const li = document.createElement('li');
            li.className = 'friend-item';
            li.innerHTML = `
              <span>${friendData.name}</span>
              <button onclick="startChat('${friendId}', '${friendData.name}')">Chat</button>
              <button onclick="removeFriend('${friendId}')">Remove</button>
            `;
            list.appendChild(li);
          });
        });
      });
  }

  // Remove friend
  function removeFriend(friendId) {
    const currentUserId = auth.currentUser.uid;
    const batch = db.batch();

    const myFriendRef = db.collection('users').doc(currentUserId).collection('friends').doc(friendId);
    batch.delete(myFriendRef);
    const friendFriendRef = db.collection('users').doc(friendId).collection('friends').doc(currentUserId);
    batch.delete(friendFriendRef);

    batch.commit().then(() => {
      alert("Friend removed");
      loadFriends();
    });
  }

  // CHAT -------------------------------------------------------------
  let currentChatFriendId = null;
  let currentChatFriendName = null;
  let unsubscribeChat = null;

  function renderChat() {
    if (!currentChatFriendId) {
      document.getElementById('app').innerHTML = `
        <div class="card">
          <h3>Select a friend to chat</h3>
          <p>Go to Friends tab and click "Chat" on a friend.</p>
        </div>
      `;
      return;
    }

    document.getElementById('app').innerHTML = `
      <div class="chat-container">
        <div id="messages" class="messages"></div>
        <div class="chat-input">
          <textarea id="chatMessage" rows="2" placeholder="Type a message"></textarea>
          <button onclick="sendMessage()">Send</button>
        </div>
      </div>
    `;
    loadMessages();
  }

  // Start chat with friend
  function startChat(friendId, friendName) {
    currentChatFriendId = friendId;
    currentChatFriendName = friendName;
    showPage('chat');
  }

  // Send chat message
  function sendMessage() {
    const msgInput = document.getElementById('chatMessage');
    const text = msgInput.value.trim();
    if (!text) return;

    const currentUserId = auth.currentUser.uid;
    const chatId = getChatId(currentUserId, currentChatFriendId);

    db.collection('chats').doc(chatId).collection('messages').add({
      from: currentUserId,
      to: currentChatFriendId,
      text,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      edited: false,
      read: false,
    });

    msgInput.value = '';
  }

  // Load chat messages
  function loadMessages() {
    if (unsubscribeChat) unsubscribeChat();

    const currentUserId = auth.currentUser.uid;
    const chatId = getChatId(currentUserId, currentChatFriendId);
    const messagesDiv = document.getElementById('messages');

    unsubscribeChat = db.collection('chats').doc(chatId).collection('messages')
      .orderBy('timestamp')
      .onSnapshot(snapshot => {
        messagesDiv.innerHTML = "";
        snapshot.forEach(doc => {
          const msg = doc.data();
          const div = document.createElement('div');
          div.className = 'message ' + (msg.from === currentUserId ? 'me' : 'friend');
          div.innerHTML = `
            <div>${escapeHtml(msg.text)}</div>
            <small>${msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString() : ''}${msg.edited ? ' (edited)' : ''}</small>
          `;
          messagesDiv.appendChild(div);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });
      });
  }

  // Utility: get chatId by combining two user ids sorted
  function getChatId(uid1, uid2) {
    return [uid1, uid2].sort().join('_');
  }

  // Simple HTML escape to prevent injection
  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, function(m) {
      return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
    });
  }

  // SETTINGS PAGE
  function renderSettings() {
    document.getElementById('app').innerHTML = `
      <div class="card">
        <button onclick="auth.signOut()">Logout</button>
      </div>
    `;
  }

  // Auth state change
  auth.onAuthStateChanged(user => {
    if (user) {
      showPage('feed');
      document.getElementById('navBar').style.display = 'flex';
    } else {
      renderLogin();
      document.getElementById('navBar').style.display = 'none';
    }
  });

</script>

</body>
</html>
