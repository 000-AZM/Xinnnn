<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Xinn Social</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<style>
  body, html {
    margin:0; padding:0; height:100%; font-family: Arial, sans-serif; background:#f0f2f5;
    display:flex; flex-direction: column;
  }
  header {
    background:#2196F3; color:white; padding:10px; text-align:center;
    flex-shrink: 0;
  }
  #app {
    flex-grow: 1; overflow-y: auto; padding: 15px;
    max-width: 600px; margin: 0 auto;
  }
  .card {
    background:white; padding:15px; margin-bottom: 15px; border-radius:8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  input, textarea, button, select {
    width:100%; padding:10px; margin:5px 0; border:1px solid #ccc; border-radius:5px;
    box-sizing: border-box;
    font-size: 15px;
  }
  button {
    background:#2196F3; color:white; border:none; cursor:pointer;
    font-weight: 600;
  }
  button:disabled {
    background:#ccc; cursor: not-allowed;
  }
  nav {
    position:fixed; bottom:0; left:0; right:0; background:white;
    display:flex; justify-content:space-around; border-top:1px solid #ccc; padding:10px 0;
    flex-shrink: 0;
    max-width: 600px; margin: 0 auto;
  }
  nav button {
    background:none; border:none; color:#555; font-size: 24px;
    display:flex; flex-direction: column; align-items: center;
  }
  nav button.active {
    color:#2196F3; font-weight:bold;
  }
  nav button span.material-icons {
    font-size: 28px;
  }
  /* Modal styles */
  .modal-backdrop {
    position: fixed; top:0; left:0; width:100vw; height:100vh;
    background: rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center;
    z-index: 1000;
  }
  .modal {
    background: white; padding: 20px; border-radius: 8px;
    max-width: 400px; width: 100%;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  }
  .modal h3 {
    margin-top:0;
  }
  .modal button.close-btn {
    background: #ff4444;
    margin-top: 10px;
  }
  /* Chat bubble */
  .chat-message {
    max-width: 70%; margin-bottom: 8px; padding: 10px 15px;
    border-radius: 20px; font-size: 14px;
    word-wrap: break-word;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  .chat-message.self {
    background:#DCF8C6; margin-left:auto; border-bottom-right-radius: 0;
  }
  .chat-message.friend {
    background:#FFFFFF; margin-right:auto; border-bottom-left-radius: 0;
  }
  .chat-container {
    max-height: 400px; overflow-y: auto; margin-bottom: 15px; padding: 10px; background: #eee; border-radius: 8px;
  }
  /* Avatar circle */
  .avatar-circle {
    width:36px; height:36px; border-radius:50%; background:#2196F3; color:white;
    display:flex; justify-content:center; align-items:center;
    font-weight:bold; font-size:18px; user-select:none;
    margin-right: 10px;
  }
  /* Post card */
  .post-header {
    display:flex; align-items:center; margin-bottom:8px;
  }
  .post-header .avatar-circle {
    flex-shrink:0;
  }
  .post-header .post-author {
    font-weight: 700; font-size: 16px;
  }
  .post-time {
    font-size: 12px; color: gray;
  }
  /* Friend list */
  #friendList li {
    padding: 8px 12px; background: #fff; margin-bottom: 8px; border-radius: 6px;
    cursor: default;
    display: flex; align-items: center;
  }
  #friendList li .avatar-circle {
    margin-right: 10px;
  }
  /* Friend request card */
  .request-card {
    display: flex; justify-content: space-between; align-items: center;
    background: #fff; padding: 10px; margin-bottom: 10px; border-radius: 6px;
  }
  .request-name {
    font-weight: 600;
  }
  .request-buttons button {
    margin-left: 8px;
    min-width: 70px;
  }
</style>
</head>
<body>

<header><h2>Xinn Social</h2></header>

<div id="app"></div>

<nav id="navBar" style="display:none;">
  <button id="navFeed" title="Feed" onclick="showPage('feed')">
    <span class="material-icons">home</span>Feed
  </button>
  <button id="navFriends" title="Friends" onclick="showPage('friends')">
    <span class="material-icons">group</span>Friends
  </button>
  <button id="navChat" title="Chat" onclick="showPage('chat')">
    <span class="material-icons">chat</span>Chat
  </button>
  <button id="navProfile" title="Profile" onclick="showPage('profile')">
    <span class="material-icons">person</span>Profile
  </button>
  <button id="navSettings" title="Settings" onclick="showPage('settings')">
    <span class="material-icons">settings</span>Settings
  </button>
</nav>

<!-- Edit Profile Modal -->
<div id="editProfileModal" class="modal-backdrop" style="display:none;">
  <div class="modal">
    <h3>Edit Profile</h3>
    <label>Name</label>
    <input id="editName" type="text" />
    <label>Bio</label>
    <textarea id="editBio" rows="3"></textarea>
    <label>Avatar Image (optional)</label>
    <input id="editAvatar" type="file" accept="image/*" />
    <div style="text-align:right; margin-top:15px;">
      <button onclick="saveProfile()">Save</button>
      <button class="close-btn" onclick="closeEditProfile()">Cancel</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
  // Firebase config (replace with yours)
  const firebaseConfig = {
    apiKey: "AIzaSyDhVRhDDCM8vFbNe9f1Ag4Xn0901igl4s0",
    authDomain: "xinn-social.firebaseapp.com",
    projectId: "xinn-social",
    storageBucket: "xinn-social.firebasestorage.app",
    messagingSenderId: "860868128981",
    appId: "1:860868128981:web:a5cb9b2cb32b10077e725c",
    measurementId: "G-2ZFNQND35B"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Current user data cache
  let currentUserData = null;
  let currentPage = null;
  let avatarBase64 = null;

  // Navigation buttons
  const navButtons = {
    feed: document.getElementById("navFeed"),
    friends: document.getElementById("navFriends"),
    chat: document.getElementById("navChat"),
    profile: document.getElementById("navProfile"),
    settings: document.getElementById("navSettings"),
  };

  function setActiveNav(page) {
    currentPage = page;
    for (const key in navButtons) {
      navButtons[key].classList.toggle("active", key === page);
    }
  }

  // Show page by name
  function showPage(page) {
    setActiveNav(page);
    if (page === "feed") renderFeed();
    else if (page === "friends") renderFriends();
    else if (page === "chat") renderChat();
    else if (page === "profile") renderProfile();
    else if (page === "settings") renderSettings();
  }

  // ----- AUTH -----
  function renderLogin() {
    document.getElementById("app").innerHTML = `
      <div class="container card" style="max-width: 400px; margin: 40px auto;">
        <h3>Login to Xinn Social</h3>
        <input type="email" id="email" placeholder="Email (@xinn.lab only)" />
        <input type="password" id="password" placeholder="Password" />
        <button id="loginBtn">Login</button>
        <p>Or <a href="#" id="registerLink">Register</a></p>
      </div>`;
    document.getElementById("loginBtn").onclick = login;
    document.getElementById("registerLink").onclick = (e) => {
      e.preventDefault();
      renderRegister();
    };
  }

  function renderRegister() {
    document.getElementById("app").innerHTML = `
      <div class="container card" style="max-width: 400px; margin: 40px auto;">
        <h3>Create Account</h3>
        <input type="text" id="regName" placeholder="Full Name" />
        <input type="number" id="regAge" placeholder="Age" />
        <textarea id="regBio" placeholder="Bio"></textarea>
        <input type="email" id="regEmail" placeholder="Email (@xinn.lab only)" />
        <input type="password" id="regPassword" placeholder="Password" />
        <button id="registerBtn">Register</button>
        <p>Already have an account? <a href="#" id="loginLink">Login</a></p>
      </div>`;
    document.getElementById("registerBtn").onclick = register;
    document.getElementById("loginLink").onclick = (e) => {
      e.preventDefault();
      renderLogin();
    };
  }

  async function login() {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();
    if (!email.endsWith("@xinn.lab")) {
      alert("Email must end with @xinn.lab");
      return;
    }
    try {
      await auth.signInWithEmailAndPassword(email, password);
    } catch (e) {
      alert(e.message);
    }
  }

  async function register() {
    const name = document.getElementById("regName").value.trim();
    const age = document.getElementById("regAge").value.trim();
    const bio = document.getElementById("regBio").value.trim();
    const email = document.getElementById("regEmail").value.trim();
    const password = document.getElementById("regPassword").value.trim();

    if (!email.endsWith("@xinn.lab")) {
      alert("Email must end with @xinn.lab");
      return;
    }
    if (!name || !age || !bio || !email || !password) {
      alert("Please fill in all fields");
      return;
    }

    try {
      const cred = await auth.createUserWithEmailAndPassword(email, password);
      await db.collection("users").doc(cred.user.uid).set({
        name,
        age,
        bio,
        email,
        friends: [],
        friendRequests: [],
        sentRequests: [],
        avatar: null
      });
      alert("Account created! Please login.");
      renderLogin();
    } catch (e) {
      alert(e.message);
    }
  }

  // ----- FEED -----
  function renderFeed() {
    document.getElementById("app").innerHTML = `
      <div>
        <div class="card">
          <textarea id="postContent" placeholder="What's on your mind?" style="resize:none;"></textarea>
          <button id="postBtn">Post</button>
        </div>
        <div id="feedPosts"></div>
      </div>
    `;
    document.getElementById("postBtn").onclick = createPost;
    loadPosts();
  }

  async function createPost() {
    const content = document.getElementById("postContent").value.trim();
    if (!content) return;
    await db.collection("posts").add({
      content,
      uid: auth.currentUser.uid,
      likes: [],
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    });
    document.getElementById("postContent").value = "";
  }

  function loadPosts() {
    db.collection("posts")
      .orderBy("timestamp", "desc")
      .onSnapshot(async (snap) => {
        let html = "";
        const posts = [];
        snap.forEach((doc) => posts.push({ id: doc.id, ...doc.data() }));

        for (const post of posts) {
          let user = { name: "Unknown", avatar: null };
          try {
            const userDoc = await db.collection("users").doc(post.uid).get();
            if (userDoc.exists) user = userDoc.data();
          } catch {}

          const time = post.timestamp
            ? post.timestamp.toDate().toLocaleString()
            : "Just now";
          const liked = post.likes.includes(auth.currentUser.uid);

          html += `
          <div class="card" style="padding: 12px;">
            <div class="post-header">
              <div class="avatar-circle">${user.name ? user.name[0].toUpperCase() : "?"}</div>
              <div>
                <div class="post-author">${user.name}</div>
                <div class="post-time">${time}</div>
              </div>
            </div>
            <div style="margin:10px 0;font-size:15px;">${escapeHtml(post.content)}</div>
            <hr style="margin:8px 0;" />
            <button onclick="toggleLike('${post.id}')">👍 Like (${post.likes.length})</button>
          </div>`;
        }
        document.getElementById("feedPosts").innerHTML = html;
      });
  }

  async function toggleLike(postId) {
    const postRef = db.collection("posts").doc(postId);
    const doc = await postRef.get();
    if (!doc.exists) return;
    const likes = doc.data().likes || [];
    let updatedLikes;
    if (likes.includes(auth.currentUser.uid)) {
      updatedLikes = likes.filter((id) => id !== auth.currentUser.uid);
    } else {
      updatedLikes = [...likes, auth.currentUser.uid];
    }
    await postRef.update({ likes: updatedLikes });
  }

  // ----- FRIENDS -----
  // Show friend list and friend requests
  async function renderFriends() {
    document.getElementById("app").innerHTML = `
      <div>
        <h3>Friends</h3>
        <ul id="friendList"></ul>
        <h3>Friend Requests</h3>
        <div id="friendRequests"></div>
        <h3>Search Users</h3>
        <input type="text" id="friendSearchInput" placeholder="Search by name or email" />
        <div id="friendSearchResults"></div>
      </div>
    `;
    loadFriendsAndRequests();
    document.getElementById("friendSearchInput").oninput = searchUsers;
  }

  async function loadFriendsAndRequests() {
    if (!auth.currentUser) return;
    const userDoc = await db.collection("users").doc(auth.currentUser.uid).get();
    if (!userDoc.exists) return;
    const data = userDoc.data();
    currentUserData = data;

    // Friends
    const friends = data.friends || [];
    const friendListEl = document.getElementById("friendList");
    friendListEl.innerHTML = "";
    for (const fid of friends) {
      const fdoc = await db.collection("users").doc(fid).get();
      if (fdoc.exists) {
        const fdata = fdoc.data();
        friendListEl.innerHTML += `<li><div class="avatar-circle">${fdata.name ? fdata.name[0].toUpperCase() : "?"}</div> ${escapeHtml(fdata.name)}</li>`;
      }
    }
    if (friends.length === 0) friendListEl.innerHTML = "<p>No friends yet.</p>";

    // Friend Requests
    const requests = data.friendRequests || [];
    const friendRequestsEl = document.getElementById("friendRequests");
    friendRequestsEl.innerHTML = "";
    for (const rid of requests) {
      const rdoc = await db.collection("users").doc(rid).get();
      if (rdoc.exists) {
        const rdata = rdoc.data();
        friendRequestsEl.innerHTML += `
          <div class="request-card">
            <div class="request-name">${escapeHtml(rdata.name)}</div>
            <div class="request-buttons">
              <button onclick="acceptFriend('${rid}')">Accept</button>
              <button onclick="declineFriend('${rid}')">Decline</button>
            </div>
          </div>`;
      }
    }
    if (requests.length === 0) friendRequestsEl.innerHTML = "<p>No friend requests.</p>";
  }

  // Search users by name or email
  let searchTimeout = null;
  function searchUsers() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(async () => {
      const query = document.getElementById("friendSearchInput").value.trim();
      if (!query) {
        document.getElementById("friendSearchResults").innerHTML = "";
        return;
      }
      // Firestore doesn't support OR queries, so search by name and email separately and combine.
      const results = [];
      const resultsEmails = new Set();

      try {
        // Search by name (simple prefix search)
        const nameSnap = await db
          .collection("users")
          .orderBy("name")
          .startAt(query)
          .endAt(query + "\uf8ff")
          .limit(10)
          .get();

        nameSnap.forEach((doc) => {
          results.push({ id: doc.id, ...doc.data() });
          resultsEmails.add(doc.data().email);
        });

        // Search by email if query includes '@'
        if (query.includes("@")) {
          const emailSnap = await db
            .collection("users")
            .where("email", "==", query)
            .limit(10)
            .get();
          emailSnap.forEach((doc) => {
            if (!resultsEmails.has(doc.data().email)) {
              results.push({ id: doc.id, ...doc.data() });
              resultsEmails.add(doc.data().email);
            }
          });
        }
      } catch (e) {
        console.error(e);
        document.getElementById("friendSearchResults").innerHTML =
          "<p>Error searching users.</p>";
        return;
      }

      if (results.length === 0) {
        document.getElementById("friendSearchResults").innerHTML =
          "<p>No users found.</p>";
        return;
      }

      // Filter out current user and friends & sent requests
      const filtered = results.filter(
        (u) =>
          u.id !== auth.currentUser.uid &&
          !(currentUserData.friends || []).includes(u.id) &&
          !(currentUserData.sentRequests || []).includes(u.id) &&
          !(currentUserData.friendRequests || []).includes(u.id)
      );

      if (filtered.length === 0) {
        document.getElementById("friendSearchResults").innerHTML =
          "<p>No users found to add.</p>";
        return;
      }

      // Show results
      const html = filtered
        .map(
          (u) => `
          <div class="request-card">
            <div class="request-name">${escapeHtml(u.name)} (${escapeHtml(u.email)})</div>
            <button onclick="sendFriendRequest('${u.id}')">Send Request</button>
          </div>`
        )
        .join("");
      document.getElementById("friendSearchResults").innerHTML = html;
    }, 400);
  }

  async function sendFriendRequest(friendId) {
    const userRef = db.collection("users").doc(auth.currentUser.uid);
    const friendRef = db.collection("users").doc(friendId);

    try {
      await db.runTransaction(async (transaction) => {
        const userDoc = await transaction.get(userRef);
        const friendDoc = await transaction.get(friendRef);
        if (!userDoc.exists || !friendDoc.exists) throw "User not found";

        const userData = userDoc.data();
        const friendData = friendDoc.data();

        if (
          userData.sentRequests?.includes(friendId) ||
          userData.friends?.includes(friendId) ||
          userData.friendRequests?.includes(friendId)
        ) {
          throw "Request already sent or user already a friend";
        }

        const updatedSentRequests = [...(userData.sentRequests || []), friendId];
        const updatedFriendRequests = [...(friendData.friendRequests || []), auth.currentUser.uid];

        transaction.update(userRef, { sentRequests: updatedSentRequests });
        transaction.update(friendRef, { friendRequests: updatedFriendRequests });
      });
      alert("Friend request sent!");
      loadFriendsAndRequests();
      searchUsers();
    } catch (e) {
      alert("Error sending friend request: " + e);
    }
  }

  async function acceptFriend(friendId) {
    const userRef = db.collection("users").doc(auth.currentUser.uid);
    const friendRef = db.collection("users").doc(friendId);

    try {
      await db.runTransaction(async (transaction) => {
        const userDoc = await transaction.get(userRef);
        const friendDoc = await transaction.get(friendRef);
        if (!userDoc.exists || !friendDoc.exists) throw "User not found";

        const userData = userDoc.data();
        const friendData = friendDoc.data();

        if (!userData.friendRequests?.includes(friendId)) {
          throw "No friend request from this user";
        }

        // Update friend lists
        const updatedFriendsUser = [...(userData.friends || []), friendId];
        const updatedFriendsFriend = [...(friendData.friends || []), auth.currentUser.uid];

        // Remove from requests
        const updatedFriendRequests = userData.friendRequests.filter((id) => id !== friendId);
        const updatedSentRequests = friendData.sentRequests.filter((id) => id !== auth.currentUser.uid);

        transaction.update(userRef, {
          friends: updatedFriendsUser,
          friendRequests: updatedFriendRequests,
        });
        transaction.update(friendRef, {
          friends: updatedFriendsFriend,
          sentRequests: updatedSentRequests,
        });
      });
      alert("Friend request accepted!");
      loadFriendsAndRequests();
    } catch (e) {
      alert("Error accepting friend request: " + e);
    }
  }

  async function declineFriend(friendId) {
    const userRef = db.collection("users").doc(auth.currentUser.uid);
    const friendRef = db.collection("users").doc(friendId);

    try {
      await db.runTransaction(async (transaction) => {
        const userDoc = await transaction.get(userRef);
        const friendDoc = await transaction.get(friendRef);
        if (!userDoc.exists || !friendDoc.exists) throw "User not found";

        const userData = userDoc.data();
        const friendData = friendDoc.data();

        if (!userData.friendRequests?.includes(friendId)) {
          throw "No friend request from this user";
        }

        // Remove friend request and sent request
        const updatedFriendRequests = userData.friendRequests.filter((id) => id !== friendId);
        const updatedSentRequests = friendData.sentRequests.filter((id) => id !== auth.currentUser.uid);

        transaction.update(userRef, { friendRequests: updatedFriendRequests });
        transaction.update(friendRef, { sentRequests: updatedSentRequests });
      });
      alert("Friend request declined!");
      loadFriendsAndRequests();
    } catch (e) {
      alert("Error declining friend request: " + e);
    }
  }

  // ----- PROFILE -----
  async function renderProfile() {
    if (!auth.currentUser) return;
    const userDoc = await db.collection("users").doc(auth.currentUser.uid).get();
    if (!userDoc.exists) return;

    const user = userDoc.data();
    currentUserData = user;
    const friends = user.friends || [];

    let friendsHTML = "";
    for (const fid of friends) {
      const fdoc = await db.collection("users").doc(fid).get();
      if (fdoc.exists) {
        const f = fdoc.data();
        friendsHTML += `<li><div class="avatar-circle">${f.name ? f.name[0].toUpperCase() : "?"}</div> ${escapeHtml(f.name)}</li>`;
      }
    }
    if (!friendsHTML) friendsHTML = "<p>No friends yet.</p>";

    const avatarHtml = user.avatar
      ? `<img src="${user.avatar}" alt="avatar" style="width:64px;height:64px;border-radius:50%;object-fit:cover;margin-bottom:10px;">`
      : `<div class="avatar-circle" style="width:64px;height:64px;font-size:28px;">${user.name ? user.name[0].toUpperCase() : "?"}</div>`;

    document.getElementById("app").innerHTML = `
      <div>
        <div class="card" style="text-align:center;">
          ${avatarHtml}
          <h3>${escapeHtml(user.name)}</h3>
          <p><strong>Age:</strong> ${escapeHtml(user.age)}</p>
          <p><strong>Bio:</strong> ${escapeHtml(user.bio)}</p>
          <button onclick="openEditProfile()">Edit Profile</button>
        </div>
        <div class="card">
          <h3>Friends</h3>
          <ul id="friendList">${friendsHTML}</ul>
        </div>
      </div>
    `;
  }

  function openEditProfile() {
    if (!currentUserData) return;
    document.getElementById("editName").value = currentUserData.name || "";
    document.getElementById("editBio").value = currentUserData.bio || "";
    avatarBase64 = currentUserData.avatar || null;
    document.getElementById("editAvatar").value = "";
    document.getElementById("editProfileModal").style.display = "flex";
  }

  function closeEditProfile() {
    document.getElementById("editProfileModal").style.display = "none";
  }

  // Convert image file to base64 string
  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = (error) => reject(error);
      reader.readAsDataURL(file);
    });
  }

  async function saveProfile() {
    const newName = document.getElementById("editName").value.trim();
    const newBio = document.getElementById("editBio").value.trim();
    const avatarFile = document.getElementById("editAvatar").files[0];

    if (!newName) {
      alert("Name cannot be empty");
      return;
    }

    if (avatarFile) {
      try {
        avatarBase64 = await fileToBase64(avatarFile);
      } catch {
        alert("Failed to read avatar image");
        return;
      }
    }

    try {
      await db.collection("users").doc(auth.currentUser.uid).update({
        name: newName,
        bio: newBio,
        avatar: avatarBase64 || null,
      });
      currentUserData.name = newName;
      currentUserData.bio = newBio;
      currentUserData.avatar = avatarBase64;
      alert("Profile updated!");
      closeEditProfile();
      renderProfile();
    } catch (e) {
      alert("Error saving profile: " + e.message);
    }
  }

  // ----- CHAT -----
  // Basic chat only between current user and friends (not fully featured, simplified)
  async function renderChat() {
    if (!auth.currentUser) return;
    const userDoc = await db.collection("users").doc(auth.currentUser.uid).get();
    if (!userDoc.exists) return;

    const friends = userDoc.data().friends || [];

    document.getElementById("app").innerHTML = `
      <div>
        <h3>Chat</h3>
        <select id="chatFriendSelect">
          <option value="">Select friend to chat</option>
          ${friends
            .map(
              (fid) =>
                `<option value="${fid}"></option>`
            )
            .join("")}
        </select>
        <div id="chatArea" style="display:none;">
          <div class="chat-container" id="chatMessages"></div>
          <textarea id="chatInput" placeholder="Type a message" rows="2" style="resize:none;"></textarea>
          <button id="sendChatBtn">Send</button>
        </div>
      </div>
    `;

    // Load friend names in select
    const select = document.getElementById("chatFriendSelect");
    for (const fid of friends) {
      const fdoc = await db.collection("users").doc(fid).get();
      if (fdoc.exists) {
        const f = fdoc.data();
        const opt = document.createElement("option");
        opt.value = fid;
        opt.textContent = f.name;
        select.appendChild(opt);
      }
    }

    select.onchange = () => {
      if (select.value) {
        openChatWithFriend(select.value);
      } else {
        document.getElementById("chatArea").style.display = "none";
        if (unsubscribeChat) unsubscribeChat();
      }
    };

    document.getElementById("sendChatBtn").onclick = sendMessage;
  }

  let unsubscribeChat = null;
  let currentChatFriendId = null;

  function openChatWithFriend(friendId) {
    currentChatFriendId = friendId;
    document.getElementById("chatArea").style.display = "block";
    document.getElementById("chatMessages").innerHTML = "";

    if (unsubscribeChat) unsubscribeChat();

    // Load messages between current user and friend
    unsubscribeChat = db
      .collection("chats")
      .doc(chatId(auth.currentUser.uid, friendId))
      .collection("messages")
      .orderBy("timestamp", "asc")
      .onSnapshot((snap) => {
        let html = "";
        snap.forEach((doc) => {
          const msg = doc.data();
          const isSelf = msg.senderId === auth.currentUser.uid;
          html += `<div class="chat-message ${isSelf ? "self" : "friend"}">${escapeHtml(
            msg.text
          )}</div>`;
        });
        document.getElementById("chatMessages").innerHTML = html;
        const chatContainer = document.getElementById("chatMessages");
        chatContainer.scrollTop = chatContainer.scrollHeight;
      });
  }

  function chatId(uid1, uid2) {
    return uid1 < uid2 ? uid1 + "_" + uid2 : uid2 + "_" + uid1;
  }

  async function sendMessage() {
    const input = document.getElementById("chatInput");
    const text = input.value.trim();
    if (!text || !currentChatFriendId) return;

    const messagesRef = db
      .collection("chats")
      .doc(chatId(auth.currentUser.uid, currentChatFriendId))
      .collection("messages");

    await messagesRef.add({
      text,
      senderId: auth.currentUser.uid,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    });

    input.value = "";
  }

  // ----- SETTINGS -----
  function renderSettings() {
    document.getElementById("app").innerHTML = `
      <div>
        <h3>Settings</h3>
        <button id="logoutBtn" style="background:#f44336;">Logout</button>
      </div>
    `;
    document.getElementById("logoutBtn").onclick = async () => {
      await auth.signOut();
      renderLogin();
      document.getElementById("navBar").style.display = "none";
    };
  }

  // Escape HTML to prevent XSS
  function escapeHtml(text) {
    if (!text) return "";
    return text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // --- INIT ---
  auth.onAuthStateChanged((user) => {
    if (user) {
      document.getElementById("navBar").style.display = "flex";
      showPage("feed");
    } else {
      renderLogin();
      document.getElementById("navBar").style.display = "none";
    }
  });
</script>

</body>
</html>
