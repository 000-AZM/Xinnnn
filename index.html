<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Xinn Social</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #f0f2f5;
  }
  header {
    background: #2196f3;
    color: white;
    padding: 10px;
    text-align: center;
  }
  .container {
    padding: 20px;
    max-width: 600px;
    margin: auto;
  }
  .card {
    background: white;
    padding: 15px;
    margin: 10px 0;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }
  input,
  textarea,
  button,
  select {
    width: 100%;
    padding: 10px;
    margin: 5px 0;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-sizing: border-box;
    font-size: 14px;
  }
  button {
    background: #2196f3;
    color: white;
    border: none;
    cursor: pointer;
  }
  button[disabled] {
    background: #bbb;
    cursor: not-allowed;
  }
  nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    display: flex;
    justify-content: space-around;
    border-top: 1px solid #ccc;
    padding: 10px 0;
    max-width: 600px;
    margin: auto;
    width: 100%;
    box-sizing: border-box;
  }
  nav button {
    background: none;
    color: #555;
    border: none;
    font-size: 24px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  nav button.active {
    color: #2196f3;
    font-weight: bold;
  }
  .message {
    padding: 8px 12px;
    margin: 6px 0;
    border-radius: 18px;
    max-width: 75%;
    word-wrap: break-word;
    position: relative;
    font-size: 15px;
    line-height: 1.3;
  }
  .message.you {
    background: #dcf8c6;
    margin-left: auto;
    text-align: right;
  }
  .message.friend {
    background: white;
    border: 1px solid #ddd;
  }
  .message .actions {
    margin-top: 6px;
    font-size: 12px;
    text-align: right;
  }
  .message .actions button {
    background: none;
    border: none;
    color: #2196f3;
    cursor: pointer;
    margin-left: 8px;
    font-size: 12px;
    padding: 2px 6px;
    border-radius: 12px;
  }
  .message .reply-to {
    background: #eee;
    padding: 4px 8px;
    border-radius: 12px;
    margin-bottom: 4px;
    font-size: 12px;
    color: #555;
  }
  #chatWindow {
    border: 1px solid #ccc;
    border-radius: 8px;
    height: 350px;
    display: flex;
    flex-direction: column;
    padding: 10px;
    background: #fff;
  }
  #chatMessages {
    flex: 1;
    overflow-y: auto;
  }
  #chatInputContainer {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
  }
  #chatInput {
    flex: 1;
    resize: none;
    font-size: 15px;
    border-radius: 20px;
    padding: 10px 16px;
    border: 1px solid #ccc;
  }
  #emojiPicker {
    display: none;
    max-width: 600px;
    margin: 4px auto 0 auto;
    background: white;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 8px;
    max-height: 100px;
    overflow-y: auto;
    user-select: none;
  }
  #emojiPicker span {
    cursor: pointer;
    font-size: 20px;
    padding: 4px 6px;
    margin: 2px;
    display: inline-block;
  }
  #typingIndicator {
    font-style: italic;
    color: #888;
    height: 20px;
    margin-top: 4px;
  }
  #replyPreview {
    display: none;
    background: #eee;
    padding: 6px 12px;
    margin-top: 6px;
    border-radius: 12px;
    font-size: 14px;
    position: relative;
  }
  #replyPreview button {
    position: absolute;
    right: 6px;
    top: 6px;
    background: transparent;
    border: none;
    font-weight: bold;
    cursor: pointer;
    font-size: 16px;
    line-height: 1;
  }
</style>
</head>
<body>

<header><h2>Xinn Social</h2></header>

<div id="app"></div>

<nav id="navBar" style="display:none;">
  <button id="navFeed" onclick="showPage('feed')" title="Feed">
    <span class="material-icons">home</span>
  </button>
  <button id="navFriends" onclick="showPage('friends')" title="Friends">
    <span class="material-icons">group</span>
  </button>
  <button id="navChat" onclick="showPage('chat')" title="Chat">
    <span class="material-icons">chat</span>
  </button>
  <button id="navProfile" onclick="showPage('profile')" title="Profile">
    <span class="material-icons">person</span>
  </button>
  <button id="navSettings" onclick="showPage('settings')" title="Settings">
    <span class="material-icons">settings</span>
  </button>
</nav>

<div id="emojiPicker"></div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCGN7t5FjDeJ-ewm7S_9z0VJrRSggTaJ2Q",
  authDomain: "coin-base-by-hector.firebaseapp.com",
  databaseURL: "https://coin-base-by-hector-default-rtdb.firebaseio.com",
  projectId: "coin-base-by-hector",
  storageBucket: "coin-base-by-hector.firebasestorage.app",
  messagingSenderId: "398789890422",
  appId: "1:398789890422:web:ed6a928037b24be2e36a57",
  measurementId: "G-SGJJM5K3G9"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// --- Utility ---
function escapeHtml(text) {
  if (!text) return '';
  return text.replace(/[&<>"']/g, function(m) {
    switch(m) {
      case '&': return '&amp;';
      case '<': return '&lt;';
      case '>': return '&gt;';
      case '"': return '&quot;';
      case "'": return '&#039;';
      default: return m;
    }
  });
}
function getCurrentUid() {
  return auth.currentUser ? auth.currentUser.uid : null;
}

// ------------- LOGIN & REGISTER -------------

function renderLogin() {
  document.getElementById('app').innerHTML = `
    <div class="container card">
      <h3>Login to Xinn Social</h3>
      <input type="email" id="email" placeholder="Email (@xinn.lab only)" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="login()">Login</button>
      <p>Or <a href="#" onclick="renderRegister()">Register</a></p>
    </div>`;
}

function renderRegister() {
  document.getElementById('app').innerHTML = `
    <div class="container card">
      <h3>Create Account</h3>
      <input type="text" id="name" placeholder="Full Name" />
      <input type="number" id="age" placeholder="Age" />
      <textarea id="bio" placeholder="Bio"></textarea>
      <input type="email" id="email" placeholder="Email (@xinn.lab only)" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="register()">Register</button>
      <p>Already have an account? <a href="#" onclick="renderLogin()">Login</a></p>
    </div>`;
}

function login() {
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value.trim();
  if (!email.endsWith('@xinn.lab')) {
    alert('Email must end with @xinn.lab');
    return;
  }
  auth.signInWithEmailAndPassword(email, pass).catch(e => alert(e.message));
}

function register() {
  const name = document.getElementById('name').value.trim();
  const age = document.getElementById('age').value.trim();
  const bio = document.getElementById('bio').value.trim();
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value.trim();
  if (!email.endsWith('@xinn.lab')) {
    alert('Email must end with @xinn.lab');
    return;
  }
  auth.createUserWithEmailAndPassword(email, pass)
    .then(cred => {
      return db.collection('users').doc(cred.user.uid).set({
        name,
        name_lower: name.toLowerCase(),
        age,
        bio,
        email
      });
    })
    .catch(e => alert(e.message));
}

// ------------- FEED -----------------

function renderFeed() {
  document.getElementById('app').innerHTML = `
    <div class="container">
      <div class="card">
        <textarea id="postContent" placeholder="What's on your mind?" style="resize:none;"></textarea>
        <button onclick="createPost()">Post</button>
      </div>
      <div id="feedPosts"></div>
    </div>`;
  loadPosts();
}

function createPost() {
  const content = document.getElementById('postContent').value.trim();
  if (!content) return;
  db.collection('posts').add({
    content,
    uid: getCurrentUid(),
    likes: [],
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
  document.getElementById('postContent').value = '';
}

function loadPosts() {
  db.collection('posts').orderBy('timestamp', 'desc').onSnapshot(snap => {
    let html = '';
    let postPromises = [];

    snap.forEach(doc => {
      const p = doc.data();
      postPromises.push(
        db.collection('users').doc(p.uid).get().then(userDoc => {
          const user = userDoc.data() || { name: "Unknown" };
          const time = p.timestamp ? p.timestamp.toDate().toLocaleString() : "Just now";

          html += `
            <div class="card" style="padding: 12px;">
              <div style="display:flex;align-items:center;margin-bottom:8px;">
                <span class="material-icons" style="font-size:36px;color:#2196F3;margin-right:10px;">account_circle</span>
                <div>
                  <strong>${escapeHtml(user.name)}</strong><br />
                  <small style="color:gray;">${escapeHtml(time)}</small>
                </div>
              </div>
              <div style="margin:10px 0;font-size:15px;">${escapeHtml(p.content)}</div>
              <hr style="margin:8px 0;" />
              <button onclick="toggleLike('${doc.id}')" style="background:none;color:#2196F3;border:none;cursor:pointer;">
                üëç Like (${p.likes.length})
              </button>
            </div>`;
        })
      );
    });

    Promise.all(postPromises).then(() => {
      document.getElementById('feedPosts').innerHTML = html;
    });
  });
}

function toggleLike(postId) {
  const ref = db.collection('posts').doc(postId);
  ref.get().then(doc => {
    const data = doc.data();
    let likes = data.likes || [];
    const uid = getCurrentUid();
    if (likes.includes(uid)) {
      likes = likes.filter(id => id !== uid);
    } else {
      likes.push(uid);
    }
    ref.update({ likes });
  });
}

// ------------- PROFILE -----------------

function renderProfile() {
  const uid = getCurrentUid();
  if (!uid) return;
  db.collection('users').doc(uid).get().then(doc => {
    const u = doc.data();
    document.getElementById('app').innerHTML = `
      <div class="container">
        <div class="card">
          <h3>${escapeHtml(u.name)}</h3>
          <p>Age: ${escapeHtml(u.age)}</p>
          <p>Bio: ${escapeHtml(u.bio)}</p>
          <button onclick="editProfile()">Edit Profile</button>
        </div>
      </div>`;
  });
}

function editProfile() {
  const uid = getCurrentUid();
  if (!uid) return;
  db.collection('users').doc(uid).get().then(doc => {
    const u = doc.data();
    document.getElementById('app').innerHTML = `
      <div class="container card">
        <input id="name" value="${escapeHtml(u.name)}" placeholder="Full Name" />
        <input id="age" value="${escapeHtml(u.age)}" placeholder="Age" />
        <textarea id="bio" placeholder="Bio">${escapeHtml(u.bio)}</textarea>
        <button onclick="saveProfile()">Save</button>
      </div>`;
  });
}

function saveProfile() {
  const uid = getCurrentUid();
  if (!uid) return;
  const name = document.getElementById('name').value.trim();
  const age = document.getElementById('age').value.trim();
  const bio = document.getElementById('bio').value.trim();
  db.collection('users').doc(uid).update({
    name,
    name_lower: name.toLowerCase(),
    age,
    bio
  });
  renderProfile();
}

// ------------- FRIENDS -----------------

let searchTimeout;
function renderFriends() {
  document.getElementById('app').innerHTML = `
    <div class="container card">
      <h3>Friends</h3>
      <input id="searchInput" type="text" placeholder="Search friends by name" autocomplete="off" oninput="debouncedSearchUsers()" />
      <div id="searchResults"></div>
      <h4>Your Friends</h4>
      <div id="friendList"></div>
      <h4>Friend Requests</h4>
      <div id="friendRequests"></div>
    </div>`;
  loadFriends();
  loadFriendRequests();
}

function debouncedSearchUsers() {
  if (searchTimeout) clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    searchUsers();
  }, 400);
}

function searchUsers() {
  const query = document.getElementById('searchInput').value.trim().toLowerCase();
  if (!query) {
    document.getElementById('searchResults').innerHTML = '';
    return;
  }
  const uid = getCurrentUid();
  db.collection('users')
    .where('name_lower', '>=', query)
    .where('name_lower', '<=', query + '\uf8ff')
    .limit(10)
    .get()
    .then(snapshot => {
      let html = '';
      const promises = [];
      snapshot.forEach(doc => {
        if (doc.id === uid) return; // skip self
        promises.push(
          checkFriendStatus(uid, doc.id).then(status => {
            html += `
              <div style="padding:6px; border-bottom:1px solid #ccc; display:flex; justify-content:space-between; align-items:center;">
                <span>${escapeHtml(doc.data().name)}</span>
                ${status === 'friends' ? '<span>Friends</span>' : ''}
                ${status === 'pending' ? '<span>Request Sent</span>' : ''}
                ${status === 'none' ? `<button onclick="sendFriendRequest('${doc.id}')">Add Friend</button>` : ''}
              </div>`;
          })
        );
      });
      Promise.all(promises).then(() => {
        document.getElementById('searchResults').innerHTML = html || '<p>No users found</p>';
      });
    });
}

function checkFriendStatus(myUid, otherUid) {
  return db.collection('friends').doc(myUid).get().then(doc => {
    if (!doc.exists) return 'none';
    const friends = doc.data().friends || [];
    if (friends.includes(otherUid)) return 'friends';
    // Check if friend request sent by me
    return db.collection('friendRequests')
      .where('from', '==', myUid)
      .where('to', '==', otherUid)
      .where('status', '==', 'pending')
      .get()
      .then(snap => {
        if (!snap.empty) return 'pending';
        return 'none';
      });
  });
}

function sendFriendRequest(toUid) {
  const fromUid = getCurrentUid();
  if (!fromUid) return alert('Not logged in');
  // Prevent sending duplicates
  db.collection('friendRequests')
    .where('from', '==', fromUid)
    .where('to', '==', toUid)
    .where('status', '==', 'pending')
    .get()
    .then(snap => {
      if (!snap.empty) return alert('Friend request already sent');
      db.collection('friendRequests').add({
        from: fromUid,
        to: toUid,
        status: 'pending',
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => alert('Friend request sent'));
    });
}

function loadFriends() {
  const uid = getCurrentUid();
  if (!uid) return;
  db.collection('friends').doc(uid).onSnapshot(doc => {
    const data = doc.data();
    const friends = data ? data.friends || [] : [];
    if (friends.length === 0) {
      document.getElementById('friendList').innerHTML = '<p>You have no friends yet.</p>';
      return;
    }
    let html = '';
    const promises = [];
    friends.forEach(friendUid => {
      promises.push(
        db.collection('users').doc(friendUid).get().then(friendDoc => {
          if (!friendDoc.exists) return;
          const friendData = friendDoc.data();
          html += `
            <div style="padding:6px; border-bottom:1px solid #ccc; display:flex; justify-content:space-between; align-items:center;">
              <span>${escapeHtml(friendData.name)}</span>
              <div>
                <button onclick="startChatWith('${friendUid}', '${escapeHtml(friendData.name)}')">Chat</button>
                <button onclick="removeFriend('${friendUid}')">Remove</button>
              </div>
            </div>`;
        })
      );
    });
    Promise.all(promises).then(() => {
      document.getElementById('friendList').innerHTML = html;
    });
  });
}

function removeFriend(friendUid) {
  const uid = getCurrentUid();
  if (!uid) return;
  // Remove friend from both users' friend lists
  const userRef = db.collection('friends').doc(uid);
  const friendRef = db.collection('friends').doc(friendUid);

  userRef.get().then(doc => {
    if (!doc.exists) return;
    let friends = doc.data().friends || [];
    friends = friends.filter(f => f !== friendUid);
    userRef.set({ friends }, { merge: true });
  });
  friendRef.get().then(doc => {
    if (!doc.exists) return;
    let friends = doc.data().friends || [];
    friends = friends.filter(f => f !== uid);
    friendRef.set({ friends }, { merge: true });
  });
}

function loadFriendRequests() {
  const uid = getCurrentUid();
  if (!uid) return;
  
  db.collection('friendRequests')
    .where('to', '==', uid)
    .where('status', '==', 'pending')
    .orderBy('timestamp', 'desc')
    .onSnapshot(snapshot => {
      let html = '';
      if (snapshot.empty) {
        html = '<p>No pending friend requests.</p>';
        document.getElementById('friendRequests').innerHTML = html;
        return;
      }

      snapshot.forEach(doc => {
        const req = doc.data();
        const requestId = doc.id;
        html += `
          <div style="padding:6px; border-bottom:1px solid #ccc; display:flex; justify-content:space-between; align-items:center;">
            <span><strong>Request from:</strong> <span id="reqUserName_${requestId}">Loading...</span></span>
            <div>
              <button onclick="acceptFriendRequest('${requestId}', '${req.from}')">Accept</button>
              <button onclick="declineFriendRequest('${requestId}')">Decline</button>
            </div>
          </div>
        `;

        db.collection('users').doc(req.from).get().then(userDoc => {
          if (userDoc.exists) {
            const nameSpan = document.getElementById('reqUserName_' + requestId);
            if (nameSpan) {
              nameSpan.textContent = userDoc.data().name;
            }
          }
        });
      });
      document.getElementById('friendRequests').innerHTML = html;
    });
}

function acceptFriendRequest(requestId, fromUid) {
  const uid = getCurrentUid();
  if (!uid) return;
  // Update request status
  db.collection('friendRequests').doc(requestId).update({ status: 'accepted' });

  // Add each other as friends
  const userRef = db.collection('friends').doc(uid);
  const friendRef = db.collection('friends').doc(fromUid);

  userRef.get().then(doc => {
    let friends = doc.exists ? doc.data().friends || [] : [];
    if (!friends.includes(fromUid)) friends.push(fromUid);
    userRef.set({ friends }, { merge: true });
  });
  friendRef.get().then(doc => {
    let friends = doc.exists ? doc.data().friends || [] : [];
    if (!friends.includes(uid)) friends.push(uid);
    friendRef.set({ friends }, { merge: true });
  });
}

function declineFriendRequest(requestId) {
  db.collection('friendRequests').doc(requestId).update({ status: 'declined' });
}

// ------------- CHAT -----------------

let currentChatFriendUid = null;
let currentChatFriendName = null;
let editingMessageId = null;
let replyingMessage = null;
let typingRef = null;
let typingTimeout = null;

const emojis = ['üòÄ','üòÇ','üòç','üòé','üëç','üôè','üéâ','üíî','üî•','ü§ñ','üí¨','üò¢'];

function renderChat() {
  if (!currentChatFriendUid) {
    document.getElementById('app').innerHTML = `<div class="container card"><p>Select a friend from Friends tab to chat.</p></div>`;
    return;
  }
  document.getElementById('app').innerHTML = `
    <div class="container card">
      <h3>Chat with ${escapeHtml(currentChatFriendName)}</h3>
      <div id="chatWindow">
        <div id="chatMessages"></div>
        <div id="typingIndicator"></div>
        <div id="replyPreview">
          Replying to: <span id="replyText"></span>
          <button onclick="cancelReply()">√ó</button>
        </div>
      </div>
      <div id="chatInputContainer">
        <button onclick="toggleEmojiPicker()" title="Emoji" style="font-size: 22px;">üòä</button>
        <textarea id="chatInput" rows="2" placeholder="Type a message..." oninput="onChatInput()"></textarea>
        <button id="sendChatBtn" onclick="sendMessage()" disabled>Send</button>
      </div>
    </div>`;
  renderEmojiPicker();
  loadMessages();
}

function getChatId(uid1, uid2) {
  return uid1 < uid2 ? uid1 + '_' + uid2 : uid2 + '_' + uid1;
}

function loadMessages() {
  const uid = getCurrentUid();
  if (!uid || !currentChatFriendUid) return;

  const chatId = getChatId(uid, currentChatFriendUid);
  const chatMessagesDiv = document.getElementById('chatMessages');
  chatMessagesDiv.innerHTML = '';

  db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp', 'asc').onSnapshot(snapshot => {
    chatMessagesDiv.innerHTML = '';
    snapshot.forEach(doc => {
      const msg = doc.data();
      const isYou = msg.sender === uid;

      const msgDiv = document.createElement('div');
      msgDiv.className = 'message ' + (isYou ? 'you' : 'friend');

      if (msg.replyText) {
        const replyDiv = document.createElement('div');
        replyDiv.className = 'reply-to';
        replyDiv.textContent = 'Reply: ' + msg.replyText;
        msgDiv.appendChild(replyDiv);
      }

      const textDiv = document.createElement('div');
      textDiv.textContent = msg.text;
      msgDiv.appendChild(textDiv);

      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'actions';

      if (isYou) {
        const editBtn = document.createElement('button');
        editBtn.textContent = 'Edit';
        editBtn.onclick = () => editMessage(doc.id, msg.text);
        actionsDiv.appendChild(editBtn);
      }

      const replyBtn = document.createElement('button');
      replyBtn.textContent = 'Reply';
      replyBtn.onclick = () => startReply(msg.text);
      actionsDiv.appendChild(replyBtn);

      msgDiv.appendChild(actionsDiv);

      chatMessagesDiv.appendChild(msgDiv);
    });
    chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
  });

  setupTypingIndicator(chatId, uid);
}

function editMessage(messageId, currentText) {
  editingMessageId = messageId;
  document.getElementById('chatInput').value = currentText;
  document.getElementById('sendChatBtn').textContent = 'Save';
  document.getElementById('sendChatBtn').disabled = false;
  document.getElementById('chatInput').focus();
}

function startReply(text) {
  replyingMessage = text;
  const replyPreview = document.getElementById('replyPreview');
  document.getElementById('replyText').textContent = text;
  replyPreview.style.display = 'block';
  document.getElementById('chatInput').focus();
}

function cancelReply() {
  replyingMessage = null;
  const replyPreview = document.getElementById('replyPreview');
  replyPreview.style.display = 'none';
}

function sendMessage() {
  const uid = getCurrentUid();
  if (!uid || !currentChatFriendUid) return;

  const textArea = document.getElementById('chatInput');
  const text = textArea.value.trim();
  if (!text) return;

  const chatId = getChatId(uid, currentChatFriendUid);
  const messagesRef = db.collection('chats').doc(chatId).collection('messages');

  if (editingMessageId) {
    // Save edited message
    messagesRef.doc(editingMessageId).update({
      text,
      edited: true
    }).then(() => {
      editingMessageId = null;
      textArea.value = '';
      document.getElementById('sendChatBtn').textContent = 'Send';
      document.getElementById('sendChatBtn').disabled = true;
      cancelReply();
    });
  } else {
    // Send new message
    messagesRef.add({
      sender: uid,
      text,
      replyText: replyingMessage || null,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
      textArea.value = '';
      document.getElementById('sendChatBtn').disabled = true;
      cancelReply();
    });
  }
}

function onChatInput() {
  const val = document.getElementById('chatInput').value.trim();
  document.getElementById('sendChatBtn').disabled = !val;
  updateTypingStatus();
}

// Emoji picker

function renderEmojiPicker() {
  const emojiPicker = document.getElementById('emojiPicker');
  emojiPicker.innerHTML = emojis.map(e => `<span onclick="addEmoji('${e}')">${e}</span>`).join('');
}

function toggleEmojiPicker() {
  const emojiPicker = document.getElementById('emojiPicker');
  emojiPicker.style.display = emojiPicker.style.display === 'block' ? 'none' : 'block';
}

function addEmoji(emoji) {
  const input = document.getElementById('chatInput');
  input.value += emoji;
  input.focus();
  document.getElementById('sendChatBtn').disabled = false;
}

// Typing indicator

function setupTypingIndicator(chatId, uid) {
  if (typingRef) typingRef.off();

  typingRef = db.collection('typingStatus').doc(chatId);

  const otherUid = currentChatFriendUid;

  // Listen to other's typing status
  typingRef.onSnapshot(doc => {
    if (!doc.exists) return;
    const data = doc.data();
    if (data[otherUid]) {
      document.getElementById('typingIndicator').textContent = `${currentChatFriendName} is typing...`;
    } else {
      document.getElementById('typingIndicator').textContent = '';
    }
  });
}

function updateTypingStatus() {
  const uid = getCurrentUid();
  if (!uid || !currentChatFriendUid) return;

  const chatId = getChatId(uid, currentChatFriendUid);
  const typingDoc = db.collection('typingStatus').doc(chatId);

  typingDoc.set({ [uid]: true }, { merge: true });

  if (typingTimeout) clearTimeout(typingTimeout);

  typingTimeout = setTimeout(() => {
    typingDoc.set({ [uid]: false }, { merge: true });
  }, 2000);
}

// Start chat from friend list

function startChatWith(friendUid, friendName) {
  currentChatFriendUid = friendUid;
  currentChatFriendName = friendName;
  showPage('chat');
}

// ------------- NAVIGATION -----------------

function showPage(page) {
  // Highlight nav buttons
  ['navFeed', 'navFriends', 'navChat', 'navProfile', 'navSettings'].forEach(id => {
    document.getElementById(id).classList.remove('active');
  });
  if (page === 'feed') document.getElementById('navFeed').classList.add('active');
  else if (page === 'friends') document.getElementById('navFriends').classList.add('active');
  else if (page === 'chat') document.getElementById('navChat').classList.add('active');
  else if (page === 'profile') document.getElementById('navProfile').classList.add('active');
  else if (page === 'settings') document.getElementById('navSettings').classList.add('active');

  if (page === 'feed') renderFeed();
  else if (page === 'profile') renderProfile();
  else if (page === 'friends') renderFriends();
  else if (page === 'chat') renderChat();
  else if (page === 'settings') renderSettings();
}

// ------------- SETTINGS -----------------

function renderSettings() {
  document.getElementById('app').innerHTML = `
    <div class="container card">
      <button onclick="auth.signOut()">Logout</button>
    </div>`;
}

// ------------- AUTH STATE CHANGE -------------

auth.onAuthStateChanged(user => {
  if (user) {
    document.getElementById('navBar').style.display = 'flex';
    showPage('feed');
  } else {
    document.getElementById('navBar').style.display = 'none';
    renderLogin();
  }
});
</script>
</body>
</html>
