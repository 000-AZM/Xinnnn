<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Xinn Social</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<style>
  body {
    font-family: 'Roboto', Arial, sans-serif;
    margin: 0;
    background: #f0f2f5;
  }
  header {
    background: #2196f3;
    color: white;
    padding: 10px;
    text-align: center;
    font-weight: 500;
    font-size: 1.5rem;
  }
  .container {
    padding: 20px;
  }
  .card {
    background: white;
    padding: 15px;
    margin: 10px 0;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgb(0 0 0 / 0.1);
  }
  input, textarea, button, select {
    width: 100%;
    padding: 10px;
    margin: 6px 0;
    border: 1.5px solid #ccc;
    border-radius: 8px;
    font-size: 1rem;
    font-family: inherit;
    box-sizing: border-box;
    transition: border-color 0.3s ease;
  }
  input:focus, textarea:focus {
    border-color: #2196f3;
    outline: none;
  }
  button {
    background: #2196f3;
    color: white;
    border: none;
    cursor: pointer;
    font-weight: 500;
    font-size: 1rem;
    border-radius: 8px;
    padding: 12px;
    transition: background-color 0.3s ease;
  }
  button:hover:not(:disabled) {
    background: #1769aa;
  }
  button:disabled {
    background: #90caf9;
    cursor: not-allowed;
  }
  nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    display: flex;
    justify-content: space-around;
    border-top: 1px solid #ccc;
    padding: 10px 0;
    z-index: 10;
  }
  nav button {
    background: none;
    color: #555;
    border: none;
    font-size: 24px;
    cursor: pointer;
  }
  nav button.active {
    color: #2196f3;
    font-weight: 700;
  }

  /* Chat styles */
  #app {
    padding-bottom: 60px; /* space for nav */
  }

  .chat-container {
    display: flex;
    height: 80vh;
    max-height: 80vh;
    border-radius: 12px;
    overflow: hidden;
    background: white;
    box-shadow: 0 1px 5px rgb(0 0 0 / 0.1);
  }

  #friendsList {
    width: 30%;
    border-right: 1px solid #ddd;
    overflow-y: auto;
    background: #fafafa;
  }

  #friendsList h3 {
    margin: 0;
    padding: 16px;
    font-weight: 600;
    border-bottom: 1px solid #ddd;
    background: #f5f5f5;
  }

  #chatFriendsContainer > div {
    padding: 12px 16px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  #chatFriendsContainer > div:hover {
    background-color: #e3f2fd;
  }

  #chatWindow {
    width: 70%;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    background: white;
  }

  #chatMessages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 16px;
    background: #e9f0ff;
  }

  .message {
    max-width: 75%;
    margin-bottom: 12px;
    padding: 12px 16px;
    border-radius: 18px;
    box-shadow: 0 1px 3px rgb(0 0 0 / 0.12);
    position: relative;
    font-size: 14px;
    line-height: 1.3;
    word-break: break-word;
    user-select: text;
  }

  .message.you {
    background: #2196f3;
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 4px;
  }

  .message.friend {
    background: #fff;
    border: 1.5px solid #ddd;
    color: #222;
    margin-right: auto;
    border-bottom-left-radius: 4px;
  }

  .message small {
    font-size: 10px;
    color: rgba(255,255,255,0.8);
    position: absolute;
    top: 4px;
    right: 12px;
  }
  .message.friend small {
    color: #888;
    top: auto;
    bottom: 4px;
    right: 12px;
    position: relative;
  }

  .actions {
    margin-top: 6px;
    text-align: right;
  }
  .actions button {
    background: none;
    border: none;
    color: #2196f3;
    font-size: 16px;
    margin-left: 8px;
    cursor: pointer;
    padding: 0 6px;
    border-radius: 4px;
    transition: background-color 0.2s ease;
  }
  .actions button:hover {
    background-color: rgba(33, 150, 243, 0.15);
  }

  .reply-to {
    font-size: 12px;
    margin-bottom: 6px;
    padding-left: 8px;
    border-left: 3px solid #2196f3;
    color: #0d47a1;
    cursor: pointer;
    user-select: none;
  }

  #chatInputContainer {
    padding: 12px 16px;
    border-top: 1px solid #ddd;
    background: #f5f5f5;
    display: flex;
    flex-direction: column;
  }

  #chatInput {
    resize: none;
    font-size: 14px;
    padding: 10px;
    border-radius: 12px;
    border: 1.5px solid #ccc;
    font-family: inherit;
    min-height: 60px;
    max-height: 120px;
    overflow-y: auto;
  }

  #sendChatBtn {
    margin-top: 8px;
    align-self: flex-end;
    min-width: 80px;
  }

  #replyPreview {
    background: #e3f2fd;
    border-left: 4px solid #2196f3;
    padding: 6px 12px;
    margin-bottom: 8px;
    font-size: 13px;
    color: #0d47a1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-radius: 8px;
  }
  #replyPreview button {
    background: none;
    border: none;
    font-size: 18px;
    line-height: 1;
    cursor: pointer;
    color: #0d47a1;
  }

  /* Scrollbar styling for chat */
  #friendsList::-webkit-scrollbar,
  #chatMessages::-webkit-scrollbar {
    width: 8px;
  }
  #friendsList::-webkit-scrollbar-thumb,
  #chatMessages::-webkit-scrollbar-thumb {
    background: rgba(33, 150, 243, 0.3);
    border-radius: 4px;
  }

  /* Other pages style tweaks */
  textarea#postContent {
    min-height: 70px;
    border-radius: 12px;
    font-size: 15px;
  }
  .card h3 {
    margin-top: 0;
    font-weight: 600;
  }
  a {
    color: #2196f3;
    cursor: pointer;
    text-decoration: none;
  }
  a:hover {
    text-decoration: underline;
  }
</style>
</head>
<body>

<header><h2>Xinn Social</h2></header>

<div id="app"></div>

<nav id="navBar" style="display:none;">
  <button onclick="showPage('feed')" title="Feed"><span class="material-icons">home</span></button>
  <button onclick="showPage('friends')" title="Friends"><span class="material-icons">group</span></button>
  <button onclick="showPage('chat')" title="Chat"><span class="material-icons">chat</span></button>
  <button onclick="showPage('profile')" title="Profile"><span class="material-icons">person</span></button>
  <button onclick="showPage('settings')" title="Settings"><span class="material-icons">settings</span></button>
</nav>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCGN7t5FjDeJ-ewm7S_9z0VJrRSggTaJ2Q",
  authDomain: "coin-base-by-hector.firebaseapp.com",
  databaseURL: "https://coin-base-by-hector-default-rtdb.firebaseio.com",
  projectId: "coin-base-by-hector",
  storageBucket: "coin-base-by-hector.appspot.com",
  messagingSenderId: "398789890422",
  appId: "1:398789890422:web:ed6a928037b24be2e36a57",
  measurementId: "G-SGJJM5K3G9"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

function escapeHtml(text) {
  if (!text) return '';
  return text.replace(/[&<>"']/g, m => {
    switch (m) {
      case '&': return '&amp;';
      case '<': return '&lt;';
      case '>': return '&gt;';
      case '"': return '&quot;';
      case "'": return '&#39;';
      default: return m;
    }
  });
}

function getCurrentUid() {
  return auth.currentUser ? auth.currentUser.uid : null;
}

// ----- LOGIN & REGISTER -----
function renderLogin() {
  document.getElementById('app').innerHTML = `
    <div class="container card">
      <h3>Login to Xinn Social</h3>
      <input type="email" id="email" placeholder="Email (@xinn.lab only)" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="login()">Login</button>
      <p>Or <a onclick="renderRegister()">Register</a></p>
    </div>
  `;
}

function renderRegister() {
  document.getElementById('app').innerHTML = `
    <div class="container card">
      <h3>Create Account</h3>
      <input type="text" id="name" placeholder="Full Name" />
      <input type="number" id="age" placeholder="Age" />
      <textarea id="bio" placeholder="Bio"></textarea>
      <input type="email" id="email" placeholder="Email (@xinn.lab only)" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="register()">Register</button>
      <p>Already have an account? <a onclick="renderLogin()">Login</a></p>
    </div>
  `;
}

function login() {
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value.trim();
  if (!email.endsWith('@xinn.lab')) {
    alert('Email must end with @xinn.lab');
    return;
  }
  auth.signInWithEmailAndPassword(email, pass).catch(e => alert(e.message));
}

function register() {
  const name = document.getElementById('name').value.trim();
  const age = document.getElementById('age').value.trim();
  const bio = document.getElementById('bio').value.trim();
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value.trim();
  if (!email.endsWith('@xinn.lab')) {
    alert('Email must end with @xinn.lab');
    return;
  }
  auth.createUserWithEmailAndPassword(email, pass)
    .then(cred => {
      return db.collection('users').doc(cred.user.uid).set({ name, age, bio, email });
    })
    .catch(e => alert(e.message));
}

// ----- FEED -----
function renderFeed() {
  document.getElementById('app').innerHTML = `
    <div class="container">
      <div class="card">
        <textarea id="postContent" placeholder="What's on your mind?" style="resize:none;"></textarea>
        <button onclick="createPost()">Post</button>
      </div>
      <div id="feedPosts"></div>
    </div>`;
  loadPosts();
}

function createPost() {
  const content = document.getElementById('postContent').value.trim();
  if (!content) return;
  db.collection('posts').add({
    content,
    uid: auth.currentUser.uid,
    likes: [],
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
  document.getElementById('postContent').value = '';
}

function loadPosts() {
  db.collection('posts').orderBy('timestamp', 'desc').onSnapshot(snap => {
    let html = '';
    let postPromises = [];

    snap.forEach(doc => {
      const p = doc.data();
      postPromises.push(
        db.collection('users').doc(p.uid).get().then(userDoc => {
          const user = userDoc.data() || { name: "Unknown" };
          const time = p.timestamp ? p.timestamp.toDate().toLocaleString() : "Just now";

          html += `
            <div class="card" style="padding: 12px;">
              <div style="display:flex;align-items:center;margin-bottom:8px;">
                <span class="material-icons" style="font-size:36px;color:#2196F3;margin-right:10px;">account_circle</span>
                <div>
                  <strong>${escapeHtml(user.name)}</strong><br />
                  <small style="color:gray;">${time}</small>
                </div>
              </div>
              <div style="margin:10px 0;font-size:15px;">${escapeHtml(p.content)}</div>
              <hr style="margin:8px 0;">
              <button onclick="toggleLike('${doc.id}')" style="background:none;color:#2196F3;border:none;cursor:pointer;">
                👍 Like (${p.likes.length})
              </button>
            </div>`;
        })
      );
    });

    Promise.all(postPromises).then(() => {
      document.getElementById('feedPosts').innerHTML = html;
    });
  });
}

function toggleLike(postId) {
  const ref = db.collection('posts').doc(postId);
  ref.get().then(doc => {
    const data = doc.data();
    let likes = data.likes || [];
    if (likes.includes(auth.currentUser.uid)) {
      likes = likes.filter(id => id !== auth.currentUser.uid);
    } else {
      likes.push(auth.currentUser.uid);
    }
    ref.update({ likes });
  });
}

// ----- PROFILE -----
function renderProfile() {
  db.collection('users').doc(auth.currentUser.uid).get().then(doc => {
    const u = doc.data();
    document.getElementById('app').innerHTML = `
      <div class="container">
        <div class="card">
          <h3>${escapeHtml(u.name)}</h3>
          <p>Age: ${escapeHtml(u.age)}</p>
          <p>Bio: ${escapeHtml(u.bio)}</p>
          <button onclick="editProfile()">Edit Profile</button>
        </div>
      </div>`;
  });
}

function editProfile() {
  db.collection('users').doc(auth.currentUser.uid).get().then(doc => {
    const u = doc.data();
    document.getElementById('app').innerHTML = `
      <div class="container card">
        <input id="name" value="${escapeHtml(u.name)}" />
        <input id="age" value="${escapeHtml(u.age)}" />
        <textarea id="bio">${escapeHtml(u.bio)}</textarea>
        <button onclick="saveProfile()">Save</button>
      </div>`;
  });
}

function saveProfile() {
  const name = document.getElementById('name').value.trim();
  const age = document.getElementById('age').value.trim();
  const bio = document.getElementById('bio').value.trim();
  db.collection('users').doc(auth.currentUser.uid).update({ name, age, bio });
  renderProfile();
}

// ----- FRIENDS -----
function renderFriends() {
  const currentUid = getCurrentUid();
  document.getElementById('app').innerHTML = `
    <div class="container card">
      <h3>Friends & Requests</h3>
      <input type="text" id="friendEmailInput" placeholder="Friend's Email (@xinn.lab only)" />
      <button onclick="sendFriendRequest()">Send Friend Request</button>
      <h4>Pending Requests</h4>
      <div id="pendingRequests"></div>
      <h4>Friend List</h4>
      <div id="friendList"></div>
    </div>`;
  loadFriendData(currentUid);
}

function sendFriendRequest() {
  const email = document.getElementById('friendEmailInput').value.trim();
  if (!email.endsWith('@xinn.lab')) {
    alert('Friend email must end with @xinn.lab');
    return;
  }
  db.collection('users').where('email', '==', email).get().then(querySnap => {
    if (querySnap.empty) {
      alert('No user found with that email');
      return;
    }
    const friendUid = querySnap.docs[0].id;
    const currentUid = getCurrentUid();
    if (friendUid === currentUid) {
      alert("You can't add yourself");
      return;
    }
    // Add friend request
    const requestsRef = db.collection('friendRequests');
    // Check if already requested or friends
    requestsRef.where('from', '==', currentUid).where('to', '==', friendUid).get()
      .then(snap => {
        if (!snap.empty) {
          alert('Friend request already sent');
          return;
        }
        db.collection('friends').doc(currentUid).get().then(doc => {
          const friends = doc.exists ? doc.data().list || [] : [];
          if (friends.includes(friendUid)) {
            alert('Already friends');
            return;
          }
          // Send request
          requestsRef.add({ from: currentUid, to: friendUid, timestamp: firebase.firestore.FieldValue.serverTimestamp() })
            .then(() => {
              alert('Friend request sent');
              renderFriends();
            })
            .catch(e => alert('Error sending friend request: ' + e.message));
        });
      });
  });
}

function loadFriendData(currentUid) {
  const requestsRef = db.collection('friendRequests');
  const friendsRef = db.collection('friends');

  // Load incoming requests
  requestsRef.where('to', '==', currentUid).get().then(snapshot => {
    const pendingRequestsDiv = document.getElementById('pendingRequests');
    if (snapshot.empty) {
      pendingRequestsDiv.innerHTML = '<p>No pending requests.</p>';
      return;
    }
    let html = '';
    const promises = [];
    snapshot.forEach(doc => {
      const req = doc.data();
      const reqId = doc.id;
      promises.push(db.collection('users').doc(req.from).get().then(userDoc => {
        const u = userDoc.data();
        html += `<div style="display:flex; justify-content:space-between; align-items:center; padding:6px 0; border-bottom:1px solid #eee;">
          <div>${escapeHtml(u.name)} (${escapeHtml(u.email)})</div>
          <div>
            <button onclick="acceptRequest('${reqId}', '${req.from}')">Accept</button>
            <button onclick="declineRequest('${reqId}')">Decline</button>
          </div>
        </div>`;
      }));
    });
    Promise.all(promises).then(() => {
      pendingRequestsDiv.innerHTML = html;
    });
  });

  // Load friends list
  friendsRef.doc(currentUid).get().then(doc => {
    const friendListDiv = document.getElementById('friendList');
    if (!doc.exists || !doc.data().list || doc.data().list.length === 0) {
      friendListDiv.innerHTML = '<p>No friends yet.</p>';
      return;
    }
    const friendUids = doc.data().list;
    let html = '';
    const promises = friendUids.map(uid => db.collection('users').doc(uid).get().then(userDoc => {
      const u = userDoc.data();
      html += `<div style="display:flex; justify-content:space-between; align-items:center; padding:6px 0; border-bottom:1px solid #eee;">
        <div>${escapeHtml(u.name)} (${escapeHtml(u.email)})</div>
        <div>
          <button onclick="removeFriend('${uid}')">Remove</button>
        </div>
      </div>`;
    }));
    Promise.all(promises).then(() => {
      friendListDiv.innerHTML = html;
    });
  });
}

function acceptRequest(reqId, friendUid) {
  const currentUid = getCurrentUid();
  const batch = db.batch();

  // Add friendUid to current user's friend list
  const currentUserRef = db.collection('friends').doc(currentUid);
  const friendUserRef = db.collection('friends').doc(friendUid);

  // Get current friend lists to update
  Promise.all([currentUserRef.get(), friendUserRef.get()]).then(([doc1, doc2]) => {
    let list1 = doc1.exists ? doc1.data().list || [] : [];
    let list2 = doc2.exists ? doc2.data().list || [] : [];

    if (!list1.includes(friendUid)) list1.push(friendUid);
    if (!list2.includes(currentUid)) list2.push(currentUid);

    batch.set(currentUserRef, { list: list1 }, { merge: true });
    batch.set(friendUserRef, { list: list2 }, { merge: true });
    batch.delete(db.collection('friendRequests').doc(reqId));

    return batch.commit();
  }).then(() => {
    alert('Friend request accepted!');
    renderFriends();
  }).catch(e => alert('Error accepting request: ' + e.message));
}

function declineRequest(reqId) {
  db.collection('friendRequests').doc(reqId).delete()
    .then(() => {
      alert('Friend request declined');
      renderFriends();
    }).catch(e => alert('Error declining request: ' + e.message));
}

function removeFriend(friendUid) {
  const currentUid = getCurrentUid();
  const batch = db.batch();

  const currentUserRef = db.collection('friends').doc(currentUid);
  const friendUserRef = db.collection('friends').doc(friendUid);

  Promise.all([currentUserRef.get(), friendUserRef.get()]).then(([doc1, doc2]) => {
    let list1 = doc1.exists ? doc1.data().list || [] : [];
    let list2 = doc2.exists ? doc2.data().list || [] : [];

    list1 = list1.filter(uid => uid !== friendUid);
    list2 = list2.filter(uid => uid !== currentUid);

    batch.set(currentUserRef, { list: list1 }, { merge: true });
    batch.set(friendUserRef, { list: list2 }, { merge: true });

    return batch.commit();
  }).then(() => {
    alert('Friend removed');
    renderFriends();
  }).catch(e => alert('Error removing friend: ' + e.message));
}

// ----- CHAT -----
let unsubscribeChat = null;
let currentChatFriendUid = null;
let editingMessageId = null;
let replyingMessage = null;

function renderChat() {
  const currentUid = getCurrentUid();
  document.getElementById('app').innerHTML = `
    <div class="container chat-container">
      <div id="friendsList">
        <h3>Your Friends</h3>
        <div id="chatFriendsContainer">Loading friends...</div>
      </div>
      <div id="chatWindow">
        <div id="chatMessages" style="flex-grow:1; overflow-y:auto; padding:16px; background:#e9f0ff;">Select a friend to start chatting.</div>
        <div id="chatInputContainer" style="display:flex; flex-direction:column;">
          <div id="replyPreview" style="display:none;">
            Replying to: <span id="replyText"></span>
            <button onclick="cancelReply()" title="Cancel reply">×</button>
          </div>
          <textarea id="chatInput" placeholder="Select a friend to chat" disabled></textarea>
          <button id="sendChatBtn" onclick="sendMessage()" disabled>Send</button>
        </div>
      </div>
    </div>`;

  loadChatFriends(currentUid);
  setupChatInputListener();
}

function loadChatFriends(currentUid) {
  db.collection('friends').doc(currentUid).get().then(doc => {
    const container = document.getElementById('chatFriendsContainer');
    if (!doc.exists || !doc.data().list || doc.data().list.length === 0) {
      container.innerHTML = '<p style="padding:12px; color:#999;">No friends to chat with.</p>';
      return;
    }
    const friendUids = doc.data().list;
    let html = '';
    const promises = friendUids.map(uid => db.collection('users').doc(uid).get().then(userDoc => {
      const u = userDoc.data();
      html += `<div onclick="selectChatFriend('${uid}', '${escapeHtml(u.name)}')" style="cursor:pointer; padding: 10px 15px; border-bottom: 1px solid #eee;">
        <span class="material-icons" style="vertical-align:middle; color:#2196f3;">account_circle</span> ${escapeHtml(u.name)}
      </div>`;
    }));
    Promise.all(promises).then(() => {
      container.innerHTML = html;
    });
  });
}

function setupChatInputListener() {
  const chatInput = document.getElementById('chatInput');
  chatInput.addEventListener('keydown', e => {
    if (e.ctrlKey && e.key === 'Enter') {
      e.preventDefault();
      document.getElementById('sendChatBtn').click();
    }
  });

  chatInput.oninput = () => {
    const sendBtn = document.getElementById('sendChatBtn');
    sendBtn.disabled = chatInput.value.trim() === '' || !currentChatFriendUid;
  };
}

function getChatId(uid1, uid2) {
  return uid1 < uid2 ? uid1 + '_' + uid2 : uid2 + '_' + uid1;
}

function selectChatFriend(friendUid, friendName) {
  if (unsubscribeChat) unsubscribeChat();
  currentChatFriendUid = friendUid;
  editingMessageId = null;
  replyingMessage = null;

  const chatInput = document.getElementById('chatInput');
  const sendBtn = document.getElementById('sendChatBtn');
  chatInput.disabled = false;
  chatInput.value = '';
  chatInput.placeholder = `Message to ${friendName}`;
  sendBtn.textContent = 'Send';
  sendBtn.disabled = true;
  document.getElementById('replyPreview').style.display = 'none';

  // Load chat messages
  const chatId = getChatId(getCurrentUid(), friendUid);
  const chatMessagesDiv = document.getElementById('chatMessages');
  chatMessagesDiv.innerHTML = 'Loading messages...';

  unsubscribeChat = db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp')
    .onSnapshot(snapshot => {
      chatMessagesDiv.innerHTML = '';
      if (snapshot.empty) {
        chatMessagesDiv.innerHTML = '<p style="color:#999;">No messages yet.</p>';
        return;
      }
      snapshot.forEach(doc => {
        const msg = doc.data();
        chatMessagesDiv.appendChild(createMessageElement(doc.id, msg));
      });
      chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
    });
}

function createMessageElement(msgId, msg) {
  const uid = getCurrentUid();
  const messageDiv = document.createElement('div');
  messageDiv.className = 'message ' + (msg.uid === uid ? 'you' : 'friend');
  messageDiv.dataset.msgId = msgId;

  // Timestamp
  const time = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleString() : '...';

  // Reply snippet if any
  let replyHTML = '';
  if (msg.replyTo) {
    replyHTML = `<div class="reply-to" title="Click to jump to replied message" onclick="scrollToMessage('${msg.replyTo}')">↪ ${escapeHtml(msg.replyText || '(deleted)')}</div>`;
  }

  // Message text or edit input
  if (editingMessageId === msgId) {
    // In edit mode, show textarea & save/cancel buttons
    messageDiv.innerHTML = `
      ${replyHTML}
      <textarea id="editMsgInput" style="width:100%;height:60px;resize:none;border-radius:8px; border:1.5px solid #2196f3;">${escapeHtml(msg.text)}</textarea>
      <div class="actions">
        <button onclick="saveEditedMessage('${msgId}')">Save</button>
        <button onclick="cancelEdit()">Cancel</button>
      </div>`;
  } else {
    // Normal view mode
    messageDiv.innerHTML = `
      ${replyHTML}
      <div>${escapeHtml(msg.text)}</div>
      <small>${time}</small>`;
    if (msg.uid === uid) {
      // Show edit and reply buttons for own messages
      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'actions';
      actionsDiv.innerHTML = `
        <button onclick="startEditMessage('${msgId}')">Edit</button>
        <button onclick="startReplyMessage('${msgId}', '${escapeHtml(msg.text)}')">Reply</button>`;
      messageDiv.appendChild(actionsDiv);
    } else {
      // Only reply for friend's message
      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'actions';
      actionsDiv.innerHTML = `<button onclick="startReplyMessage('${msgId}', '${escapeHtml(msg.text)}')">Reply</button>`;
      messageDiv.appendChild(actionsDiv);
    }
  }
  return messageDiv;
}

function scrollToMessage(msgId) {
  const el = document.querySelector(`[data-msg-id="${msgId}"]`);
  if (el) {
    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    el.style.backgroundColor = '#ffffcc';
    setTimeout(() => el.style.backgroundColor = '', 1500);
  }
}

function sendMessage() {
  const textArea = document.getElementById('chatInput');
  const text = textArea.value.trim();
  if (!text || !currentChatFriendUid) return;

  const chatId = getChatId(getCurrentUid(), currentChatFriendUid);
  const messagesRef = db.collection('chats').doc(chatId).collection('messages');

  if (editingMessageId) {
    // Save edited message
    messagesRef.doc(editingMessageId).update({ text }).then(() => {
      editingMessageId = null;
      textArea.value = '';
      textArea.placeholder = `Message to ${currentChatFriendUid}`;
      document.getElementById('sendChatBtn').textContent = 'Send';
      document.getElementById('replyPreview').style.display = 'none';
      replyingMessage = null;
    });
  } else {
    // Normal send
    const msgData = {
      uid: getCurrentUid(),
      text,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };
    if (replyingMessage) {
      msgData.replyTo = replyingMessage.id;
      msgData.replyText = replyingMessage.text;
    }
    messagesRef.add(msgData).then(() => {
      textArea.value = '';
      cancelReply();
    });
  }
}

function startEditMessage(msgId) {
  editingMessageId = msgId;
  renderChat(); // re-render chat to show edit input
  setTimeout(() => {
    document.getElementById('editMsgInput').focus();
  }, 100);
}

function saveEditedMessage(msgId) {
  const newText = document.getElementById('editMsgInput').value.trim();
  if (!newText) {
    alert('Message cannot be empty');
    return;
  }
  const chatId = getChatId(getCurrentUid(), currentChatFriendUid);
  db.collection('chats').doc(chatId).collection('messages').doc(msgId).update({ text: newText })
    .then(() => {
      editingMessageId = null;
      renderChat();
    });
}

function cancelEdit() {
  editingMessageId = null;
  renderChat();
}

function startReplyMessage(msgId, msgText) {
  replyingMessage = { id: msgId, text: msgText };
  const replyPreview = document.getElementById('replyPreview');
  document.getElementById('replyText').textContent = msgText.length > 50 ? msgText.substr(0, 47) + '...' : msgText;
  replyPreview.style.display = 'flex';
  const chatInput = document.getElementById('chatInput');
  chatInput.focus();
}

function cancelReply() {
  replyingMessage = null;
  const replyPreview = document.getElementById('replyPreview');
  replyPreview.style.display = 'none';
}

// ----- NAVIGATION -----
function showPage(page) {
  switch(page) {
    case 'feed': renderFeed(); break;
    case 'profile': renderProfile(); break;
    case 'friends': renderFriends(); break;
    case 'chat': renderChat(); break;
    case 'settings': renderSettings(); break;
  }
  setActiveNav(page);
}

function setActiveNav(page) {
  const buttons = document.querySelectorAll('nav button');
  buttons.forEach(btn => btn.classList.remove('active'));
  const iconMap = { feed: 'home', friends: 'group', chat: 'chat', profile: 'person', settings: 'settings' };
  buttons.forEach(btn => {
    if (btn.title.toLowerCase() === page) btn.classList.add('active');
  });
}

// ----- SETTINGS -----
function renderSettings() {
  document.getElementById('app').innerHTML = `
    <div class="container card">
      <h3>Settings</h3>
      <button onclick="logout()">Logout</button>
    </div>
  `;
}

function logout() {
  auth.signOut();
}

// ----- AUTH LISTENER -----
auth.onAuthStateChanged(user => {
  if (user) {
    document.getElementById('navBar').style.display = 'flex';
    showPage('feed');
  } else {
    document.getElementById('navBar').style.display = 'none';
    renderLogin();
  }
});
</script>

</body>
</html>
