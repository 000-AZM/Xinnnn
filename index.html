<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Xinn Social</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<style>
  body { font-family: Arial, sans-serif; margin:0; background:#f0f2f5; }
  header { background:#2196F3; color:white; padding:10px; text-align:center; }
  .container { padding:20px; }
  .card { background:white; padding:15px; margin:10px 0; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
  input, textarea, button, select {
    width:100%; padding:10px; margin:5px 0; border:1px solid #ccc; border-radius:5px;
    font-family: inherit;
    font-size: 14px;
  }
  button { background:#2196F3; color:white; border:none; cursor:pointer; }
  button:disabled {
    background: #999;
    cursor: not-allowed;
  }
  nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 56px;
    background: white;
    display: flex;
    justify-content: space-around;
    border-top: 1px solid #ccc;
    padding: 0 10px;
    z-index: 100;
  }
  nav button {
    background:none;
    color:#555;
    border:none;
    cursor:pointer;
    font-size: 28px;
    line-height: 56px;
  }
  nav button.active {
    color:#2196F3;
    font-weight:bold;
  }
  #app {
    padding-bottom: 70px;
  }
  /* Chat styles */
  #chatWindow {
    display: flex; flex-direction: column; height: 80vh; border: 1px solid #ccc; border-radius: 8px; background: white;
  }
  #chatMessages {
    flex-grow: 1; overflow-y: auto; padding: 10px; font-size: 14px; background: #fafafa;
  }
  .message {
    max-width: 70%;
    margin-bottom: 10px;
    padding: 8px 12px;
    border-radius: 15px;
    position: relative;
    word-wrap: break-word;
    white-space: pre-wrap;
  }
  .message.you {
    background-color: #2196F3;
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 2px;
  }
  .message.friend {
    background-color: #eee;
    color: #333;
    margin-right: auto;
    border-bottom-left-radius: 2px;
  }
  .message small {
    font-size: 10px;
    color: rgba(0,0,0,0.5);
    display: block;
    margin-bottom: 5px;
  }
  .message .reply-to {
    border-left: 3px solid #999;
    padding-left: 6px;
    font-style: italic;
    font-size: 12px;
    margin-bottom: 6px;
    color: #555;
    cursor: pointer;
    background: #ddd;
    border-radius: 6px;
    max-width: 100%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .message .actions {
    position: absolute;
    bottom: 4px;
    right: 8px;
    display: flex;
    gap: 10px;
    opacity: 0.6;
  }
  .message:hover .actions {
    opacity: 1;
  }
  .message .actions button {
    background: none;
    border: none;
    cursor: pointer;
    color: inherit;
    font-size: 16px;
    padding: 0;
  }
  #chatInputContainer {
    padding: 10px;
    background: white;
    border-top: 1px solid #ccc;
    display: flex;
    flex-direction: column;
    gap: 5px;
  }
  #replyPreview {
    background: #eee;
    padding: 8px 12px;
    border-radius: 8px;
    font-style: italic;
    color: #555;
    position: relative;
  }
  #replyPreview button {
    position: absolute;
    right: 10px;
    top: 8px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 20px;
    line-height: 1;
    color: #999;
  }
  #chatInput {
    resize: none;
    width: 100%;
    height: 60px;
    font-size: 14px;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }
  #sendChatBtn {
    background: #2196F3;
    color: white;
    border: none;
    padding: 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
  }
  #sendChatBtn:disabled {
    background: #999;
    cursor: not-allowed;
  }
  #friendsList {
    width: 30%;
    border-right: 1px solid #ccc;
    overflow-y: auto;
    background: white;
  }
  #friendsList h3 {
    margin: 10px;
  }
  #chatFriendsContainer > div {
    padding: 10px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
  }
  #chatFriendsContainer > div:hover {
    background: #f0f0f0;
  }
</style>
</head>
<body>

<header><h2>Xinn Social</h2></header>

<div id="app"></div>

<nav id="navBar" style="display:none;">
  <button onclick="showPage('feed')" title="Feed"><span class="material-icons">home</span></button>
  <button onclick="showPage('friends')" title="Friends"><span class="material-icons">group</span></button>
  <button onclick="showPage('chat')" title="Chat"><span class="material-icons">chat</span></button>
  <button onclick="showPage('profile')" title="Profile"><span class="material-icons">person</span></button>
  <button onclick="showPage('settings')" title="Settings"><span class="material-icons">settings</span></button>
</nav>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCGN7t5FjDeJ-ewm7S_9z0VJrRSggTaJ2Q",
  authDomain: "coin-base-by-hector.firebaseapp.com",
  databaseURL: "https://coin-base-by-hector-default-rtdb.firebaseio.com",
  projectId: "coin-base-by-hector",
  storageBucket: "coin-base-by-hector.firebasestorage.app",
  messagingSenderId: "398789890422",
  appId: "1:398789890422:web:ed6a928037b24be2e36a57",
  measurementId: "G-SGJJM5K3G9"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

function getCurrentUid() {
  return auth.currentUser ? auth.currentUser.uid : null;
}

function escapeHtml(text) {
  if (!text) return '';
  return text.replace(/[&<>"']/g, function(m) {
    return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
  });
}

// ----- LOGIN & REGISTER -----
function renderLogin() {
  document.getElementById('app').innerHTML = `
    <div class="container card">
      <h3>Login to Xinn Social</h3>
      <input type="email" id="email" placeholder="Email (@xinn.lab only)">
      <input type="password" id="password" placeholder="Password">
      <button onclick="login()">Login</button>
      <p>Or <a href="#" onclick="renderRegister()">Register</a></p>
    </div>`;
}

function renderRegister() {
  document.getElementById('app').innerHTML = `
    <div class="container card">
      <h3>Create Account</h3>
      <input type="text" id="name" placeholder="Full Name">
      <input type="number" id="age" placeholder="Age">
      <textarea id="bio" placeholder="Bio"></textarea>
      <input type="email" id="email" placeholder="Email (@xinn.lab only)">
      <input type="password" id="password" placeholder="Password">
      <button onclick="register()">Register</button>
      <p>Already have an account? <a href="#" onclick="renderLogin()">Login</a></p>
    </div>`;
}

function login() {
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value.trim();
  if (!email.endsWith('@xinn.lab')) {
    alert('Email must end with @xinn.lab');
    return;
  }
  auth.signInWithEmailAndPassword(email, pass).catch(e => alert(e.message));
}

function register() {
  const name = document.getElementById('name').value.trim();
  const age = document.getElementById('age').value.trim();
  const bio = document.getElementById('bio').value.trim();
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value.trim();
  if (!email.endsWith('@xinn.lab')) {
    alert('Email must end with @xinn.lab');
    return;
  }
  auth.createUserWithEmailAndPassword(email, pass)
    .then(cred => {
      return db.collection('users').doc(cred.user.uid).set({ name, age, bio, email, friends: [], friendRequestsSent: [], friendRequestsReceived: [] });
    })
    .catch(e => alert(e.message));
}

// ----- FEED -----
function renderFeed() {
  document.getElementById('app').innerHTML = `
    <div class="container">
      <div class="card">
        <textarea id="postContent" placeholder="What's on your mind?" style="resize:none;"></textarea>
        <button onclick="createPost()">Post</button>
      </div>
      <div id="feedPosts"></div>
    </div>`;
  loadPosts();
}

function createPost() {
  const content = document.getElementById('postContent').value.trim();
  if (!content) return;
  db.collection('posts').add({
    content,
    uid: auth.currentUser.uid,
    likes: [],
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    document.getElementById('postContent').value = '';
  }).catch(e => alert(e.message));
}

function loadPosts() {
  db.collection('posts').orderBy('timestamp', 'desc').onSnapshot(snap => {
    let html = '';
    let postPromises = [];

    snap.forEach(doc => {
      const p = doc.data();
      postPromises.push(
        db.collection('users').doc(p.uid).get().then(userDoc => {
          const user = userDoc.data() || { name: "Unknown" };
          const time = p.timestamp ? p.timestamp.toDate().toLocaleString() : "Just now";

          html += `
            <div class="card" style="padding: 12px;">
              <div style="display:flex;align-items:center;margin-bottom:8px;">
                <span class="material-icons" style="font-size:36px;color:#2196F3;margin-right:10px;">account_circle</span>
                <div>
                  <strong>${escapeHtml(user.name)}</strong><br>
                  <small style="color:gray;">${time}</small>
                </div>
              </div>
              <div style="margin:10px 0;font-size:15px;">${escapeHtml(p.content)}</div>
              <hr style="margin:8px 0;">
              <button onclick="toggleLike('${doc.id}')" style="background:none;color:#2196F3;border:none;cursor:pointer;">
                üëç Like (${p.likes.length})
              </button>
            </div>`;
        })
      );
    });

    Promise.all(postPromises).then(() => {
      document.getElementById('feedPosts').innerHTML = html;
    });
  });
}

function toggleLike(postId) {
  const ref = db.collection('posts').doc(postId);
  ref.get().then(doc => {
    const data = doc.data();
    let likes = data.likes || [];
    if (likes.includes(auth.currentUser.uid)) {
      likes = likes.filter(id => id !== auth.currentUser.uid);
    } else {
      likes.push(auth.currentUser.uid);
    }
    ref.update({ likes });
  });
}

// ----- PROFILE -----
function renderProfile() {
  db.collection('users').doc(auth.currentUser.uid).get().then(doc => {
    const u = doc.data();
    document.getElementById('app').innerHTML = `
      <div class="container">
        <div class="card">
          <h3>${escapeHtml(u.name)}</h3>
          <p>Age: ${escapeHtml(u.age)}</p>
          <p>Bio: ${escapeHtml(u.bio)}</p>
          <button onclick="editProfile()">Edit Profile</button>
        </div>
      </div>`;
  });
}

function editProfile() {
  db.collection('users').doc(auth.currentUser.uid).get().then(doc => {
    const u = doc.data();
    document.getElementById('app').innerHTML = `
      <div class="container card">
        <input id="name" value="${escapeHtml(u.name)}" placeholder="Full Name">
        <input id="age" value="${escapeHtml(u.age)}" placeholder="Age">
        <textarea id="bio" placeholder="Bio">${escapeHtml(u.bio)}</textarea>
        <button onclick="saveProfile()">Save</button>
      </div>`;
  });
}

function saveProfile() {
  const name = document.getElementById('name').value.trim();
  const age = document.getElementById('age').value.trim();
  const bio = document.getElementById('bio').value.trim();
  db.collection('users').doc(auth.currentUser.uid).update({ name, age, bio }).then(() => {
    renderProfile();
  });
}

// ----- FRIENDS -----
async function renderFriends() {
  const uid = getCurrentUid();
  if (!uid) return;

  const userDoc = await db.collection('users').doc(uid).get();
  const userData = userDoc.data() || {};

  let html = '<div class="container">';

  // Friend Requests Received
  const requestsReceived = userData.friendRequestsReceived || [];
  html += `<div class="card"><h3>Friend Requests Received</h3>`;
  if (requestsReceived.length === 0) {
    html += `<p>No friend requests received.</p>`;
  } else {
    for (const requesterUid of requestsReceived) {
      const userDoc = await db.collection('users').doc(requesterUid).get();
      const requester = userDoc.data() || { name: 'Unknown' };
      html += `
        <div style="padding:8px; border-bottom:1px solid #eee;">
          <strong>${escapeHtml(requester.name)}</strong> (${escapeHtml(requester.email)})
          <br/>
          <button onclick="acceptFriend('${requesterUid}')">Accept</button>
          <button onclick="declineFriend('${requesterUid}')">Decline</button>
        </div>
      `;
    }
  }
  html += `</div>`;

  // Friend Requests Sent
  const requestsSent = userData.friendRequestsSent || [];
  html += `<div class="card"><h3>Friend Requests Sent</h3>`;
  if (requestsSent.length === 0) {
    html += `<p>No friend requests sent.</p>`;
  } else {
    for (const sentUid of requestsSent) {
      const userDoc = await db.collection('users').doc(sentUid).get();
      const sentUser = userDoc.data() || { name: 'Unknown' };
      html += `
        <div style="padding:8px; border-bottom:1px solid #eee;">
          <strong>${escapeHtml(sentUser.name)}</strong> (${escapeHtml(sentUser.email)})
          <br/>
          <button onclick="cancelFriendRequest('${sentUid}')">Cancel Request</button>
        </div>
      `;
    }
  }
  html += `</div>`;

  // Friends List
  const friends = userData.friends || [];
  html += `<div class="card"><h3>Your Friends</h3>`;
  if (friends.length === 0) {
    html += `<p>You have no friends added yet.</p>`;
  } else {
    for (const friendUid of friends) {
      const userDoc = await db.collection('users').doc(friendUid).get();
      const friend = userDoc.data() || { name: 'Unknown' };
      html += `
        <div style="padding:8px; border-bottom:1px solid #eee;">
          <strong>${escapeHtml(friend.name)}</strong> (${escapeHtml(friend.email)})<br>
          <button onclick="removeFriend('${friendUid}')">Remove Friend</button>
          <button onclick="startChat('${friendUid}', '${escapeHtml(friend.name)}')">Chat</button>
        </div>
      `;
    }
  }
  html += `</div>`;

  // Search to send friend requests
  html += `<div class="card">
    <h3>Send Friend Request</h3>
    <input type="email" id="searchEmail" placeholder="Friend's email (@xinn.lab only)" />
    <button onclick="sendFriendRequest()">Send Request</button>
  </div>`;

  html += '</div>';

  document.getElementById('app').innerHTML = html;
}

async function sendFriendRequest() {
  const email = document.getElementById('searchEmail').value.trim();
  if (!email.endsWith('@xinn.lab')) {
    alert('Email must end with @xinn.lab');
    return;
  }
  const uid = getCurrentUid();
  if (!uid) return;

  try {
    // Find user by email
    const querySnapshot = await db.collection('users').where('email', '==', email).get();
    if (querySnapshot.empty) {
      alert('User not found.');
      return;
    }
    const targetDoc = querySnapshot.docs[0];
    const targetUid = targetDoc.id;
    if (targetUid === uid) {
      alert("You can't add yourself.");
      return;
    }

    const userRef = db.collection('users').doc(uid);
    const targetRef = db.collection('users').doc(targetUid);

    // Check if already friends or request pending
    const userDoc = await userRef.get();
    const userData = userDoc.data();

    if (userData.friends && userData.friends.includes(targetUid)) {
      alert('This user is already your friend.');
      return;
    }
    if (userData.friendRequestsSent && userData.friendRequestsSent.includes(targetUid)) {
      alert('Friend request already sent.');
      return;
    }

    // Update friendRequestsReceived and friendRequestsSent arrays
    await targetRef.update({
      friendRequestsReceived: firebase.firestore.FieldValue.arrayUnion(uid)
    });
    await userRef.update({
      friendRequestsSent: firebase.firestore.FieldValue.arrayUnion(targetUid)
    });

    alert('Friend request sent!');
    renderFriends();
  } catch (err) {
    alert('Error sending friend request: ' + err.message);
  }
}

async function acceptFriend(requesterUid) {
  const uid = getCurrentUid();
  if (!uid) return;

  const userRef = db.collection('users').doc(uid);
  const requesterRef = db.collection('users').doc(requesterUid);

  try {
    await userRef.update({
      friendRequestsReceived: firebase.firestore.FieldValue.arrayRemove(requesterUid),
      friends: firebase.firestore.FieldValue.arrayUnion(requesterUid)
    });
    await requesterRef.update({
      friendRequestsSent: firebase.firestore.FieldValue.arrayRemove(uid),
      friends: firebase.firestore.FieldValue.arrayUnion(uid)
    });
    alert('Friend request accepted!');
    renderFriends();
  } catch (err) {
    alert('Error accepting friend request: ' + err.message);
  }
}

async function declineFriend(requesterUid) {
  const uid = getCurrentUid();
  if (!uid) return;

  const userRef = db.collection('users').doc(uid);
  const requesterRef = db.collection('users').doc(requesterUid);

  try {
    await userRef.update({
      friendRequestsReceived: firebase.firestore.FieldValue.arrayRemove(requesterUid)
    });
    await requesterRef.update({
      friendRequestsSent: firebase.firestore.FieldValue.arrayRemove(uid)
    });
    alert('Friend request declined.');
    renderFriends();
  } catch (err) {
    alert('Error declining friend request: ' + err.message);
  }
}

async function cancelFriendRequest(targetUid) {
  const uid = getCurrentUid();
  if (!uid) return;

  const userRef = db.collection('users').doc(uid);
  const targetRef = db.collection('users').doc(targetUid);

  try {
    await userRef.update({
      friendRequestsSent: firebase.firestore.FieldValue.arrayRemove(targetUid)
    });
    await targetRef.update({
      friendRequestsReceived: firebase.firestore.FieldValue.arrayRemove(uid)
    });
    alert('Friend request canceled.');
    renderFriends();
  } catch (err) {
    alert('Error canceling friend request: ' + err.message);
  }
}

async function removeFriend(friendUid) {
  const uid = getCurrentUid();
  if (!uid) return;

  const userRef = db.collection('users').doc(uid);
  const friendRef = db.collection('users').doc(friendUid);

  if (!confirm("Are you sure you want to remove this friend?")) return;

  try {
    await userRef.update({
      friends: firebase.firestore.FieldValue.arrayRemove(friendUid)
    });
    await friendRef.update({
      friends: firebase.firestore.FieldValue.arrayRemove(uid)
    });
    alert('Friend removed.');
    renderFriends();
  } catch (err) {
    alert('Error removing friend: ' + err.message);
  }
}

// ----- CHAT -----
let currentChatFriendUid = null;
let unsubscribeChat = null;
let editingMessageId = null; // to store editing message id
let replyingMessage = null; // to store replying message data

function getChatId(uid1, uid2) {
  return [uid1, uid2].sort().join('_');
}

async function renderChat() {
  const uid = getCurrentUid();
  if (!uid) return;

  const app = document.getElementById('app');
  app.innerHTML = `
    <div class="container" style="display:flex;flex-direction:row; height:80vh;">
      <div id="friendsList" style="width:30%; border-right:1px solid #ccc; overflow-y:auto; background:white;">
        <h3>Your Friends</h3>
        <div id="chatFriendsContainer" style="padding:10px;">Loading friends...</div>
      </div>
      <div id="chatWindow" style="width:70%; display:flex; flex-direction:column; justify-content:space-between;">
        <div id="chatMessages" style="flex-grow:1; overflow-y:auto; padding:10px; border-bottom:1px solid #ccc; background:#fafafa;">Select a friend to start chatting</div>
        <div id="chatInputContainer" style="padding:10px;">
          <div id="replyPreview" style="display:none;">
            Replying to: <span id="replyText"></span>
            <button title="Cancel reply" onclick="cancelReply()">√ó</button>
          </div>
          <textarea id="chatInput" placeholder="Select a friend to start chatting" disabled></textarea>
          <button id="sendChatBtn" disabled>Send</button>
        </div>
      </div>
    </div>
  `;

  try {
    const userDoc = await db.collection('users').doc(uid).get();
    const userData = userDoc.data() || {};
    const friends = userData.friends || [];

    if (friends.length === 0) {
      document.getElementById('chatFriendsContainer').innerHTML = '<p>You have no friends to chat with.</p>';
      return;
    }

    const friendsInfoPromises = friends.map(fid => db.collection('users').doc(fid).get());
    const friendsDocs = await Promise.all(friendsInfoPromises);

    const friendsHTML = friendsDocs.map(doc => {
      const u = doc.data();
      return `
        <div style="padding:8px; border-bottom:1px solid #eee; cursor:pointer;" onclick="selectChatFriend('${doc.id}', '${escapeHtml(u.name)}')">
          <strong>${escapeHtml(u.name)}</strong><br><small>${escapeHtml(u.email)}</small>
        </div>
      `;
    }).join('');

    document.getElementById('chatFriendsContainer').innerHTML = friendsHTML;

  } catch (err) {
    document.getElementById('chatFriendsContainer').innerHTML = `<p>Error loading friends: ${escapeHtml(err.message)}</p>`;
  }

  // Disable chat input initially
  document.getElementById('chatInput').disabled = true;
  document.getElementById('sendChatBtn').disabled = true;

  // Add send button event
  document.getElementById('sendChatBtn').onclick = () => {
    if (editingMessageId) {
      submitEditMessage();
    } else {
      sendMessage();
    }
  };

  // Also send message on Ctrl+Enter
  document.getElementById('chatInput').addEventListener('keydown', e => {
    if (e.ctrlKey && e.key === 'Enter') {
      e.preventDefault();
      document.getElementById('sendChatBtn').click();
    }
  });
}

async function selectChatFriend(friendUid, friendName) {
  if (unsubscribeChat) unsubscribeChat();
  currentChatFriendUid = friendUid;
  editingMessageId = null;
  replyingMessage = null;

  const chatInput = document.getElementById('chatInput');
  const sendBtn = document.getElementById('sendChatBtn');
  chatInput.disabled = false;
  chatInput.value = '';
  chatInput.placeholder = `Message to ${friendName}`;
  sendBtn.textContent = 'Send';
  sendBtn.disabled = true;
  document.getElementById('replyPreview').style.display = 'none';

  // Load chat messages
  const chatId = getChatId(getCurrentUid(), friendUid);
  const chatMessagesDiv = document.getElementById('chatMessages');
  chatMessagesDiv.innerHTML = 'Loading messages...';

  unsubscribeChat = db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp')
    .onSnapshot(snapshot => {
      chatMessagesDiv.innerHTML = '';
      if (snapshot.empty) {
        chatMessagesDiv.innerHTML = '<p style="color:#999;">No messages yet.</p>';
        return;
      }
      snapshot.forEach(doc => {
        const msg = doc.data();
        chatMessagesDiv.appendChild(createMessageElement(doc.id, msg));
      });
      chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
    });

  // Enable send button only if input not empty
  chatInput.oninput = () => {
    sendBtn.disabled = chatInput.value.trim() === '';
  };
}

// Create a message element with edit and reply actions
function createMessageElement(msgId, msg) {
  const uid = getCurrentUid();
  const messageDiv = document.createElement('div');
  messageDiv.className = 'message ' + (msg.uid === uid ? 'you' : 'friend');
  messageDiv.dataset.msgId = msgId;

  // Timestamp
  const time = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleString() : '...';

  // Reply snippet if any
  let replyHTML = '';
  if (msg.replyTo) {
    replyHTML = `<div class="reply-to" title="Click to jump to replied message" onclick="scrollToMessage('${msg.replyTo}')">` +
      `‚Ü™ ${escapeHtml(msg.replyText || '(deleted)')}` +
      `</div>`;
  }

  // Message text or edit input
  if (editingMessageId === msgId) {
    // In edit mode, show textarea & save/cancel buttons
    messageDiv.innerHTML = `
      ${replyHTML}
      <textarea id="editMsgInput" style="width:100%; height:60px; font-family: inherit; font-size:14px;">${escapeHtml(msg.text)}</textarea>
      <div style="margin-top:4px; text-align:right;">
        <button onclick="cancelEdit()">Cancel</button>
        <button onclick="submitEditMessage()">Save</button>
      </div>
    `;
  } else {
    // Normal message display
    messageDiv.innerHTML = `
      <small>${time}</small>
      ${replyHTML}
      <div>${escapeHtml(msg.text)}</div>
      <div class="actions">
        <button title="Reply" onclick="startReply('${msgId}', '${escapeHtml(msg.text)}', event)">‚Ü™</button>
        ${msg.uid === uid ? `<button title="Edit" onclick="startEdit('${msgId}')">‚úèÔ∏è</button>` : ''}
      </div>
    `;
  }
  return messageDiv;
}

// Scroll to message by id when clicking reply snippet
function scrollToMessage(msgId) {
  const el = document.querySelector(`[data-msg-id="${msgId}"]`);
  if (el) {
    el.scrollIntoView({behavior: 'smooth', block: 'center'});
    el.style.backgroundColor = '#ffffcc';
    setTimeout(() => el.style.backgroundColor = '', 2000);
  }
}

// Reply feature
function startReply(msgId, msgText, event) {
  event.stopPropagation();
  replyingMessage = { msgId, text: msgText };
  const replyPreview = document.getElementById('replyPreview');
  document.getElementById('replyText').textContent = msgText;
  replyPreview.style.display = 'block';
  document.getElementById('chatInput').focus();
}

function cancelReply() {
  replyingMessage = null;
  document.getElementById('replyPreview').style.display = 'none';
}

// Edit feature
function startEdit(msgId) {
  editingMessageId = msgId;
  // re-render chat messages to show editing textarea
  if (!currentChatFriendUid) return;
  selectChatFriend(currentChatFriendUid, ''); // friend name not needed here
}

function cancelEdit() {
  editingMessageId = null;
  if (!currentChatFriendUid) return;
  selectChatFriend(currentChatFriendUid, '');
}

function submitEditMessage() {
  const editInput = document.getElementById('editMsgInput');
  if (!editInput) return;
  const newText = editInput.value.trim();
  if (!newText) {
    alert('Message cannot be empty.');
    return;
  }
  const uid = getCurrentUid();
  if (!uid) return;

  const chatId = getChatId(uid, currentChatFriendUid);
  const msgRef = db.collection('chats').doc(chatId).collection('messages').doc(editingMessageId);

  msgRef.get().then(doc => {
    if (!doc.exists) return alert('Message not found');
    const msg = doc.data();
    if (msg.uid !== uid) return alert('You can only edit your own messages');

    return msgRef.update({ text: newText });
  }).then(() => {
    editingMessageId = null;
    cancelReply(); // cancel reply if any
    selectChatFriend(currentChatFriendUid, '');
  }).catch(err => alert('Error updating message: ' + err.message));
}

function sendMessage() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;

  const uid = getCurrentUid();
  if (!uid || !currentChatFriendUid) return;

  const chatId = getChatId(uid, currentChatFriendUid);
  const messagesRef = db.collection('chats').doc(chatId).collection('messages');

  const messageData = {
    uid,
    text,
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
  };

  if (replyingMessage) {
    messageData.replyTo = replyingMessage.msgId;
    messageData.replyText = replyingMessage.text;
  }

  messagesRef.add(messageData).then(() => {
    input.value = '';
    document.getElementById('sendChatBtn').disabled = true;
    cancelReply();
  }).catch(err => alert('Error sending message: ' + err.message));
}

function showPage(page) {
  clearActiveNav();
  const buttons = document.querySelectorAll('nav button');
  buttons.forEach(btn => {
    if (btn.getAttribute('onclick').includes(page)) {
      btn.classList.add('active');
    }
  });

  if (page === 'feed') renderFeed();
  else if (page === 'profile') renderProfile();
  else if (page === 'friends') renderFriends();
  else if (page === 'chat') renderChat();
  else if (page === 'settings') renderSettings();
}

function clearActiveNav() {
  const buttons = document.querySelectorAll('nav button');
  buttons.forEach(btn => btn.classList.remove('active'));
}

function renderSettings() {
  document.getElementById('app').innerHTML = `
    <div class="container card">
      <button onclick="auth.signOut()">Logout</button>
    </div>`;
}

// Auth state listener
auth.onAuthStateChanged(user => {
  if (user) {
    showPage('feed');
    document.getElementById('navBar').style.display = 'flex';
  } else {
    renderLogin();
    document.getElementById('navBar').style.display = 'none';
  }
});
</script>

</body>
</html>
