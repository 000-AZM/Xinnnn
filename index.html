<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Xinn Social</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<style>
  /* Reset & basic */
  body, html {
    margin: 0; padding: 0; height: 100vh; font-family: Arial, sans-serif; background: #f0f2f5;
    display: flex; flex-direction: column;
  }
  header {
    background: #2196F3; color: white; padding: 10px; text-align: center;
    font-size: 1.5rem; font-weight: bold;
  }
  #app {
    flex-grow: 1; overflow-y: auto; padding: 15px;
  }
  .card {
    background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 15px; padding: 15px;
  }
  input, textarea, button, select {
    width: 100%; padding: 10px; margin: 5px 0 15px 0;
    border: 1px solid #ccc; border-radius: 5px;
    font-size: 1rem;
    box-sizing: border-box;
  }
  textarea { resize: vertical; }
  button {
    background: #2196F3; color: white; border: none; cursor: pointer;
    font-weight: bold; transition: background 0.3s ease;
  }
  button:hover {
    background: #1769aa;
  }
  nav {
    display: flex; justify-content: space-around;
    position: fixed; bottom: 0; left: 0; right: 0;
    background: white; border-top: 1px solid #ccc; padding: 10px 0;
  }
  nav button {
    background: none; border: none; cursor: pointer;
    color: #555; font-size: 1.8rem;
    display: flex; flex-direction: column; align-items: center;
    justify-content: center;
  }
  nav button.active {
    color: #2196F3;
  }
  nav button span.material-icons {
    font-size: 28px;
  }
  .friend-item, .request-card {
    display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px solid #ddd; padding: 10px 0;
  }
  .friend-item div, .request-card div {
    display: flex; align-items: center;
  }
  .avatar-circle {
    background: #2196F3; color: white; border-radius: 50%;
    width: 40px; height: 40px; font-size: 20px;
    display: flex; align-items: center; justify-content: center;
    margin-right: 10px; user-select: none;
  }
  .chat-container {
    max-height: 350px; overflow-y: auto; border: 1px solid #ccc;
    padding: 10px; border-radius: 5px; background: #fff;
    margin-bottom: 10px;
  }
  .chat-message {
    max-width: 75%; margin-bottom: 8px; padding: 8px 12px;
    border-radius: 20px; font-size: 0.9rem; line-height: 1.3;
    word-wrap: break-word;
    clear: both;
  }
  .chat-message.self {
    background: #2196F3; color: white;
    margin-left: auto;
    border-bottom-right-radius: 0;
  }
  .chat-message.friend {
    background: #e4e6eb; color: #050505;
    margin-right: auto;
    border-bottom-left-radius: 0;
  }
  #chatInput {
    resize: none;
  }
  /* Profile edit modal */
  #editProfileModal {
    display: none;
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    justify-content: center; align-items: center;
    z-index: 1000;
  }
  #editProfileModal .modal-content {
    background: white; padding: 20px; border-radius: 8px; width: 320px;
  }
  #editProfileModal h3 {
    margin-top: 0; margin-bottom: 15px;
  }
  #editProfileModal button.close-btn {
    background: #f44336; margin-top: 10px;
  }
  #friendSearchResults > .request-card button {
    width: auto; min-width: 100px;
  }
</style>
</head>
<body>

<header>Xinn Social</header>

<div id="app"></div>

<nav id="navBar" style="display:none;">
  <button id="navFeed" onclick="showPage('feed')" title="Feed"><span class="material-icons">home</span></button>
  <button id="navFriends" onclick="showPage('friends')" title="Friends"><span class="material-icons">group</span></button>
  <button id="navChat" onclick="showPage('chat')" title="Chat"><span class="material-icons">chat</span></button>
  <button id="navProfile" onclick="showPage('profile')" title="Profile"><span class="material-icons">person</span></button>
  <button id="navSettings" onclick="showPage('settings')" title="Settings"><span class="material-icons">settings</span></button>
</nav>

<!-- Profile Edit Modal -->
<div id="editProfileModal">
  <div class="modal-content">
    <h3>Edit Profile</h3>
    <input type="text" id="editName" placeholder="Full Name" />
    <textarea id="editBio" placeholder="Bio"></textarea>
    <input type="file" id="editAvatar" accept="image/*" />
    <button onclick="saveProfile()">Save</button>
    <button class="close-btn" onclick="closeEditProfile()">Cancel</button>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
  // Firebase config - replace with your own config
  const firebaseConfig = {
    apiKey: "AIzaSyDhVRhDDCM8vFbNe9f1Ag4Xn0901igl4s0",
    authDomain: "xinn-social.firebaseapp.com",
    projectId: "xinn-social",
    storageBucket: "xinn-social.firebasestorage.app",
    messagingSenderId: "860868128981",
    appId: "1:860868128981:web:a5cb9b2cb32b10077e725c",
    measurementId: "G-2ZFNQND35B"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Global vars
  let currentUserData = null;
  let avatarBase64 = null;
  let unsubscribeChat = null;
  let currentChatFriendId = null;
  let searchTimeout = null;

  // Escape HTML to prevent XSS
  function escapeHtml(text) {
    if (!text) return "";
    return text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // Show navigation active button
  function setActiveNav(page) {
    ["navFeed","navFriends","navChat","navProfile","navSettings"].forEach(id => {
      document.getElementById(id).classList.toggle("active", id === "nav" + page.charAt(0).toUpperCase() + page.slice(1));
    });
  }

  // ---------- AUTH -------------

  function renderLogin() {
    document.getElementById("app").innerHTML = `
      <div class="card" style="max-width: 400px; margin: 50px auto;">
        <h3>Login to Xinn Social</h3>
        <input type="email" id="email" placeholder="Email (@xinn.lab only)" />
        <input type="password" id="password" placeholder="Password" />
        <button onclick="login()">Login</button>
        <p style="text-align:center;">Or <a href="#" onclick="renderRegister()">Register</a></p>
      </div>`;
    document.getElementById("navBar").style.display = "none";
  }

  function renderRegister() {
    document.getElementById("app").innerHTML = `
      <div class="card" style="max-width: 400px; margin: 50px auto;">
        <h3>Create Account</h3>
        <input type="text" id="name" placeholder="Full Name" />
        <input type="number" id="age" placeholder="Age" />
        <textarea id="bio" placeholder="Bio"></textarea>
        <input type="email" id="email" placeholder="Email (@xinn.lab only)" />
        <input type="password" id="password" placeholder="Password" />
        <button onclick="register()">Register</button>
        <p style="text-align:center;">Already have an account? <a href="#" onclick="renderLogin()">Login</a></p>
      </div>`;
    document.getElementById("navBar").style.display = "none";
  }

  function login() {
    const email = document.getElementById("email").value.trim();
    const pass = document.getElementById("password").value.trim();
    if (!email.endsWith("@xinn.lab")) {
      alert("Email must end with @xinn.lab");
      return;
    }
    auth.signInWithEmailAndPassword(email, pass).catch(e => alert(e.message));
  }

  async function register() {
    const name = document.getElementById("name").value.trim();
    const age = document.getElementById("age").value.trim();
    const bio = document.getElementById("bio").value.trim();
    const email = document.getElementById("email").value.trim();
    const pass = document.getElementById("password").value.trim();

    if (!email.endsWith("@xinn.lab")) {
      alert("Email must end with @xinn.lab");
      return;
    }
    if (!name || !age || !bio) {
      alert("Please fill all fields.");
      return;
    }
    try {
      const cred = await auth.createUserWithEmailAndPassword(email, pass);
      await db.collection("users").doc(cred.user.uid).set({
        name, age, bio, email,
        friends: [],
        friendRequests: [],
        sentRequests: [],
        avatar: null,
      });
      alert("Registered successfully! Please login.");
      renderLogin();
    } catch (e) {
      alert(e.message);
    }
  }

  // ---------- NAV & PAGES ----------

  function showPage(page) {
    setActiveNav(page);
    switch(page) {
      case "feed": renderFeed(); break;
      case "friends": renderFriends(); break;
      case "chat": renderChat(); break;
      case "profile": renderProfile(); break;
      case "settings": renderSettings(); break;
    }
  }

  // --------- FEED ------------

  function renderFeed() {
    document.getElementById("app").innerHTML = `
      <div class="card" style="max-width:600px; margin: 0 auto;">
        <textarea id="postContent" placeholder="What's on your mind?" rows="3" style="resize:none;"></textarea>
        <button onclick="createPost()">Post</button>
      </div>
      <div id="feedPosts" style="max-width:600px; margin: 20px auto;"></div>
    `;
    loadPosts();
  }

  async function createPost() {
    const content = document.getElementById("postContent").value.trim();
    if (!content) return alert("Post can't be empty.");
    try {
      await db.collection("posts").add({
        content,
        uid: auth.currentUser.uid,
        likes: [],
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      document.getElementById("postContent").value = "";
    } catch(e) {
      alert("Error creating post: " + e.message);
    }
  }

  function loadPosts() {
    db.collection("posts").orderBy("timestamp", "desc").onSnapshot(async snap => {
      let html = "";
      const postPromises = [];
      snap.forEach(doc => {
        const p = doc.data();
        postPromises.push(
          db.collection("users").doc(p.uid).get().then(userDoc => {
            const user = userDoc.data() || {name: "Unknown"};
            const time = p.timestamp ? p.timestamp.toDate().toLocaleString() : "Just now";
            html += `
              <div class="card" style="max-width:600px; margin: 10px auto;">
                <div style="display:flex; align-items:center; margin-bottom:8px;">
                  <span class="material-icons" style="font-size:36px; color:#2196F3; margin-right:10px;">account_circle</span>
                  <div>
                    <strong>${escapeHtml(user.name)}</strong><br />
                    <small style="color:gray;">${time}</small>
                  </div>
                </div>
                <div style="font-size:15px; margin: 10px 0;">${escapeHtml(p.content)}</div>
                <hr style="margin: 8px 0;">
                <button onclick="toggleLike('${doc.id}')" style="background:none; color:#2196F3; border:none; cursor:pointer;">
                  👍 Like (${p.likes.length})
                </button>
              </div>
            `;
          })
        );
      });
      await Promise.all(postPromises);
      document.getElementById("feedPosts").innerHTML = html;
    });
  }

  async function toggleLike(postId) {
    try {
      const ref = db.collection("posts").doc(postId);
      const doc = await ref.get();
      const data = doc.data();
      let likes = data.likes || [];
      const uid = auth.currentUser.uid;
      if (likes.includes(uid)) {
        likes = likes.filter(id => id !== uid);
      } else {
        likes.push(uid);
      }
      await ref.update({likes});
    } catch (e) {
      alert("Error liking post: " + e.message);
    }
  }

  // ---------- FRIENDS ----------

  async function renderFriends() {
    if (!auth.currentUser) return;

    // Main UI: tabs for Friends list and Requests & Search
    document.getElementById("app").innerHTML = `
      <div class="card" style="max-width: 600px; margin: 0 auto;">
        <h3>Friend Requests</h3>
        <div id="friendRequestsContainer"></div>
      </div>
      <div class="card" style="max-width: 600px; margin: 20px auto;">
        <h3>Search Users</h3>
        <input type="text" id="friendSearchInput" placeholder="Search by name or email" />
        <div id="friendSearchResults"></div>
      </div>
      <div class="card" style="max-width: 600px; margin: 20px auto;">
        <h3>Your Friends</h3>
        <ul id="friendList" style="list-style:none; padding: 0;"></ul>
      </div>
    `;

    document.getElementById("friendSearchInput").addEventListener("input", () => searchUsers());

    await loadFriendsAndRequests();
  }

  async function loadFriendsAndRequests() {
    const userDoc = await db.collection("users").doc(auth.currentUser.uid).get();
    if (!userDoc.exists) return;

    currentUserData = userDoc.data();

    // Display friend requests
    const friendRequestsContainer = document.getElementById("friendRequestsContainer");
    if (!currentUserData.friendRequests || currentUserData.friendRequests.length === 0) {
      friendRequestsContainer.innerHTML = "<p>No friend requests</p>";
    } else {
      let reqHtml = "";
      for (const fid of currentUserData.friendRequests) {
        const fdoc = await db.collection("users").doc(fid).get();
        if (!fdoc.exists) continue;
        const f = fdoc.data();
        reqHtml += `
          <div class="request-card">
            <div><div class="avatar-circle">${f.name ? f.name[0].toUpperCase() : "?"}</div>${escapeHtml(f.name)}</div>
            <div>
              <button onclick="acceptFriend('${fid}')">Accept</button>
              <button onclick="declineFriend('${fid}')" style="background:#f44336;">Decline</button>
            </div>
          </div>
        `;
      }
      friendRequestsContainer.innerHTML = reqHtml;
    }

    // Display friends list
    const friendListUl = document.getElementById("friendList");
    if (!currentUserData.friends || currentUserData.friends.length === 0) {
      friendListUl.innerHTML = "<p>No friends yet.</p>";
    } else {
      let friendsHTML = "";
      for (const fid of currentUserData.friends) {
        const fdoc = await db.collection("users").doc(fid).get();
        if (!fdoc.exists) continue;
        const f = fdoc.data();
        friendsHTML += `
          <li class="friend-item" onclick="visitProfile('${fid}')">
            <div class="avatar-circle">${f.name ? f.name[0].toUpperCase() : "?"}</div>
            <div>${escapeHtml(f.name)}</div>
          </li>
        `;
      }
      friendListUl.innerHTML = friendsHTML;
    }
  }

  // Accept friend request
  async function acceptFriend(friendId) {
    const uid = auth.currentUser.uid;
    const batch = db.batch();

    const userRef = db.collection("users").doc(uid);
    const friendRef = db.collection("users").doc(friendId);

    try {
      const [userDoc, friendDoc] = await Promise.all([userRef.get(), friendRef.get()]);
      if (!userDoc.exists || !friendDoc.exists) return alert("User data missing.");

      let userData = userDoc.data();
      let friendData = friendDoc.data();

      // Remove friendId from friendRequests
      userData.friendRequests = (userData.friendRequests || []).filter(id => id !== friendId);
      // Add friendId to friends if not present
      if (!userData.friends) userData.friends = [];
      if (!userData.friends.includes(friendId)) userData.friends.push(friendId);

      // Remove uid from friend's sentRequests
      friendData.sentRequests = (friendData.sentRequests || []).filter(id => id !== uid);
      // Add uid to friend's friends if not present
      if (!friendData.friends) friendData.friends = [];
      if (!friendData.friends.includes(uid)) friendData.friends.push(uid);

      batch.update(userRef, {
        friendRequests: userData.friendRequests,
        friends: userData.friends
      });
      batch.update(friendRef, {
        sentRequests: friendData.sentRequests,
        friends: friendData.friends
      });
      await batch.commit();
      alert("Friend request accepted!");
      await loadFriendsAndRequests();
    } catch(e) {
      alert("Error accepting friend request: " + e.message);
    }
  }

  // Decline friend request
  async function declineFriend(friendId) {
    const uid = auth.currentUser.uid;
    const batch = db.batch();

    const userRef = db.collection("users").doc(uid);
    const friendRef = db.collection("users").doc(friendId);

    try {
      const [userDoc, friendDoc] = await Promise.all([userRef.get(), friendRef.get()]);
      if (!userDoc.exists || !friendDoc.exists) return alert("User data missing.");

      let userData = userDoc.data();
      let friendData = friendDoc.data();

      // Remove friendId from friendRequests
      userData.friendRequests = (userData.friendRequests || []).filter(id => id !== friendId);
      // Remove uid from friend's sentRequests
      friendData.sentRequests = (friendData.sentRequests || []).filter(id => id !== uid);

      batch.update(userRef, { friendRequests: userData.friendRequests });
      batch.update(friendRef, { sentRequests: friendData.sentRequests });
      await batch.commit();
      alert("Friend request declined.");
      await loadFriendsAndRequests();
    } catch(e) {
      alert("Error declining friend request: " + e.message);
    }
  }

  // Search users to send friend request
  let lastSearchQuery = "";
  async function searchUsers() {
    const input = document.getElementById("friendSearchInput");
    const query = input.value.trim().toLowerCase();
    const resultsContainer = document.getElementById("friendSearchResults");
    resultsContainer.innerHTML = "";

    if (query.length < 2) {
      resultsContainer.innerHTML = "<p>Type at least 2 characters to search.</p>";
      return;
    }
    if (query === lastSearchQuery) return; // prevent duplicate search calls
    lastSearchQuery = query;

    try {
      // Search users by name or email containing the query
      const usersSnap = await db.collection("users").get();
      let foundUsers = [];
      usersSnap.forEach(doc => {
        const u = doc.data();
        const uId = doc.id;
        if (uId === auth.currentUser.uid) return; // skip self
        // Check if friend already or request sent or received
        const alreadyFriend = (currentUserData.friends || []).includes(uId);
        const sentReq = (currentUserData.sentRequests || []).includes(uId);
        const receivedReq = (currentUserData.friendRequests || []).includes(uId);
        if (alreadyFriend || sentReq || receivedReq) return;
        // Check if name or email matches query
        if (u.name.toLowerCase().includes(query) || u.email.toLowerCase().includes(query)) {
          foundUsers.push({ id: uId, name: u.name, email: u.email });
        }
      });

      if (foundUsers.length === 0) {
        resultsContainer.innerHTML = "<p>No users found.</p>";
        return;
      }

      let html = "";
      for (const user of foundUsers) {
        html += `
          <div class="request-card">
            <div><div class="avatar-circle">${user.name ? user.name[0].toUpperCase() : "?"}</div>${escapeHtml(user.name)}</div>
            <button onclick="sendFriendRequest('${user.id}')">Send Request</button>
          </div>
        `;
      }
      resultsContainer.innerHTML = html;

    } catch(e) {
      resultsContainer.innerHTML = `<p>Error searching users: ${escapeHtml(e.message)}</p>`;
    }
  }

  // Send friend request
  async function sendFriendRequest(friendId) {
    const uid = auth.currentUser.uid;
    if (friendId === uid) return alert("Cannot send friend request to yourself.");

    const batch = db.batch();
    const userRef = db.collection("users").doc(uid);
    const friendRef = db.collection("users").doc(friendId);

    try {
      const [userDoc, friendDoc] = await Promise.all([userRef.get(), friendRef.get()]);
      if (!userDoc.exists || !friendDoc.exists) return alert("User not found.");

      let userData = userDoc.data();
      let friendData = friendDoc.data();

      // Check duplicates
      if ((userData.sentRequests || []).includes(friendId)) {
        return alert("Friend request already sent.");
      }
      if ((userData.friends || []).includes(friendId)) {
        return alert("User is already your friend.");
      }
      // Update arrays
      userData.sentRequests = userData.sentRequests || [];
      friendData.friendRequests = friendData.friendRequests || [];

      userData.sentRequests.push(friendId);
      friendData.friendRequests.push(uid);

      batch.update(userRef, { sentRequests: userData.sentRequests });
      batch.update(friendRef, { friendRequests: friendData.friendRequests });
      await batch.commit();
      alert("Friend request sent!");
      await loadFriendsAndRequests();
      document.getElementById("friendSearchInput").value = "";
      document.getElementById("friendSearchResults").innerHTML = "";
    } catch(e) {
      alert("Error sending friend request: " + e.message);
    }
  }

  // ---------- PROFILE ----------

  async function renderProfile() {
    if (!auth.currentUser) return;
    const userDoc = await db.collection("users").doc(auth.currentUser.uid).get();
    if (!userDoc.exists) return alert("User data not found.");
    currentUserData = userDoc.data();

    let friendsHTML = "";
    if (currentUserData.friends && currentUserData.friends.length > 0) {
      for (const fid of currentUserData.friends) {
        const fdoc = await db.collection("users").doc(fid).get();
        if (!fdoc.exists) continue;
        const f = fdoc.data();
        friendsHTML += `
          <li class="friend-item" onclick="visitProfile('${fid}')">
            <div class="avatar-circle">${f.name ? f.name[0].toUpperCase() : "?"}</div>
            <div>${escapeHtml(f.name)}</div>
          </li>`;
      }
    } else {
      friendsHTML = "<p>No friends yet.</p>";
    }

    document.getElementById("app").innerHTML = `
      <div class="card" style="max-width: 600px; margin: 0 auto;">
        <h3>${escapeHtml(currentUserData.name)}</h3>
        <p><strong>Age:</strong> ${escapeHtml(currentUserData.age)}</p>
        <p><strong>Bio:</strong> ${escapeHtml(currentUserData.bio)}</p>
        <button onclick="openEditProfile()">Edit Profile</button>
        <h4 style="margin-top: 30px;">Your Friends</h4>
        <ul style="list-style:none; padding:0;">${friendsHTML}</ul>
      </div>
    `;
  }

  // Visit friend's profile (view-only)
  async function visitProfile(uid) {
    if (!uid) return;
    const doc = await db.collection("users").doc(uid).get();
    if (!doc.exists) return alert("User not found.");
    const user = doc.data();
    document.getElementById("app").innerHTML = `
      <div class="card" style="max-width:600px; margin: 0 auto;">
        <h3>${escapeHtml(user.name)}</h3>
        <p><strong>Age:</strong> ${escapeHtml(user.age)}</p>
        <p><strong>Bio:</strong> ${escapeHtml(user.bio)}</p>
        <button onclick="showPage('friends')">Back to Friends</button>
      </div>
    `;
  }

  // Profile Edit Modal control
  function openEditProfile() {
    document.getElementById("editProfileModal").style.display = "flex";
    document.getElementById("editName").value = currentUserData.name || "";
    document.getElementById("editBio").value = currentUserData.bio || "";
    avatarBase64 = null;
    document.getElementById("editAvatar").value = "";
  }
  function closeEditProfile() {
    document.getElementById("editProfileModal").style.display = "none";
  }

  // Save profile edits
  async function saveProfile() {
    const newName = document.getElementById("editName").value.trim();
    const newBio = document.getElementById("editBio").value.trim();
    const avatarFile = document.getElementById("editAvatar").files[0];

    if (!newName) return alert("Name cannot be empty.");

    if (avatarFile) {
      // Read file as base64
      const reader = new FileReader();
      reader.onload = async function(e) {
        avatarBase64 = e.target.result;
        await updateProfile(newName, newBio, avatarBase64);
      };
      reader.readAsDataURL(avatarFile);
    } else {
      await updateProfile(newName, newBio, currentUserData.avatar || null);
    }
  }

  async function updateProfile(name, bio, avatar) {
    try {
      await db.collection("users").doc(auth.currentUser.uid).update({
        name, bio, avatar
      });
      currentUserData.name = name;
      currentUserData.bio = bio;
      currentUserData.avatar = avatar;
      alert("Profile updated!");
      closeEditProfile();
      renderProfile();
    } catch(e) {
      alert("Error updating profile: " + e.message);
    }
  }

  // ---------- CHAT ----------

  async function renderChat() {
    if (!auth.currentUser) return;
    if (!currentUserData) {
      const userDoc = await db.collection("users").doc(auth.currentUser.uid).get();
      if (!userDoc.exists) return alert("User data not found.");
      currentUserData = userDoc.data();
    }

    // If no friends show message
    if (!currentUserData.friends || currentUserData.friends.length === 0) {
      document.getElementById("app").innerHTML = `
        <div class="card" style="max-width: 600px; margin: 50px auto; text-align:center;">
          <p>You have no friends to chat with.</p>
          <button onclick="showPage('friends')">Find Friends</button>
        </div>`;
      return;
    }

    // Show friends list for chat selection and chat UI
    let friendsHTML = "";
    for (const fid of currentUserData.friends) {
      const fdoc = await db.collection("users").doc(fid).get();
      if (!fdoc.exists) continue;
      const f = fdoc.data();
      friendsHTML += `
        <li class="friend-item" onclick="openChatWith('${fid}')">
          <div class="avatar-circle">${f.name ? f.name[0].toUpperCase() : "?"}</div>
          <div>${escapeHtml(f.name)}</div>
        </li>`;
    }

    document.getElementById("app").innerHTML = `
      <div class="card" style="max-width: 800px; margin: 0 auto; display:flex; gap: 15px; flex-wrap: wrap;">
        <div style="flex:1; min-width:200px; max-width: 250px; border-right:1px solid #ddd; overflow-y:auto; max-height: 450px;">
          <h3>Friends</h3>
          <ul style="list-style:none; padding: 0; margin: 0;">${friendsHTML}</ul>
        </div>
        <div style="flex:2; min-width: 300px; display:flex; flex-direction: column; justify-content: space-between;">
          <h3 id="chatFriendName">Select a friend to chat</h3>
          <div id="chatMessages" class="chat-container"></div>
          <textarea id="chatInput" rows="3" placeholder="Type a message" disabled></textarea>
          <button id="sendMsgBtn" onclick="sendMessage()" disabled>Send</button>
        </div>
      </div>
    `;

    currentChatFriendId = null;
    if (unsubscribeChat) {
      unsubscribeChat();
      unsubscribeChat = null;
    }
  }

  // Open chat with friend id
  async function openChatWith(friendId) {
    if (!friendId) return;
    if (unsubscribeChat) unsubscribeChat();

    currentChatFriendId = friendId;

    // Get friend name
    const friendDoc = await db.collection("users").doc(friendId).get();
    if (!friendDoc.exists) return alert("Friend data not found.");
    const friend = friendDoc.data();

    document.getElementById("chatFriendName").textContent = friend.name;
    document.getElementById("chatInput").disabled = false;
    document.getElementById("sendMsgBtn").disabled = false;

    loadChatMessages(friendId);
  }

  // Compose chat document id based on uids lex order
  function getChatDocId(uid1, uid2) {
    return uid1 < uid2 ? uid1 + "_" + uid2 : uid2 + "_" + uid1;
  }

  // Load chat messages for chat doc
  function loadChatMessages(friendId) {
    const chatId = getChatDocId(auth.currentUser.uid, friendId);
    const chatMessagesDiv = document.getElementById("chatMessages");
    chatMessagesDiv.innerHTML = "<p>Loading messages...</p>";

    unsubscribeChat = db.collection("chats").doc(chatId).collection("messages")
      .orderBy("timestamp", "asc").onSnapshot(snapshot => {
        if (snapshot.empty) {
          chatMessagesDiv.innerHTML = "<p>No messages yet.</p>";
          return;
        }
        let html = "";
        snapshot.forEach(doc => {
          const m = doc.data();
          const isSelf = m.senderId === auth.currentUser.uid;
          html += `<div class="chat-message ${isSelf ? "self" : "friend"}">${escapeHtml(m.text)}</div>`;
        });
        chatMessagesDiv.innerHTML = html;
        chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
      });
  }

  // Send chat message
  async function sendMessage() {
    const friendId = currentChatFriendId;
    if (!friendId) return alert("Select a friend first.");
    const input = document.getElementById("chatInput");
    const text = input.value.trim();
    if (!text) return;

    const chatId = getChatDocId(auth.currentUser.uid, friendId);
    input.value = "";

    try {
      await db.collection("chats").doc(chatId).collection("messages").add({
        senderId: auth.currentUser.uid,
        receiverId: friendId,
        text,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
    } catch(e) {
      alert("Error sending message: " + e.message);
    }
  }

  // ---------- SETTINGS ----------

  function renderSettings() {
    document.getElementById("app").innerHTML = `
      <div class="card" style="max-width: 400px; margin: 50px auto; text-align:center;">
        <button onclick="auth.signOut()">Logout</button>
      </div>
    `;
  }

  // ----------- AUTH STATE CHANGE -------------

  auth.onAuthStateChanged(async user => {
    if (user) {
      // Load current user data
      try {
        const userDoc = await db.collection("users").doc(user.uid).get();
        currentUserData = userDoc.exists ? userDoc.data() : null;
      } catch { currentUserData = null; }

      document.getElementById("navBar").style.display = "flex";
      showPage("feed");
    } else {
      currentUserData = null;
      document.getElementById("navBar").style.display = "none";
      renderLogin();
    }
  });

</script>

</body>
</html>
