<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Xinn Social â€” Feed/Profile Fix</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
  :root{
    --primary:#2196F3; --bg:#f0f2f5; --card:#fff; --muted:#666;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:#111;display:flex;flex-direction:column;min-height:100vh}
  header{background:var(--primary);color:#fff;padding:12px 16px;display:flex;justify-content:space-between;align-items:center}
  header h1{margin:0;font-size:18px}
  #app{padding:16px;max-width:900px;margin:16px auto 96px;flex:1}
  .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.06);margin-bottom:12px}
  input,textarea,button,select{width:100%;padding:10px;margin:6px 0;border:1px solid #ccc;border-radius:8px}
  textarea{resize:vertical}
  button{background:var(--primary);color:#fff;border:none;cursor:pointer}
  nav{position:fixed;left:0;right:0;bottom:0;background:var(--card);display:flex;justify-content:space-around;padding:10px 0;border-top:1px solid #ddd;max-width:900px;margin:0 auto}
  nav button{background:none;border:none;color:#555;display:flex;flex-direction:column;align-items:center;font-size:14px}
  nav button.active{color:var(--primary);font-weight:700}
  .avatar-circle{width:40px;height:40px;border-radius:50%;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;margin-right:10px}
  .profile-avatar{width:80px;height:80px;border-radius:50%;object-fit:cover;margin-bottom:10px}
  .chat-container{max-height:420px;overflow:auto;padding:10px;border-radius:8px;background:#e5ddd5}
  .chat-message{max-width:70%;padding:8px 12px;margin:8px 0;border-radius:18px;word-break:break-word}
  .chat-message.self{background:#dcf8c6;margin-left:auto;border-bottom-right-radius:0}
  .chat-message.friend{background:#fff;margin-right:auto;border-bottom-left-radius:0}
  .row{display:flex;gap:12px;align-items:center}
  .muted{color:var(--muted)}
  @media(max-width:600px){#app{padding:12px}}
</style>
</head>
<body>
<header>
  <h1>Xinn Social</h1>
  <div style="display:flex;gap:12px;align-items:center">
    <button id="darkToggle" style="background:none;border:none;color:#fff;cursor:pointer">ðŸŒ™</button>
  </div>
</header>

<div id="app"></div>

<nav id="navBar" style="display:none">
  <button id="navFeed" onclick="go('feed')"><span class="material-icons">home</span>Feed</button>
  <button id="navFriends" onclick="go('friends')"><span class="material-icons">group</span>Friends</button>
  <button id="navChat" onclick="go('chat')"><span class="material-icons">chat</span>Chat</button>
  <button id="navProfile" onclick="go('profile')"><span class="material-icons">person</span>Profile</button>
  <button id="navSettings" onclick="go('settings')"><span class="material-icons">settings</span>Settings</button>
</nav>

<!-- Edit profile modal -->
<div id="editProfileModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);align-items:center;justify-content:center;z-index:999">
  <div style="background:#fff;padding:16px;border-radius:8px;max-width:420px;width:90%">
    <h3>Edit profile</h3>
    <input id="editName" placeholder="Full name" />
    <input id="editAge" placeholder="Age" />
    <textarea id="editBio" rows="3" placeholder="Bio"></textarea>
    <label>Avatar (optional)</label>
    <input id="editAvatar" type="file" accept="image/*" />
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button onclick="closeEdit()">Cancel</button>
      <button onclick="saveProfile()">Save</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
/* ---------- CONFIG - replace with your config if needed ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyDhVRhDDCM8vFbNe9f1Ag4Xn0901igl4s0",
  authDomain: "xinn-social.firebaseapp.com",
  projectId: "xinn-social",
  storageBucket: "xinn-social.firebasestorage.app",
  messagingSenderId: "860868128981",
  appId: "1:860868128981:web:a5cb9b2cb32b10077e725c",
  measurementId: "G-2ZFNQND35B"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ---------- Utilities ---------- */
function $(id){ return document.getElementById(id); }
function safeSet(id, html){
  const el = $(id); if(!el) return; el.innerHTML = html;
}
function escapeHTML(s){ if(!s) return ''; return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ---------- State ---------- */
let me = null;
let meData = null; // user doc
let currentView = 'feed';
let currentProfileUid = null; // when viewing a profile (own or other)
let avatarBase64 = null;      // used in edit modal

/* ---------- Auth handling ---------- */
auth.onAuthStateChanged(async user => {
  me = user;
  if(me){
    // ensure user doc exists
    const ref = db.collection('users').doc(me.uid);
    const doc = await ref.get();
    if(!doc.exists){
      await ref.set({
        name: me.email.split('@')[0],
        age: '',
        bio: '',
        email: me.email,
        friends: [],
        friendRequests: [],
        sentRequests: [],
        avatar: null
      });
    }
    meData = (await ref.get()).data();
    $('navBar').style.display = 'flex';
    go('feed');
  } else {
    meData = null;
    $('navBar').style.display = 'none';
    renderLogin();
  }
});

/* ---------- Navigation ---------- */
function setActiveNav(page){
  currentView = page;
  ['navFeed','navFriends','navChat','navProfile','navSettings'].forEach(id => {
    const btn = $(id);
    if(!btn) return;
    btn.classList.toggle('active', id.toLowerCase() === ('nav'+page).toLowerCase());
  });
}
function go(page){
  setActiveNav(page);
  if(page==='feed') renderFeed();
  if(page==='friends') renderFriends();
  if(page==='chat') renderChat();
  if(page==='profile') { currentProfileUid = me.uid; renderProfile(me.uid); }
  if(page==='settings') renderSettings();
}

/* ---------- AUTH UI ---------- */
function renderLogin(){
  setActiveNav(null);
  document.getElementById('app').innerHTML = `
    <div class="card" style="max-width:420px;margin:40px auto">
      <h3>Login</h3>
      <input id="loginEmail" placeholder="Email (@xinn.lab only)" />
      <input id="loginPass" type="password" placeholder="Password" />
      <button id="btnLogin">Login</button>
      <p style="margin-top:8px">Or <a href="#" id="toRegister">Register</a></p>
    </div>`;
  $('btnLogin').onclick = async ()=> {
    const email = $('loginEmail').value.trim();
    const pass = $('loginPass').value;
    if(!email.endsWith('@xinn.lab')) return alert('Email must end with @xinn.lab');
    try{ await auth.signInWithEmailAndPassword(email, pass); } catch(e){ alert(e.message); }
  };
  $('toRegister').onclick = (e)=>{ e.preventDefault(); renderRegister(); };
}

function renderRegister(){
  document.getElementById('app').innerHTML = `
    <div class="card" style="max-width:420px;margin:40px auto">
      <h3>Register</h3>
      <input id="regName" placeholder="Full name" />
      <input id="regAge" placeholder="Age" />
      <textarea id="regBio" placeholder="Bio" rows="3"></textarea>
      <input id="regEmail" placeholder="Email (@xinn.lab only)" />
      <input id="regPass" type="password" placeholder="Password" />
      <button id="btnRegister">Create account</button>
      <p style="margin-top:8px">Have an account? <a href="#" id="toLogin">Login</a></p>
    </div>`;
  $('btnRegister').onclick = async ()=>{
    const name = $('regName').value.trim();
    const age = $('regAge').value.trim();
    const bio = $('regBio').value.trim();
    const email = $('regEmail').value.trim();
    const pass = $('regPass').value;
    if(!email.endsWith('@xinn.lab')) return alert('Email must end with @xinn.lab');
    if(!name || !age) return alert('Fill required fields');
    try{
      const cred = await auth.createUserWithEmailAndPassword(email, pass);
      // Create user doc and auto-login (auth state will change)
      await db.collection('users').doc(cred.user.uid).set({
        name, age, bio, email,
        friends: [], friendRequests: [], sentRequests: [], avatar: null
      });
      // No need to call signIn â€” auth state already set (auto login)
    } catch(e){ alert(e.message); }
  };
  $('toLogin').onclick = (e)=>{ e.preventDefault(); renderLogin(); };
}

/* ---------- FEED ---------- */
/* Feed shows only public posts (visibility: 'public') */
function renderFeed(){
  safeSet('app', `
    <div>
      <div class="card" style="max-width:720px;margin:0 auto;">
        <h3>What's on your mind?</h3>
        <textarea id="feedPostContent" rows="3" placeholder="Share something with everyone (public)"></textarea>
        <button id="btnFeedPost">Post to feed (public)</button>
      </div>
      <div id="feedPosts" style="max-width:720px;margin:12px auto"></div>
    </div>
  `);
  const btn = $('btnFeedPost'); if(btn) btn.onclick = createPostFeed;
  loadFeedPosts();
}

async function createPostFeed(){
  const content = $('feedPostContent') ? $('feedPostContent').value.trim() : '';
  if(!content) return alert('Post cannot be empty');
  try{
    await db.collection('posts').add({
      content,
      uid: me.uid,
      visibility: 'public', // important: public -> appears in feed
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    if($('feedPostContent')) $('feedPostContent').value = '';
  } catch(e){ alert('Error posting: '+e.message); }
}

function loadFeedPosts(){
  const container = 'feedPosts';
  safeSet(container, '<p>Loading feed...</p>');
  // Only public posts
  db.collection('posts').where('visibility','==','public').orderBy('timestamp','desc')
    .onSnapshot(async snap=>{
      if(!$(container)) return; // guard
      if(snap.empty) { safeSet(container, '<p>No public posts yet.</p>'); return; }
      let html = '';
      // gather user docs to reduce calls
      const posts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      for(const p of posts){
        let user = { name: 'Unknown', avatar: null };
        try {
          const ud = await db.collection('users').doc(p.uid).get();
          if(ud.exists) user = ud.data();
        } catch {}
        const t = p.timestamp ? p.timestamp.toDate().toLocaleString() : 'Just now';
        html += `<div class="card" style="padding:12px;">
          <div class="row" style="align-items:center;cursor:pointer" onclick="renderProfile('${p.uid}')">
            ${user.avatar ? `<img src="${user.avatar}" class="profile-avatar" style="width:40px;height:40px;margin-right:10px" />`
                         : `<div class="avatar-circle">${user.name ? user.name[0].toUpperCase() : '?'}</div>`}
            <div>
              <div style="font-weight:700">${escapeHTML(user.name)}</div>
              <div class="muted" style="font-size:12px">${t}</div>
            </div>
          </div>
          <div style="margin-top:10px">${escapeHTML(p.content)}</div>
        </div>`;
      }
      safeSet(container, html);
    });
}

/* ---------- PROFILE (timeline posts separate) ---------- */
/* Profile timeline: show posts WHERE uid == profileUid (all posts by user),
   so posts created with visibility:'profile' won't show in public feed. */

async function renderProfile(uid){
  // if uid omitted, show current user's profile
  if(!uid) uid = me.uid;
  currentProfileUid = uid;
  const doc = await db.collection('users').doc(uid).get();
  if(!doc.exists) {
    safeSet('app','<div class="card">User not found</div>');
    return;
  }
  const user = doc.data();
  const isMe = (uid === me.uid);
  // header
  safeSet('app', `<div style="max-width:720px;margin:0 auto;">
    <div class="card" style="text-align:center;">
      ${user.avatar ? `<img src="${user.avatar}" class="profile-avatar" />` : `<div class="avatar-circle" style="width:80px;height:80px;font-size:32px">${user.name ? user.name[0].toUpperCase() : '?'}</div>`}
      <h3>${escapeHTML(user.name)}</h3>
      <p><strong>Age:</strong> ${escapeHTML(user.age||'')}</p>
      <p><strong>Bio:</strong> ${escapeHTML(user.bio||'')}</p>
      ${isMe ? `<button id="btnOpenEdit">Edit Profile</button>` : ''}
    </div>
    <div id="profilePostArea"></div>
    <div id="profilePosts" style="margin-top:12px"></div>
  </div>`);
  if(isMe){
    const btn = $('btnOpenEdit'); if(btn) btn.onclick = openEditModal;
    // show interface to post on own profile (visibility: 'profile' so it won't show in feed)
    safeSet('profilePostArea', `<div class="card" style="max-width:720px;margin:12px auto">
      <h4>Post on your timeline</h4>
      <textarea id="profilePostContent" rows="3" placeholder="Share something on your timeline (only on your profile)"></textarea>
      <button id="btnProfilePost">Post to profile</button>
    </div>`);
    const btnPost = $('btnProfilePost'); if(btnPost) btnPost.onclick = createPostProfile;
  } else {
    safeSet('profilePostArea',''); // nothing for other user's profile
  }
  loadProfilePosts(uid);
}

async function createPostProfile(){
  const contentEl = $('profilePostContent');
  if(!contentEl) return;
  const content = contentEl.value.trim();
  if(!content) return alert('Post cannot be empty');
  try{
    await db.collection('posts').add({
      content,
      uid: me.uid,
      visibility: 'profile', // important: profile-only posts don't go to public feed
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    contentEl.value = '';
    // refresh profile posts
    loadProfilePosts(me.uid);
  } catch(e){ alert('Error posting: ' + e.message); }
}

function loadProfilePosts(uid){
  safeSet('profilePosts','<p>Loading posts...</p>');
  // Query posts where uid == profile uid. Could be visibility profile OR public OR any -> we show all posts by that user
  db.collection('posts').where('uid','==',uid).orderBy('timestamp','desc').onSnapshot(snap=>{
    if(!$('profilePosts')) return;
    if(snap.empty){ safeSet('profilePosts','<p>No posts on this profile yet.</p>'); return; }
    let html = '';
    snap.forEach(doc => {
      const p = doc.data();
      const t = p.timestamp ? p.timestamp.toDate().toLocaleString() : 'Just now';
      html += `<div class="card" style="padding:10px;margin-bottom:8px;">
        <small class="muted">${t}</small>
        <div style="margin-top:8px">${escapeHTML(p.content)}</div>
      </div>`;
    });
    safeSet('profilePosts', html);
  });
}

/* ---------- FRIENDS ---------- */

async function renderFriends(){
  safeSet('app', `<div style="max-width:720px;margin:0 auto;">
    <div class="card">
      <h3>Find people</h3>
      <input id="friendSearch" placeholder="Search name or email..." />
      <div id="friendSearchResults"></div>
    </div>
    <div class="card">
      <h3>Pending requests</h3>
      <div id="pendingRequests"></div>
    </div>
    <div class="card">
      <h3>Your friends</h3>
      <div id="friendList"></div>
    </div>
  </div>`);
  const search = $('friendSearch'); if(search) search.addEventListener('input', debounce(()=>searchUsers(search.value.trim()),300));
  await loadFriendPanels();
}

function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

async function loadFriendPanels(){
  // refresh meData
  const meRef = db.collection('users').doc(me.uid);
  const meDoc = await meRef.get(); if(!meDoc.exists) return;
  meData = meDoc.data();

  // pending requests (received)
  const pending = meData.friendRequests || [];
  if(!$('pendingRequests')) return;
  if(pending.length===0) safeSet('pendingRequests','<p>No pending requests</p>');
  else {
    let html = '';
    for(const fid of pending){
      const d = await db.collection('users').doc(fid).get();
      if(!d.exists) continue;
      const u = d.data();
      html += `<div class="request-card">
        <div><div class="avatar-circle">${u.name?u.name[0].toUpperCase():'?'}</div>${escapeHTML(u.name)}</div>
        <div>
          <button onclick="acceptFriend('${fid}')">Accept</button>
          <button onclick="declineFriend('${fid}')">Decline</button>
        </div>
      </div>`;
    }
    safeSet('pendingRequests', html);
  }

  // friends
  const friends = meData.friends || [];
  if(!$('friendList')) return;
  if(friends.length===0) safeSet('friendList','<p>No friends yet</p>');
  else {
    let html = '';
    for(const fid of friends){
      const d = await db.collection('users').doc(fid).get();
      if(!d.exists) continue;
      const u = d.data();
      html += `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;">
        <div style="display:flex;align-items:center;cursor:pointer" onclick="renderProfile('${fid}')">
          <div class="avatar-circle">${u.name?u.name[0].toUpperCase():'?'}</div>
          <div>${escapeHTML(u.name)}</div>
        </div>
        <div><button onclick="unfriend('${fid}')">Unfriend</button></div>
      </div>`;
    }
    safeSet('friendList', html);
  }
}

async function searchUsers(q){
  const out = 'friendSearchResults';
  safeSet(out, '<p>Searching...</p>');
  if(!q){ safeSet(out,''); return; }
  try{
    // simple client-side search (small user base); filter out self/friends/pending
    const snap = await db.collection('users').get();
    const results = [];
    snap.forEach(d=>{
      if(d.id === me.uid) return;
      const u = d.data();
      if((meData.friends||[]).includes(d.id)) return;
      if((meData.sentRequests||[]).includes(d.id)) return;
      if((meData.friendRequests||[]).includes(d.id)) return;
      if((u.name||'').toLowerCase().includes(q.toLowerCase()) || (u.email||'').toLowerCase().includes(q.toLowerCase())){
        results.push({ id:d.id, ...u });
      }
    });
    if(results.length === 0) { safeSet(out,'<p>No users found</p>'); return; }
    let html = '';
    for(const r of results){
      html += `<div class="request-card">
        <div><div class="avatar-circle">${r.name?r.name[0].toUpperCase():'?'}</div>${escapeHTML(r.name)}</div>
        <div><button onclick="sendFriendRequest('${r.id}')">Send Request</button></div>
      </div>`;
    }
    safeSet(out, html);
  } catch(e){ safeSet(out, '<p>Error searching users</p>'); console.error(e); }
}

async function sendFriendRequest(targetUid){
  if(!targetUid) return;
  if(targetUid === me.uid) return alert("Can't friend yourself");
  try{
    // update both docs
    await db.collection('users').doc(me.uid).update({ sentRequests: firebase.firestore.FieldValue.arrayUnion(targetUid) });
    await db.collection('users').doc(targetUid).update({ friendRequests: firebase.firestore.FieldValue.arrayUnion(me.uid) });
    alert('Friend request sent');
    await loadFriendPanels();
  } catch(e){ alert('Error: '+e.message); }
}

async function acceptFriend(fromUid){
  const meRef = db.collection('users').doc(me.uid);
  const otherRef = db.collection('users').doc(fromUid);
  try{
    await meRef.update({
      friendRequests: firebase.firestore.FieldValue.arrayRemove(fromUid),
      friends: firebase.firestore.FieldValue.arrayUnion(fromUid)
    });
    await otherRef.update({
      sentRequests: firebase.firestore.FieldValue.arrayRemove(me.uid),
      friends: firebase.firestore.FieldValue.arrayUnion(me.uid)
    });
    alert('Friend added');
    await loadFriendPanels();
  } catch(e){ alert('Error: '+e.message); }
}

async function declineFriend(fromUid){
  const meRef = db.collection('users').doc(me.uid);
  const otherRef = db.collection('users').doc(fromUid);
  try{
    await meRef.update({ friendRequests: firebase.firestore.FieldValue.arrayRemove(fromUid) });
    await otherRef.update({ sentRequests: firebase.firestore.FieldValue.arrayRemove(me.uid) });
    alert('Friend request declined');
    await loadFriendPanels();
  } catch(e){ alert('Error: '+e.message); }
}

async function unfriend(friendId){
  const meRef = db.collection('users').doc(me.uid);
  const otherRef = db.collection('users').doc(friendId);
  try{
    await meRef.update({ friends: firebase.firestore.FieldValue.arrayRemove(friendId) });
    await otherRef.update({ friends: firebase.firestore.FieldValue.arrayRemove(me.uid) });
    alert('Unfriended');
    await loadFriendPanels();
  } catch(e){ alert('Error: '+e.message); }
}

/* ---------- CHAT (messenger-like UI) ---------- */

async function renderChat(){
  // refresh meData
  const doc = await db.collection('users').doc(me.uid).get(); meData = doc.exists?doc.data():meData;
  const friends = meData.friends || [];
  if(!friends.length){
    safeSet('app','<div class="card" style="max-width:720px;margin:0 auto;text-align:center">No friends to chat with yet</div>');
    return;
  }
  safeSet('app', `<div style="max-width:900px;margin:0 auto;display:flex;gap:12px;flex-wrap:wrap">
    <div style="width:260px"><div class="card"><h4>Friends</h4><div id="chatFriendList"></div></div></div>
    <div style="flex:1;min-width:300px"><div class="card"><h4 id="chatWithName">Select a friend</h4><div id="chatMessages" class="chat-container"></div>
      <textarea id="chatInput" rows="2" placeholder="Type a message" style="border-radius:8px"></textarea>
      <button id="sendChatBtn">Send</button>
    </div></div>
  </div>`);
  // populate friends
  const listEl = $('chatFriendList'); if(!listEl) return;
  let html = '';
  for(const fid of friends){
    const fdoc = await db.collection('users').doc(fid).get(); if(!fdoc.exists) continue;
    const f = fdoc.data();
    html += `<div style="padding:8px;border-bottom:1px solid #eee;cursor:pointer" onclick="openChat('${fid}','${escapeHTML(f.name)}')">
      <div style="display:flex;align-items:center"><div class="avatar-circle">${f.name?f.name[0].toUpperCase():'?'}</div><div>${escapeHTML(f.name)}</div></div>
    </div>`;
  }
  safeSet('chatFriendList', html);
  const sendBtn = $('sendChatBtn'); if(sendBtn) sendBtn.onclick = sendChatMessage;
}

let chatUnsub = null, chatWith = null;
function openChat(friendUid, friendName){
  chatWith = friendUid;
  const messages = $('chatMessages'); if(!messages) return;
  $('chatWithName').textContent = friendName;
  messages.innerHTML = '<p>Loading messages...</p>';
  if(chatUnsub) chatUnsub();
  const cid = [me.uid, friendUid].sort().join('_');
  chatUnsub = db.collection('chats').doc(cid).collection('messages').orderBy('timestamp','asc')
    .onSnapshot(snap=>{
      if(!messages) return;
      if(snap.empty){ messages.innerHTML = '<p>No messages yet</p>'; return; }
      let html = '';
      snap.forEach(d=>{
        const m = d.data();
        const cls = m.uid === me.uid ? 'self' : 'friend';
        html += `<div class="chat-message ${cls}">${escapeHTML(m.text)}</div>`;
      });
      messages.innerHTML = html;
      messages.scrollTop = messages.scrollHeight;
    });
}

async function sendChatMessage(){
  const txt = $('chatInput') ? $('chatInput').value.trim() : '';
  if(!txt) return;
  if(!chatWith) return alert('Select a friend to chat with');
  const cid = [me.uid, chatWith].sort().join('_');
  try{
    await db.collection('chats').doc(cid).collection('messages').add({
      uid: me.uid,
      text: txt,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    if($('chatInput')) $('chatInput').value = '';
  } catch(e){ alert('Error sending: '+e.message); }
}

/* ---------- SETTINGS ---------- */

function renderSettings(){
  safeSet('app', `<div class="card" style="max-width:480px;margin:0 auto">
    <h3>Settings</h3>
    <button id="btnLogout" style="background:#f44336">Logout</button>
    <hr/>
    <h4>Change password</h4>
    <input id="currentPass" type="password" placeholder="Current password" />
    <input id="newPass" type="password" placeholder="New password" />
    <button id="btnChangePass">Change password</button>
  </div>`);
  if($('btnLogout')) $('btnLogout').onclick = ()=>auth.signOut();
  if($('btnChangePass')) $('btnChangePass').onclick = changePassword;
}

async function changePassword(){
  const cur = $('currentPass').value, neu = $('newPass').value;
  if(!cur || !neu) return alert('Fill both fields');
  const user = auth.currentUser;
  const cred = firebase.auth.EmailAuthProvider.credential(user.email, cur);
  try{
    await user.reauthenticateWithCredential(cred);
    await user.updatePassword(neu);
    alert('Password updated');
    $('currentPass').value=''; $('newPass').value='';
  } catch(e){ alert('Error: '+e.message); }
}

/* ---------- PROFILE EDIT modal ---------- */
function openEditModal(){
  if(!meData) return;
  $('editName').value = meData.name || '';
  $('editAge').value = meData.age || '';
  $('editBio').value = meData.bio || '';
  avatarBase64 = meData.avatar || null;
  $('editProfileModal').style.display = 'flex';
}
function closeEdit(){ $('editProfileModal').style.display = 'none'; }

$('editAvatar')?.addEventListener('change', function(e){
  const f = e.target.files[0];
  if(!f) return;
  // resize small client-side optionally, but for simplicity convert to base64 directly
  const r = new FileReader();
  r.onload = evt => avatarBase64 = evt.target.result;
  r.readAsDataURL(f);
});

async function saveProfile(){
  const name = $('editName').value.trim();
  const age = $('editAge').value.trim();
  const bio = $('editBio').value.trim();
  if(!name) return alert('Name cannot be empty');
  try{
    await db.collection('users').doc(me.uid).update({
      name, age, bio, avatar: avatarBase64 || null
    });
    meData = (await db.collection('users').doc(me.uid).get()).data();
    alert('Profile updated');
    closeEdit();
    renderProfile(me.uid);
  } catch(e){ alert('Error saving: '+e.message); }
}

/* ---------- HELPERS ---------- */
function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

/* ---------- INITIAL ---------- */
window.addEventListener('load', ()=> {
  // dark toggle
  $('darkToggle')?.addEventListener('click', ()=> document.body.classList.toggle('dark'));
});

// expose some functions used by inline event handlers
window.renderProfile = renderProfile;
window.go = go;
window.sendFriendRequest = sendFriendRequest;
window.acceptFriend = acceptFriend;
window.declineFriend = declineFriend;
window.unfriend = unfriend;
window.openChat = openChat;
window.renderLogin = renderLogin;
window.renderRegister = renderRegister;
window.openEditModal = openEditModal;

/* ---------- END ---------- */
</script>
</body>
</html>
