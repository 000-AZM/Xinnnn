<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Xinn Social</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<style>
  body { font-family: Arial, sans-serif; margin:0; background:#f0f2f5; }
  header { background:#2196F3; color:white; padding:10px; text-align:center; }
  .container { padding:20px; }
  .card { background:white; padding:15px; margin:10px 0; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
  input, textarea, button, select {
    width:100%; padding:10px; margin:5px 0; border:1px solid #ccc; border-radius:5px;
  }
  button { background:#2196F3; color:white; border:none; cursor:pointer; }
  nav { position:fixed; bottom:0; left:0; right:0; background:white; display:flex; justify-content:space-around; border-top:1px solid #ccc; padding:10px 0; }
  nav button { background:none; color:#555; font-size:24px; }
  nav button.active { color:#2196F3; font-weight:bold; }
  ul { list-style:none; padding-left:0; }
  li { padding:8px 0; border-bottom:1px solid #ddd; }
  li button { width:auto; padding:5px 10px; margin-left:10px; font-size:14px; }
</style>
</head>
<body>

<header><h2>Xinn Social</h2></header>

<div id="app"></div>

<nav id="navBar" style="display:none;">
  <button id="navFeed" onclick="showPage('feed')" title="Feed"><span class="material-icons">home</span></button>
  <button id="navFriends" onclick="showPage('friends')" title="Friends"><span class="material-icons">group</span></button>
  <button id="navChat" onclick="showPage('chat')" title="Chat"><span class="material-icons">chat</span></button>
  <button id="navProfile" onclick="showPage('profile')" title="Profile"><span class="material-icons">person</span></button>
  <button id="navSettings" onclick="showPage('settings')" title="Settings"><span class="material-icons">settings</span></button>
</nav>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCGN7t5FjDeJ-ewm7S_9z0VJrRSggTaJ2Q",
  authDomain: "coin-base-by-hector.firebaseapp.com",
  databaseURL: "https://coin-base-by-hector-default-rtdb.firebaseio.com",
  projectId: "coin-base-by-hector",
  storageBucket: "coin-base-by-hector.firebasestorage.app",
  messagingSenderId: "398789890422",
  appId: "1:398789890422:web:ed6a928037b24be2e36a57",
  measurementId: "G-SGJJM5K3G9"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentChatFriendId = null;
let currentChatFriendName = '';
let unsubscribeChat = null;
let searchTimeout = null;

// --- AUTH & UI ---
function renderLogin() {
  document.getElementById('app').innerHTML = `
    <div class="container card">
      <h3>Login to Xinn Social</h3>
      <input type="email" id="email" placeholder="Email (@xinn.lab only)" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="login()">Login</button>
      <p>Or <a href="#" onclick="renderRegister()">Register</a></p>
    </div>
  `;
  document.getElementById('navBar').style.display = 'none';
}

function renderRegister() {
  document.getElementById('app').innerHTML = `
    <div class="container card">
      <h3>Create Account</h3>
      <input type="text" id="name" placeholder="Full Name" />
      <input type="number" id="age" placeholder="Age" />
      <textarea id="bio" placeholder="Bio"></textarea>
      <input type="email" id="email" placeholder="Email (@xinn.lab only)" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="register()">Register</button>
      <p>Already have an account? <a href="#" onclick="renderLogin()">Login</a></p>
    </div>
  `;
  document.getElementById('navBar').style.display = 'none';
}

function login() {
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value.trim();
  if (!email.endsWith('@xinn.lab')) {
    alert('Email must end with @xinn.lab');
    return;
  }
  auth.signInWithEmailAndPassword(email, pass)
    .catch(e => alert(e.message));
}

function register() {
  const name = document.getElementById('name').value.trim();
  const age = document.getElementById('age').value.trim();
  const bio = document.getElementById('bio').value.trim();
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value.trim();

  if (!email.endsWith('@xinn.lab')) {
    alert('Email must end with @xinn.lab');
    return;
  }
  if (!name) {
    alert('Please enter your full name');
    return;
  }
  
  auth.createUserWithEmailAndPassword(email, pass)
    .then(cred => {
      return db.collection('users').doc(cred.user.uid).set({
        name,
        age,
        bio,
        email,
        nameLower: name.toLowerCase(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    })
    .catch(e => alert(e.message));
}

// --- FRIENDS ---

// Render friend list and pending requests
function renderFriends() {
  document.getElementById('app').innerHTML = `
    <div class="container card">
      <h3>Friends & Search</h3>
      <input type="text" id="searchInput" placeholder="Search users by name..." oninput="searchFriends()" />
      <div id="friendList" style="margin-top:10px;"></div>
      <div id="searchResults" style="margin-top:20px;"></div>
    </div>
  `;
  loadFriendList();
}

// Load current friends
async function loadFriendList() {
  const uid = auth.currentUser.uid;
  const friendListDiv = document.getElementById('friendList');
  friendListDiv.innerHTML = '<h4>Your Friends:</h4>';

  try {
    const friendsSnap = await db.collection('users').doc(uid).collection('friends').get();
    if (friendsSnap.empty) {
      friendListDiv.innerHTML += '<p>You have no friends yet.</p>';
      return;
    }

    let html = '';
    for (const doc of friendsSnap.docs) {
      const friendId = doc.id;
      const userDoc = await db.collection('users').doc(friendId).get();
      const friend = userDoc.data();
      if (!friend) continue;
      html += `
        <div style="padding:6px; border-bottom:1px solid #ccc; cursor:pointer;" onclick="visitProfile('${friendId}')">
          <strong>${friend.name}</strong> <small style="color:gray;">(Click to view profile)</small>
        </div>
      `;
    }
    friendListDiv.innerHTML += html;

  } catch (e) {
    friendListDiv.innerHTML += `<p style="color:red;">Error loading friends: ${e.message}</p>`;
  }
}

let searchTimeout;
function searchFriends() {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(async () => {
    const query = document.getElementById('searchInput').value.trim().toLowerCase();
    const searchResultsDiv = document.getElementById('searchResults');
    searchResultsDiv.innerHTML = '';

    if (!query) return;

    const uid = auth.currentUser.uid;

    try {
      // Query users where nameLower starts with query
      const usersSnap = await db.collection('users')
        .orderBy('nameLower')
        .startAt(query)
        .endAt(query + '\uf8ff')
        .limit(10)
        .get();

      if (usersSnap.empty) {
        searchResultsDiv.innerHTML = '<p>No users found.</p>';
        return;
      }

      let html = '<h4>Search Results:</h4>';
      for (const doc of usersSnap.docs) {
        const user = doc.data();
        const userId = doc.id;

        if (userId === uid) continue; // skip yourself

        // Check if already friend
        const friendDoc = await db.collection('users').doc(uid).collection('friends').doc(userId).get();
        if (friendDoc.exists) continue;

        // Check if friend request sent by current user to this user
        const sentReqDoc = await db.collection('users').doc(userId).collection('friendRequests').doc(uid).get();
        if (sentReqDoc.exists) continue;

        // Check if friend request received from this user
        const receivedReqDoc = await db.collection('users').doc(uid).collection('friendRequests').doc(userId).get();
        if (receivedReqDoc.exists) continue;

        html += `
          <div style="padding:6px; border-bottom:1px solid #ccc; cursor:pointer;" onclick="visitProfile('${userId}')">
            <strong>${user.name}</strong> <small style="color:gray;">(Click to view profile)</small>
          </div>
        `;
      }

      if (html === '<h4>Search Results:</h4>') {
        html = '<p>No users found.</p>';
      }

      searchResultsDiv.innerHTML = html;

    } catch (e) {
      searchResultsDiv.innerHTML = `<p style="color:red;">Error searching users: ${e.message}</p>`;
    }
  }, 300);
}

// Load incoming friend requests (pending)
function loadPendingRequests() {
  const uid = auth.currentUser.uid;
  const list = document.getElementById('pendingRequests');
  list.innerHTML = '<li>Loading requests...</li>';

  db.collection('users').doc(uid).collection('friendRequests')
    .where('status', '==', 'pending')
    .get()
    .then(snapshot => {
      if (snapshot.empty) {
        list.innerHTML = '<li>No pending requests</li>';
        return;
      }
      list.innerHTML = '';
      snapshot.forEach(doc => {
        const req = doc.data();
        const li = document.createElement('li');
        li.textContent = req.fromName || 'Unknown';
        li.style.fontWeight = 'bold';

        const acceptBtn = document.createElement('button');
        acceptBtn.textContent = 'Accept';
        acceptBtn.onclick = () => acceptFriendRequest(doc.id, req.from);

        const declineBtn = document.createElement('button');
        declineBtn.textContent = 'Decline';
        declineBtn.onclick = () => declineFriendRequest(doc.id);

        li.appendChild(acceptBtn);
        li.appendChild(declineBtn);
        list.appendChild(li);
      });
    })
    .catch(e => {
      list.innerHTML = '<li>Error loading requests</li>';
      console.error('Load requests error:', e);
    });
}

// Send friend request (creates doc in recipient's friendRequests subcollection)
function sendFriendRequest(toId, toName) {
  const fromId = auth.currentUser.uid;
  const fromName = auth.currentUser.displayName || 'You';

  // Prevent sending to self
  if (fromId === toId) {
    alert("You can't add yourself");
    return;
  }

  // Add friend request doc to recipient
  db.collection('users').doc(toId).collection('friendRequests').doc(fromId).set({
    from: fromId,
    fromName,
    status: 'pending',
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    alert('Friend request sent to ' + toName);
    searchUsers(); // refresh search results to update button state
  }).catch(e => {
    alert('Error sending friend request: ' + e.message);
  });
}

// Cancel sent friend request (delete doc from recipient's friendRequests subcollection)
function cancelFriendRequest(toId) {
  const fromId = auth.currentUser.uid;

  db.collection('users').doc(toId).collection('friendRequests').doc(fromId).delete()
    .then(() => {
      alert('Friend request canceled');
      searchUsers(); // refresh search results
    }).catch(e => {
      alert('Error canceling request: ' + e.message);
    });
}

// Accept friend request: add each other as friends & remove the request doc
function acceptFriendRequest(requestId, fromId) {
  const currentUserId = auth.currentUser.uid;

  const batch = db.batch();

  // Add to current user's friends subcollection
  const myFriendRef = db.collection('users').doc(currentUserId).collection('friends').doc(fromId);
  batch.set(myFriendRef, { since: firebase.firestore.FieldValue.serverTimestamp() });

  // Add to friend's friends subcollection
  const friendFriendRef = db.collection('users').doc(fromId).collection('friends').doc(currentUserId);
  batch.set(friendFriendRef, { since: firebase.firestore.FieldValue.serverTimestamp() });

  // Remove friend request doc
  const reqRef = db.collection('users').doc(currentUserId).collection('friendRequests').doc(requestId);
  batch.delete(reqRef);

  batch.commit()
    .then(() => {
      alert('Friend request accepted!');
      loadFriendList();
      loadPendingRequests();
    })
    .catch(e => {
      alert('Error accepting friend request: ' + e.message);
    });
}

// Decline friend request (delete request doc)
function declineFriendRequest(requestId) {
  const currentUserId = auth.currentUser.uid;
  db.collection('users').doc(currentUserId).collection('friendRequests').doc(requestId).delete()
    .then(() => {
      alert('Friend request declined');
      loadPendingRequests();
    }).catch(e => {
      alert('Error declining request: ' + e.message);
    });
}

// Search users excluding self, friends, and pending friend requests (sent or received)
function searchUsers() {
  const q = document.getElementById('searchFriendInput').value.trim().toLowerCase();
  const currentUserId = auth.currentUser.uid;

  if (searchTimeout) clearTimeout(searchTimeout);
  if (!q) {
    document.getElementById('searchResults').innerHTML = "";
    return;
  }

  searchTimeout = setTimeout(() => {
    db.collection('users')
      .orderBy('nameLower')
      .startAt(q)
      .endAt(q + '\uf8ff')
      .limit(20)
      .get()
      .then(snap => {
        let users = [];
        snap.forEach(doc => {
          if (doc.id !== currentUserId) {
            users.push({ id: doc.id, ...doc.data() });
          }
        });

        if (users.length === 0) {
          document.getElementById('searchResults').innerHTML = '<li>No users found</li>';
          return;
        }

        Promise.all([
          db.collection('users').doc(currentUserId).collection('friends').get(),
          db.collection('users').doc(currentUserId).collection('friendRequests').get(),
          db.collectionGroup('friendRequests').where('from', '==', currentUserId).where('status', '==', 'pending').get()
        ]).then(([friendsSnap, incomingReqSnap, sentReqSnap]) => {
          const friendIds = friendsSnap.docs.map(d => d.id);
          const incomingReqIds = incomingReqSnap.docs.map(d => d.id);
          const sentReqIds = sentReqSnap.docs.map(d => d.ref.parent.parent.id);

          let html = "";
          users.forEach(user => {
            // Exclude friends
            if (friendIds.includes(user.id)) return;

            // Exclude if user has sent you a friend request (incoming)
            if (incomingReqIds.includes(user.id)) {
              html += `<li>${user.name} (${user.email || ''}) - Sent you a request</li>`;
              return;
            }

            // Exclude if you have already sent a request to user
            if (sentReqIds.includes(user.id)) {
              html += `<li>${user.name} (${user.email || ''}) - Request sent 
                <button onclick="cancelFriendRequest('${user.id}')">Cancel</button></li>`;
              return;
            }

            // Show Add Friend button if none above
            html += `<li>${user.name} (${user.email || ''}) 
              <button onclick="sendFriendRequest('${user.id}', '${user.name}')">Add Friend</button></li>`;
          });
          document.getElementById('searchResults').innerHTML = html || "<li>No users found</li>";
        });
      }).catch(e => {
        if (e.code === 'failed-precondition') {
          alert('Firestore index missing for friend search. Please create the index in Firebase console.');
        } else {
          alert('Error searching users: ' + e.message);
        }
        document.getElementById('searchResults').innerHTML = '<li>Error searching users</li>';
      });
  }, 500);
}

// --- CHAT ---
// Chat system simplified for friends only
function renderChat() {
  if (!currentChatFriendId) {
    document.getElementById('app').innerHTML = `
      <div class="container card">
        <h3>Select a friend to chat from Friends tab</h3>
      </div>
    `;
    return;
  }

  document.getElementById('app').innerHTML = `
    <div class="container chat-container">
      <h3>Chat with ${currentChatFriendName}</h3>
      <div id="messages" style="max-height:300px; overflow-y:auto; border:1px solid #ccc; padding:10px; border-radius:8px; background:#fff;"></div>
      <div style="display:flex; margin-top:10px;">
        <textarea id="messageInput" rows="2" placeholder="Type a message" style="flex:1; resize:none; padding:10px; border-radius:8px; border:1px solid #ccc;"></textarea>
        <button onclick="sendMessage()" style="margin-left:10px; padding:10px 20px;">Send</button>
      </div>
    </div>
  `;

  loadChatMessages(currentChatFriendId);
}

function openChat(friendId, friendName) {
  currentChatFriendId = friendId;
  currentChatFriendName = friendName;
  if (unsubscribeChat) unsubscribeChat();
  showPage('chat');
}

function loadChatMessages(friendId) {
  const currentUserId = auth.currentUser.uid;
  const chatId = getChatId(currentUserId, friendId);
  const messagesRef = db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp');

  if (unsubscribeChat) unsubscribeChat();

  unsubscribeChat = messagesRef.onSnapshot(snapshot => {
    const messagesDiv = document.getElementById('messages');
    messagesDiv.innerHTML = "";
    snapshot.forEach(doc => {
      const msg = doc.data();
      const div = document.createElement('div');
      div.style.margin = '8px 0';
      div.style.maxWidth = '70%';
      div.style.padding = '8px 12px';
      div.style.borderRadius = '20px';
      div.style.clear = 'both';
      div.style.wordWrap = 'break-word';
      div.style.fontSize = '14px';
      if (msg.sender === currentUserId) {
        div.style.backgroundColor = '#DCF8C6';
        div.style.float = 'right';
        div.style.textAlign = 'right';
      } else {
        div.style.backgroundColor = '#fff';
        div.style.border = '1px solid #ccc';
        div.style.float = 'left';
        div.style.textAlign = 'left';
      }
      div.textContent = msg.text;
      messagesDiv.appendChild(div);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

function sendMessage() {
  const currentUserId = auth.currentUser.uid;
  const friendId = currentChatFriendId;
  if (!friendId) return;

  const text = document.getElementById('messageInput').value.trim();
  if (!text) return;

  const chatId = getChatId(currentUserId, friendId);

  db.collection('chats').doc(chatId).collection('messages').add({
    sender: currentUserId,
    text,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    document.getElementById('messageInput').value = '';
  }).catch(e => {
    alert('Error sending message: ' + e.message);
  });
}

function getChatId(uid1, uid2) {
  return uid1 < uid2 ? uid1 + '_' + uid2 : uid2 + '_' + uid1;
}

// --- PROFILE ---
function renderProfile() {
  const uid = auth.currentUser.uid;
  db.collection('users').doc(uid).get()
    .then(doc => {
      const u = doc.data();
      document.getElementById('app').innerHTML = `
        <div class="container">
          <div class="card">
            <h3>${u.name}</h3>
            <p>Age: ${u.age || '-'}</p>
            <p>Bio: ${u.bio || '-'}</p>
            <button onclick="editProfile()">Edit Profile</button>
          </div>
        </div>
      `;
    }).catch(e => {
      alert('Error loading profile: ' + e.message);
    });
}

function editProfile() {
  const uid = auth.currentUser.uid;
  db.collection('users').doc(uid).get()
    .then(doc => {
      const u = doc.data();
      document.getElementById('app').innerHTML = `
        <div class="container card">
          <input id="name" value="${u.name || ''}" placeholder="Full Name" />
          <input id="age" value="${u.age || ''}" placeholder="Age" />
          <textarea id="bio" placeholder="Bio">${u.bio || ''}</textarea>
          <button onclick="saveProfile()">Save</button>
        </div>
      `;
    });
}

function saveProfile() {
  const uid = auth.currentUser.uid;
  const name = document.getElementById('name').value.trim();
  const age = document.getElementById('age').value.trim();
  const bio = document.getElementById('bio').value.trim();
  if (!name) {
    alert('Name cannot be empty');
    return;
  }
  db.collection('users').doc(uid).update({
    name,
    age,
    bio,
    nameLower: name.toLowerCase()
  }).then(() => {
    renderProfile();
  }).catch(e => {
    alert('Error saving profile: ' + e.message);
  });
}

// --- FEED --- (basic feed for demo)
function renderFeed() {
  document.getElementById('app').innerHTML = `
    <div class="container">
      <div class="card">
        <textarea id="postContent" placeholder="What's on your mind?" style="resize:none;"></textarea>
        <button onclick="createPost()">Post</button>
      </div>
      <div id="feedPosts"></div>
    </div>
  `;
  loadPosts();
}

function createPost() {
  const content = document.getElementById('postContent').value.trim();
  if (!content) return;
  db.collection('posts').add({
    content,
    uid: auth.currentUser.uid,
    likes: [],
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
  document.getElementById('postContent').value = '';
}

function loadPosts() {
  db.collection('posts').orderBy('timestamp', 'desc').onSnapshot(snap => {
    let html = '';
    let postPromises = [];

    snap.forEach(doc => {
      const p = doc.data();
      postPromises.push(
        db.collection('users').doc(p.uid).get().then(userDoc => {
          const user = userDoc.data() || { name: "Unknown" };
          const time = p.timestamp ? p.timestamp.toDate().toLocaleString() : "Just now";

          // Make user name clickable to visit profile
          html += `
            <div class="card" style="padding: 12px;">
              <div style="display:flex;align-items:center;margin-bottom:8px;">
                <span class="material-icons" style="font-size:36px;color:#2196F3;margin-right:10px;">account_circle</span>
                <div>
                  <strong style="cursor:pointer; color:#2196F3;" onclick="visitProfile('${p.uid}')">${user.name}</strong><br>
                  <small style="color:gray;">${time}</small>
                </div>
              </div>
              <div style="margin:10px 0;font-size:15px;">${p.content}</div>
              <hr style="margin:8px 0;">
              <button onclick="toggleLike('${doc.id}')"
                style="background:none;color:#2196F3;border:none;cursor:pointer;">
                👍 Like (${p.likes.length})
              </button>
            </div>`;
        })
      );
    });

    Promise.all(postPromises).then(() => {
      document.getElementById('feedPosts').innerHTML = html;
    });
  });
}
// --- Visit other user's profile (read-only) ---
async function visitProfile(uid) {
  try {
    const doc = await db.collection('users').doc(uid).get();
    if (!doc.exists) {
      alert('User profile not found');
      return;
    }
    const u = doc.data();
    const currentUserId = auth.currentUser.uid;
    const isCurrentUser = (uid === currentUserId);

    if (isCurrentUser) {
      // Show editable profile
      document.getElementById('app').innerHTML = `
        <div class="container card">
          <button onclick="showPage('feed')" style="margin-bottom:10px;">&larr; Back to Feed</button>
          <h3>${u.name}</h3>
          <p>Age: ${u.age || '-'}</p>
          <p>Bio: ${u.bio || '-'}</p>
          <button onclick="editProfile()">Edit Profile</button>
        </div>
      `;
      return;
    }

    // Check friend request & friendship status
    const friendsRef = db.collection('users').doc(currentUserId).collection('friends').doc(uid);
    const sentRequestRef = db.collection('users').doc(uid).collection('friendRequests').doc(currentUserId);
    const receivedRequestRef = db.collection('users').doc(currentUserId).collection('friendRequests').doc(uid);

    const [friendDoc, sentReqDoc, receivedReqDoc] = await Promise.all([
      friendsRef.get(),
      sentRequestRef.get(),
      receivedRequestRef.get()
    ]);

    let actionButtons = '';

    if (friendDoc.exists) {
      actionButtons = `<p style="color:green; font-weight:bold;">You and ${u.name} are friends.</p>`;
    } else if (receivedReqDoc.exists) {
      // Current user received a friend request from viewed user => can Accept or Decline
      actionButtons = `
        <button onclick="acceptFriendRequest('${uid}')">Accept Friend Request</button>
        <button onclick="declineFriendRequest('${uid}')">Decline</button>
      `;
    } else if (sentReqDoc.exists) {
      // Current user already sent a friend request to viewed user => can Cancel
      actionButtons = `
        <button onclick="cancelFriendRequest('${uid}')">Cancel Friend Request</button>
      `;
    } else {
      // No relation => can send friend request
      actionButtons = `<button onclick="sendFriendRequest('${uid}')">Send Friend Request</button>`;
    }

    document.getElementById('app').innerHTML = `
      <div class="container card">
        <button onclick="showPage('feed')" style="margin-bottom:10px;">&larr; Back to Feed</button>
        <h3>${u.name}</h3>
        <p>Age: ${u.age || '-'}</p>
        <p>Bio: ${u.bio || '-'}</p>
        <div>${actionButtons}</div>
      </div>
    `;

  } catch (e) {
    alert('Error loading profile: ' + e.message);
  }
}
function toggleLike(postId) {
  const ref = db.collection('posts').doc(postId);
  ref.get().then(doc => {
    const data = doc.data();
    let likes = data.likes || [];
    if (likes.includes(auth.currentUser.uid)) {
      likes = likes.filter(id => id !== auth.currentUser.uid);
    } else {
      likes.push(auth.currentUser.uid);
    }
    ref.update({ likes });
  });
}

// --- SETTINGS ---
function renderSettings() {
  document.getElementById('app').innerHTML = `
    <div class="container card">
      <button onclick="auth.signOut()">Logout</button>
    </div>
  `;
}

// --- NAVIGATION ---
function showPage(page) {
  // Update active nav button
  ['navFeed','navFriends','navChat','navProfile','navSettings'].forEach(id => {
    document.getElementById(id).classList.remove('active');
  });
  if (page === 'feed') document.getElementById('navFeed').classList.add('active');
  else if (page === 'friends') document.getElementById('navFriends').classList.add('active');
  else if (page === 'chat') document.getElementById('navChat').classList.add('active');
  else if (page === 'profile') document.getElementById('navProfile').classList.add('active');
  else if (page === 'settings') document.getElementById('navSettings').classList.add('active');

  if (page === 'feed') renderFeed();
  if (page === 'profile') renderProfile();
  if (page === 'friends') renderFriends();
  if (page === 'chat') renderChat();
  if (page === 'settings') renderSettings();
}

// --- AUTH STATE ---
auth.onAuthStateChanged(user => {
  if (user) {
    // Ensure displayName for friend request names
    if (!user.displayName) {
      db.collection('users').doc(user.uid).get().then(doc => {
        const u = doc.data();
        if (u && u.name) {
          user.updateProfile({ displayName: u.name });
        }
      });
    }
    showPage('feed');
    document.getElementById('navBar').style.display = 'flex';
  } else {
    renderLogin();
    document.getElementById('navBar').style.display = 'none';
    currentChatFriendId = null;
    currentChatFriendName = '';
  }
});
</script>

</body>
</html>
