<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Xinn Social</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; background: #f0f2f5;
    transition: background-color 0.3s, color 0.3s;
  }
  body.dark {
    background: #18191A; color: #E4E6EB;
  }
  header {
    background: #2196F3;
    color: white;
    padding: 10px;
    text-align: center;
  }
  .container {
    padding: 20px;
    max-width: 600px;
    margin: 0 auto;
  }
  .card {
    background: white;
    padding: 15px;
    margin: 10px 0;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  body.dark .card {
    background: #242526;
    color: #ddd;
  }
  input, textarea, button, select {
    width: 100%;
    padding: 10px;
    margin: 5px 0;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-sizing: border-box;
    font-size: 14px;
  }
  body.dark input, body.dark textarea {
    background: #3A3B3C; color: white; border: 1px solid #555;
  }
  button {
    background: #2196F3;
    color: white;
    border: none;
    cursor: pointer;
    font-weight: bold;
  }
  button.primary {
    background: #4CAF50;
  }
  button.danger {
    background: #f44336;
  }
  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  nav {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: white;
    display: flex;
    justify-content: space-around;
    border-top: 1px solid #ccc;
    padding: 10px 0;
    box-sizing: border-box;
    z-index: 1000;
  }
  body.dark nav {
    background: #242526;
    border-color: #444;
  }
  nav button {
    background: none;
    color: #555;
    font-size: 24px;
  }
  nav button.active {
    color: #2196F3;
    font-weight: bold;
  }
  #notificationBadge {
    position: absolute;
    top: 5px;
    right: 5px;
    background: red;
    color: white;
    font-size: 12px;
    padding: 2px 6px;
    border-radius: 50%;
    display: none;
  }
  #notiDropdown {
    position: fixed;
    bottom: 50px;
    right: 10px;
    width: 280px;
    max-height: 350px;
    overflow-y: auto;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    display: none;
    z-index: 1001;
  }
  body.dark #notiDropdown {
    background: #242526;
    color: #ddd;
  }
  #notiDropdown .notiItem {
    padding: 10px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
  }
  body.dark #notiDropdown .notiItem {
    border-color: #444;
  }
  #notiDropdown .notiItem.unread {
    font-weight: bold;
    background: #E3F2FD;
  }
  body.dark #notiDropdown .notiItem.unread {
    background: #3A3B3C;
  }
  .friend-avatar {
    display: inline-block;
    width: 40px; height: 40px;
    background: #2196F3;
    color: white;
    border-radius: 50%;
    line-height: 40px;
    text-align: center;
    margin: 0 6px 6px 0;
    cursor: pointer;
    user-select: none;
  }
  .friend-list {
    margin-top: 12px;
  }
  .message {
    margin: 6px 0;
    max-width: 70%;
    padding: 8px 12px;
    border-radius: 15px;
    font-size: 14px;
    position: relative;
    word-wrap: break-word;
  }
  .message.sent {
    background-color: #DCF8C6;
    align-self: flex-end;
    border-bottom-right-radius: 2px;
  }
  .message.received {
    background-color: white;
    border: 1px solid #ccc;
    border-bottom-left-radius: 2px;
  }
  .message.dark.sent {
    background-color: #054640;
    color: #a2fba2;
  }
  .message.dark.received {
    background-color: #3A3B3C;
    border-color: #555;
    color: #ddd;
  }
  .chat-messages {
    display: flex;
    flex-direction: column;
    padding: 10px;
    height: 350px;
    overflow-y: auto;
    background: #e5ddd5;
    border-radius: 10px;
    margin-bottom: 10px;
  }
  body.dark .chat-messages {
    background: #121212;
  }
  .chat-input-area {
    display: flex;
    gap: 10px;
  }
  .chat-input-area textarea {
    resize: none;
    flex-grow: 1;
    height: 60px;
  }
  .chat-input-area button {
    width: 80px;
  }
</style>
</head>
<body>

<header>
  <h2>Xinn Social</h2>
</header>

<div id="app"></div>

<nav id="navBar" style="display:none; position: fixed; bottom: 0; left: 0; right: 0;">
  <button id="navFeed" title="Feed" onclick="showPage('feed')"><span class="material-icons">home</span></button>
  <button id="navFriends" title="Friends" onclick="showPage('friends')"><span class="material-icons">group</span></button>
  <button id="navChat" title="Chat" onclick="showPage('chat')"><span class="material-icons">chat</span></button>
  <button id="navProfile" title="Profile" onclick="showPage('profile')"><span class="material-icons">person</span></button>
  <button id="navSettings" title="Settings" onclick="showPage('settings')"><span class="material-icons">settings</span></button>
  <button id="navNoti" title="Notifications" style="position: relative;" onclick="toggleNotifications()">
    <span class="material-icons">notifications</span>
    <span id="notificationBadge"></span>
  </button>
</nav>

<div id="notiDropdown"></div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
  // Your Firebase config:
  const firebaseConfig = {
    apiKey: "AIzaSyDhVRhDDCM8vFbNe9f1Ag4Xn0901igl4s0",
    authDomain: "xinn-social.firebaseapp.com",
    projectId: "xinn-social",
    storageBucket: "xinn-social.firebasestorage.app",
    messagingSenderId: "860868128981",
    appId: "1:860868128981:web:a5cb9b2cb32b10077e725c",
    measurementId: "G-2ZFNQND35B"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Globals
  let currentUser = null; // will hold logged in user
  let currentChatUserId = null; // currently chatting friend uid

  // ========== AUTH ==========

  function showLogin() {
    document.getElementById('app').innerHTML = `
      <div class="container card">
        <h3>Login to Xinn Social</h3>
        <input type="email" id="email" placeholder="Email (@xinn.lab only)" />
        <input type="password" id="password" placeholder="Password" />
        <button onclick="login()">Login</button>
        <p>Or <a href="#" onclick="renderRegister()">Register</a></p>
      </div>
    `;
  }

  function renderRegister() {
    document.getElementById('app').innerHTML = `
      <div class="container card">
        <h3>Create Account</h3>
        <input type="text" id="name" placeholder="Full Name" />
        <input type="number" id="age" placeholder="Age" />
        <textarea id="bio" placeholder="Bio"></textarea>
        <input type="email" id="email" placeholder="Email (@xinn.lab only)" />
        <input type="password" id="password" placeholder="Password" />
        <button onclick="register()">Register</button>
        <p>Already have an account? <a href="#" onclick="showLogin()">Login</a></p>
      </div>
    `;
  }

  function login() {
    const email = document.getElementById('email').value.trim();
    const pass = document.getElementById('password').value.trim();
    if (!email.endsWith('@xinn.lab')) {
      alert('Email must end with @xinn.lab');
      return;
    }
    auth.signInWithEmailAndPassword(email, pass)
      .catch(e => alert(e.message));
  }

  function register() {
    const name = document.getElementById('name').value.trim();
    const age = document.getElementById('age').value.trim();
    const bio = document.getElementById('bio').value.trim();
    const email = document.getElementById('email').value.trim();
    const pass = document.getElementById('password').value.trim();
    if (!email.endsWith('@xinn.lab')) {
      alert('Email must end with @xinn.lab');
      return;
    }
    auth.createUserWithEmailAndPassword(email, pass)
      .then(cred => {
        // Create user doc in Firestore
        return db.collection('users').doc(cred.user.uid).set({ name, age, bio, email });
      })
      .catch(e => alert(e.message));
  }

  // ========== NAVIGATION ==========

  function setActiveNav(btnId) {
    const btns = document.querySelectorAll('nav button');
    btns.forEach(b => b.classList.remove('active'));
    const activeBtn = document.getElementById(btnId);
    if(activeBtn) activeBtn.classList.add('active');
  }

  function showPage(page) {
    if (!currentUser) {
      showLogin();
      return;
    }
    if(page === 'feed') {
      setActiveNav('navFeed');
      renderFeed();
    } else if(page === 'friends') {
      setActiveNav('navFriends');
      renderFriends();
    } else if(page === 'chat') {
      setActiveNav('navChat');
      renderChat();
    } else if(page === 'profile') {
      setActiveNav('navProfile');
      renderProfile(currentUser.uid);
    } else if(page === 'settings') {
      setActiveNav('navSettings');
      renderSettings();
    }
  }

  // ========== FEED ==========

  function renderFeed() {
    document.getElementById('app').innerHTML = `
      <div class="container">
        <div class="card">
          <textarea id="postContent" placeholder="What's on your mind?" style="resize:none;"></textarea>
          <button onclick="createPost()">Post</button>
        </div>
        <div id="feedPosts"></div>
      </div>
    `;
    loadPosts();
  }

  function createPost() {
    const content = document.getElementById('postContent').value.trim();
    if (!content) return alert("Post content can't be empty");
    db.collection('posts').add({
      content,
      uid: currentUser.uid,
      likes: [],
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById('postContent').value = '';
  }

  function loadPosts() {
    db.collection('posts').orderBy('timestamp', 'desc').limit(20).onSnapshot(async snap => {
      let html = '';
      for (const doc of snap.docs) {
        const p = doc.data();
        const userDoc = await db.collection('users').doc(p.uid).get();
        const user = userDoc.data() || { name: "Unknown" };
        const time = p.timestamp ? p.timestamp.toDate().toLocaleString() : "Just now";
        html += `
          <div class="card" style="padding:12px;">
            <div style="display:flex; align-items:center; margin-bottom:8px; cursor:pointer;" onclick="visitProfile('${p.uid}')">
              <span class="material-icons" style="font-size:36px; color:#2196F3; margin-right:10px;">account_circle</span>
              <div>
                <strong>${user.name}</strong><br>
                <small style="color:gray;">${time}</small>
              </div>
            </div>
            <div style="margin:10px 0; font-size:15px;">${escapeHTML(p.content)}</div>
            <hr style="margin:8px 0;" />
            <button onclick="toggleLike('${doc.id}', event)" style="background:none; color:#2196F3; border:none; cursor:pointer;">
              👍 Like (${p.likes.length})
            </button>
          </div>
        `;
      }
      document.getElementById('feedPosts').innerHTML = html;
    });
  }

  function toggleLike(postId, event) {
    event.stopPropagation(); // prevent triggering parent click
    const ref = db.collection('posts').doc(postId);
    ref.get().then(doc => {
      const data = doc.data();
      let likes = data.likes || [];
      if (likes.includes(currentUser.uid)) {
        likes = likes.filter(id => id !== currentUser.uid);
      } else {
        likes.push(currentUser.uid);
      }
      ref.update({ likes });
    });
  }

  // ========== FRIENDS ==========

  /*
    Firestore structure:
    - Collection "users" with user docs
    - Subcollection "friendRequests" under each user:
      docId = requesterUid
      fields: status = 'pending'|'accepted'|'declined', timestamp
    - Subcollection "friends" under each user:
      docId = friendUid
  */

  function renderFriends() {
    document.getElementById('app').innerHTML = `
      <div class="container">
        <input type="text" id="searchFriendInput" placeholder="Search users by name or email" />
        <button onclick="searchFriends()">Search</button>
        <div id="searchResults" style="margin-top: 10px;"></div>
        <h3>Your Friends</h3>
        <div id="friendList" class="friend-list"></div>
        <h3>Pending Friend Requests</h3>
        <div id="pendingRequests"></div>
      </div>
    `;
    loadFriendList();
    loadPendingRequests();
  }

  async function searchFriends() {
    const q = document.getElementById('searchFriendInput').value.trim().toLowerCase();
    const resultsDiv = document.getElementById('searchResults');
    resultsDiv.innerHTML = 'Searching...';

    if (!q) {
      resultsDiv.innerHTML = '<p>Please enter a search term</p>';
      return;
    }

    // Search users collection by name or email (case-insensitive)
    const results = [];
    try {
      const snapshot = await db.collection('users').get();
      snapshot.forEach(doc => {
        const data = doc.data();
        if ((data.name && data.name.toLowerCase().includes(q)) ||
            (data.email && data.email.toLowerCase().includes(q))) {
          results.push({ uid: doc.id, ...data });
        }
      });
      if(results.length === 0) {
        resultsDiv.innerHTML = '<p>No users found.</p>';
        return;
      }
      // Filter out self and existing friends and requests
      const filtered = [];
      for (const user of results) {
        if(user.uid === currentUser.uid) continue;
        if(await isFriend(user.uid)) continue;
        if(await hasPendingRequestWith(user.uid)) continue;
        filtered.push(user);
      }
      if(filtered.length === 0) {
        resultsDiv.innerHTML = '<p>No new users to add.</p>';
        return;
      }
      let html = '<ul style="list-style:none; padding-left:0;">';
      filtered.forEach(u => {
        html += `
          <li style="margin-bottom:10px;">
            <strong>${escapeHTML(u.name)}</strong> (${escapeHTML(u.email)}) 
            <button onclick="sendFriendRequest('${u.uid}')">Add Friend</button>
          </li>`;
      });
      html += '</ul>';
      resultsDiv.innerHTML = html;
    } catch (e) {
      resultsDiv.innerHTML = '<p>Error searching users: ' + e.message + '</p>';
    }
  }

  async function isFriend(uid) {
    const doc = await db.collection('friends').doc(currentUser.uid)
      .collection('userFriends').doc(uid).get();
    return doc.exists;
  }

  async function hasPendingRequestWith(uid) {
    const sent = await db.collection('friendRequests').doc(currentUser.uid)
      .collection('sentRequests').doc(uid).get();
    const received = await db.collection('friendRequests').doc(currentUser.uid)
      .collection('receivedRequests').doc(uid).get();
    return (sent.exists && sent.data().status === 'pending') || (received.exists && received.data().status === 'pending');
  }

  async function sendFriendRequest(targetUid) {
    if (targetUid === currentUser.uid) return alert("You can't friend yourself!");
    try {
      // Add request to receiver's receivedRequests
      await db.collection('friendRequests').doc(targetUid).collection('receivedRequests').doc(currentUser.uid).set({
        status: 'pending',
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        fromUid: currentUser.uid
      });
      // Add request to sender's sentRequests
      await db.collection('friendRequests').doc(currentUser.uid).collection('sentRequests').doc(targetUid).set({
        status: 'pending',
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        toUid: targetUid
      });
      alert("Friend request sent!");
      renderFriends();
    } catch (e) {
      alert("Error sending friend request: " + e.message);
    }
  }

  async function loadFriendList() {
    const listDiv = document.getElementById('friendList');
    listDiv.innerHTML = 'Loading friends...';
    try {
      const snap = await db.collection('friends').doc(currentUser.uid).collection('userFriends').get();
      if(snap.empty) {
        listDiv.innerHTML = '<p>No friends yet</p>';
        return;
      }
      let html = '';
      for(const doc of snap.docs) {
        const f = doc.data();
        const userDoc = await db.collection('users').doc(doc.id).get();
        const user = userDoc.data() || { name: "Unknown" };
        html += `<div class="friend-avatar" title="${escapeHTML(user.name)}" onclick="visitProfile('${doc.id}')">
          ${user.name.charAt(0).toUpperCase()}
        </div>`;
      }
      listDiv.innerHTML = html;
    } catch(e) {
      listDiv.innerHTML = '<p>Error loading friends: '+e.message+'</p>';
    }
  }

  async function loadPendingRequests() {
    const pendingDiv = document.getElementById('pendingRequests');
    pendingDiv.innerHTML = 'Loading pending requests...';
    try {
      const snap = await db.collection('friendRequests').doc(currentUser.uid).collection('receivedRequests')
        .where('status', '==', 'pending').orderBy('timestamp', 'desc').get();
      if(snap.empty) {
        pendingDiv.innerHTML = '<p>No pending friend requests</p>';
        return;
      }
      let html = '';
      for(const doc of snap.docs) {
        const req = doc.data();
        const fromUserDoc = await db.collection('users').doc(doc.id).get();
        const fromUser = fromUserDoc.data() || { name: "Unknown" };
        html += `
          <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <strong>${escapeHTML(fromUser.name)}</strong> wants to be your friend
            </div>
            <div>
              <button onclick="respondFriendRequest('${doc.id}', true)">Accept</button>
              <button class="danger" onclick="respondFriendRequest('${doc.id}', false)">Decline</button>
            </div>
          </div>`;
      }
      pendingDiv.innerHTML = html;
    } catch(e) {
      pendingDiv.innerHTML = '<p>Error loading requests: '+e.message+'</p>';
    }
  }

  async function respondFriendRequest(requesterUid, accept) {
    try {
      if (accept) {
        // Add both to friends collections
        await db.collection('friends').doc(currentUser.uid).collection('userFriends').doc(requesterUid).set({ since: firebase.firestore.FieldValue.serverTimestamp() });
        await db.collection('friends').doc(requesterUid).collection('userFriends').doc(currentUser.uid).set({ since: firebase.firestore.FieldValue.serverTimestamp() });
      }
      // Update status in receivedRequests and sentRequests
      await db.collection('friendRequests').doc(currentUser.uid).collection('receivedRequests').doc(requesterUid).update({ status: accept ? 'accepted' : 'declined' });
      await db.collection('friendRequests').doc(requesterUid).collection('sentRequests').doc(currentUser.uid).update({ status: accept ? 'accepted' : 'declined' });

      alert(accept ? "Friend request accepted!" : "Friend request declined");
      renderFriends();
    } catch(e) {
      alert("Error updating request: "+e.message);
    }
  }

  // ========== PROFILE ==========

  function renderProfile(uid) {
    document.getElementById('app').innerHTML = '<div class="container card">Loading profile...</div>';
    db.collection('users').doc(uid).get().then(doc => {
      if(!doc.exists) {
        document.getElementById('app').innerHTML = '<div class="container card">User not found</div>';
        return;
      }
      const u = doc.data();
      document.getElementById('app').innerHTML = `
        <div class="container card">
          <h3>${escapeHTML(u.name)}</h3>
          <p><strong>Age:</strong> ${escapeHTML(u.age)}</p>
          <p><strong>Bio:</strong> ${escapeHTML(u.bio)}</p>
          ${uid === currentUser.uid ? `<button onclick="editProfile()">Edit Profile</button>` : ''}
          <h4>Friends</h4>
          <div id="profileFriendList" class="friend-list">Loading friends...</div>
        </div>
      `;
      loadProfileFriends(uid);
    });
  }

  function editProfile() {
    db.collection('users').doc(currentUser.uid).get().then(doc => {
      const u = doc.data();
      document.getElementById('app').innerHTML = `
        <div class="container card">
          <input id="name" value="${escapeHTML(u.name)}" placeholder="Full Name" />
          <input id="age" value="${escapeHTML(u.age)}" placeholder="Age" />
          <textarea id="bio" placeholder="Bio">${escapeHTML(u.bio)}</textarea>
          <button onclick="saveProfile()">Save</button>
          <button onclick="showPage('profile')">Cancel</button>
        </div>
      `;
    });
  }

  function saveProfile() {
    const name = document.getElementById('name').value.trim();
    const age = document.getElementById('age').value.trim();
    const bio = document.getElementById('bio').value.trim();
    db.collection('users').doc(currentUser.uid).update({ name, age, bio }).then(() => {
      alert('Profile updated');
      renderProfile(currentUser.uid);
    }).catch(e => alert(e.message));
  }

  async function loadProfileFriends(uid) {
    const listDiv = document.getElementById('profileFriendList');
    listDiv.innerHTML = 'Loading friends...';
    try {
      const snap = await db.collection('friends').doc(uid).collection('userFriends').get();
      if(snap.empty) {
        listDiv.innerHTML = '<p>No friends yet</p>';
        return;
      }
      let html = '';
      for(const doc of snap.docs) {
        const f = doc.data();
        const userDoc = await db.collection('users').doc(doc.id).get();
        const user = userDoc.data() || { name: "Unknown" };
        html += `<div class="friend-avatar" title="${escapeHTML(user.name)}" onclick="visitProfile('${doc.id}')">
          ${user.name.charAt(0).toUpperCase()}
        </div>`;
      }
      listDiv.innerHTML = html;
    } catch(e) {
      listDiv.innerHTML = '<p>Error loading friends: '+e.message+'</p>';
    }
  }

  // ========== CHAT ==========

  /*
    Firestore chat structure:
    Collection: chats
      docId: userA_userB (sorted uids joined by '_')
      subcollection: messages
        docs: messageId with fields:
          from, to, content, timestamp
  */

  function renderChat() {
    if(!currentUser) return;
    document.getElementById('app').innerHTML = `
      <div class="container">
        <h3>Chat with friends</h3>
        <div id="chatFriendList" class="friend-list" style="margin-bottom:10px;"></div>
        <div id="chatArea" style="display:none;">
          <h4 id="chatWithName"></h4>
          <div class="chat-messages" id="chatMessages"></div>
          <div class="chat-input-area">
            <textarea id="chatInput" placeholder="Type a message..."></textarea>
            <button onclick="sendMessage()">Send</button>
          </div>
          <button onclick="closeChat()">Close Chat</button>
        </div>
      </div>
    `;
    loadChatFriends();
  }

  async function loadChatFriends() {
    const div = document.getElementById('chatFriendList');
    div.innerHTML = 'Loading friends...';
    try {
      const snap = await db.collection('friends').doc(currentUser.uid).collection('userFriends').get();
      if(snap.empty) {
        div.innerHTML = '<p>No friends to chat with.</p>';
        return;
      }
      let html = '';
      for(const doc of snap.docs) {
        const userDoc = await db.collection('users').doc(doc.id).get();
        const user = userDoc.data() || { name: "Unknown" };
        html += `<div class="friend-avatar" title="${escapeHTML(user.name)}" onclick="openChat('${doc.id}', '${escapeHTML(user.name)}')">
          ${user.name.charAt(0).toUpperCase()}
        </div>`;
      }
      div.innerHTML = html;
    } catch(e) {
      div.innerHTML = '<p>Error loading chat friends: '+e.message+'</p>';
    }
  }

  let chatListener = null;
  function openChat(friendUid, friendName) {
    currentChatUserId = friendUid;
    document.getElementById('chatArea').style.display = 'block';
    document.getElementById('chatWithName').textContent = `Chat with ${friendName}`;
    document.getElementById('chatMessages').innerHTML = 'Loading messages...';

    if (chatListener) chatListener(); // detach previous listener

    const chatId = getChatId(currentUser.uid, friendUid);
    chatListener = db.collection('chats').doc(chatId).collection('messages')
      .orderBy('timestamp')
      .onSnapshot(snapshot => {
        let html = '';
        snapshot.forEach(doc => {
          const m = doc.data();
          const isSent = m.from === currentUser.uid;
          html += `<div class="message ${isSent ? 'sent' : 'received'} ${document.body.classList.contains('dark') ? 'dark' : ''}">
            ${escapeHTML(m.content)}
          </div>`;
        });
        const chatMessagesDiv = document.getElementById('chatMessages');
        chatMessagesDiv.innerHTML = html;
        chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
      });
  }

  function closeChat() {
    if(chatListener) chatListener();
    currentChatUserId = null;
    document.getElementById('chatArea').style.display = 'none';
  }

  function sendMessage() {
    const input = document.getElementById('chatInput');
    const content = input.value.trim();
    if (!content || !currentChatUserId) return;

    const chatId = getChatId(currentUser.uid, currentChatUserId);
    const msgData = {
      from: currentUser.uid,
      to: currentChatUserId,
      content,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    db.collection('chats').doc(chatId).collection('messages').add(msgData);
    input.value = '';
  }

  function getChatId(uid1, uid2) {
    return [uid1, uid2].sort().join('_');
  }

  // ========== SETTINGS ==========

  function renderSettings() {
    document.getElementById('app').innerHTML = `
      <div class="container card">
        <h3>Settings</h3>
        <button onclick="toggleDarkMode()">Toggle Dark Mode</button>
        <h4>Change Password</h4>
        <input type="password" id="oldPassword" placeholder="Current Password" />
        <input type="password" id="newPassword" placeholder="New Password" />
        <button onclick="changePassword()">Change Password</button>
        <button onclick="logout()">Logout</button>
      </div>
    `;
  }

  function toggleDarkMode() {
    document.body.classList.toggle('dark');
  }

  function changePassword() {
    const oldPass = document.getElementById('oldPassword').value.trim();
    const newPass = document.getElementById('newPassword').value.trim();
    if(!oldPass || !newPass) {
      alert('Please fill both fields');
      return;
    }
    const user = auth.currentUser;
    const cred = firebase.auth.EmailAuthProvider.credential(user.email, oldPass);
    user.reauthenticateWithCredential(cred).then(() => {
      return user.updatePassword(newPass);
    }).then(() => {
      alert('Password changed successfully');
      document.getElementById('oldPassword').value = '';
      document.getElementById('newPassword').value = '';
    }).catch(e => alert('Error: ' + e.message));
  }

  function logout() {
    auth.signOut();
  }

  // ========== NOTIFICATIONS ==========

  let notiOpen = false;
  function toggleNotifications() {
    if(notiOpen) {
      closeNotifications();
    } else {
      openNotifications();
    }
  }

  function openNotifications() {
    if(!currentUser) return;
    notiOpen = true;
    document.getElementById('notiDropdown').style.display = 'block';
    loadNotifications();
  }

  function closeNotifications() {
    notiOpen = false;
    document.getElementById('notiDropdown').style.display = 'none';
  }

  async function loadNotifications() {
    const notiDiv = document.getElementById('notiDropdown');
    notiDiv.innerHTML = 'Loading notifications...';
    try {
      const snap = await db.collection('notifications').doc(currentUser.uid).collection('userNotifications')
        .orderBy('timestamp', 'desc').limit(10).get();
      if(snap.empty) {
        notiDiv.innerHTML = '<p>No notifications</p>';
        updateNotiBadge(0);
        return;
      }
      let unreadCount = 0;
      let html = '';
      snap.forEach(doc => {
        const n = doc.data();
        if(!n.read) unreadCount++;
        html += `<div class="notiItem ${!n.read ? 'unread' : ''}">
          ${escapeHTML(n.text)}
        </div>`;
      });
      notiDiv.innerHTML = html;
      updateNotiBadge(unreadCount);
    } catch(e) {
      notiDiv.innerHTML = '<p>Error loading notifications: '+e.message+'</p>';
    }
  }

  function updateNotiBadge(count) {
    const badge = document.getElementById('notificationBadge');
    if(count > 0) {
      badge.style.display = 'inline-block';
      badge.textContent = count;
    } else {
      badge.style.display = 'none';
    }
  }

  // ========== UTILS ==========

  function escapeHTML(str) {
    if (!str) return '';
    return str.replace(/[&<>"']/g, function(m) {
      return {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[m];
    });
  }

  // Profile visit shortcut
  function visitProfile(uid) {
    showPage('profile');
    renderProfile(uid);
  }

  // ========== INIT ==========

  auth.onAuthStateChanged(user => {
    if(user) {
      currentUser = user;
      document.getElementById('navBar').style.display = 'flex';
      showPage('feed');
    } else {
      currentUser = null;
      document.getElementById('navBar').style.display = 'none';
      showLogin();
    }
  });

</script>
</body>
</html>
