<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Xinn Social</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<style>
  body { font-family: Arial, sans-serif; margin:0; background:#f0f2f5; }
  header { background:#2196F3; color:white; padding:10px; text-align:center; }
  .container { padding:20px; max-width: 600px; margin: 0 auto; }
  .card { background:white; padding:15px; margin:10px 0; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
  input, textarea, button, select {
    width:100%; padding:10px; margin:5px 0; border:1px solid #ccc; border-radius:5px;
    box-sizing: border-box;
  }
  button { background:#2196F3; color:white; border:none; cursor:pointer; }
  nav { position:fixed; bottom:0; left:0; right:0; background:white; display:flex; justify-content:space-around; border-top:1px solid #ccc; padding:10px 0; }
  nav button { background:none; color:#555; font-size: 24px; border:none; cursor:pointer; }
  nav button.active { color:#2196F3; font-weight:bold; }
  /* Friend & Chat styles simplified for brevity */
  #chatWindow { border:1px solid #ccc; border-radius:8px; background:#fff; display:flex; flex-direction: column; height: 500px; }
  #chatMessages { flex-grow:1; overflow-y: auto; padding:10px; }
  .message { margin-bottom:10px; max-width: 75%; padding:8px 12px; border-radius:15px; position: relative; font-size: 14px; line-height: 1.4; }
  .message.you { background:#dcf8c6; margin-left: auto; border-bottom-right-radius: 2px; }
  .message.friend { background:#fff; border:1px solid #ccc; margin-right: auto; border-bottom-left-radius: 2px; }
  .message .actions { margin-top:4px; font-size: 12px; }
  .message .actions button { margin-right: 6px; background:none; border:none; color:#2196F3; cursor:pointer; }
  #chatInputContainer { display:flex; gap: 5px; padding: 10px; border-top: 1px solid #ccc; }
  #chatInput { flex-grow: 1; resize: none; padding: 10px; border-radius: 20px; border: 1px solid #ccc; }
  #sendChatBtn { background:#2196F3; color:white; border:none; padding: 0 16px; border-radius: 20px; cursor:pointer; }
  #emojiPicker { position: absolute; bottom: 60px; right: 20px; background: white; border: 1px solid #ccc; border-radius: 8px; max-width: 250px; max-height: 150px; overflow-y: auto; display:none; padding: 5px; }
  #emojiPicker span { cursor: pointer; font-size: 20px; margin: 3px; user-select:none; }
  #typingIndicator { font-style: italic; font-size: 12px; color: #555; height: 18px; margin-left: 12px; }
  #replyPreview { background:#eee; padding: 5px 10px; border-radius: 10px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
  #replyPreview button { background: none; border: none; font-weight: bold; cursor: pointer; }
</style>
</head>
<body>

<header><h2>Xinn Social</h2></header>

<div id="app"></div>

<nav id="navBar" style="display:none;">
  <button onclick="showPage('feed')" id="navFeed" title="Feed"><span class="material-icons">home</span></button>
  <button onclick="showPage('friends')" id="navFriends" title="Friends"><span class="material-icons">group</span></button>
  <button onclick="showPage('chat')" id="navChat" title="Chat"><span class="material-icons">chat</span></button>
  <button onclick="showPage('profile')" id="navProfile" title="Profile"><span class="material-icons">person</span></button>
  <button onclick="showPage('settings')" id="navSettings" title="Settings"><span class="material-icons">settings</span></button>
</nav>

<div id="emojiPicker"></div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCGN7t5FjDeJ-ewm7S_9z0VJrRSggTaJ2Q",
  authDomain: "coin-base-by-hector.firebaseapp.com",
  databaseURL: "https://coin-base-by-hector-default-rtdb.firebaseio.com",
  projectId: "coin-base-by-hector",
  storageBucket: "coin-base-by-hector.firebasestorage.app",
  messagingSenderId: "398789890422",
  appId: "1:398789890422:web:ed6a928037b24be2e36a57",
  measurementId: "G-SGJJM5K3G9"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

function getCurrentUid() {
  return auth.currentUser ? auth.currentUser.uid : null;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function renderLogin() {
  document.getElementById('app').innerHTML = `
    <div class="container card">
      <h3>Login to Xinn Social</h3>
      <input type="email" id="email" placeholder="Email (@xinn.lab only)" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="login()">Login</button>
      <p>Or <a href="#" onclick="renderRegister()">Register</a></p>
    </div>`;
}

function renderRegister() {
  document.getElementById('app').innerHTML = `
    <div class="container card">
      <h3>Create Account</h3>
      <input type="text" id="name" placeholder="Full Name" />
      <input type="number" id="age" placeholder="Age" />
      <textarea id="bio" placeholder="Bio"></textarea>
      <input type="email" id="email" placeholder="Email (@xinn.lab only)" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="register()">Register</button>
      <p>Already have an account? <a href="#" onclick="renderLogin()">Login</a></p>
    </div>`;
}

function login() {
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value.trim();
  if (!email.endsWith('@xinn.lab')) {
    alert('Email must end with @xinn.lab');
    return;
  }
  auth.signInWithEmailAndPassword(email, pass).catch(e => alert(e.message));
}

function register() {
  const name = document.getElementById('name').value.trim();
  const age = document.getElementById('age').value.trim();
  const bio = document.getElementById('bio').value.trim();
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value.trim();
  if (!email.endsWith('@xinn.lab')) {
    alert('Email must end with @xinn.lab');
    return;
  }
  auth.createUserWithEmailAndPassword(email, pass)
    .then(cred => {
      return db.collection('users').doc(cred.user.uid).set({ 
        name, 
        name_lower: name.toLowerCase(),
        age, 
        bio, 
        email 
      });
    })
    .catch(e => alert(e.message));
}

function renderFeed() {
  document.getElementById('app').innerHTML = `
    <div class="container">
      <div class="card">
        <textarea id="postContent" placeholder="What's on your mind?" style="resize:none;"></textarea>
        <button onclick="createPost()">Post</button>
      </div>
      <div id="feedPosts"></div>
    </div>`;
  loadPosts();
}

function createPost() {
  const content = document.getElementById('postContent').value.trim();
  if (!content) return;
  db.collection('posts').add({
    content,
    uid: getCurrentUid(),
    likes: [],
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
  document.getElementById('postContent').value = '';
}

function loadPosts() {
  db.collection('posts').orderBy('timestamp', 'desc').onSnapshot(snap => {
    let html = '';
    let postPromises = [];
    snap.forEach(doc => {
      const p = doc.data();
      postPromises.push(
        db.collection('users').doc(p.uid).get().then(userDoc => {
          const user = userDoc.data() || { name: "Unknown" };
          const time = p.timestamp ? p.timestamp.toDate().toLocaleString() : "Just now";
          html += `
            <div class="card" style="padding: 12px;">
              <div style="display:flex;align-items:center;margin-bottom:8px;">
                <span class="material-icons" style="font-size:36px;color:#2196F3;margin-right:10px;">account_circle</span>
                <div>
                  <strong>${escapeHtml(user.name)}</strong><br>
                  <small style="color:gray;">${time}</small>
                </div>
              </div>
              <div style="margin:10px 0;font-size:15px;">${escapeHtml(p.content)}</div>
              <hr style="margin:8px 0;">
              <button onclick="toggleLike('${doc.id}')" style="background:none;color:#2196F3;border:none;cursor:pointer;">
                ğŸ‘ Like (${p.likes.length})
              </button>
            </div>`;
        })
      );
    });
    Promise.all(postPromises).then(() => {
      document.getElementById('feedPosts').innerHTML = html;
    });
  });
}

function toggleLike(postId) {
  const ref = db.collection('posts').doc(postId);
  ref.get().then(doc => {
    const data = doc.data();
    let likes = data.likes || [];
    const uid = getCurrentUid();
    if (likes.includes(uid)) {
      likes = likes.filter(id => id !== uid);
    } else {
      likes.push(uid);
    }
    ref.update({ likes });
  });
}

function renderProfile() {
  db.collection('users').doc(getCurrentUid()).get().then(doc => {
    const u = doc.data();
    document.getElementById('app').innerHTML = `
      <div class="container">
        <div class="card">
          <h3>${escapeHtml(u.name)}</h3>
          <p>Age: ${escapeHtml(u.age)}</p>
          <p>Bio: ${escapeHtml(u.bio)}</p>
          <button onclick="editProfile()">Edit Profile</button>
        </div>
      </div>`;
  });
}

function editProfile() {
  db.collection('users').doc(getCurrentUid()).get().then(doc => {
    const u = doc.data();
    document.getElementById('app').innerHTML = `
      <div class="container card">
        <input id="name" value="${escapeHtml(u.name)}" placeholder="Full Name" />
        <input id="age" value="${escapeHtml(u.age)}" placeholder="Age" />
        <textarea id="bio" placeholder="Bio">${escapeHtml(u.bio)}</textarea>
        <button onclick="saveProfile()">Save</button>
      </div>`;
  });
}

function saveProfile() {
  const name = document.getElementById('name').value.trim();
  const age = document.getElementById('age').value.trim();
  const bio = document.getElementById('bio').value.trim();

  db.collection('users').doc(getCurrentUid()).update({ 
    name, 
    name_lower: name.toLowerCase(), // important for search
    age, 
    bio 
  });

  renderProfile();
}

// ------------- FRIEND SYSTEM -----------------

let friendSearchTimeout = null;

function renderFriends() {
  document.getElementById('app').innerHTML = `
    <div class="container card">
      <h3>Friends</h3>
      <input id="searchInput" type="text" placeholder="Search friends by name" oninput="searchUsers()" autocomplete="off" />
      <div id="searchResults"></div>
      <h4>Your Friends</h4>
      <div id="friendList"></div>
      <h4>Friend Requests</h4>
      <div id="friendRequests"></div>
    </div>`;

  loadFriends();
  loadFriendRequests();
}

function searchUsers() {
  const query = document.getElementById('searchInput').value.trim().toLowerCase();
  if (friendSearchTimeout) clearTimeout(friendSearchTimeout);
  if (!query) {
    document.getElementById('searchResults').innerHTML = '';
    return;
  }
  friendSearchTimeout = setTimeout(() => {
    db.collection('users')
      .where('name_lower', '>=', query)
      .where('name_lower', '<=', query + '\uf8ff')
      .limit(10)
      .get()
      .then(snapshot => {
        const uid = getCurrentUid();
        let html = '';
        snapshot.forEach(doc => {
          if (doc.id === uid) return; // Don't show yourself
          const user = doc.data();
          html += `
            <div style="padding:6px; border-bottom:1px solid #ccc;">
              <strong>${escapeHtml(user.name)}</strong><br/>
              <small>${escapeHtml(user.email)}</small><br/>
              <button onclick="sendFriendRequest('${doc.id}')">Send Friend Request</button>
            </div>`;
        });
        document.getElementById('searchResults').innerHTML = html || '<p>No users found</p>';
      });
  }, 300);
}

function sendFriendRequest(toUid) {
  const fromUid = getCurrentUid();
  if (!fromUid) return;

  // Write friend request in Firestore (for example, under collection 'friendRequests')
  const requestDoc = db.collection('friendRequests').doc(fromUid + '_' + toUid);
  requestDoc.get().then(doc => {
    if (doc.exists) {
      alert('Friend request already sent or pending.');
      return;
    }
    requestDoc.set({
      from: fromUid,
      to: toUid,
      status: 'pending',
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
      alert('Friend request sent!');
      loadFriendRequests();
    }).catch(e => alert('Error sending friend request: ' + e.message));
  });
}

function loadFriendRequests() {
  const uid = getCurrentUid();
  db.collection('friendRequests')
    .where('to', '==', uid)
    .where('status', '==', 'pending')
    .orderBy('timestamp', 'desc')
    .onSnapshot(snapshot => {
      let html = '';
      snapshot.forEach(doc => {
        const req = doc.data();
        html += `
          <div style="padding:6px; border-bottom:1px solid #ccc;">
            <strong>Friend request from:</strong> <span id="reqUserName${doc.id}">Loading...</span><br/>
            <button onclick="acceptFriendRequest('${doc.id}', '${req.from}')">Accept</button>
            <button onclick="declineFriendRequest('${doc.id}')">Decline</button>
          </div>`;
        // Load sender name
        db.collection('users').doc(req.from).get().then(userDoc => {
          const nameSpan = document.getElementById('reqUserName' + doc.id);
          if (nameSpan && userDoc.exists) {
            nameSpan.textContent = userDoc.data().name;
          }
        });
      });
      if (!html) html = '<p>No pending friend requests.</p>';
      document.getElementById('friendRequests').innerHTML = html;
    });
}

function acceptFriendRequest(requestId, fromUid) {
  const uid = getCurrentUid();
  if (!uid) return;
  const batch = db.batch();

  // Add each other as friends (simplified friend list in collection 'friends', document = user id, array 'friends' = uids)
  const userFriendsRef = db.collection('friends').doc(uid);
  const fromFriendsRef = db.collection('friends').doc(fromUid);
  batch.set(userFriendsRef, { friends: firebase.firestore.FieldValue.arrayUnion(fromUid) }, { merge: true });
  batch.set(fromFriendsRef, { friends: firebase.firestore.FieldValue.arrayUnion(uid) }, { merge: true });

  // Update friend request status to accepted
  const reqRef = db.collection('friendRequests').doc(requestId);
  batch.update(reqRef, { status: 'accepted' });

  batch.commit().then(() => {
    alert('Friend request accepted!');
  });
}

function declineFriendRequest(requestId) {
  db.collection('friendRequests').doc(requestId).update({ status: 'declined' })
    .then(() => {
      alert('Friend request declined.');
    });
}

function loadFriends() {
  const uid = getCurrentUid();
  db.collection('friends').doc(uid).onSnapshot(doc => {
    let html = '';
    if (doc.exists && doc.data().friends && doc.data().friends.length > 0) {
      doc.data().friends.forEach(friendUid => {
        db.collection('users').doc(friendUid).get().then(userDoc => {
          if (!userDoc.exists) return;
          html += `
            <div style="padding:6px; border-bottom:1px solid #ccc;">
              <strong>${escapeHtml(userDoc.data().name)}</strong><br/>
              <small>${escapeHtml(userDoc.data().email)}</small><br/>
              <button onclick="removeFriend('${friendUid}')">Remove Friend</button>
              <button onclick="startChatWith('${friendUid}', '${escapeHtml(userDoc.data().name)}')">Chat</button>
            </div>`;
          document.getElementById('friendList').innerHTML = html;
        });
      });
    } else {
      html = '<p>You have no friends yet.</p>';
      document.getElementById('friendList').innerHTML = html;
    }
  });
}

function removeFriend(friendUid) {
  const uid = getCurrentUid();
  if (!uid) return;
  const batch = db.batch();
  const userFriendsRef = db.collection('friends').doc(uid);
  const friendFriendsRef = db.collection('friends').doc(friendUid);
  batch.update(userFriendsRef, { friends: firebase.firestore.FieldValue.arrayRemove(friendUid) });
  batch.update(friendFriendsRef, { friends: firebase.firestore.FieldValue.arrayRemove(uid) });
  batch.commit().then(() => {
    alert('Friend removed.');
    loadFriends();
  });
}

// -------------- CHAT SYSTEM ------------------

let currentChatFriendUid = null;
let currentChatFriendName = '';
let editingMessageId = null;
let replyingMessage = null;
let typingRef = null;
let typingTimeout = null;

const emojis = ["ğŸ˜€","ğŸ˜ƒ","ğŸ˜„","ğŸ˜","ğŸ˜†","ğŸ˜…","ğŸ˜‚","ğŸ¤£","ğŸ˜Š","ğŸ˜‡","ğŸ™‚","ğŸ™ƒ","ğŸ˜‰","ğŸ˜Œ","ğŸ˜","ğŸ¥°","ğŸ˜˜","ğŸ˜—","ğŸ˜™","ğŸ˜š","ğŸ˜‹","ğŸ˜›","ğŸ˜","ğŸ˜œ","ğŸ¤ª","ğŸ¤¨","ğŸ§","ğŸ¤“","ğŸ˜","ğŸ¥³","ğŸ˜","ğŸ˜’","ğŸ˜","ğŸ˜”","ğŸ˜Ÿ","ğŸ˜•","ğŸ™","â˜¹ï¸","ğŸ˜£","ğŸ˜–","ğŸ˜«","ğŸ˜©","ğŸ¥º","ğŸ˜¢","ğŸ˜­","ğŸ˜¤","ğŸ˜ ","ğŸ˜¡","ğŸ¤¬"];

function renderChat() {
  if (!currentChatFriendUid) {
    document.getElementById('app').innerHTML = `
      <div class="container card">
        <h3>Chat</h3>
        <p>Select a friend to start chatting.</p>
      </div>`;
    return;
  }

  document.getElementById('app').innerHTML = `
    <div class="container card" style="max-width: 600px;">
      <h3>Chat with ${escapeHtml(currentChatFriendName)}</h3>
      <div id="chatWindow">
        <div id="chatMessages"></div>
        <div id="typingIndicator"></div>
        <div id="replyPreview" style="display:none;">
          Replying to: <span id="replyText"></span> <button onclick="cancelReply()">Ã—</button>
        </div>
        <div id="chatInputContainer">
          <button onclick="toggleEmojiPicker()" title="Toggle Emoji Picker">ğŸ˜€</button>
          <textarea id="chatInput" rows="2" placeholder="Type a message..." oninput="onChatInput()"></textarea>
          <button id="sendChatBtn" onclick="sendMessage()" disabled>Send</button>
        </div>
      </div>
    </div>`;

  renderEmojiPicker();
  renderMessages();
}

function getChatId(uid1, uid2) {
  return uid1 < uid2 ? uid1 + '_' + uid2 : uid2 + '_' + uid1;
}

function renderMessages() {
  const uid = getCurrentUid();
  if (!uid || !currentChatFriendUid) return;

  const chatId = getChatId(uid, currentChatFriendUid);
  const chatMessagesDiv = document.getElementById('chatMessages');
  chatMessagesDiv.innerHTML = 'Loading messages...';

  if (typingRef) typingRef(); // unsubscribe previous typing listener

  db.collection('chats').doc(chatId).collection('messages')
    .orderBy('timestamp')
    .onSnapshot(snapshot => {
      chatMessagesDiv.innerHTML = '';
      snapshot.forEach(doc => {
        const msg = doc.data();
        const isYou = msg.sender === uid;

        const msgDiv = document.createElement('div');
        msgDiv.className = 'message ' + (isYou ? 'you' : 'friend');

        if (msg.replyTo) {
          const replyDiv = document.createElement('div');
          replyDiv.className = 'reply-to';
          replyDiv.textContent = 'Reply to: ' + msg.replyText;
          replyDiv.style.fontSize = '12px';
          replyDiv.style.color = '#666';
          replyDiv.style.marginBottom = '4px';
          msgDiv.appendChild(replyDiv);
        }

        const msgText = document.createElement('div');
        msgText.innerHTML = escapeHtml(msg.text);
        msgDiv.appendChild(msgText);

        const time = msg.timestamp ? msg.timestamp.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
        const timeSpan = document.createElement('small');
        timeSpan.textContent = time;
        timeSpan.style.marginLeft = '10px';
        timeSpan.style.color = '#555';

        if (isYou && msg.readBy && msg.readBy.includes(currentChatFriendUid)) {
          const readSpan = document.createElement('span');
          readSpan.className = 'read-receipt';
          readSpan.textContent = ' âœ“âœ“';
          readSpan.style.color = '#4fc3f7';
          readSpan.style.fontWeight = 'bold';
          timeSpan.appendChild(readSpan);
        }

        msgDiv.appendChild(timeSpan);

        // Edit & Reply buttons
        if (isYou) {
          const actionsDiv = document.createElement('div');
          actionsDiv.className = 'actions';
          const editBtn = document.createElement('button');
          editBtn.textContent = 'Edit';
          editBtn.onclick = () => startEditMessage(doc.id, msg.text);
          const replyBtn = document.createElement('button');
          replyBtn.textContent = 'Reply';
          replyBtn.onclick = () => startReplyMessage(doc.id, msg.text);
          actionsDiv.appendChild(editBtn);
          actionsDiv.appendChild(replyBtn);
          msgDiv.appendChild(actionsDiv);
        } else {
          const actionsDiv = document.createElement('div');
          actionsDiv.className = 'actions';
          const replyBtn = document.createElement('button');
          replyBtn.textContent = 'Reply';
          replyBtn.onclick = () => startReplyMessage(doc.id, msg.text);
          actionsDiv.appendChild(replyBtn);
          msgDiv.appendChild(actionsDiv);
        }

        chatMessagesDiv.appendChild(msgDiv);
      });

      // Scroll to bottom on new message
      chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
    });

  setupTypingListener();
}

function startEditMessage(messageId, currentText) {
  editingMessageId = messageId;
  document.getElementById('chatInput').value = currentText;
  document.getElementById('sendChatBtn').textContent = 'Save';
  document.getElementById('chatInput').focus();
}

function startReplyMessage(messageId, messageText) {
  replyingMessage = { id: messageId, text: messageText };
  const replyPreview = document.getElementById('replyPreview');
  const replyTextSpan = document.getElementById('replyText');
  replyTextSpan.textContent = messageText;
  replyPreview.style.display = 'flex';
  document.getElementById('chatInput').focus();
}

function cancelReply() {
  replyingMessage = null;
  const replyPreview = document.getElementById('replyPreview');
  replyPreview.style.display = 'none';
}

function sendMessage() {
  const uid = getCurrentUid();
  if (!uid || !currentChatFriendUid) return;

  const input = document.getElementById('chatInput');
  let text = input.value.trim();
  if (!text) return;

  const chatId = getChatId(uid, currentChatFriendUid);
  const messagesRef = db.collection('chats').doc(chatId).collection('messages');

  if (editingMessageId) {
    // Save edited message
    messagesRef.doc(editingMessageId).update({
      text,
      edited: true,
      editTimestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    editingMessageId = null;
    document.getElementById('sendChatBtn').textContent = 'Send';
  } else {
    // Send new message
    const messageData = {
      text,
      sender: uid,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      readBy: [uid],
    };
    if (replyingMessage) {
      messageData.replyTo = replyingMessage.id;
      messageData.replyText = replyingMessage.text;
      cancelReply();
    }
    messagesRef.add(messageData);
  }

  input.value = '';
  input.focus();
  document.getElementById('sendChatBtn').disabled = true;
}

function startChatWith(friendUid, friendName) {
  currentChatFriendUid = friendUid;
  currentChatFriendName = friendName;
  showPage('chat');
}

function onChatInput() {
  const input = document.getElementById('chatInput');
  document.getElementById('sendChatBtn').disabled = !input.value.trim();
  sendTypingStatus();
}

// Typing indicator logic
function setupTypingListener() {
  const uid = getCurrentUid();
  const chatId = getChatId(uid, currentChatFriendUid);
  const typingIndicatorDiv = document.getElementById('typingIndicator');

  if (typingRef) typingRef();

  typingRef = db.collection('typing').doc(chatId).onSnapshot(doc => {
    if (!doc.exists) {
      typingIndicatorDiv.textContent = '';
      return;
    }
    const data = doc.data();
    const otherUid = currentChatFriendUid;
    if (data[otherUid]) {
      typingIndicatorDiv.textContent = `${currentChatFriendName} is typing...`;
    } else {
      typingIndicatorDiv.textContent = '';
    }
  });
}

function sendTypingStatus() {
  const uid = getCurrentUid();
  const chatId = getChatId(uid, currentChatFriendUid);
  if (!uid || !chatId) return;

  const typingDocRef = db.collection('typing').doc(chatId);

  typingDocRef.set({
    [uid]: true
  }, { merge: true });

  if (typingTimeout) clearTimeout(typingTimeout);
  typingTimeout = setTimeout(() => {
    typingDocRef.set({
      [uid]: false
    }, { merge: true });
  }, 1500);
}

function renderEmojiPicker() {
  const emojiPicker = document.getElementById('emojiPicker');
  emojiPicker.innerHTML = '';
  emojis.forEach(emoji => {
    const span = document.createElement('span');
    span.textContent = emoji;
    span.onclick = () => {
      const input = document.getElementById('chatInput');
      input.value += emoji;
      input.focus();
      onChatInput();
      emojiPicker.style.display = 'none';
    };
    emojiPicker.appendChild(span);
  });
}

function toggleEmojiPicker() {
  const emojiPicker = document.getElementById('emojiPicker');
  if (emojiPicker.style.display === 'block') {
    emojiPicker.style.display = 'none';
  } else {
    emojiPicker.style.display = 'block';
  }
}

// -------------- SETTINGS ------------------

function renderSettings() {
  document.getElementById('app').innerHTML = `
    <div class="container card">
      <button onclick="auth.signOut()">Logout</button>
    </div>`;
}

function showPage(page) {
  // Update nav active
  document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
  if(page === 'feed') document.getElementById('navFeed').classList.add('active');
  else if(page === 'friends') document.getElementById('navFriends').classList.add('active');
  else if(page === 'chat') document.getElementById('navChat').classList.add('active');
  else if(page === 'profile') document.getElementById('navProfile').classList.add('active');
  else if(page === 'settings') document.getElementById('navSettings').classList.add('active');

  if (page === 'feed') renderFeed();
  else if (page === 'profile') renderProfile();
  else if (page === 'friends') renderFriends();
  else if (page === 'chat') renderChat();
  else if (page === 'settings') renderSettings();
}

auth.onAuthStateChanged(user => {
  if (user) {
    showPage('feed');
    document.getElementById('navBar').style.display = 'flex';
  } else {
    renderLogin();
    document.getElementById('navBar').style.display = 'none';
  }
});
</script>
</body>
</html>
