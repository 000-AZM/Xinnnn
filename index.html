<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Xinn Social</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<style>
  /* Reset & base */
  body, html {
    margin:0; padding:0; background:#f0f2f5; font-family: Arial, sans-serif; height: 100vh;
    display: flex; flex-direction: column;
  }
  header {
    background:#2196F3; color:white; padding:10px; text-align:center; flex-shrink: 0;
  }
  #app {
    flex: 1 1 auto;
    overflow-y: auto;
    padding: 20px;
    max-width: 900px;
    margin: 0 auto;
    width: 100%;
    box-sizing: border-box;
  }
  .card {
    background:white;
    border-radius:8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    padding:15px;
    margin-bottom: 15px;
  }
  input, textarea, button, select {
    width: 100%;
    padding: 10px;
    margin: 6px 0;
    border-radius: 5px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
  button {
    background:#2196F3;
    color:white;
    border:none;
    cursor:pointer;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background:#1976d2;
  }
  nav {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: white;
    border-top: 1px solid #ccc;
    display: flex;
    justify-content: space-around;
    padding: 10px 0;
    flex-shrink: 0;
    z-index: 1000;
  }
  nav button {
    background:none;
    border:none;
    color:#555;
    font-size: 24px;
  }
  nav button.active {
    color:#2196F3;
    font-weight: bold;
  }
  /* Avatar circle */
  .avatar-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #2196F3;
    color: white;
    font-weight: bold;
    font-size: 20px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-right: 10px;
  }
  /* Friend list */
  ul.friend-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  ul.friend-list li {
    display: flex;
    align-items: center;
    padding: 8px 5px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
  }
  ul.friend-list li:hover {
    background: #f9f9f9;
  }
  /* Search results & requests */
  .request-card {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 8px;
    border: 1px solid #ddd;
    border-radius: 6px;
    margin-bottom: 8px;
  }
  .request-card button {
    width: auto;
    padding: 6px 12px;
  }
  /* Chat UI */
  .chat-container {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: #e5ddd5;
    max-height: 400px;
  }
  .chat-message {
    max-width: 70%;
    margin: 8px 0;
    padding: 10px 14px;
    border-radius: 20px;
    font-size: 15px;
    line-height: 1.3;
    position: relative;
    word-wrap: break-word;
  }
  .chat-message.self {
    background: #dcf8c6;
    align-self: flex-end;
    border-bottom-right-radius: 0;
  }
  .chat-message.friend {
    background: white;
    align-self: flex-start;
    border-bottom-left-radius: 0;
  }
  /* Chat input area */
  #chatInput {
    width: 100%;
    border-radius: 20px;
    padding: 12px 16px;
    resize: none;
    border: 1px solid #ccc;
    box-sizing: border-box;
    font-size: 14px;
    margin-top: 10px;
  }
  #sendMsgBtn {
    margin-top: 8px;
    width: 100%;
    border-radius: 20px;
    padding: 12px;
  }
  /* Profile avatar image */
  .profile-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    background: #ccc;
    display: block;
    margin-bottom: 10px;
  }
  /* Edit Profile Modal */
  #editProfileModal {
    display: none;
    position: fixed;
    z-index: 2000;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.4);
    justify-content: center;
    align-items: center;
  }
  #editProfileModal .modal-content {
    background: white;
    padding: 20px;
    border-radius: 8px;
    max-width: 400px;
    width: 90%;
  }
  #editProfileModal .modal-content input[type="file"] {
    padding: 0;
  }
  #editProfileModal .modal-header {
    font-weight: bold;
    margin-bottom: 12px;
  }
  #editProfileModal .modal-footer {
    text-align: right;
  }
  #editProfileModal .modal-footer button {
    margin-left: 8px;
  }
  /* Responsive */
  @media (max-width: 600px) {
    #app {
      padding: 10px;
    }
    nav button {
      font-size: 20px;
    }
  }
</style>
</head>
<body>

<header><h2>Xinn Social</h2></header>

<div id="app"></div>

<nav id="navBar" style="display:none;">
  <button onclick="showPage('feed')" id="nav-feed" title="Feed"><span class="material-icons">home</span></button>
  <button onclick="showPage('friends')" id="nav-friends" title="Friends"><span class="material-icons">group</span></button>
  <button onclick="showPage('chat')" id="nav-chat" title="Chat"><span class="material-icons">chat</span></button>
  <button onclick="showPage('profile')" id="nav-profile" title="Profile"><span class="material-icons">person</span></button>
  <button onclick="showPage('settings')" id="nav-settings" title="Settings"><span class="material-icons">settings</span></button>
</nav>

<!-- Edit Profile Modal -->
<div id="editProfileModal">
  <div class="modal-content">
    <div class="modal-header">Edit Profile</div>
    <input type="text" id="editName" placeholder="Full Name" />
    <textarea id="editBio" placeholder="Bio" rows="3"></textarea>
    <label>Change Avatar (optional)</label>
    <input type="file" id="editAvatar" accept="image/*" />
    <div class="modal-footer">
      <button onclick="closeEditProfile()">Cancel</button>
      <button onclick="saveProfile()">Save</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDhVRhDDCM8vFbNe9f1Ag4Xn0901igl4s0",
  authDomain: "xinn-social.firebaseapp.com",
  projectId: "xinn-social",
  storageBucket: "xinn-social.firebasestorage.app",
  messagingSenderId: "860868128981",
  appId: "1:860868128981:web:a5cb9b2cb32b10077e725c",
  measurementId: "G-2ZFNQND35B"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUserData = null;
let currentChatFriendId = null;
let unsubscribeChat = null;
let avatarBase64 = null;

function escapeHtml(text) {
  if (!text) return "";
  return text.replace(/[&<>"'`=\/]/g, function (s) {
    return ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;',
      '/': '&#x2F;',
      '`': '&#x60;',
      '=': '&#x3D;'
    })[s];
  });
}

// -------- AUTH & USER -----------

function renderLogin() {
  document.getElementById('app').innerHTML = `
    <div class="card" style="max-width: 400px; margin: 50px auto;">
      <h3>Login to Xinn Social</h3>
      <input type="email" id="email" placeholder="Email (@xinn.lab only)" autocomplete="username" />
      <input type="password" id="password" placeholder="Password" autocomplete="current-password" />
      <button onclick="login()">Login</button>
      <p>Or <a href="#" onclick="renderRegister()">Register</a></p>
    </div>`;
  setActiveNav(null);
}

function renderRegister() {
  document.getElementById('app').innerHTML = `
    <div class="card" style="max-width: 400px; margin: 50px auto;">
      <h3>Create Account</h3>
      <input type="text" id="name" placeholder="Full Name" autocomplete="name" />
      <input type="number" id="age" placeholder="Age" />
      <textarea id="bio" placeholder="Bio" rows="3"></textarea>
      <input type="email" id="email" placeholder="Email (@xinn.lab only)" autocomplete="email" />
      <input type="password" id="password" placeholder="Password" autocomplete="new-password" />
      <button onclick="register()">Register</button>
      <p>Already have an account? <a href="#" onclick="renderLogin()">Login</a></p>
    </div>`;
  setActiveNav(null);
}

async function login() {
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value.trim();
  if (!email.endsWith('@xinn.lab')) {
    alert('Email must end with @xinn.lab');
    return;
  }
  try {
    await auth.signInWithEmailAndPassword(email, pass);
  } catch(e) {
    alert("Login failed: " + e.message);
  }
}

async function register() {
  const name = document.getElementById('name').value.trim();
  const age = document.getElementById('age').value.trim();
  const bio = document.getElementById('bio').value.trim();
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value.trim();
  if (!email.endsWith('@xinn.lab')) {
    alert('Email must end with @xinn.lab');
    return;
  }
  if (!name || !age || !bio) {
    alert("Please fill all fields");
    return;
  }
  try {
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    // After successful register, add user data to Firestore
    await db.collection('users').doc(cred.user.uid).set({
      name, age, bio, email,
      friends: [],
      friendRequests: [],
      sentRequests: [],
      avatar: null
    });
    // Auto login: auth state change listener will handle
  } catch(e) {
    alert("Registration failed: " + e.message);
  }
}

// ---------- NAV & PAGES -----------

function setActiveNav(pageId) {
  ['nav-feed','nav-friends','nav-chat','nav-profile','nav-settings'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    if(id === 'nav-' + pageId) el.classList.add('active');
    else el.classList.remove('active');
  });
}

function showPage(page) {
  setActiveNav(page);
  switch(page) {
    case 'feed': renderFeed(); break;
    case 'friends': renderFriends(); break;
    case 'chat': renderChat(); break;
    case 'profile': renderProfile(); break;
    case 'settings': renderSettings(); break;
  }
}

// ---------- FEED PAGE ----------

function renderFeed() {
  document.getElementById('app').innerHTML = `
    <div class="card" style="max-width: 600px; margin: 0 auto;">
      <textarea id="postContent" placeholder="What's on your mind?" style="resize:none; min-height: 70px;"></textarea>
      <button onclick="createPostOnFeed()">Post</button>
    </div>
    <div id="feedPosts"></div>
  `;
  loadPostsForFeed();
}

function createPostOnFeed() {
  const content = document.getElementById('postContent').value.trim();
  if (!content) return alert("Post content can't be empty.");
  db.collection('posts').add({
    content,
    uid: auth.currentUser.uid,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    document.getElementById('postContent').value = '';
  }).catch(e => alert("Error posting: "+ e.message));
}

async function loadPostsForFeed() {
  const feedDiv = document.getElementById('feedPosts');
  feedDiv.innerHTML = '<p>Loading posts...</p>';

  db.collection('posts').orderBy('timestamp', 'desc').onSnapshot(async snap => {
    if(snap.empty) {
      feedDiv.innerHTML = '<p>No posts yet.</p>';
      return;
    }
    let html = '';
    for (const doc of snap.docs) {
      const post = doc.data();
      const userDoc = await db.collection('users').doc(post.uid).get();
      const user = userDoc.exists ? userDoc.data() : { name: "Unknown" };
      const time = post.timestamp ? post.timestamp.toDate().toLocaleString() : 'Just now';
      const avatar = user.avatar || null;

      html += `
        <div class="card" style="padding: 12px;">
          <div style="display:flex;align-items:center;margin-bottom:8px;cursor:pointer;" onclick="visitProfile('${doc.data().uid}')">
            ${avatar
              ? `<img src="${avatar}" alt="avatar" class="profile-avatar" style="width:40px; height:40px; margin-right:10px; border-radius:50%;">`
              : `<div class="avatar-circle">${user.name ? user.name[0].toUpperCase() : '?'}</div>`
            }
            <div>
              <strong>${escapeHtml(user.name)}</strong><br>
              <small style="color:gray;">${time}</small>
            </div>
          </div>
          <div style="font-size:15px; margin-top: 5px;">${escapeHtml(post.content)}</div>
        </div>
      `;
    }
    feedDiv.innerHTML = html;
  });
}

// ---------- FRIENDS PAGE ----------

async function renderFriends() {
  await loadFriendsAndRequests();

  document.getElementById('app').innerHTML = `
    <div class="card" style="max-width: 600px; margin: 0 auto 15px;">
      <input type="text" id="friendSearchInput" placeholder="Search users by name or email" oninput="searchUsers()" autocomplete="off" />
      <div id="friendSearchResults"></div>
    </div>

    <div class="card" style="max-width: 600px; margin: 0 auto;">
      <h3>Pending Friend Requests</h3>
      <div id="friendRequestsList"></div>
    </div>

    <div class="card" style="max-width: 600px; margin: 15px auto 0;">
      <h3>Your Friends</h3>
      <ul class="friend-list" id="friendList"></ul>
    </div>
  `;
}

let friendRequests = [];
let sentRequests = [];
let friendsList = [];

async function loadFriendsAndRequests() {
  try {
    const uid = auth.currentUser.uid;
    const userDoc = await db.collection("users").doc(uid).get();
    if (!userDoc.exists) return;

    const data = userDoc.data();
    friendRequests = data.friendRequests || [];
    sentRequests = data.sentRequests || [];
    friendsList = data.friends || [];

    // Render requests
    let reqHtml = '';
    for (const fid of friendRequests) {
      const fdoc = await db.collection("users").doc(fid).get();
      if (!fdoc.exists) continue;
      const f = fdoc.data();
      reqHtml += `
        <div class="request-card">
          <div style="display:flex; align-items:center;">
            <div class="avatar-circle">${f.name ? f.name[0].toUpperCase() : "?"}</div>
            <div>${escapeHtml(f.name)}</div>
          </div>
          <div>
            <button onclick="acceptRequest('${fid}')">Accept</button>
            <button onclick="declineRequest('${fid}')">Decline</button>
          </div>
        </div>`;
    }
    document.getElementById('friendRequestsList').innerHTML = reqHtml || '<p>No pending requests</p>';

    // Render friends
    let friendHtml = '';
    for (const fid of friendsList) {
      const fdoc = await db.collection("users").doc(fid).get();
      if (!fdoc.exists) continue;
      const f = fdoc.data();
      friendHtml += `<li onclick="visitProfile('${fid}')">
        <div class="avatar-circle">${f.name ? f.name[0].toUpperCase() : "?"}</div> ${escapeHtml(f.name)}
      </li>`;
    }
    document.getElementById('friendList').innerHTML = friendHtml || '<p>No friends yet.</p>';
  } catch (e) {
    alert("Error loading friends or requests: " + e.message);
  }
}

let searchTimeout = null;

function searchUsers() {
  const query = document.getElementById('friendSearchInput').value.trim().toLowerCase();
  const resultsDiv = document.getElementById('friendSearchResults');
  resultsDiv.innerHTML = '';

  if (searchTimeout) clearTimeout(searchTimeout);
  if (!query) return;

  // debounce search 500ms
  searchTimeout = setTimeout(async () => {
    try {
      // Search users by name or email that contain query and exclude self and friends and sentRequests and friendRequests
      const uid = auth.currentUser.uid;
      const userDoc = await db.collection("users").doc(uid).get();
      if (!userDoc.exists) return;

      const userData = userDoc.data();
      const allExcludedIds = new Set([
        uid,
        ...(userData.friends || []),
        ...(userData.sentRequests || []),
        ...(userData.friendRequests || []),
      ]);

      // Firestore doesn't support OR queries easily; we'll do two queries and merge results:
      const usersByNameSnap = await db.collection("users")
        .orderBy("name")
        .startAt(query)
        .endAt(query + "\uf8ff")
        .limit(10)
        .get();

      const usersByEmailSnap = await db.collection("users")
        .orderBy("email")
        .startAt(query)
        .endAt(query + "\uf8ff")
        .limit(10)
        .get();

      // Merge results
      let users = [];
      usersByNameSnap.forEach(doc => users.push({ id: doc.id, data: doc.data() }));
      usersByEmailSnap.forEach(doc => {
        if (!users.some(u => u.id === doc.id)) users.push({ id: doc.id, data: doc.data() });
      });

      // Filter out excluded and show only those that are not already friends/requests
      const filteredUsers = users.filter(u => !allExcludedIds.has(u.id));

      if (!filteredUsers.length) {
        resultsDiv.innerHTML = '<p>No users found.</p>';
        return;
      }

      // Show search results with button to send request
      let resHtml = '';
      filteredUsers.forEach(u => {
        resHtml += `
          <div class="request-card">
            <div style="display:flex; align-items:center;">
              <div class="avatar-circle">${u.data.name ? u.data.name[0].toUpperCase() : "?"}</div>
              <div>${escapeHtml(u.data.name)}</div>
            </div>
            <div>
              <button onclick="sendFriendRequest('${u.id}')">Add Friend</button>
            </div>
          </div>
        `;
      });
      resultsDiv.innerHTML = resHtml;
    } catch (e) {
      resultsDiv.innerHTML = '<p>Error searching users.</p>';
      console.error(e);
    }
  }, 500);
}

async function sendFriendRequest(friendId) {
  const uid = auth.currentUser.uid;
  if (!friendId || friendId === uid) return;

  try {
    // Update current user sentRequests
    await db.collection("users").doc(uid).update({
      sentRequests: firebase.firestore.FieldValue.arrayUnion(friendId)
    });
    // Update friend user's friendRequests
    await db.collection("users").doc(friendId).update({
      friendRequests: firebase.firestore.FieldValue.arrayUnion(uid)
    });
    alert("Friend request sent.");
    renderFriends(); // refresh
  } catch(e) {
    alert("Error sending friend request: " + e.message);
  }
}

async function acceptRequest(friendId) {
  const uid = auth.currentUser.uid;
  if (!friendId) return;
  try {
    // Add each other to friends lists
    await db.collection("users").doc(uid).update({
      friends: firebase.firestore.FieldValue.arrayUnion(friendId),
      friendRequests: firebase.firestore.FieldValue.arrayRemove(friendId)
    });
    await db.collection("users").doc(friendId).update({
      friends: firebase.firestore.FieldValue.arrayUnion(uid),
      sentRequests: firebase.firestore.FieldValue.arrayRemove(uid)
    });
    alert("Friend request accepted.");
    renderFriends();
  } catch(e) {
    alert("Error accepting request: " + e.message);
  }
}

async function declineRequest(friendId) {
  const uid = auth.currentUser.uid;
  if (!friendId) return;
  try {
    // Remove request from friendRequests and sentRequests
    await db.collection("users").doc(uid).update({
      friendRequests: firebase.firestore.FieldValue.arrayRemove(friendId)
    });
    await db.collection("users").doc(friendId).update({
      sentRequests: firebase.firestore.FieldValue.arrayRemove(uid)
    });
    alert("Friend request declined.");
    renderFriends();
  } catch(e) {
    alert("Error declining request: " + e.message);
  }
}

// ---------- CHAT PAGE ----------

function renderChat() {
  if (!friendsList.length) {
    document.getElementById('app').innerHTML = `
      <div class="card" style="max-width:600px; margin: 0 auto; text-align:center;">
        <p>You have no friends to chat with. Add friends first.</p>
      </div>`;
    return;
  }

  let friendOptions = '';
  for(const fid of friendsList) {
    friendOptions += `<option value="${fid}">${escapeHtml('Loading...')}</option>`;
  }

  document.getElementById('app').innerHTML = `
    <div style="max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; height: 80vh;">
      <select id="chatFriendSelect" onchange="changeChatFriend()" style="margin-bottom: 10px; padding: 10px; border-radius: 5px; border: 1px solid #ccc;">
        <option value="">Select friend to chat</option>
      </select>
      <div class="chat-container" id="chatMessages"></div>
      <textarea id="chatInput" placeholder="Type a message"></textarea>
      <button id="sendMsgBtn" onclick="sendMessage()">Send</button>
    </div>
  `;

  loadFriendsForChat();
  currentChatFriendId = null;
  unsubscribeChat && unsubscribeChat();
}

async function loadFriendsForChat() {
  const select = document.getElementById('chatFriendSelect');
  select.innerHTML = '<option value="">Select friend to chat</option>';

  for (const fid of friendsList) {
    const doc = await db.collection('users').doc(fid).get();
    if (!doc.exists) continue;
    const u = doc.data();
    const displayName = u.name || "Unknown";
    const option = document.createElement('option');
    option.value = fid;
    option.textContent = displayName;
    select.appendChild(option);
  }
}

async function changeChatFriend() {
  const friendId = document.getElementById('chatFriendSelect').value;
  if (!friendId) {
    document.getElementById('chatMessages').innerHTML = '';
    currentChatFriendId = null;
    unsubscribeChat && unsubscribeChat();
    return;
  }
  currentChatFriendId = friendId;
  loadChatMessages(friendId);
}

function loadChatMessages(friendId) {
  if (unsubscribeChat) unsubscribeChat();

  const uid = auth.currentUser.uid;
  const chatId = [uid, friendId].sort().join('_');

  const chatMessagesDiv = document.getElementById('chatMessages');
  chatMessagesDiv.innerHTML = '<p>Loading chat...</p>';

  unsubscribeChat = db.collection('chats').doc(chatId).collection('messages')
    .orderBy('timestamp', 'asc')
    .onSnapshot(snapshot => {
      if(snapshot.empty) {
        chatMessagesDiv.innerHTML = '<p>No messages yet.</p>';
        return;
      }
      let html = '';
      snapshot.forEach(doc => {
        const msg = doc.data();
        const isSelf = msg.uid === uid;
        const cls = isSelf ? 'self' : 'friend';
        html += `<div class="chat-message ${cls}">${escapeHtml(msg.text)}</div>`;
      });
      chatMessagesDiv.innerHTML = html;
      chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
    });
}

async function sendMessage() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;

  if (!currentChatFriendId) {
    alert("Select a friend to chat with first.");
    return;
  }

  const uid = auth.currentUser.uid;
  const chatId = [uid, currentChatFriendId].sort().join('_');
  const timestamp = firebase.firestore.FieldValue.serverTimestamp();

  try {
    await db.collection('chats').doc(chatId).collection('messages').add({
      uid,
      text,
      timestamp
    });
    input.value = '';
  } catch(e) {
    alert("Error sending message: " + e.message);
  }
}

// ---------- PROFILE PAGE ----------

async function renderProfile(userId = null) {
  // If no userId, show current user's profile
  if (!userId) userId = auth.currentUser.uid;

  const doc = await db.collection("users").doc(userId).get();
  if (!doc.exists) {
    document.getElementById('app').innerHTML = '<p>User not found.</p>';
    return;
  }
  const u = doc.data();

  // If current user profile, allow posting on own profile
  let postSection = '';
  if (userId === auth.currentUser.uid) {
    postSection = `
      <div class="card" style="max-width: 600px; margin: 10px auto;">
        <textarea id="profilePostContent" placeholder="Write something on your timeline..." style="resize:none; min-height: 70px;"></textarea>
        <button onclick="createPostOnProfile()">Post</button>
      </div>
      <div id="profilePosts"></div>
    `;
  } else {
    postSection = `<div id="profilePosts"></div>`;
  }

  document.getElementById('app').innerHTML = `
    <div style="max-width:600px; margin: 0 auto;">
      ${u.avatar ? `<img src="${u.avatar}" alt="Avatar" class="profile-avatar" />` :
      `<div class="avatar-circle" style="width:80px; height:80px; font-size: 36px; line-height: 80px; margin-bottom: 15px;">
        ${u.name ? u.name[0].toUpperCase() : "?"}
      </div>`}
      <h2>${escapeHtml(u.name)}</h2>
      <p><strong>Age:</strong> ${escapeHtml(u.age)}</p>
      <p><strong>Bio:</strong> ${escapeHtml(u.bio)}</p>
      ${userId === auth.currentUser.uid ? `<button onclick="openEditProfile()">Edit Profile</button>` : ''}
      <hr />
      <h3>${userId === auth.currentUser.uid ? "Your Timeline" : escapeHtml(u.name) + "'s Timeline"}</h3>
      ${postSection}
    </div>
  `;

  loadPostsForProfile(userId);
}

function openEditProfile() {
  document.getElementById('editName').value = currentUserData.name || '';
  document.getElementById('editBio').value = currentUserData.bio || '';
  avatarBase64 = currentUserData.avatar || null;
  document.getElementById('editAvatar').value = '';
  document.getElementById('editProfileModal').style.display = 'flex';
}

function closeEditProfile() {
  document.getElementById('editProfileModal').style.display = 'none';
}

document.getElementById('editAvatar').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(evt) {
    avatarBase64 = evt.target.result; // base64 string
  };
  reader.readAsDataURL(file);
});

async function saveProfile() {
  const name = document.getElementById('editName').value.trim();
  const bio = document.getElementById('editBio').value.trim();
  if (!name) return alert("Name cannot be empty.");

  try {
    const updateData = { name, bio };
    if (avatarBase64) updateData.avatar = avatarBase64;

    await db.collection('users').doc(auth.currentUser.uid).update(updateData);
    alert("Profile updated.");
    currentUserData = {...currentUserData, ...updateData};
    closeEditProfile();
    renderProfile();
  } catch(e) {
    alert("Error saving profile: " + e.message);
  }
}

// Profile timeline posts

async function createPostOnProfile() {
  const content = document.getElementById('profilePostContent').value.trim();
  if (!content) return alert("Post content can't be empty.");
  try {
    await db.collection('posts').add({
      content,
      uid: auth.currentUser.uid,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById('profilePostContent').value = '';
  } catch(e) {
    alert("Error posting: " + e.message);
  }
}

async function loadPostsForProfile(userId) {
  const container = document.getElementById('profilePosts');
  container.innerHTML = 'Loading posts...';

  try {
    const snap = await db.collection('posts').where('uid','==', userId).orderBy('timestamp','desc').get();
    if (snap.empty) {
      container.innerHTML = '<p>No posts yet.</p>';
      return;
    }
    let html = '';
    snap.forEach(doc => {
      const p = doc.data();
      const time = p.timestamp ? p.timestamp.toDate().toLocaleString() : 'Just now';
      html += `
        <div class="card" style="padding: 10px;">
          <small style="color: gray;">${time}</small>
          <p>${escapeHtml(p.content)}</p>
        </div>
      `;
    });
    container.innerHTML = html;
  } catch(e) {
    container.innerHTML = '<p>Error loading posts.</p>';
  }
}

// ---------- SETTINGS PAGE ----------

function renderSettings() {
  document.getElementById('app').innerHTML = `
    <div class="card" style="max-width: 400px; margin: 0 auto;">
      <h3>Settings</h3>
      <button onclick="logout()">Logout</button>
      <hr/>
      <h4>Change Password</h4>
      <input type="password" id="currentPassword" placeholder="Current Password" />
      <input type="password" id="newPassword" placeholder="New Password" />
      <button onclick="changePassword()">Change Password</button>
    </div>
  `;
}

async function logout() {
  await auth.signOut();
}

async function changePassword() {
  const currentPassword = document.getElementById('currentPassword').value.trim();
  const newPassword = document.getElementById('newPassword').value.trim();
  if (!currentPassword || !newPassword) return alert("Please fill both fields.");

  const user = auth.currentUser;
  const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);
  try {
    await user.reauthenticateWithCredential(credential);
    await user.updatePassword(newPassword);
    alert("Password changed successfully.");
    document.getElementById('currentPassword').value = '';
    document.getElementById('newPassword').value = '';
  } catch(e) {
    alert("Failed to change password: " + e.message);
  }
}

// --------- AUTH STATE -----------

auth.onAuthStateChanged(async user => {
  if (user) {
    // Load current user data once
    const userDoc = await db.collection("users").doc(user.uid).get();
    currentUserData = userDoc.exists ? userDoc.data() : null;
    if (!currentUserData) {
      // If no user data, create basic
      await db.collection('users').doc(user.uid).set({
        name: user.email.split('@')[0],
        email: user.email,
        friends: [],
        friendRequests: [],
        sentRequests: [],
        bio: '',
        age: '',
        avatar: null
      });
      currentUserData = await db.collection("users").doc(user.uid).get().then(doc => doc.data());
    }
    document.getElementById('navBar').style.display = 'flex';
    showPage('feed');
  } else {
    currentUserData = null;
    document.getElementById('navBar').style.display = 'none';
    renderLogin();
  }
});

</script>

</body>
</html>
