<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Xinn Social</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<style>
  /* Basic reset */
  body, html { margin:0; padding:0; height:100%; font-family: Arial, sans-serif; background:#f0f2f5; }
  header { background:#2196F3; color:#fff; padding:12px 0; text-align:center; font-size:24px; font-weight:700; }
  #app { padding: 12px 16px 80px; min-height: calc(100vh - 112px); }
  .card { background:#fff; border-radius:8px; padding:16px; margin-bottom:16px; box-shadow:0 1px 3px rgba(0,0,0,0.12); }
  input, textarea, select, button {
    font-family: inherit;
    font-size: 15px;
    padding: 10px;
    margin: 6px 0;
    border-radius: 5px;
    border: 1px solid #ccc;<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Xinn Social</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #f0f2f5;
  }
  header {
    background: #2196f3;
    color: white;
    padding: 10px;
    text-align: center;
  }
  .container {
    padding: 20px;
  }
  .card {
    background: white;
    padding: 15px;
    margin: 10px 0;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  input, textarea, button, select {
    width: 100%;
    padding: 10px;
    margin: 5px 0;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-sizing: border-box;
  }
  button {
    background: #2196f3;
    color: white;
    border: none;
    cursor: pointer;
  }
  nav {
    position: fixed;
    bottom: 0;
    left: 0; right: 0;
    background: white;
    display: flex;
    justify-content: space-around;
    border-top: 1px solid #ccc;
    padding: 10px 0;
    height: 56px;
    box-sizing: border-box;
  }
  nav button {
    background: none;
    color: #555;
    font-size: 24px;
    border: none;
    outline: none;
    cursor: pointer;
  }
  nav button.active {
    color: #2196f3;
    font-weight: bold;
  }
  /* Friend Requests & Friends UI */
  #friendSearch {
    margin-bottom: 10px;
  }
  .request-item, .friend-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 6px;
    border-bottom: 1px solid #ddd;
  }
  .request-item button, .friend-item button {
    margin-left: 6px;
    padding: 5px 10px;
    font-size: 13px;
  }
  /* Chat UI */
  #chatBoxContainer {
    display: flex;
    flex-direction: column;
    height: 70vh;
  }
  #chatContainer {
    flex-grow: 1;
    overflow-y: auto;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    margin-bottom: 6px;
    background: #fff;
  }
  .chat-message {
    max-width: 70%;
    margin-bottom: 10px;
    padding: 8px 12px;
    border-radius: 15px;
    position: relative;
    font-size: 14px;
    line-height: 1.3;
    word-wrap: break-word;
  }
  .chat-message.you {
    background-color: #dcf8c6;
    align-self: flex-end;
    border-bottom-right-radius: 3px;
  }
  .chat-message.friend {
    background-color: #fff;
    border: 1px solid #ddd;
    align-self: flex-start;
    border-bottom-left-radius: 3px;
  }
  .chat-meta {
    font-size: 10px;
    color: gray;
    margin-top: 4px;
    text-align: right;
  }
  .chat-actions {
    margin-top: 4px;
    text-align: right;
  }
  .chat-actions button {
    font-size: 10px;
    background: none;
    border: none;
    color: #2196f3;
    cursor: pointer;
    margin-left: 8px;
  }
  #chatInputContainer {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  #chatInput {
    flex-grow: 1;
    padding: 10px;
    border-radius: 25px;
    border: 1px solid #ccc;
    font-size: 14px;
  }
  #sendBtn, #emojiBtn {
    background: #2196f3;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    font-size: 20px;
    line-height: 36px;
    text-align: center;
    color: white;
    border: none;
    cursor: pointer;
  }
  #emojiPicker {
    position: absolute;
    bottom: 70px;
    background: white;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 6px;
    display: none;
    max-width: 300px;
    flex-wrap: wrap;
    gap: 8px;
  }
  #emojiPicker span {
    cursor: pointer;
    font-size: 22px;
  }
  #typingIndicator {
    font-size: 12px;
    color: #666;
    margin-bottom: 6px;
    min-height: 18px;
  }
  #replyPreview {
    font-size: 12px;
    color: #444;
    background: #e1e1e1;
    padding: 6px 10px;
    border-radius: 10px;
    margin-bottom: 6px;
  }
</style>
</head>
<body>

<header><h2>Xinn Social</h2></header>

<div id="app"></div>

<nav id="navBar" style="display:none;">
  <button id="navFeed" onclick="showPage('feed')" title="Feed"><span class="material-icons">home</span></button>
  <button id="navFriends" onclick="showPage('friends')" title="Friends"><span class="material-icons">group</span></button>
  <button id="navChat" onclick="showPage('chat')" title="Chat"><span class="material-icons">chat</span></button>
  <button id="navProfile" onclick="showPage('profile')" title="Profile"><span class="material-icons">person</span></button>
  <button id="navSettings" onclick="showPage('settings')" title="Settings"><span class="material-icons">settings</span></button>
</nav>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCGN7t5FjDeJ-ewm7S_9z0VJrRSggTaJ2Q",
  authDomain: "coin-base-by-hector.firebaseapp.com",
  databaseURL: "https://coin-base-by-hector-default-rtdb.firebaseio.com",
  projectId: "coin-base-by-hector",
  storageBucket: "coin-base-by-hector.firebasestorage.app",
  messagingSenderId: "398789890422",
  appId: "1:398789890422:web:ed6a928037b24be2e36a57",
  measurementId: "G-SGJJM5K3G9"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Helpers
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
function getCurrentUid() {
  return auth.currentUser ? auth.currentUser.uid : null;
}

// ========== AUTH ==========

function renderLogin() {
  document.getElementById('app').innerHTML = `
    <div class="container card">
      <h3>Login to Xinn Social</h3>
      <input type="email" id="email" placeholder="Email (@xinn.lab only)" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="login()">Login</button>
      <p>Or <a href="#" onclick="renderRegister()">Register</a></p>
    </div>`;
}

function renderRegister() {
  document.getElementById('app').innerHTML = `
    <div class="container card">
      <h3>Create Account</h3>
      <input type="text" id="name" placeholder="Full Name" />
      <input type="number" id="age" placeholder="Age" />
      <textarea id="bio" placeholder="Bio"></textarea>
      <input type="email" id="email" placeholder="Email (@xinn.lab only)" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="register()">Register</button>
      <p>Already have an account? <a href="#" onclick="renderLogin()">Login</a></p>
    </div>`;
}

function login() {
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value.trim();
  if (!email.endsWith('@xinn.lab')) {
    alert('Email must end with @xinn.lab');
    return;
  }
  auth.signInWithEmailAndPassword(email, pass).catch(e => alert(e.message));
}

function register() {
  const name = document.getElementById('name').value.trim();
  const age = document.getElementById('age').value.trim();
  const bio = document.getElementById('bio').value.trim();
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value.trim();
  if (!email.endsWith('@xinn.lab')) {
    alert('Email must end with @xinn.lab');
    return;
  }
  auth.createUserWithEmailAndPassword(email, pass)
    .then(cred => {
      return db.collection('users').doc(cred.user.uid).set({ name, age, bio, email });
    })
    .catch(e => alert(e.message));
}

// ========== FEED ==========

function renderFeed() {
  setActiveNav('navFeed');
  document.getElementById('app').innerHTML = `
    <div class="container">
      <div class="card">
        <textarea id="postContent" placeholder="What's on your mind?" style="resize:none;"></textarea>
        <button onclick="createPost()">Post</button>
      </div>
      <div id="feedPosts"></div>
    </div>`;
  loadPosts();
}

function createPost() {
  const content = document.getElementById('postContent').value.trim();
  if (!content) return;
  db.collection('posts').add({
    content,
    uid: getCurrentUid(),
    likes: [],
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
  document.getElementById('postContent').value = '';
}

function loadPosts() {
  db.collection('posts').orderBy('timestamp', 'desc').onSnapshot(snap => {
    let html = '';
    let postPromises = [];
    snap.forEach(doc => {
      const p = doc.data();
      postPromises.push(
        db.collection('users').doc(p.uid).get().then(userDoc => {
          const user = userDoc.data() || { name: "Unknown" };
          const time = p.timestamp ? p.timestamp.toDate().toLocaleString() : "Just now";

          html += `
            <div class="card" style="padding: 12px;">
              <div style="display:flex;align-items:center;margin-bottom:8px;">
                <span class="material-icons" style="font-size:36px;color:#2196F3;margin-right:10px;">account_circle</span>
                <div>
                  <strong>${escapeHtml(user.name)}</strong><br>
                  <small style="color:gray;">${time}</small>
                </div>
              </div>
              <div style="margin:10px 0;font-size:15px;">${escapeHtml(p.content)}</div>
              <hr style="margin:8px 0;">
              <button onclick="toggleLike('${doc.id}')"
                style="background:none;color:#2196F3;border:none;cursor:pointer;">
                👍 Like (${p.likes.length})
              </button>
            </div>`;
        })
      );
    });
    Promise.all(postPromises).then(() => {
      document.getElementById('feedPosts').innerHTML = html;
    });
  });
}

function toggleLike(postId) {
  const ref = db.collection('posts').doc(postId);
  ref.get().then(doc => {
    const data = doc.data();
    let likes = data.likes || [];
    const uid = getCurrentUid();
    if (likes.includes(uid)) {
      likes = likes.filter(id => id !== uid);
    } else {
      likes.push(uid);
    }
    ref.update({ likes });
  });
}

// ========== PROFILE ==========

function renderProfile() {
  setActiveNav('navProfile');
  const uid = getCurrentUid();
  if (!uid) return;
  db.collection('users').doc(uid).get().then(doc => {
    const u = doc.data() || {};
    document.getElementById('app').innerHTML = `
      <div class="container">
        <div class="card">
          <h3>${escapeHtml(u.name || '')}</h3>
          <p>Age: ${escapeHtml(u.age || '')}</p>
          <p>Bio: ${escapeHtml(u.bio || '')}</p>
          <button onclick="editProfile()">Edit Profile</button>
        </div>
      </div>`;
  });
}

function editProfile() {
  const uid = getCurrentUid();
  if (!uid) return;
  db.collection('users').doc(uid).get().then(doc => {
    const u = doc.data() || {};
    document.getElementById('app').innerHTML = `
      <div class="container card">
        <input id="name" value="${escapeHtml(u.name || '')}" placeholder="Full Name" />
        <input id="age" type="number" value="${escapeHtml(u.age || '')}" placeholder="Age" />
        <textarea id="bio" placeholder="Bio">${escapeHtml(u.bio || '')}</textarea>
        <button onclick="saveProfile()">Save</button>
      </div>`;
  });
}

function saveProfile() {
  const name = document.getElementById('name').value.trim();
  const age = document.getElementById('age').value.trim();
  const bio = document.getElementById('bio').value.trim();
  db.collection('users').doc(getCurrentUid()).update({ name, age, bio });
  renderProfile();
}

// ========== FRIENDS ==========

function renderFriends() {
  setActiveNav('navFriends');
  document.getElementById('app').innerHTML = `
    <div class="container card">
      <h3>Friend Requests</h3>
      <div id="friendRequestsList">Loading...</div>
      <h3>Your Friends</h3>
      <div id="friendList">Loading...</div>
      <h3>Search Users</h3>
      <input type="text" id="friendSearch" placeholder="Search users" oninput="searchUsers(this.value)" />
      <div id="searchResults"></div>
    </div>`;
  loadFriendRequests();
  loadFriends();
}

function loadFriendRequests() {
  const uid = getCurrentUid();
  if (!uid) return;
  const listDiv = document.getElementById('friendRequestsList');
  if (!listDiv) return;

  listDiv.innerHTML = 'Loading...';

  db.collection('friendRequests')
    .where('to', '==', uid)
    .where('status', '==', 'pending')
    .orderBy('timestamp', 'desc')
    .get()
    .then(snapshot => {
      if (snapshot.empty) {
        listDiv.innerHTML = '<p>No pending requests.</p>';
        return;
      }

      let html = '';
      let promises = [];

      snapshot.forEach(doc => {
        const data = doc.data();
        const requestId = doc.id;

        promises.push(
          db.collection('users').doc(data.from).get().then(userDoc => {
            const user = userDoc.data() || { name: "Unknown" };
            html += `
              <div class="request-item">
                <span>${escapeHtml(user.name)}</span>
                <div>
                  <button onclick="acceptFriendRequest('${requestId}', '${data.from}')">Accept</button>
                  <button onclick="declineFriendRequest('${requestId}')">Decline</button>
                </div>
              </div>`;
          })
        );
      });

      Promise.all(promises).then(() => {
        listDiv.innerHTML = html;
      });
    })
    .catch(e => {
      listDiv.innerHTML = `<p style="color:red;">Error loading requests: ${e.message}</p>`;
      console.error('Error loading friend requests:', e);
    });
}

function acceptFriendRequest(requestId, fromUid) {
  const uid = getCurrentUid();
  if (!uid) return;

  // Update friendRequests status to accepted
  db.collection('friendRequests').doc(requestId).update({ status: 'accepted' })
    .then(() => {
      // Add each other as friends (bidirectional)
      const batch = db.batch();
      const userFriendsRef = db.collection('friends').doc(uid);
      const fromFriendsRef = db.collection('friends').doc(fromUid);

      batch.set(userFriendsRef, { friends: firebase.firestore.FieldValue.arrayUnion(fromUid) }, { merge: true });
      batch.set(fromFriendsRef, { friends: firebase.firestore.FieldValue.arrayUnion(uid) }, { merge: true });

      return batch.commit();
    })
    .then(() => {
      loadFriendRequests();
      loadFriends();
    })
    .catch(e => {
      alert('Error accepting friend request: ' + e.message);
    });
}

function declineFriendRequest(requestId) {
  // Just update status to declined
  db.collection('friendRequests').doc(requestId).update({ status: 'declined' })
    .then(() => {
      loadFriendRequests();
    })
    .catch(e => {
      alert('Error declining friend request: ' + e.message);
    });
}

function loadFriends() {
  const uid = getCurrentUid();
  if (!uid) return;
  const listDiv = document.getElementById('friendList');
  if (!listDiv) return;

  listDiv.innerHTML = 'Loading...';

  db.collection('friends').doc(uid).get().then(doc => {
    const data = doc.data();
    const friends = data && data.friends ? data.friends : [];
    if (friends.length === 0) {
      listDiv.innerHTML = '<p>You have no friends yet.</p>';
      return;
    }

    let html = '';
    let promises = [];
    friends.forEach(friendUid => {
      promises.push(
        db.collection('users').doc(friendUid).get().then(friendDoc => {
          const friend = friendDoc.data() || { name: "Unknown" };
          html += `
            <div class="friend-item">
              <span>${escapeHtml(friend.name)}</span>
              <button onclick="removeFriend('${friendUid}')">Remove</button>
            </div>
          `;
        })
      );
    });
    Promise.all(promises).then(() => {
      listDiv.innerHTML = html;
    });
  }).catch(e => {
    listDiv.innerHTML = `<p style="color:red;">Error loading friends: ${e.message}</p>`;
    console.error('Error loading friends:', e);
  });
}

function removeFriend(friendUid) {
  const uid = getCurrentUid();
  if (!uid) return;
  const batch = db.batch();
  const userFriendsRef = db.collection('friends').doc(uid);
  const friendFriendsRef = db.collection('friends').doc(friendUid);

  batch.update(userFriendsRef, { friends: firebase.firestore.FieldValue.arrayRemove(friendUid) });
  batch.update(friendFriendsRef, { friends: firebase.firestore.FieldValue.arrayRemove(uid) });

  batch.commit().then(() => {
    loadFriends();
  }).catch(e => {
    alert('Error removing friend: ' + e.message);
  });
}

function searchUsers(query) {
  const searchDiv = document.getElementById('searchResults');
  if (!query) {
    searchDiv.innerHTML = '';
    return;
  }
  const uid = getCurrentUid();
  if (!uid) return;

  searchDiv.innerHTML = 'Searching...';

  db.collection('users')
    .orderBy('name')
    .startAt(query)
    .endAt(query + '\uf8ff')
    .limit(10)
    .get()
    .then(snapshot => {
      if (snapshot.empty) {
        searchDiv.innerHTML = '<p>No users found.</p>';
        return;
      }

      let html = '';
      snapshot.forEach(doc => {
        const user = doc.data();
        const userId = doc.id;

        if (userId === uid) return; // skip self

        html += `
          <div class="friend-item">
            <span>${escapeHtml(user.name)}</span>
            <button onclick="sendFriendRequest('${userId}')">Add Friend</button>
          </div>`;
      });
      searchDiv.innerHTML = html || '<p>No users found.</p>';
    }).catch(e => {
      searchDiv.innerHTML = `<p style="color:red;">Error searching users: ${e.message}</p>`;
      console.error(e);
    });
}

function sendFriendRequest(toUid) {
  const fromUid = getCurrentUid();
  if (!fromUid) return;
  if (toUid === fromUid) {
    alert("You can't send friend request to yourself.");
    return;
  }

  // Check if request already exists
  db.collection('friendRequests')
    .where('from', '==', fromUid)
    .where('to', '==', toUid)
    .where('status', '==', 'pending')
    .get()
    .then(snapshot => {
      if (!snapshot.empty) {
        alert('Friend request already sent.');
        return;
      }
      // Also check if already friends
      db.collection('friends').doc(fromUid).get().then(doc => {
        const friends = doc.exists && doc.data().friends ? doc.data().friends : [];
        if (friends.includes(toUid)) {
          alert('You are already friends.');
          return;
        }
        // Add new friend request
        db.collection('friendRequests').add({
          from: fromUid,
          to: toUid,
          status: 'pending',
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
          alert('Friend request sent.');
        });
      });
    })
    .catch(e => {
      alert('Error sending friend request: ' + e.message);
    });
}

// ========== CHAT ==========

let selectedChatFriend = null;
let unsubscribeMessages = null;
let unsubscribeTyping = null;
let replyToMessage = null;

function renderChat() {
  setActiveNav('navChat');
  document.getElementById('app').innerHTML = `
    <div class="container card" style="display:flex; flex-direction: column;">
      <div>
        <select id="chatFriendSelect" onchange="selectChatFriend(this.value)">
          <option value="">Select friend to chat</option>
        </select>
      </div>
      <div id="chatBoxContainer">
        <div id="typingIndicator"></div>
        <div id="replyPreview" style="display:none;"></div>
        <div id="chatContainer"></div>
        <div id="chatInputContainer">
          <input id="chatInput" placeholder="Type a message..." />
          <button id="emojiBtn" title="Emoji">😊</button>
          <button id="sendBtn" title="Send">➡️</button>
        </div>
        <div id="emojiPicker"></div>
      </div>
    </div>
  `;

  loadFriendsForChat();

  document.getElementById('sendBtn').onclick = sendMessage;
  document.getElementById('emojiBtn').onclick = toggleEmojiPicker;
  document.getElementById('chatInput').oninput = () => sendTypingStatus(true);
  document.getElementById('chatInput').onblur = () => sendTypingStatus(false);

  setupEmojiPicker();
}

function loadFriendsForChat() {
  const uid = getCurrentUid();
  if (!uid) return;
  const select = document.getElementById('chatFriendSelect');
  select.innerHTML = '<option value="">Select friend to chat</option>';

  db.collection('friends').doc(uid).get().then(doc => {
    const data = doc.data();
    const friends = data && data.friends ? data.friends : [];
    if (friends.length === 0) {
      select.innerHTML += '<option disabled>No friends available</option>';
      return;
    }
    friends.forEach(friendUid => {
      db.collection('users').doc(friendUid).get().then(friendDoc => {
        const friend = friendDoc.data() || { name: "Unknown" };
        const opt = document.createElement('option');
        opt.value = friendUid;
        opt.textContent = friend.name;
        select.appendChild(opt);
      });
    });
  });
}

function selectChatFriend(friendUid) {
  if (unsubscribeMessages) unsubscribeMessages();
  if (unsubscribeTyping) unsubscribeTyping();

  selectedChatFriend = friendUid;
  document.getElementById('chatContainer').innerHTML = '';
  document.getElementById('typingIndicator').textContent = '';
  hideReplyPreview();

  if (!friendUid) return;

  const chatId = getChatId(getCurrentUid(), friendUid);

  unsubscribeMessages = db.collection('chats').doc(chatId).collection('messages')
    .orderBy('timestamp')
    .onSnapshot(snapshot => {
      const container = document.getElementById('chatContainer');
      container.innerHTML = '';
      snapshot.forEach(doc => {
        const msg = doc.data();
        const isYou = msg.sender === getCurrentUid();

        const div = document.createElement('div');
        div.className = 'chat-message ' + (isYou ? 'you' : 'friend');
        div.innerHTML = escapeHtml(msg.content);

        if (msg.replyToContent) {
          const replyDiv = document.createElement('div');
          replyDiv.style.fontSize = '10px';
          replyDiv.style.fontStyle = 'italic';
          replyDiv.style.marginBottom = '4px';
          replyDiv.textContent = `Reply: ${msg.replyToContent}`;
          div.prepend(replyDiv);
        }

        // Chat meta info
        const meta = document.createElement('div');
        meta.className = 'chat-meta';
        const timeStr = msg.timestamp ? msg.timestamp.toDate().toLocaleTimeString() : '';
        meta.textContent = timeStr;

        // Actions (Edit/Reply)
        const actions = document.createElement('div');
        actions.className = 'chat-actions';
        if (isYou) {
          const editBtn = document.createElement('button');
          editBtn.textContent = 'Edit';
          editBtn.onclick = () => editMessage(doc.id, msg.content);
          actions.appendChild(editBtn);
        }
        const replyBtn = document.createElement('button');
        replyBtn.textContent = 'Reply';
        replyBtn.onclick = () => setReply(doc.id, msg.content);
        actions.appendChild(replyBtn);

        div.appendChild(meta);
        div.appendChild(actions);

        container.appendChild(div);
      });

      container.scrollTop = container.scrollHeight;
    });

  // Typing indicator listener
  unsubscribeTyping = db.collection('chats').doc(chatId).collection('typing').doc(friendUid)
    .onSnapshot(doc => {
      if (!doc.exists) {
        document.getElementById('typingIndicator').textContent = '';
        return;
      }
      const data = doc.data();
      if (data.isTyping) {
        document.getElementById('typingIndicator').textContent = `${data.name || 'Friend'} is typing...`;
      } else {
        document.getElementById('typingIndicator').textContent = '';
      }
    });
}

function getChatId(uid1, uid2) {
  return [uid1, uid2].sort().join('_');
}

function sendMessage() {
  const input = document.getElementById('chatInput');
  let msg = input.value.trim();
  if (!msg || !selectedChatFriend) return;

  const chatId = getChatId(getCurrentUid(), selectedChatFriend);
  const messagesRef = db.collection('chats').doc(chatId).collection('messages');

  const data = {
    content: msg,
    sender: getCurrentUid(),
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  };

  if (replyToMessage) {
    data.replyToId = replyToMessage.id;
    data.replyToContent = replyToMessage.content;
  }

  if (replyToMessage && replyToMessage.isEditing) {
    // Edit existing message
    messagesRef.doc(replyToMessage.id).update({ content: msg }).then(() => {
      clearReply();
      input.value = '';
    });
  } else {
    // New message
    messagesRef.add(data).then(() => {
      clearReply();
      input.value = '';
    });
  }
  sendTypingStatus(false);
}

function editMessage(msgId, currentContent) {
  replyToMessage = { id: msgId, content: currentContent, isEditing: true };
  showReplyPreview(`Editing: ${currentContent}`);
  document.getElementById('chatInput').value = currentContent;
  document.getElementById('chatInput').focus();
}

function setReply(msgId, content) {
  replyToMessage = { id: msgId, content: content, isEditing: false };
  showReplyPreview(`Replying to: ${content}`);
  document.getElementById('chatInput').focus();
}

function clearReply() {
  replyToMessage = null;
  hideReplyPreview();
}

function showReplyPreview(text) {
  const preview = document.getElementById('replyPreview');
  preview.textContent = text;
  preview.style.display = 'block';
}

function hideReplyPreview() {
  const preview = document.getElementById('replyPreview');
  preview.style.display = 'none';
  preview.textContent = '';
}

function sendTypingStatus(isTyping) {
  if (!selectedChatFriend) return;
  const chatId = getChatId(getCurrentUid(), selectedChatFriend);
  const typingRef = db.collection('chats').doc(chatId).collection('typing').doc(getCurrentUid());
  if (isTyping) {
    db.collection('users').doc(getCurrentUid()).get().then(doc => {
      const name = doc.data().name || 'You';
      typingRef.set({ isTyping: true, name });
    });
  } else {
    typingRef.set({ isTyping: false });
  }
}

// ========== SETTINGS ==========

function renderSettings() {
  setActiveNav('navSettings');
  document.getElementById('app').innerHTML = `
    <div class="container card">
      <button onclick="auth.signOut()">Logout</button>
    </div>`;
}

// ========== NAV HELPER ==========

function setActiveNav(activeId) {
  ['navFeed', 'navFriends', 'navChat', 'navProfile', 'navSettings'].forEach(id => {
    const btn = document.getElementById(id);
    if (!btn) return;
    if (id === activeId) btn.classList.add('active');
    else btn.classList.remove('active');
  });
}

// ========== EMOJI PICKER ==========

function setupEmojiPicker() {
  const emojis = ['😀','😁','😂','🤣','😃','😄','😅','😆','😉','😊','😋','😎','😍','😘','😗','😙','😚','🙂','🤗','🤩','🤔','😐','😑','😶','🙄','😏','😣','😥','😮','🤐','😯','😪','😫','😴','😌','🤓','😛','😜','😝','🤤','😒','😓','😔','😕','🙃','🤑','😲','☹️','🙁','😖','😞','😟','😤','😢','😭','😦','😧','😨','😩','🤯','😬','😰','😱','🥵','🥶','😳','🤪','😵','😡','😠','🤬','😷','🤒','🤕','🤢','🤮','🤧','😇','🤠','🤡','🥳','🥺','🤥','🤫','🤭','🧐'];

  const picker = document.getElementById('emojiPicker');
  picker.innerHTML = '';
  emojis.forEach(emoji => {
    const span = document.createElement('span');
    span.textContent = emoji;
    span.onclick = () => {
      const input = document.getElementById('chatInput');
      input.value += emoji;
      input.focus();
      picker.style.display = 'none';
      sendTypingStatus(true);
    };
    picker.appendChild(span);
  });
}

function toggleEmojiPicker() {
  const picker = document.getElementById('emojiPicker');
  if (picker.style.display === 'flex') {
    picker.style.display = 'none';
  } else {
    picker.style.display = 'flex';
  }
}

// ========== AUTH STATE LISTENER ==========

auth.onAuthStateChanged(user => {
  if (user) {
    showPage('feed');
    document.getElementById('navBar').style.display = 'flex';
  } else {
    renderLogin();
    document.getElementById('navBar').style.display = 'none';
  }
});

// ========== PAGE SWITCHER ==========

function showPage(page) {
  clearReply();
  if (unsubscribeMessages) unsubscribeMessages();
  if (unsubscribeTyping) unsubscribeTyping();

  switch(page) {
    case 'feed': renderFeed(); break;
    case 'profile': renderProfile(); break;
    case 'friends': renderFriends(); break;
    case 'chat': renderChat(); break;
    case 'settings': renderSettings(); break;
  }
}

</script>
</body>
</html>

    width: 100%;
    box-sizing: border-box;
    resize: none;
  }
  button {
    background:#2196F3;
    border:none;
    color:#fff;
    font-weight:600;
    cursor:pointer;
    transition: background 0.3s ease;
  }
  button:disabled {
    background:#90caf9;
    cursor: default;
  }
  button:hover:not(:disabled) { background:#1976d2; }
  nav {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: #fff;
    border-top: 1px solid #ccc;
    display: flex;
    justify-content: space-around;
    align-items: center;
    height: 56px;
    z-index: 10;
  }
  nav button {
    background: none;
    border: none;
    color: #555;
    font-size: 28px;
    cursor: pointer;
    padding: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  nav button.active {
    color: #2196F3;
    font-weight: 700;
  }
  /* Feed post */
  .post-content { font-size: 15px; margin-top: 10px; white-space: pre-wrap; }
  .post-header { display: flex; align-items: center; margin-bottom: 8px; }
  .post-header .material-icons { font-size: 36px; color: #2196F3; margin-right: 12px; }
  .post-header strong { font-weight: 600; font-size: 16px; }
  .post-time { color: #777; font-size: 12px; }
  .like-btn {
    background: none;
    border: none;
    color: #2196F3;
    cursor: pointer;
    font-weight: 600;
    padding: 6px 0;
    width: auto;
  }
  /* Friend Requests */
  .request-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #eee;
    padding: 10px 0;
  }
  .request-item span { font-weight: 600; }
  .request-actions button {
    margin-left: 8px;
    padding: 6px 12px;
    font-weight: 600;
    border-radius: 4px;
    border: none;
    cursor: pointer;
  }
  .request-actions .accept { background: #4caf50; color: #fff; }
  .request-actions .decline { background: #f44336; color: #fff; }
  /* Friend list */
  .friend-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #eee;
    padding: 10px 0;
  }
  .friend-item span { font-weight: 600; }
  .friend-item button {
    background: #f44336;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
  }
  /* Chat */
  #chatContainer {
    height: calc(100vh - 220px);
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #fff;
    padding: 12px;
    margin-bottom: 8px;
  }
  .chat-message {
    max-width: 70%;
    margin-bottom: 10px;
    padding: 8px 12px;
    border-radius: 18px;
    position: relative;
    font-size: 14px;
    line-height: 1.3;
    word-wrap: break-word;
    white-space: pre-wrap;
  }
  .chat-message.you {
    background: #e1f5fe;
    margin-left: auto;
    border-bottom-right-radius: 4px;
  }
  .chat-message.friend {
    background: #f1f0f0;
    margin-right: auto;
    border-bottom-left-radius: 4px;
  }
  .chat-meta {
    font-size: 11px;
    color: #666;
    margin-top: 2px;
    display: flex;
    justify-content: space-between;
  }
  .chat-actions {
    margin-top: 4px;
  }
  .chat-actions button {
    background: none;
    border: none;
    color: #2196F3;
    cursor: pointer;
    font-size: 12px;
    margin-right: 10px;
  }
  /* Reply preview */
  #replyPreview {
    background: #f0f0f0;
    padding: 6px 12px;
    border-left: 4px solid #2196F3;
    margin-bottom: 6px;
    display: none;
    font-style: italic;
  }
  /* Typing indicator */
  #typingIndicator {
    font-style: italic;
    color: #888;
    height: 18px;
    margin-bottom: 6px;
  }
  /* Emoji picker */
  #emojiPicker {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 6px;
    max-width: 280px;
    display: none;
    position: absolute;
    bottom: 70px;
    right: 20px;
    overflow-wrap: break-word;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  #emojiPicker span {
    font-size: 22px;
    cursor: pointer;
    margin: 4px 6px;
    user-select: none;
  }
  /* Chat input area */
  #chatInputContainer {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  #chatInput {
    flex-grow: 1;
  }
  @media (max-width: 600px) {
    #app { padding-bottom: 100px; }
    nav { height: 56px; }
  }
</style>
</head>
<body>

<header>Xinn Social</header>
<div id="app"></div>

<nav id="navBar" style="display:none;">
  <button id="navFeed" title="Feed" onclick="showPage('feed')" class="active"><span class="material-icons">home</span></button>
  <button id="navFriends" title="Friends" onclick="showPage('friends')"><span class="material-icons">group</span></button>
  <button id="navChat" title="Chat" onclick="showPage('chat')"><span class="material-icons">chat</span></button>
  <button id="navProfile" title="Profile" onclick="showPage('profile')"><span class="material-icons">person</span></button>
  <button id="navSettings" title="Settings" onclick="showPage('settings')"><span class="material-icons">settings</span></button>
</nav>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
// ==== Firebase Init ====
const firebaseConfig = {
  apiKey: "AIzaSyCGN7t5FjDeJ-ewm7S_9z0VJrRSggTaJ2Q",
  authDomain: "coin-base-by-hector.firebaseapp.com",
  databaseURL: "https://coin-base-by-hector-default-rtdb.firebaseio.com",
  projectId: "coin-base-by-hector",
  storageBucket: "coin-base-by-hector.appspot.com",
  messagingSenderId: "398789890422",
  appId: "1:398789890422:web:ed6a928037b24be2e36a57",
  measurementId: "G-SGJJM5K3G9"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// === Helpers ===
function getCurrentUid() {
  return auth.currentUser ? auth.currentUser.uid : null;
}
function escapeHtml(text) {
  if (!text) return "";
  return text.replace(/[&<>"']/g, (m) => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
  })[m]);
}

// ==== AUTH ====

// Show login form
function renderLogin() {
  document.getElementById('app').innerHTML = `
    <div class="card">
      <h3>Login to Xinn Social</h3>
      <input type="email" id="email" placeholder="Email (@xinn.lab only)" autocomplete="username">
      <input type="password" id="password" placeholder="Password" autocomplete="current-password">
      <button id="loginBtn">Login</button>
      <p>Or <a href="#" onclick="renderRegister();return false;">Register</a></p>
    </div>`;
  document.getElementById('loginBtn').onclick = login;
}

// Show register form
function renderRegister() {
  document.getElementById('app').innerHTML = `
    <div class="card">
      <h3>Create Account</h3>
      <input type="text" id="name" placeholder="Full Name" autocomplete="name">
      <input type="number" id="age" placeholder="Age">
      <textarea id="bio" placeholder="Bio"></textarea>
      <input type="email" id="email" placeholder="Email (@xinn.lab only)" autocomplete="email">
      <input type="password" id="password" placeholder="Password" autocomplete="new-password">
      <button id="registerBtn">Register</button>
      <p>Already have an account? <a href="#" onclick="renderLogin();return false;">Login</a></p>
    </div>`;
  document.getElementById('registerBtn').onclick = register;
}

function login() {
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value.trim();
  if (!email.endsWith('@xinn.lab')) return alert('Email must end with @xinn.lab');
  auth.signInWithEmailAndPassword(email, pass).catch(e => alert(e.message));
}

function register() {
  const name = document.getElementById('name').value.trim();
  const age = document.getElementById('age').value.trim();
  const bio = document.getElementById('bio').value.trim();
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value.trim();
  if (!email.endsWith('@xinn.lab')) return alert('Email must end with @xinn.lab');
  if (!name || !age) return alert('Please fill all fields');
  auth.createUserWithEmailAndPassword(email, pass)
    .then(cred => {
      return db.collection('users').doc(cred.user.uid).set({ name, age, bio, email });
    })
    .catch(e => alert(e.message));
}

// ==== NAV ====

function showPage(page) {
  // Highlight nav buttons
  ['navFeed','navFriends','navChat','navProfile','navSettings'].forEach(id=>{
    document.getElementById(id).classList.remove('active');
  });
  if(page==='feed') document.getElementById('navFeed').classList.add('active');
  else if(page==='friends') document.getElementById('navFriends').classList.add('active');
  else if(page==='chat') document.getElementById('navChat').classList.add('active');
  else if(page==='profile') document.getElementById('navProfile').classList.add('active');
  else if(page==='settings') document.getElementById('navSettings').classList.add('active');

  if (page === 'feed') renderFeed();
  else if (page === 'profile') renderProfile();
  else if (page === 'friends') renderFriends();
  else if (page === 'chat') renderChat();
  else if (page === 'settings') renderSettings();
}

// ==== FEED ====

function renderFeed() {
  document.getElementById('app').innerHTML = `
    <div class="card">
      <textarea id="postContent" placeholder="What's on your mind?" rows="3"></textarea>
      <button id="postBtn">Post</button>
    </div>
    <div id="feedPosts"></div>
  `;
  document.getElementById('postBtn').onclick = createPost;
  loadPosts();
}

function createPost() {
  const content = document.getElementById('postContent').value.trim();
  if (!content) return alert('Post content cannot be empty');
  db.collection('posts').add({
    content,
    uid: getCurrentUid(),
    likes: [],
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
  document.getElementById('postContent').value = '';
}

function loadPosts() {
  db.collection('posts').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
    let html = '';
    let promises = [];

    snapshot.forEach(doc => {
      const p = doc.data();
      promises.push(
        db.collection('users').doc(p.uid).get().then(userDoc => {
          const user = userDoc.data() || { name: "Unknown" };
          const time = p.timestamp ? p.timestamp.toDate().toLocaleString() : "Just now";
          const liked = p.likes.includes(getCurrentUid());
          html += `
            <div class="card">
              <div class="post-header">
                <span class="material-icons">account_circle</span>
                <div>
                  <strong>${escapeHtml(user.name)}</strong><br>
                  <span class="post-time">${time}</span>
                </div>
              </div>
              <div class="post-content">${escapeHtml(p.content)}</div>
              <button class="like-btn" onclick="toggleLike('${doc.id}')">
                👍 ${liked ? 'Unlike' : 'Like'} (${p.likes.length})
              </button>
            </div>
          `;
        })
      );
    });

    Promise.all(promises).then(() => {
      document.getElementById('feedPosts').innerHTML = html;
    });
  });
}

function toggleLike(postId) {
  const ref = db.collection('posts').doc(postId);
  ref.get().then(doc => {
    const data = doc.data();
    if (!data) return;
    let likes = data.likes || [];
    const uid = getCurrentUid();
    if (likes.includes(uid)) {
      likes = likes.filter(id => id !== uid);
    } else {
      likes.push(uid);
    }
    ref.update({ likes });
  });
}

// ==== PROFILE ====

function renderProfile() {
  const uid = getCurrentUid();
  if (!uid) return;
  db.collection('users').doc(uid).get().then(doc => {
    if (!doc.exists) return alert('Profile not found');
    const u = doc.data();
    document.getElementById('app').innerHTML = `
      <div class="card">
        <h3>${escapeHtml(u.name)}</h3>
        <p>Age: ${escapeHtml(u.age)}</p>
        <p>Bio: ${escapeHtml(u.bio)}</p>
        <button id="editProfileBtn">Edit Profile</button>
      </div>
    `;
    document.getElementById('editProfileBtn').onclick = editProfile;
  });
}

function editProfile() {
  const uid = getCurrentUid();
  if (!uid) return;
  db.collection('users').doc(uid).get().then(doc => {
    if (!doc.exists) return alert('Profile not found');
    const u = doc.data();
    document.getElementById('app').innerHTML = `
      <div class="card">
        <input id="name" value="${escapeHtml(u.name)}" placeholder="Full Name">
        <input id="age" value="${escapeHtml(u.age)}" placeholder="Age">
        <textarea id="bio" placeholder="Bio">${escapeHtml(u.bio)}</textarea>
        <button id="saveProfileBtn">Save</button>
      </div>
    `;
    document.getElementById('saveProfileBtn').onclick = saveProfile;
  });
}

function saveProfile() {
  const uid = getCurrentUid();
  if (!uid) return;
  const name = document.getElementById('name').value.trim();
  const age = document.getElementById('age').value.trim();
  const bio = document.getElementById('bio').value.trim();
  if (!name || !age) return alert('Please fill all fields');
  db.collection('users').doc(uid).update({ name, age, bio })
    .then(() => renderProfile())
    .catch(e => alert(e.message));
}

// ==== FRIENDS SYSTEM ====

function renderFriends() {
  document.getElementById('app').innerHTML = `
    <div class="card">
      <input type="text" id="friendSearch" placeholder="Search users by name or email" autocomplete="off" />
      <div id="searchResults" style="margin-top:12px;"></div>
    </div>
    <div class="card" style="margin-top:12px;">
      <h3>Pending Friend Requests</h3>
      <div id="friendRequestsList">Loading...</div>
    </div>
    <div class="card" style="margin-top:12px;">
      <h3>Your Friends</h3>
      <div id="friendList">Loading...</div>
    </div>
  `;

  // Set up search debounce
  let debounceTimer;
  document.getElementById('friendSearch').addEventListener('input', e => {
    clearTimeout(debounceTimer);
    const query = e.target.value.trim();
    if (!query) {
      document.getElementById('searchResults').innerHTML = '';
      return;
    }
    debounceTimer = setTimeout(() => {
      searchUsers(query);
    }, 500);
  });

  loadFriendRequests();
  loadFriends();
}

function searchUsers(query) {
  const uid = getCurrentUid();
  if (!uid) return;

  const resultsDiv = document.getElementById('searchResults');
  resultsDiv.innerHTML = 'Searching...';

  // Search by name or email case-insensitive start with
  db.collection('users')
    .where('name', '>=', query)
    .where('name', '<=', query + '\uf8ff')
    .limit(10)
    .get()
    .then(snapshot => {
      let users = [];
      snapshot.forEach(doc => {
        if (doc.id !== uid) users.push({ id: doc.id, ...doc.data() });
      });

      // Also search by email if different
      if (users.length === 0) {
        return db.collection('users')
          .where('email', '>=', query)
          .where('email', '<=', query + '\uf8ff')
          .limit(10)
          .get()
          .then(emailSnap => {
            emailSnap.forEach(doc => {
              if (doc.id !== uid) users.push({ id: doc.id, ...doc.data() });
            });
            return users;
          });
      } else {
        return users;
      }
    })
    .then(users => {
      if (users.length === 0) {
        resultsDiv.innerHTML = '<p>No users found.</p>';
        return;
      }

      // For each user, determine friend/request status
      const uid = getCurrentUid();
      // Get current friends
      db.collection('friends').doc(uid).get().then(friendDoc => {
        const friends = (friendDoc.exists && friendDoc.data().friends) || [];
        // Get sent friend requests
        db.collection('friendRequests')
          .where('from', '==', uid)
          .where('status', '==', 'pending')
          .get()
          .then(sentReqSnap => {
            const sentReqIds = sentReqSnap.docs.map(d => d.data().to);
            let html = '';
            users.forEach(user => {
              if (friends.includes(user.id)) {
                html += `<div class="request-item">${escapeHtml(user.name)} (Friend)</div>`;
              } else if (sentReqIds.includes(user.id)) {
                html += `<div class="request-item">${escapeHtml(user.name)} (Request sent) <button onclick="cancelFriendRequest('${user.id}')">Cancel</button></div>`;
              } else {
                html += `<div class="request-item">${escapeHtml(user.name)} <button onclick="sendFriendRequest('${user.id}')">Add Friend</button></div>`;
              }
            });
            resultsDiv.innerHTML = html;
          });
      });
    }).catch(e => {
      resultsDiv.innerHTML = '<p>Error searching users.</p>';
      console.error(e);
    });
}

function sendFriendRequest(toUid) {
  const uid = getCurrentUid();
  if (!uid) return alert('Not logged in');

  // Check existing pending requests to avoid duplicates
  db.collection('friendRequests')
    .where('from', '==', uid)
    .where('to', '==', toUid)
    .where('status', '==', 'pending')
    .get()
    .then(snap => {
      if (!snap.empty) return alert('Friend request already sent');
      // Create friend request
      return db.collection('friendRequests').add({
        from: uid,
        to: toUid,
        status: 'pending',
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
    })
    .then(() => {
      alert('Friend request sent');
      searchUsers(document.getElementById('friendSearch').value.trim());
      loadFriendRequests();
    })
    .catch(e => alert('Error sending friend request: ' + e.message));
}

function cancelFriendRequest(toUid) {
  const uid = getCurrentUid();
  if (!uid) return alert('Not logged in');

  db.collection('friendRequests')
    .where('from', '==', uid)
    .where('to', '==', toUid)
    .where('status', '==', 'pending')
    .get()
    .then(snap => {
      if (snap.empty) return alert('No pending request found');
      const batch = db.batch();
      snap.forEach(doc => batch.delete(doc.ref));
      return batch.commit();
    })
    .then(() => {
      alert('Friend request canceled');
      searchUsers(document.getElementById('friendSearch').value.trim());
      loadFriendRequests();
    })
    .catch(e => alert('Error canceling friend request: ' + e.message));
}

function loadFriendRequests() {
  const uid = getCurrentUid();
  if (!uid) return;

  const listDiv = document.getElementById('friendRequestsList');
  listDiv.innerHTML = 'Loading...';

  db.collection('friendRequests')
    .where('to', '==', uid)
    .where('status', '==', 'pending')
    .orderBy('timestamp', 'desc')
    .get()
    .then(snapshot => {
      if (snapshot.empty) {
        listDiv.innerHTML = '<p>No pending requests.</p>';
        return;
      }

      let html = '';
      let promises = [];

      snapshot.forEach(doc => {
        const data = doc.data();
        const requestId = doc.id;
        promises.push(
          db.collection('users').doc(data.from).get().then(userDoc => {
            const user = userDoc.data() || { name: "Unknown" };
            html += `
              <div class="request-item" style="display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid #ddd;">
                <span>${escapeHtml(user.name)}</span>
                <div>
                  <button onclick="acceptFriendRequest('${requestId}', '${data.from}')">Accept</button>
                  <button onclick="declineFriendRequest('${requestId}')">Decline</button>
                </div>
              </div>
            `;
          })
        );
      });

      Promise.all(promises).then(() => {
        listDiv.innerHTML = html;
      });
    })
    .catch(e => {
      listDiv.innerHTML = `<p style="color:red;">Error loading requests: ${e.message}</p>`;
      console.error(e);
    });
}


function acceptFriendRequest(requestId, fromUid) {
  const uid = getCurrentUid();
  if (!uid) return alert('Not logged in');

  const batch = db.batch();

  // Update friendRequests doc status to accepted
  const reqRef = db.collection('friendRequests').doc(requestId);
  batch.update(reqRef, { status: 'accepted' });

  // Add to both users' friends list
  const userFriendsRef = db.collection('friends').doc(uid);
  const fromFriendsRef = db.collection('friends').doc(fromUid);

  batch.set(userFriendsRef, { friends: firebase.firestore.FieldValue.arrayUnion(fromUid) }, { merge: true });
  batch.set(fromFriendsRef, { friends: firebase.firestore.FieldValue.arrayUnion(uid) }, { merge: true });

  batch.commit().then(() => {
    alert('Friend request accepted');
    loadFriendRequests();
    loadFriends();
  }).catch(e => alert('Error accepting request: ' + e.message));
}

function declineFriendRequest(requestId) {
  const uid = getCurrentUid();
  if (!uid) return alert('Not logged in');
  db.collection('friendRequests').doc(requestId).update({ status: 'declined' })
    .then(() => {
      alert('Friend request declined');
      loadFriendRequests();
    })
    .catch(e => alert('Error declining request: ' + e.message));
}

function loadFriends() {
  const uid = getCurrentUid();
  if (!uid) return;

  const friendListDiv = document.getElementById('friendList');
  friendListDiv.innerHTML = 'Loading...';

  db.collection('friends').doc(uid).get().then(doc => {
    if (!doc.exists || !doc.data().friends.length) {
      friendListDiv.innerHTML = '<p>No friends yet.</p>';
      return;
    }
    const friendIds = doc.data().friends;

    const friendPromises = friendIds.map(fid =>
      db.collection('users').doc(fid).get().then(userDoc => {
        const u = userDoc.data() || { name: "Unknown" };
        return { id: fid, name: u.name };
      })
    );

    Promise.all(friendPromises).then(friends => {
      let html = '';
      friends.forEach(friend => {
        html += `
          <div class="friend-item">
            <span>${escapeHtml(friend.name)}</span>
            <button onclick="unfriend('${friend.id}')">Unfriend</button>
          </div>
        `;
      });
      friendListDiv.innerHTML = html;
    });
  });
}

function unfriend(friendUid) {
  const uid = getCurrentUid();
  if (!uid) return alert('Not logged in');

  const batch = db.batch();
  const userFriendsRef = db.collection('friends').doc(uid);
  const friendFriendsRef = db.collection('friends').doc(friendUid);

  batch.update(userFriendsRef, { friends: firebase.firestore.FieldValue.arrayRemove(friendUid) });
  batch.update(friendFriendsRef, { friends: firebase.firestore.FieldValue.arrayRemove(uid) });

  batch.commit().then(() => {
    alert('Unfriended successfully');
    loadFriends();
  }).catch(e => alert('Error unfriending: ' + e.message));
}

// ==== CHAT ====

let selectedChatFriend = null;
let unsubscribeChat = null;
let unsubscribeTyping = null;
let replyToMessage = null;

function renderChat() {
  const uid = getCurrentUid();
  if (!uid) return;

  document.getElementById('app').innerHTML = `
    <div class="card">
      <h3>Friends to Chat</h3>
      <div id="chatFriendsList" style="max-height:150px; overflow-y:auto; margin-bottom:12px;"></div>
    </div>
    <div class="card" style="display:none;" id="chatBoxContainer">
      <h4 id="chatWith"></h4>
      <div id="chatContainer"></div>
      <div id="typingIndicator"></div>
      <div id="replyPreview"></div>
      <div id="chatInputContainer">
        <button id="emojiBtn" title="Emoji">&#128515;</button>
        <input id="chatInput" type="text" placeholder="Type a message..." autocomplete="off" />
        <button id="sendBtn" disabled>Send</button>
      </div>
      <div id="emojiPicker"></div>
    </div>
  `;

  loadChatFriends();

  // Emoji picker logic
  const emojiBtn = document.getElementById('emojiBtn');
  const emojiPicker = document.getElementById('emojiPicker');
  const chatInput = document.getElementById('chatInput');

  const emojis = ['😀','😂','😍','😢','👍','🎉','❤️','🙌','😎','😡','🤔','😊','😇','🥳','😴'];

  emojiPicker.innerHTML = emojis.map(e => `<span>${e}</span>`).join('');

  emojiBtn.onclick = () => {
    emojiPicker.style.display = emojiPicker.style.display === 'block' ? 'none' : 'block';
  };

  emojiPicker.querySelectorAll('span').forEach(span => {
    span.onclick = () => {
      chatInput.value += span.textContent;
      chatInput.focus();
      emojiPicker.style.display = 'none';
      updateSendButton();
    };
  });

  chatInput.oninput = () => {
    updateSendButton();
    sendTypingStatus();
  };

  document.getElementById('sendBtn').onclick = sendMessage;

  // Clicking outside emoji picker closes it
  document.addEventListener('click', (e) => {
    if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
      emojiPicker.style.display = 'none';
    }
  });
}

function updateSendButton() {
  const sendBtn = document.getElementById('sendBtn');
  const chatInput = document.getElementById('chatInput');
  sendBtn.disabled = chatInput.value.trim() === '';
}

function loadChatFriends() {
  const uid = getCurrentUid();
  if (!uid) return;
  const friendsListDiv = document.getElementById('chatFriendsList');
  friendsListDiv.innerHTML = 'Loading...';

  db.collection('friends').doc(uid).get().then(doc => {
    if (!doc.exists || !doc.data().friends.length) {
      friendsListDiv.innerHTML = '<p>No friends available for chat.</p>';
      return;
    }
    const friendIds = doc.data().friends;
    const promises = friendIds.map(fid =>
      db.collection('users').doc(fid).get().then(userDoc => {
        const u = userDoc.data() || { name: "Unknown" };
        return { id: fid, name: u.name };
      })
    );

    Promise.all(promises).then(friends => {
      let html = '';
      friends.forEach(f => {
        html += `<div style="padding:8px; cursor:pointer; border-bottom:1px solid #eee;" onclick="selectChatFriend('${f.id}', '${escapeHtml(f.name)}')">${escapeHtml(f.name)}</div>`;
      });
      friendsListDiv.innerHTML = html;
    });
  });
}

function selectChatFriend(friendUid, friendName) {
  selectedChatFriend = friendUid;

  document.getElementById('chatWith').textContent = `Chat with ${friendName}`;
  document.getElementById('chatBoxContainer').style.display = 'block';
  document.getElementById('chatContainer').innerHTML = '';
  document.getElementById('replyPreview').style.display = 'none';
  replyToMessage = null;

  if (unsubscribeChat) unsubscribeChat();
  if (unsubscribeTyping) unsubscribeTyping();

  loadChatMessages();
  listenTypingStatus();
}

function getChatId(uid1, uid2) {
  return uid1 < uid2 ? uid1 + '_' + uid2 : uid2 + '_' + uid1;
}

function loadChatMessages() {
  const uid = getCurrentUid();
  if (!uid || !selectedChatFriend) return;
  const chatId = getChatId(uid, selectedChatFriend);
  const chatContainer = document.getElementById('chatContainer');
  chatContainer.innerHTML = '';

  unsubscribeChat = db.collection('chats').doc(chatId).collection('messages')
    .orderBy('timestamp')
    .onSnapshot(snapshot => {
      chatContainer.innerHTML = '';
      snapshot.forEach(doc => {
        const msg = doc.data();
        const isMe = msg.sender === uid;
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('chat-message');
        msgDiv.classList.add(isMe ? 'you' : 'friend');
        let content = escapeHtml(msg.content);
        if(msg.replyTo) {
          content = `<em>Reply to: ${escapeHtml(msg.replyToContent)}</em><br>${content}`;
        }
        msgDiv.innerHTML = content;

        const metaDiv = document.createElement('div');
        metaDiv.classList.add('chat-meta');
        const timeStr = msg.timestamp ? msg.timestamp.toDate().toLocaleTimeString() : '';
        metaDiv.textContent = timeStr;

        const actionsDiv = document.createElement('div');
        actionsDiv.classList.add('chat-actions');

        // Only sender can edit
        if (isMe) {
          const editBtn = document.createElement('button');
          editBtn.textContent = 'Edit';
          editBtn.onclick = () => startEditMessage(doc.id, msg.content);
          actionsDiv.appendChild(editBtn);
        }
        // Reply button for all
        const replyBtn = document.createElement('button');
        replyBtn.textContent = 'Reply';
        replyBtn.onclick = () => startReplyMessage(doc.id, msg.content);
        actionsDiv.appendChild(replyBtn);

        msgDiv.appendChild(metaDiv);
        msgDiv.appendChild(actionsDiv);
        chatContainer.appendChild(msgDiv);
      });
      chatContainer.scrollTop = chatContainer.scrollHeight;
    });
}

let editingMessageId = null;

function startEditMessage(msgId, currentContent) {
  if (!editingMessageId) {
    editingMessageId = msgId;
    const chatInput = document.getElementById('chatInput');
    chatInput.value = currentContent;
    chatInput.focus();
    document.getElementById('sendBtn').textContent = 'Save';
  }
}

function startReplyMessage(msgId, msgContent) {
  replyToMessage = { id: msgId, content: msgContent };
  const replyPreview = document.getElementById('replyPreview');
  replyPreview.textContent = `Replying to: ${msgContent}`;
  replyPreview.style.display = 'block';
}

function clearReply() {
  replyToMessage = null;
  const replyPreview = document.getElementById('replyPreview');
  replyPreview.style.display = 'none';
}

function sendMessage() {
  const uid = getCurrentUid();
  if (!uid || !selectedChatFriend) return;

  const chatId = getChatId(uid, selectedChatFriend);
  const chatInput = document.getElementById('chatInput');
  const content = chatInput.value.trim();
  if (!content) return;

  const messagesRef = db.collection('chats').doc(chatId).collection('messages');
  const timestamp = firebase.firestore.FieldValue.serverTimestamp();

  if (editingMessageId) {
    // Save edited message
    messagesRef.doc(editingMessageId).update({ content }).then(() => {
      editingMessageId = null;
      chatInput.value = '';
      document.getElementById('sendBtn').textContent = 'Send';
      clearReply();
    });
  } else {
    // Send new message
    let msgData = {
      sender: uid,
      content,
      timestamp
    };
    if (replyToMessage) {
      msgData.replyTo = replyToMessage.id;
      msgData.replyToContent = replyToMessage.content;
    }
    messagesRef.add(msgData).then(() => {
      chatInput.value = '';
      clearReply();
    });
  }
}

function sendTypingStatus() {
  const uid = getCurrentUid();
  if (!uid || !selectedChatFriend) return;
  const chatId = getChatId(uid, selectedChatFriend);
  const typingRef = db.collection('chats').doc(chatId).collection('typing').doc(uid);

  typingRef.set({ typing: true });
  setTimeout(() => typingRef.set({ typing: false }), 3000);
}

function listenTypingStatus() {
  const uid = getCurrentUid();
  if (!uid || !selectedChatFriend) return;
  const chatId = getChatId(uid, selectedChatFriend);
  const typingIndicator = document.getElementById('typingIndicator');

  unsubscribeTyping = db.collection('chats').doc(chatId).collection('typing')
    .onSnapshot(snapshot => {
      let typingUsers = [];
      snapshot.forEach(doc => {
        if (doc.id !== uid && doc.data().typing) typingUsers.push(doc.id);
      });
      if (typingUsers.length > 0) {
        typingIndicator.textContent = 'Friend is typing...';
      } else {
        typingIndicator.textContent = '';
      }
    });
}

// ==== SETTINGS ====

function renderSettings() {
  document.getElementById('app').innerHTML = `
    <div class="card">
      <button id="logoutBtn">Logout</button>
    </div>
  `;
  document.getElementById('logoutBtn').onclick = () => {
    auth.signOut();
  };
}

// ==== INIT APP ====

auth.onAuthStateChanged(user => {
  if (user) {
    document.getElementById('navBar').style.display = 'flex';
    showPage('feed');
  } else {
    document.getElementById('navBar').style.display = 'none';
    renderLogin();
  }
});
</script>

</body>
</html>
