<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Xinn Social</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<style>
  /* Reset & base */
  * {
    box-sizing: border-box;
  }
  body, html {
    margin:0; padding:0; height:100%;
    font-family: Arial, sans-serif;
    background: #f0f2f5;
  }
  header {
    background: #2196F3;
    color: white;
    padding: 10px;
    text-align: center;
    font-weight: bold;
    font-size: 1.5em;
  }
  /* Main container flex */
  .main-container {
    display: flex;
    flex-wrap: wrap;
    max-width: 1000px;
    margin: 20px auto;
    gap: 20px;
    padding: 0 10px;
  }
  /* Feed and sidebar */
  .feed {
    flex: 1 1 600px;
    max-width: 700px;
  }
  .sidebar {
    flex: 1 1 300px;
    max-width: 300px;
  }
  /* Cards */
  .card {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    padding: 15px;
    margin-bottom: 20px;
  }
  /* Inputs and buttons */
  input, textarea, button, select {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    border-radius: 5px;
    border: 1px solid #ccc;
    font-size: 1em;
  }
  button {
    background: #2196F3;
    color: white;
    border: none;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.2s ease;
  }
  button:hover {
    background: #1976d2;
  }
  /* Nav bar fixed bottom */
  nav {
    position: fixed;
    bottom: 0;
    left: 0; right: 0;
    background: white;
    display: flex;
    justify-content: space-around;
    border-top: 1px solid #ccc;
    padding: 10px 0;
    z-index: 1000;
  }
  nav button {
    background: none;
    color: #555;
    border: none;
    font-size: 24px;
  }
  nav button.active {
    color: #2196F3;
    font-weight: bold;
  }
  /* Post card */
  .post-card {
    word-break: break-word;
  }
  .post-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
  }
  .post-header .material-icons {
    font-size: 36px;
    color: #2196F3;
  }
  .post-content {
    font-size: 15px;
    margin-bottom: 8px;
  }
  .post-footer {
    display: flex;
    justify-content: flex-start;
    gap: 10px;
  }
  .post-footer button {
    background: none;
    border: none;
    color: #2196F3;
    cursor: pointer;
    font-size: 14px;
  }
  /* Profile avatar */
  .avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: #bbb;
    display: inline-block;
    object-fit: cover;
  }
  /* Responsive */
  @media (max-width: 768px) {
    .main-container {
      flex-direction: column;
      padding-bottom: 70px; /* for nav */
    }
    .feed, .sidebar {
      max-width: 100%;
    }
  }
</style>
</head>
<body>

<header>Xinn Social</header>

<div id="app" class="main-container"></div>

<nav id="navBar" style="display:none;">
  <button onclick="showPage('feed')" id="nav-feed" class="active" title="Feed"><span class="material-icons">home</span></button>
  <button onclick="showPage('friends')" id="nav-friends" title="Friends"><span class="material-icons">group</span></button>
  <button onclick="showPage('chat')" id="nav-chat" title="Chat"><span class="material-icons">chat</span></button>
  <button onclick="showPage('profile')" id="nav-profile" title="Profile"><span class="material-icons">person</span></button>
  <button onclick="showPage('settings')" id="nav-settings" title="Settings"><span class="material-icons">settings</span></button>
</nav>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
// Your Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDhVRhDDCM8vFbNe9f1Ag4Xn0901igl4s0",
  authDomain: "xinn-social.firebaseapp.com",
  projectId: "xinn-social",
  storageBucket: "xinn-social.firebasestorage.app",
  messagingSenderId: "860868128981",
  appId: "1:860868128981:web:a5cb9b2cb32b10077e725c",
  measurementId: "G-2ZFNQND35B"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUserData = null;

function setActiveNav(buttonId) {
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById(buttonId);
  if(btn) btn.classList.add('active');
}

// --- LOGIN & REGISTER ---

function renderLogin() {
  setActiveNav(null);
  document.getElementById('app').innerHTML = `
    <div class="card" style="max-width:400px;margin:40px auto;">
      <h3>Login to Xinn Social</h3>
      <input type="email" id="email" placeholder="Email (@xinn.lab only)" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="login()">Login</button>
      <p>Or <a href="#" onclick="renderRegister()">Register</a></p>
    </div>`;
  document.getElementById('navBar').style.display = 'none';
}

function renderRegister() {
  setActiveNav(null);
  document.getElementById('app').innerHTML = `
    <div class="card" style="max-width:400px;margin:40px auto;">
      <h3>Create Account</h3>
      <input type="text" id="name" placeholder="Full Name" />
      <input type="number" id="age" placeholder="Age" />
      <textarea id="bio" placeholder="Bio"></textarea>
      <input type="email" id="email" placeholder="Email (@xinn.lab only)" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="register()">Register</button>
      <p>Already have an account? <a href="#" onclick="renderLogin()">Login</a></p>
    </div>`;
  document.getElementById('navBar').style.display = 'none';
}

async function login() {
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value.trim();
  if (!email.endsWith('@xinn.lab')) {
    alert('Email must end with @xinn.lab');
    return;
  }
  try {
    await auth.signInWithEmailAndPassword(email, pass);
  } catch(e) {
    alert(e.message);
  }
}

async function register() {
  const name = document.getElementById('name').value.trim();
  const age = document.getElementById('age').value.trim();
  const bio = document.getElementById('bio').value.trim();
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value.trim();

  if (!email.endsWith('@xinn.lab')) {
    alert('Email must end with @xinn.lab');
    return;
  }
  if (!name || !age || !bio || !email || !pass) {
    alert('Please fill all fields');
    return;
  }

  try {
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    await db.collection('users').doc(cred.user.uid).set({ name, age, bio, email, avatar: "" });
    // Auto-login: no need to login again
  } catch(e) {
    alert(e.message);
  }
}

// --- NAVIGATION ---

function showPage(page) {
  if (!auth.currentUser) {
    renderLogin();
    return;
  }
  setActiveNav('nav-' + page);
  switch(page) {
    case 'feed': renderFeed(); break;
    case 'profile': renderProfile(auth.currentUser.uid); break;
    case 'friends': renderFriends(); break;
    case 'chat': renderChat(); break;
    case 'settings': renderSettings(); break;
  }
}

// --- FEED ---

function renderFeed() {
  document.getElementById('app').innerHTML = `
    <div class="feed">
      <div class="card">
        <textarea id="postContent" placeholder="What's on your mind?" rows="3" style="resize:none;"></textarea>
        <button onclick="createPost()">Post</button>
      </div>
      <div id="feedPosts"></div>
    </div>
    <div class="sidebar">
      <div class="card">
        <h3>Friends</h3>
        <div id="friendListFeed">Loading...</div>
      </div>
    </div>
  `;
  loadFriendsList('friendListFeed');
  loadPostsFeed();
}

function createPost() {
  const content = document.getElementById('postContent').value.trim();
  if (!content) return alert("Cannot post empty content");
  db.collection('posts').add({
    content,
    uid: auth.currentUser.uid,
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    visibility: "public"  // for future feature
  }).then(() => {
    document.getElementById('postContent').value = '';
  }).catch(e => alert(e.message));
}

function loadPostsFeed() {
  // Query posts ordered by timestamp desc
  // Requires composite index if filtering or ordering by multiple fields.
  db.collection('posts').orderBy('timestamp', 'desc').limit(20)
    .onSnapshot(snap => {
      let html = '';
      let promises = [];
      snap.forEach(doc => {
        const post = doc.data();
        promises.push(
          db.collection('users').doc(post.uid).get().then(userDoc => {
            const user = userDoc.data() || { name: "Unknown", avatar: "" };
            const timeStr = post.timestamp ? post.timestamp.toDate().toLocaleString() : "Just now";
            html += `
              <div class="card post-card">
                <div class="post-header">
                  ${user.avatar ? `<img src="${user.avatar}" alt="avatar" class="avatar">` :
                    `<span class="material-icons avatar">account_circle</span>`}
                  <div>
                    <strong style="cursor:pointer;" onclick="renderProfile('${doc.data().uid}')">${user.name}</strong><br>
                    <small style="color:gray;">${timeStr}</small>
                  </div>
                </div>
                <div class="post-content">${escapeHtml(post.content)}</div>
              </div>`;
          })
        );
      });
      Promise.all(promises).then(() => {
        document.getElementById('feedPosts').innerHTML = html || "<p>No posts yet.</p>";
      });
    }, e => {
      document.getElementById('feedPosts').innerHTML = "<p>Error loading posts.</p>";
    });
}

// --- PROFILE ---

function renderProfile(uid) {
  db.collection('users').doc(uid).get().then(doc => {
    if (!doc.exists) {
      alert("User not found");
      return;
    }
    const u = doc.data();
    currentUserData = u;

    // Allow editing only if own profile
    const isOwn = uid === auth.currentUser.uid;

    document.getElementById('app').innerHTML = `
      <div class="feed">
        <div class="card" style="text-align:center;">
          ${u.avatar ? `<img src="${u.avatar}" alt="avatar" class="avatar" style="width:100px;height:100px;">` :
            `<span class="material-icons avatar" style="font-size:100px;">account_circle</span>`}
          <h2>${u.name}</h2>
          <p><b>Age:</b> ${u.age}</p>
          <p><b>Bio:</b> ${escapeHtml(u.bio)}</p>
          ${isOwn ? '<button onclick="renderEditProfile()">Edit Profile</button>' : ''}
        </div>
        <div class="sidebar">
          <div class="card">
            <h3>Posts</h3>
            <div id="profilePosts">Loading...</div>
          </div>
        </div>
      </div>
    `;
    loadPostsByUser(uid, 'profilePosts');
  });
}

function renderEditProfile() {
  document.getElementById('app').innerHTML = `
    <div class="card" style="max-width:400px;margin:40px auto;">
      <h3>Edit Profile</h3>
      <label>Name</label>
      <input type="text" id="editName" value="${escapeHtml(currentUserData.name)}" />
      <label>Age</label>
      <input type="number" id="editAge" value="${escapeHtml(currentUserData.age)}" />
      <label>Bio</label>
      <textarea id="editBio">${escapeHtml(currentUserData.bio)}</textarea>
      <label>Avatar (Base64)</label>
      <textarea id="editAvatar" placeholder="Paste base64 image string here">${currentUserData.avatar || ''}</textarea>
      <button onclick="saveProfile()">Save</button>
      <button onclick="renderProfile('${auth.currentUser.uid}')">Cancel</button>
    </div>
  `;
}

function saveProfile() {
  const name = document.getElementById('editName').value.trim();
  const age = document.getElementById('editAge').value.trim();
  const bio = document.getElementById('editBio').value.trim();
  const avatar = document.getElementById('editAvatar').value.trim();

  if (!name || !age || !bio) return alert("Name, age and bio cannot be empty");

  db.collection('users').doc(auth.currentUser.uid).update({ name, age, bio, avatar })
    .then(() => {
      alert("Profile updated");
      renderProfile(auth.currentUser.uid);
    }).catch(e => alert(e.message));
}

// Load posts for profile user
function loadPostsByUser(uid, containerId) {
  db.collection('posts').where('uid', '==', uid).orderBy('timestamp', 'desc').limit(20)
    .onSnapshot(snap => {
      let html = '';
      snap.forEach(doc => {
        const p = doc.data();
        const timeStr = p.timestamp ? p.timestamp.toDate().toLocaleString() : "Just now";
        html += `
          <div class="card post-card">
            <div class="post-header">
              <span class="material-icons avatar">account_circle</span>
              <div>
                <small style="color:gray;">${timeStr}</small>
              </div>
            </div>
            <div class="post-content">${escapeHtml(p.content)}</div>
          </div>
        `;
      });
      document.getElementById(containerId).innerHTML = html || "<p>No posts yet.</p>";
    });
}

// --- FRIENDS (basic list, request UI) ---

function renderFriends() {
  document.getElementById('app').innerHTML = `
    <div class="sidebar" style="margin:auto;">
      <div class="card">
        <h3>Friend List</h3>
        <input type="text" id="friendSearchInput" placeholder="Search friends or users" oninput="searchUsers()" />
        <div id="friendSearchResults"></div>
      </div>
    </div>
  `;
  loadFriendsList('friendSearchResults');
}

// Load friend list to given containerId
function loadFriendsList(containerId) {
  const uid = auth.currentUser.uid;
  db.collection('users').doc(uid).collection('friends').get()
    .then(snap => {
      let html = '<ul style="list-style:none;padding:0;">';
      if (snap.empty) html += '<li>No friends yet.</li>';
      else {
        snap.forEach(doc => {
          const f = doc.data();
          html += `<li style="margin-bottom:8px;">
            <strong>${escapeHtml(f.name)}</strong>
          </li>`;
        });
      }
      html += '</ul>';
      document.getElementById(containerId).innerHTML = html;
    });
}

let userSearchTimeout = null;
function searchUsers() {
  const query = document.getElementById('friendSearchInput').value.trim().toLowerCase();
  const container = document.getElementById('friendSearchResults');
  if (!query) {
    container.innerHTML = '';
    return;
  }
  // Debounce search to reduce reads
  if (userSearchTimeout) clearTimeout(userSearchTimeout);
  userSearchTimeout = setTimeout(() => {
    db.collection('users')
      .where('name_lower', '>=', query)
      .where('name_lower', '<=', query + '\uf8ff')
      .limit(10)
      .get()
      .then(snap => {
        if (snap.empty) {
          container.innerHTML = '<p>No users found.</p>';
          return;
        }
        let html = '<ul style="list-style:none;padding:0;">';
        snap.forEach(doc => {
          const u = doc.data();
          if (u.email === auth.currentUser.email) return; // skip self
          html += `<li style="margin-bottom:8px;">
            <strong style="cursor:pointer;" onclick="renderProfile('${doc.id}')">${escapeHtml(u.name)}</strong> 
            <button onclick="sendFriendRequest('${doc.id}', '${escapeHtml(u.name)}')">Add Friend</button>
          </li>`;
        });
        html += '</ul>';
        container.innerHTML = html;
      }).catch(e => {
        container.innerHTML = '<p>Error searching users.</p>';
      });
  }, 500);
}

function sendFriendRequest(targetUid, targetName) {
  const uid = auth.currentUser.uid;
  if (confirm(`Send friend request to ${targetName}?`)) {
    // Add request doc under target user's friendRequests collection
    db.collection('users').doc(targetUid).collection('friendRequests').doc(uid).set({
      from: uid,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
      alert("Friend request sent");
    }).catch(e => {
      alert("Error sending friend request: " + e.message);
    });
  }
}

// --- CHAT placeholder ---
function renderChat() {
  document.getElementById('app').innerHTML = `
    <div class="card" style="max-width:600px;margin:40px auto;">
      <h3>Chat</h3>
      <p>Coming soon...</p>
    </div>
  `;
}

// --- SETTINGS ---

function renderSettings() {
  document.getElementById('app').innerHTML = `
    <div class="card" style="max-width:400px;margin:40px auto;">
      <h3>Settings</h3>
      <button onclick="logout()">Logout</button>
    </div>
  `;
}

function logout() {
  auth.signOut();
}

// --- UTILITIES ---

function escapeHtml(text) {
  if (!text) return '';
  return text.replace(/[&<>"']/g, m => {
    switch(m) {
      case '&': return '&amp;';
      case '<': return '&lt;';
      case '>': return '&gt;';
      case '"': return '&quot;';
      case "'": return '&#39;';
      default: return m;
    }
  });
}

// --- INIT ---

auth.onAuthStateChanged(user => {
  if (user) {
    // Update user profile in currentUserData
    db.collection('users').doc(user.uid).get().then(doc => {
      currentUserData = doc.data();
    });
    showPage('feed');
    document.getElementById('navBar').style.display = 'flex';
  } else {
    renderLogin();
  }
});

</script>

</body>
</html>
