<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Xinn Social</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<style>
  /* GENERAL STYLES */
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    background: #f0f2f5;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header {
    background: #2196f3;
    color: white;
    padding: 10px 0;
    text-align: center;
    font-weight: 600;
    font-size: 1.3rem;
    user-select: none;
  }
  .container {
    padding: 20px;
  }
  .card {
    background: white;
    padding: 15px;
    margin: 10px 0;
    border-radius: 12px;
    box-shadow: 0 1.5px 4px rgba(0,0,0,0.15);
  }
  input, textarea, button, select {
    font-family: inherit;
    font-size: 1rem;
    width: 100%;
    padding: 10px;
    margin: 5px 0 10px;
    border-radius: 6px;
    border: 1.5px solid #ccc;
    transition: border-color 0.3s;
  }
  input:focus, textarea:focus {
    outline: none;
    border-color: #2196f3;
  }
  button {
    background: #2196f3;
    color: white;
    border: none;
    cursor: pointer;
    font-weight: 600;
    border-radius: 6px;
    transition: background-color 0.3s;
  }
  button:hover:not(:disabled) {
    background: #1976d2;
  }
  button:disabled {
    background: #90caf9;
    cursor: default;
  }
  nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    display: flex;
    justify-content: space-around;
    border-top: 1px solid #ccc;
    padding: 10px 0;
    user-select: none;
    z-index: 100;
  }
  nav button {
    background: none;
    border: none;
    color: #555;
    font-size: 24px;
    padding: 4px 8px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  nav button.active {
    color: #2196f3;
    font-weight: bold;
  }
  nav button:focus {
    outline: none;
  }

  /* CHAT CONTAINER */
  .chat-container {
    display: flex;
    height: calc(100vh - 96px); /* full height minus header & nav */
    overflow: hidden;
  }
  #friendsList {
    width: 260px;
    background: white;
    border-right: 1px solid #ddd;
    display: flex;
    flex-direction: column;
  }
  #friendsList h3 {
    padding: 15px 20px;
    border-bottom: 1px solid #eee;
    font-weight: 600;
    color: #333;
  }
  #chatFriendsContainer {
    flex-grow: 1;
    overflow-y: auto;
  }
  #chatFriendsContainer > div {
    cursor: pointer;
    padding: 14px 20px;
    border-bottom: 1px solid #eee;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: background-color 0.2s;
  }
  #chatFriendsContainer > div:hover {
    background-color: #e9f0ff;
  }
  #chatFriendsContainer > div.active {
    background-color: #d0e2ff;
    font-weight: 600;
  }
  #chatFriendsContainer .material-icons {
    color: #2196f3;
    font-size: 28px;
  }

  #chatWindow {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    background: #f7f9fc;
  }

  #chatMessages {
    flex-grow: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
    scrollbar-width: thin;
    scrollbar-color: #90caf9 transparent;
  }
  #chatMessages::-webkit-scrollbar {
    width: 8px;
  }
  #chatMessages::-webkit-scrollbar-thumb {
    background-color: #90caf9;
    border-radius: 4px;
  }
  #chatMessages::-webkit-scrollbar-track {
    background: transparent;
  }

  /* MESSAGE BUBBLES */
  .message {
    max-width: 70%;
    padding: 10px 15px;
    border-radius: 18px;
    position: relative;
    word-wrap: break-word;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    font-size: 0.95rem;
    line-height: 1.3;
  }
  .message.you {
    background-color: #dcf8c6;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
    color: #202c33;
  }
  .message.friend {
    background-color: white;
    align-self: flex-start;
    border-bottom-left-radius: 4px;
    color: #111;
  }
  .message small {
    font-size: 0.7rem;
    color: #666;
    position: absolute;
    bottom: 4px;
    right: 10px;
  }

  /* Reply snippet */
  .reply-to {
    font-size: 0.8rem;
    background: #e1e1e1;
    border-left: 4px solid #2196f3;
    padding: 4px 8px;
    margin-bottom: 6px;
    cursor: pointer;
    border-radius: 8px;
    color: #333;
    max-width: 90%;
  }

  /* Actions buttons under each message */
  .actions {
    margin-top: 6px;
    display: flex;
    gap: 12px;
  }
  .actions button {
    font-size: 0.8rem;
    background: transparent;
    border: none;
    color: #2196f3;
    cursor: pointer;
    padding: 2px 6px;
    border-radius: 4px;
    transition: background-color 0.2s;
  }
  .actions button:hover {
    background-color: #bbdefb;
  }
  .actions button:focus {
    outline: none;
  }

  /* Edit message textarea */
  #editMsgInput {
    width: 100%;
    border-radius: 12px;
    border: 1.5px solid #2196f3;
    padding: 8px;
    resize: none;
    font-size: 1rem;
  }

  /* Reply preview bar above input */
  #replyPreview {
    background: #e9f0ff;
    border-left: 4px solid #2196f3;
    padding: 6px 12px;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-radius: 6px;
    font-size: 0.9rem;
    color: #222;
  }
  #replyPreview button {
    font-weight: bold;
    font-size: 1.2rem;
    line-height: 1;
    color: #666;
    background: transparent;
    border: none;
    cursor: pointer;
  }
  #replyPreview button:hover {
    color: #2196f3;
  }

  /* Chat input container */
  #chatInputContainer {
    padding: 12px 16px;
    background: white;
    border-top: 1px solid #ddd;
    display: flex;
    gap: 10px;
    align-items: center;
  }
  #chatInput {
    flex-grow: 1;
    resize: none;
    border-radius: 20px;
    border: 1.5px solid #ccc;
    padding: 10px 15px;
    font-size: 1rem;
    font-family: inherit;
    min-height: 38px;
    max-height: 120px;
    overflow-y: auto;
    transition: border-color 0.3s;
  }
  #chatInput:focus {
    border-color: #2196f3;
    outline: none;
  }
  #sendChatBtn {
    background: #2196f3;
    border-radius: 50%;
    width: 42px;
    height: 42px;
    font-size: 24px;
    line-height: 42px;
    padding: 0;
    text-align: center;
    color: white;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  #sendChatBtn:disabled {
    background: #90caf9;
    cursor: default;
  }
  #sendChatBtn:hover:not(:disabled) {
    background: #1976d2;
  }

  /* Smaller nav icons for better fit */
  nav button .material-icons {
    font-size: 26px;
  }

  /* Scrollbar for friend list */
  #chatFriendsContainer::-webkit-scrollbar {
    width: 8px;
  }
  #chatFriendsContainer::-webkit-scrollbar-thumb {
    background-color: #90caf9;
    border-radius: 4px;
  }
  #chatFriendsContainer::-webkit-scrollbar-track {
    background: transparent;
  }

  /* Responsive tweaks */
  @media (max-width: 768px) {
    .chat-container {
      flex-direction: column;
      height: auto;
    }
    #friendsList {
      width: 100%;
      max-height: 180px;
      border-right: none;
      border-bottom: 1px solid #ddd;
      overflow-x: auto;
      display: flex;
      flex-direction: row;
      gap: 5px;
    }
    #chatFriendsContainer > div {
      flex: 0 0 auto;
      border-bottom: none;
      border-right: 1px solid #eee;
      padding: 10px 15px;
      white-space: nowrap;
    }
    #chatWindow {
      height: 60vh;
    }
  }
</style>
</head>
<body>

<header><h2>Xinn Social</h2></header>

<div id="app"></div>

<nav id="navBar" style="display:none;">
  <button onclick="showPage('feed')" title="feed"><span class="material-icons">home</span></button>
  <button onclick="showPage('friends')" title="friends"><span class="material-icons">group</span></button>
  <button onclick="showPage('chat')" title="chat"><span class="material-icons">chat</span></button>
  <button onclick="showPage('profile')" title="profile"><span class="material-icons">person</span></button>
  <button onclick="showPage('settings')" title="settings"><span class="material-icons">settings</span></button>
</nav>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCGN7t5FjDeJ-ewm7S_9z0VJrRSggTaJ2Q",
  authDomain: "coin-base-by-hector.firebaseapp.com",
  databaseURL: "https://coin-base-by-hector-default-rtdb.firebaseio.com",
  projectId: "coin-base-by-hector",
  storageBucket: "coin-base-by-hector.firebasestorage.app",
  messagingSenderId: "398789890422",
  appId: "1:398789890422:web:ed6a928037b24be2e36a57",
  measurementId: "G-SGJJM5K3G9"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Utility: escape HTML for safe output
function escapeHtml(text) {
  if (!text) return '';
  return text.replace(/[&<>"']/g, (m) => {
    switch(m) {
      case '&': return '&amp;';
      case '<': return '&lt;';
      case '>': return '&gt;';
      case '"': return '&quot;';
      case "'": return '&#39;';
      default: return m;
    }
  });
}

function getCurrentUid() {
  return auth.currentUser ? auth.currentUser.uid : null;
}

// ----- LOGIN & REGISTER -----
function renderLogin() {
  document.getElementById('app').innerHTML = `
    <div class="container card" style="max-width: 400px; margin: 30px auto;">
      <h3>Login to Xinn Social</h3>
      <input type="email" id="email" placeholder="Email (@xinn.lab only)" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="login()">Login</button>
      <p style="text-align:center; margin-top:12px;">
        Or <a href="#" onclick="renderRegister()">Register</a>
      </p>
    </div>`;
}

function renderRegister() {
  document.getElementById('app').innerHTML = `
    <div class="container card" style="max-width: 400px; margin: 30px auto;">
      <h3>Create Account</h3>
      <input type="text" id="name" placeholder="Full Name" />
      <input type="number" id="age" placeholder="Age" />
      <textarea id="bio" placeholder="Bio"></textarea>
      <input type="email" id="email" placeholder="Email (@xinn.lab only)" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="register()">Register</button>
      <p style="text-align:center; margin-top:12px;">
        Already have an account? <a href="#" onclick="renderLogin()">Login</a>
      </p>
    </div>`;
}

function login() {
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value.trim();
  if (!email.endsWith('@xinn.lab')) {
    alert('Email must end with @xinn.lab');
    return;
  }
  auth.signInWithEmailAndPassword(email, pass).catch(e => alert(e.message));
}

function register() {
  const name = document.getElementById('name').value.trim();
  const age = document.getElementById('age').value.trim();
  const bio = document.getElementById('bio').value.trim();
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value.trim();
  if (!email.endsWith('@xinn.lab')) {
    alert('Email must end with @xinn.lab');
    return;
  }
  auth.createUserWithEmailAndPassword(email, pass)
    .then(cred => {
      return db.collection('users').doc(cred.user.uid).set({ name, age, bio, email });
    })
    .catch(e => alert(e.message));
}

// ----- FEED -----
function renderFeed() {
  document.getElementById('app').innerHTML = `
    <div class="container">
      <div class="card">
        <textarea id="postContent" placeholder="What's on your mind?" style="resize:none;"></textarea>
        <button onclick="createPost()">Post</button>
      </div>
      <div id="feedPosts"></div>
    </div>`;
  loadPosts();
}

function createPost() {
  const content = document.getElementById('postContent').value.trim();
  if (!content) return;
  db.collection('posts').add({
    content,
    uid: auth.currentUser.uid,
    likes: [],
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
  document.getElementById('postContent').value = '';
}

function loadPosts() {
  db.collection('posts').orderBy('timestamp', 'desc').onSnapshot(snap => {
    let html = '';
    let postPromises = [];

    snap.forEach(doc => {
      const p = doc.data();
      postPromises.push(
        db.collection('users').doc(p.uid).get().then(userDoc => {
          const user = userDoc.data() || { name: "Unknown" };
          const time = p.timestamp ? p.timestamp.toDate().toLocaleString() : "Just now";

          html += `
            <div class="card" style="padding: 12px;">
              <div style="display:flex;align-items:center;margin-bottom:8px;">
                <span class="material-icons" style="font-size:36px;color:#2196F3;margin-right:10px;">account_circle</span>
                <div>
                  <strong>${escapeHtml(user.name)}</strong><br>
                  <small style="color:gray;">${time}</small>
                </div>
              </div>
              <div style="margin:10px 0;font-size:15px;">${escapeHtml(p.content)}</div>
              <hr style="margin:8px 0;">
              <button onclick="toggleLike('${doc.id}')" style="background:none;color:#2196F3;border:none;cursor:pointer;">
                👍 Like (${p.likes.length})
              </button>
            </div>`;
        })
      );
    });

    Promise.all(postPromises).then(() => {
      document.getElementById('feedPosts').innerHTML = html;
    });
  });
}

function toggleLike(postId) {
  const ref = db.collection('posts').doc(postId);
  ref.get().then(doc => {
    const data = doc.data();
    let likes = data.likes || [];
    if (likes.includes(auth.currentUser.uid)) {
      likes = likes.filter(id => id !== auth.currentUser.uid);
    } else {
      likes.push(auth.currentUser.uid);
    }
    ref.update({ likes });
  });
}

// ----- PROFILE -----
function renderProfile() {
  db.collection('users').doc(auth.currentUser.uid).get().then(doc => {
    const u = doc.data();
    document.getElementById('app').innerHTML = `
      <div class="container">
        <div class="card">
          <h3>${escapeHtml(u.name)}</h3>
          <p>Age: ${escapeHtml(u.age)}</p>
          <p>Bio: ${escapeHtml(u.bio)}</p>
          <button onclick="editProfile()">Edit Profile</button>
        </div>
      </div>`;
  });
}

function editProfile() {
  db.collection('users').doc(auth.currentUser.uid).get().then(doc => {
    const u = doc.data();
    document.getElementById('app').innerHTML = `
      <div class="container card" style="max-width: 400px; margin: 20px auto;">
        <input id="name" value="${escapeHtml(u.name)}" placeholder="Full Name" />
        <input id="age" value="${escapeHtml(u.age)}" placeholder="Age" />
        <textarea id="bio" placeholder="Bio">${escapeHtml(u.bio)}</textarea>
        <button onclick="saveProfile()">Save</button>
      </div>`;
  });
}

function saveProfile() {
  const name = document.getElementById('name').value.trim();
  const age = document.getElementById('age').value.trim();
  const bio = document.getElementById('bio').value.trim();
  db.collection('users').doc(auth.currentUser.uid).update({ name, age, bio });
  renderProfile();
}

// ----- FRIEND SYSTEM -----
function renderFriends() {
  document.getElementById('app').innerHTML = `
    <div class="container card" style="max-width: 600px; margin: 20px auto;">
      <h3>Friends</h3>
      <input type="text" id="searchFriend" placeholder="Search users by name or email" />
      <button onclick="searchUsers()">Search</button>
      <div id="searchResults" style="margin-top: 15px;"></div>
      <hr />
      <h4>Friend Requests</h4>
      <div id="friendRequests"></div>
      <hr />
      <h4>Your Friends</h4>
      <div id="friendList"></div>
    </div>`;
  loadFriendRequests();
  loadFriends();
}

function searchUsers() {
  const q = document.getElementById('searchFriend').value.trim().toLowerCase();
  if (!q) return;

  db.collection('users')
    .where('name_lower', '>=', q)
    .where('name_lower', '<=', q + '\uf8ff')
    .limit(10)
    .get()
    .then(snapshot => {
      let html = '';
      snapshot.forEach(doc => {
        const user = doc.data();
        if (doc.id === getCurrentUid()) return; // don't show self
        html += `
          <div style="display:flex; justify-content: space-between; padding: 8px 0;">
            <span>${escapeHtml(user.name)} (${escapeHtml(user.email)})</span>
            <button onclick="sendFriendRequest('${doc.id}')">Add Friend</button>
          </div>
        `;
      });
      document.getElementById('searchResults').innerHTML = html || '<p>No users found</p>';
    });
}

function sendFriendRequest(friendUid) {
  const uid = getCurrentUid();
  if (!uid) return;

  // Create a friend request in both users' collections
  const batch = db.batch();

  const myRequestRef = db.collection('users').doc(uid)
    .collection('friend_requests_sent').doc(friendUid);
  batch.set(myRequestRef, { sentAt: firebase.firestore.FieldValue.serverTimestamp() });

  const theirRequestRef = db.collection('users').doc(friendUid)
    .collection('friend_requests_received').doc(uid);
  batch.set(theirRequestRef, { sentAt: firebase.firestore.FieldValue.serverTimestamp() });

  batch.commit().then(() => {
    alert('Friend request sent!');
    loadFriendRequests();
  }).catch(err => {
    alert('Error sending friend request: ' + err.message);
  });
}

function loadFriendRequests() {
  const uid = getCurrentUid();
  if (!uid) return;

  const receivedRef = db.collection('users').doc(uid).collection('friend_requests_received');

  receivedRef.onSnapshot(snapshot => {
    let html = '';
    if (snapshot.empty) {
      html = '<p>No friend requests</p>';
    } else {
      snapshot.forEach(doc => {
        const requesterUid = doc.id;
        db.collection('users').doc(requesterUid).get().then(userDoc => {
          const user = userDoc.data() || {};
          html += `
            <div style="display:flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee;">
              <span>${escapeHtml(user.name || 'Unknown')}</span>
              <div>
                <button onclick="acceptFriend('${requesterUid}')">Accept</button>
                <button onclick="declineFriend('${requesterUid}')">Decline</button>
              </div>
            </div>`;
          document.getElementById('friendRequests').innerHTML = html;
        });
      });
    }
  });
}

function acceptFriend(friendUid) {
  const uid = getCurrentUid();
  if (!uid) return;

  const batch = db.batch();

  // Add to each other's friends collection
  batch.set(db.collection('users').doc(uid).collection('friends').doc(friendUid), { since: firebase.firestore.FieldValue.serverTimestamp() });
  batch.set(db.collection('users').doc(friendUid).collection('friends').doc(uid), { since: firebase.firestore.FieldValue.serverTimestamp() });

  // Remove friend requests
  batch.delete(db.collection('users').doc(uid).collection('friend_requests_received').doc(friendUid));
  batch.delete(db.collection('users').doc(friendUid).collection('friend_requests_sent').doc(uid));

  batch.commit().then(() => {
    loadFriendRequests();
    loadFriends();
  });
}

function declineFriend(friendUid) {
  const uid = getCurrentUid();
  if (!uid) return;

  const batch = db.batch();

  batch.delete(db.collection('users').doc(uid).collection('friend_requests_received').doc(friendUid));
  batch.delete(db.collection('users').doc(friendUid).collection('friend_requests_sent').doc(uid));

  batch.commit().then(() => {
    loadFriendRequests();
  });
}

function loadFriends() {
  const uid = getCurrentUid();
  if (!uid) return;

  db.collection('users').doc(uid).collection('friends').onSnapshot(snapshot => {
    let html = '';
    if (snapshot.empty) {
      html = '<p>You have no friends yet.</p>';
    } else {
      snapshot.forEach(doc => {
        const friendUid = doc.id;
        db.collection('users').doc(friendUid).get().then(userDoc => {
          const user = userDoc.data() || {};
          html += `
            <div style="display:flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee;">
              <span>${escapeHtml(user.name || 'Unknown')}</span>
              <button onclick="startChat('${friendUid}', '${escapeHtml(user.name || 'Friend')}')">Chat</button>
            </div>`;
          document.getElementById('friendList').innerHTML = html;
        });
      });
    }
  });
}

// ----- CHAT -----
let currentChatFriendUid = null;
let currentChatFriendName = '';
let editingMessageId = null;
let replyingMessage = null;

function renderChat() {
  if (!currentChatFriendUid) {
    document.getElementById('app').innerHTML = `
      <div class="container card" style="max-width: 600px; margin: 20px auto; text-align: center;">
        <p>Select a friend to start chatting from the Friends page.</p>
      </div>`;
    return;
  }

  document.getElementById('app').innerHTML = `
    <div class="chat-container" style="max-width: 900px; margin: 20px auto; box-shadow: 0 1.5px 8px rgba(0,0,0,0.2); border-radius: 12px; background: white;">
      <div id="friendsList">
        <h3>Friends</h3>
        <div id="chatFriendsContainer">Loading friends...</div>
      </div>
      <div id="chatWindow" style="display:flex; flex-direction: column;">
        <div style="padding: 14px 20px; border-bottom: 1px solid #ddd; font-weight: 600; font-size: 1.1rem; color: #2196f3;">
          Chat with ${escapeHtml(currentChatFriendName)}
        </div>
        <div id="chatMessages"></div>

        <div id="replyPreview" style="display:none;">
          <span>Replying to: <strong id="replyText"></strong></span>
          <button title="Cancel Reply" onclick="cancelReply()">&times;</button>
        </div>

        <div id="chatInputContainer">
          <textarea id="chatInput" rows="2" placeholder="Type a message..."></textarea>
          <button id="sendChatBtn" title="Send message" disabled>&#9658;</button>
        </div>
      </div>
    </div>`;

  loadChatFriends();
  loadChatMessages();

  // Enable send button only when text present
  const chatInput = document.getElementById('chatInput');
  const sendBtn = document.getElementById('sendChatBtn');
  chatInput.addEventListener('input', () => {
    sendBtn.disabled = chatInput.value.trim().length === 0;
  });
  sendBtn.onclick = sendMessage;
}

function loadChatFriends() {
  const uid = getCurrentUid();
  if (!uid) return;

  db.collection('users').doc(uid).collection('friends').get().then(snapshot => {
    let html = '';
    if (snapshot.empty) {
      html = '<p style="padding:10px;">No friends found</p>';
    } else {
      snapshot.forEach(doc => {
        const friendUid = doc.id;
        db.collection('users').doc(friendUid).get().then(userDoc => {
          const user = userDoc.data() || {};
          const isActive = friendUid === currentChatFriendUid ? 'active' : '';
          html += `
            <div class="${isActive}" onclick="startChat('${friendUid}', '${escapeHtml(user.name || "Friend")}')">
              <span class="material-icons">account_circle</span>
              <span>${escapeHtml(user.name || 'Friend')}</span>
            </div>`;
          document.getElementById('chatFriendsContainer').innerHTML = html;
        });
      });
    }
  });
}

function getChatId(uid1, uid2) {
  return uid1 < uid2 ? uid1 + '_' + uid2 : uid2 + '_' + uid1;
}

function loadChatMessages() {
  const uid = getCurrentUid();
  if (!uid || !currentChatFriendUid) return;

  const chatId = getChatId(uid, currentChatFriendUid);
  const messagesRef = db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp');

  messagesRef.onSnapshot(snapshot => {
    const container = document.getElementById('chatMessages');
    container.innerHTML = '';
    snapshot.forEach(doc => {
      const msg = doc.data();
      const msgId = doc.id;
      const isYou = msg.uid === uid;

      // Compose message bubble
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message ' + (isYou ? 'you' : 'friend');
      messageDiv.dataset.msgId = msgId;

      // Reply snippet
      let replyHTML = '';
      if (msg.replyText) {
        replyHTML = `<div class="reply-to" onclick="scrollToMessage('${msg.replyTo}')">${escapeHtml(msg.replyText)}</div>`;
      }

      // Editing state
      if (editingMessageId === msgId) {
        messageDiv.innerHTML = `
          ${replyHTML}
          <textarea id="editMsgInput" rows="3" style="border: 1.5px solid #2196f3; border-radius: 12px; width: 100%; resize:none; font-size: 1rem; padding:8px;">${escapeHtml(msg.text)}</textarea>
          <div class="actions" style="justify-content: flex-end;">
            <button onclick="saveEditedMessage('${msgId}')">Save</button>
            <button onclick="cancelEdit()">Cancel</button>
          </div>`;
      } else {
        // Normal message view
        const time = msg.timestamp ? msg.timestamp.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
        messageDiv.innerHTML = `
          ${replyHTML}
          <div>${escapeHtml(msg.text)}</div>
          <small>${time}</small>
        `;

        // Actions buttons (edit/reply)
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'actions';

        if (isYou) {
          actionsDiv.innerHTML += `<button onclick="startEditMessage('${msgId}')">Edit</button>`;
        }
        actionsDiv.innerHTML += `<button onclick="startReplyMessage('${msgId}', '${escapeHtml(msg.text)}')">Reply</button>`;

        messageDiv.appendChild(actionsDiv);
      }

      container.appendChild(messageDiv);
    });

    // Scroll to bottom on new message
    container.scrollTop = container.scrollHeight;
  });
}

function startChat(friendUid, friendName) {
  currentChatFriendUid = friendUid;
  currentChatFriendName = friendName;
  editingMessageId = null;
  replyingMessage = null;
  renderChat();
}

function sendMessage() {
  const uid = getCurrentUid();
  if (!uid || !currentChatFriendUid) return;

  const input = document.getElementById('chatInput');
  let text = input.value.trim();
  if (!text) return;

  const chatId = getChatId(uid, currentChatFriendUid);
  const messagesRef = db.collection('chats').doc(chatId).collection('messages');

  const newMsg = {
    uid,
    text,
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    replyTo: replyingMessage ? replyingMessage.msgId : null,
    replyText: replyingMessage ? replyingMessage.text : null,
  };

  messagesRef.add(newMsg).then(() => {
    input.value = '';
    document.getElementById('sendChatBtn').disabled = true;
    cancelReply();
    cancelEdit();
  });
}

function startEditMessage(msgId) {
  editingMessageId = msgId;
  renderChat();
}

function saveEditedMessage(msgId) {
  const newText = document.getElementById('editMsgInput').value.trim();
  if (!newText) return alert('Message cannot be empty');
  const uid = getCurrentUid();
  if (!uid) return;

  const chatId = getChatId(uid, currentChatFriendUid);
  const msgRef = db.collection('chats').doc(chatId).collection('messages').doc(msgId);

  msgRef.get().then(doc => {
    if (doc.exists && doc.data().uid === uid) {
      msgRef.update({ text: newText }).then(() => {
        editingMessageId = null;
        renderChat();
      });
    } else {
      alert('You can only edit your own messages.');
    }
  });
}

function cancelEdit() {
  editingMessageId = null;
  renderChat();
}

function startReplyMessage(msgId, text) {
  replyingMessage = { msgId, text };
  updateReplyPreview();
}

function cancelReply() {
  replyingMessage = null;
  updateReplyPreview();
}

function updateReplyPreview() {
  const replyPreview = document.getElementById('replyPreview');
  if (!replyPreview) return;

  if (replyingMessage) {
    document.getElementById('replyText').textContent = replyingMessage.text;
    replyPreview.style.display = 'flex';
  } else {
    replyPreview.style.display = 'none';
  }
}

function scrollToMessage(msgId) {
  const msgDiv = document.querySelector(`[data-msg-id="${msgId}"]`);
  if (msgDiv) {
    msgDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
    msgDiv.style.backgroundColor = '#ffffa8';
    setTimeout(() => {
      msgDiv.style.backgroundColor = '';
    }, 1500);
  }
}

// ----- NAV & PAGE HANDLER -----
function showPage(page) {
  currentPage = page;
  navButtons.forEach(btn => btn.classList.remove('active'));
  const btn = Array.from(navButtons).find(b => b.title === page);
  if (btn) btn.classList.add('active');

  if (page === 'feed') renderFeed();
  else if (page === 'friends') renderFriends();
  else if (page === 'chat') renderChat();
  else if (page === 'profile') renderProfile();
  else if (page === 'settings') renderSettings();
}

function renderSettings() {
  document.getElementById('app').innerHTML = `
    <div class="container card" style="max-width: 400px; margin: 20px auto;">
      <h3>Settings</h3>
      <button onclick="logout()">Logout</button>
    </div>`;
}

function logout() {
  auth.signOut();
  navBar.style.display = 'none';
  renderLogin();
}

let currentPage = 'feed';
const navBar = document.getElementById('navBar');
const navButtons = navBar.querySelectorAll('button');

// --- AUTH STATE ---
auth.onAuthStateChanged(user => {
  if (user) {
    navBar.style.display = 'flex';
    showPage(currentPage);
  } else {
    navBar.style.display = 'none';
    renderLogin();
  }
});
</script>
</body>
</html>
