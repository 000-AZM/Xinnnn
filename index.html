<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Xinn Social</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<style>
  body { font-family: Arial, sans-serif; margin:0; background:#f0f2f5; }
  header { background:#2196F3; color:white; padding:10px; text-align:center; }
  .container { padding:20px; }
  .card { background:white; padding:15px; margin:10px 0; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
  input, textarea, button, select {
    width:100%; padding:10px; margin:5px 0; border:1px solid #ccc; border-radius:5px;
  }
  button { background:#2196F3; color:white; border:none; cursor:pointer; }
  nav { position:fixed; bottom:0; left:0; right:0; background:white; display:flex; justify-content:space-around; border-top:1px solid #ccc; padding:10px 0; }
  nav button { background:none; color:#555; border:none; font-size:24px; cursor:pointer; }
  nav button.active { color:#2196F3; font-weight:bold; }
</style>
</head>
<body>

<header><h2>Xinn Social</h2></header>

<div id="app"></div>

<nav id="navBar" style="display:none;">
  <button onclick="showPage('feed')" title="Feed"><span class="material-icons">home</span></button>
  <button onclick="showPage('friends')" title="Friends"><span class="material-icons">group</span></button>
  <button onclick="showPage('chat')" title="Chat"><span class="material-icons">chat</span></button>
  <button onclick="showPage('profile')" title="Profile"><span class="material-icons">person</span></button>
  <button onclick="showPage('settings')" title="Settings"><span class="material-icons">settings</span></button>
</nav>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCGN7t5FjDeJ-ewm7S_9z0VJrRSggTaJ2Q",
  authDomain: "coin-base-by-hector.firebaseapp.com",
  databaseURL: "https://coin-base-by-hector-default-rtdb.firebaseio.com",
  projectId: "coin-base-by-hector",
  storageBucket: "coin-base-by-hector.firebasestorage.app",
  messagingSenderId: "398789890422",
  appId: "1:398789890422:web:ed6a928037b24be2e36a57",
  measurementId: "G-SGJJM5K3G9"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

function getCurrentUid() {
  return auth.currentUser ? auth.currentUser.uid : null;
}

function renderLogin() {
  document.getElementById('app').innerHTML = `
    <div class="container card">
      <h3>Login to Xinn Social</h3>
      <input type="email" id="email" placeholder="Email (@xinn.lab only)" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="login()">Login</button>
      <p>Or <a href="#" onclick="renderRegister()">Register</a></p>
    </div>`;
}

function renderRegister() {
  document.getElementById('app').innerHTML = `
    <div class="container card">
      <h3>Create Account</h3>
      <input type="text" id="name" placeholder="Full Name" />
      <input type="number" id="age" placeholder="Age" />
      <textarea id="bio" placeholder="Bio"></textarea>
      <input type="email" id="email" placeholder="Email (@xinn.lab only)" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="register()">Register</button>
      <p>Already have an account? <a href="#" onclick="renderLogin()">Login</a></p>
    </div>`;
}

function login() {
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value.trim();
  if (!email.endsWith('@xinn.lab')) {
    alert('Email must end with @xinn.lab');
    return;
  }
  auth.signInWithEmailAndPassword(email, pass)
    .catch(e => alert(e.message));
}

function register() {
  const name = document.getElementById('name').value.trim();
  const age = document.getElementById('age').value.trim();
  const bio = document.getElementById('bio').value.trim();
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value.trim();

  if (!email.endsWith('@xinn.lab')) {
    alert('Email must end with @xinn.lab');
    return;
  }
  auth.createUserWithEmailAndPassword(email, pass)
    .then(cred => {
      return db.collection('users').doc(cred.user.uid).set({
        name,
        age,
        bio,
        email,
        friends: [],
        friendRequestsReceived: [],
        friendRequestsSent: []
      });
    })
    .catch(e => alert(e.message));
}

function renderFeed() {
  document.getElementById('app').innerHTML = `
    <div class="container">
      <div class="card">
        <textarea id="postContent" placeholder="What's on your mind?" style="resize:none;"></textarea>
        <button onclick="createPost()">Post</button>
      </div>
      <div id="feedPosts"></div>
    </div>`;
  loadPosts();
}

function createPost() {
  const content = document.getElementById('postContent').value.trim();
  if (!content) return;
  db.collection('posts').add({
    content,
    uid: getCurrentUid(),
    likes: [],
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
  document.getElementById('postContent').value = '';
}

function loadPosts() {
  db.collection('posts').orderBy('timestamp', 'desc').onSnapshot(snap => {
    let html = '';
    let postPromises = [];

    snap.forEach(doc => {
      const p = doc.data();
      postPromises.push(
        db.collection('users').doc(p.uid).get().then(userDoc => {
          const user = userDoc.data() || { name: "Unknown" };
          const time = p.timestamp ? p.timestamp.toDate().toLocaleString() : "Just now";

          html += `
            <div class="card" style="padding: 12px;">
              <div style="display:flex;align-items:center;margin-bottom:8px;">
                <span class="material-icons" style="font-size:36px;color:#2196F3;margin-right:10px;">account_circle</span>
                <div>
                  <strong>${user.name}</strong><br />
                  <small style="color:gray;">${time}</small>
                </div>
              </div>
              <div style="margin:10px 0;font-size:15px;">${p.content}</div>
              <hr style="margin:8px 0;" />
              <button onclick="toggleLike('${doc.id}')" style="background:none;color:#2196F3;border:none;cursor:pointer;">
                üëç Like (${p.likes.length})
              </button>
            </div>`;
        })
      );
    });

    Promise.all(postPromises).then(() => {
      document.getElementById('feedPosts').innerHTML = html;
    });
  });
}

function toggleLike(postId) {
  const uid = getCurrentUid();
  if (!uid) return;
  const ref = db.collection('posts').doc(postId);
  ref.get().then(doc => {
    const data = doc.data();
    let likes = data.likes || [];
    if (likes.includes(uid)) {
      likes = likes.filter(id => id !== uid);
    } else {
      likes.push(uid);
    }
    ref.update({ likes });
  });
}

function renderProfile() {
  const uid = getCurrentUid();
  if (!uid) return;
  db.collection('users').doc(uid).get().then(doc => {
    const u = doc.data();
    document.getElementById('app').innerHTML = `
      <div class="container">
        <div class="card">
          <h3>${u.name}</h3>
          <p>Age: ${u.age}</p>
          <p>Bio: ${u.bio}</p>
          <button onclick="editProfile()">Edit Profile</button>
        </div>
      </div>`;
  });
}

function editProfile() {
  const uid = getCurrentUid();
  if (!uid) return;
  db.collection('users').doc(uid).get().then(doc => {
    const u = doc.data();
    document.getElementById('app').innerHTML = `
      <div class="container card">
        <input id="name" value="${u.name}" />
        <input id="age" value="${u.age}" />
        <textarea id="bio">${u.bio}</textarea>
        <button onclick="saveProfile()">Save</button>
      </div>`;
  });
}

function saveProfile() {
  const uid = getCurrentUid();
  if (!uid) return;
  const name = document.getElementById('name').value.trim();
  const age = document.getElementById('age').value.trim();
  const bio = document.getElementById('bio').value.trim();
  db.collection('users').doc(uid).update({ name, age, bio }).then(() => {
    renderProfile();
  });
}

// ===================
// FRIEND SYSTEM
// ===================

async function renderFriends() {
  const uid = getCurrentUid();
  if (!uid) return;

  const app = document.getElementById('app');
  app.innerHTML = `
    <div class="container">
      <h3>Friend Requests</h3>
      <div id="requestsContainer" class="card" style="margin-bottom:20px;">
        <p>Loading friend requests...</p>
      </div>

      <h3>Your Friends</h3>
      <div id="friendList" class="card" style="margin-bottom:20px;">
        <div id="friendsContainer">Loading...</div>
      </div>

      <h3>People You May Know</h3>
      <div id="allUsersList" class="card">
        <div id="usersContainer">Loading...</div>
      </div>
    </div>`;

  try {
    const userDoc = await db.collection('users').doc(uid).get();
    const userData = userDoc.data() || {};
    const friends = userData.friends || [];
    const friendRequestsReceived = userData.friendRequestsReceived || [];
    const friendRequestsSent = userData.friendRequestsSent || [];

    // Load all users except current
    const usersSnap = await db.collection('users').get();
    const allUsers = [];
    usersSnap.forEach(doc => {
      if (doc.id !== uid) {
        allUsers.push({ id: doc.id, ...doc.data() });
      }
    });

    // Render friend requests (incoming)
    const requestsContainer = document.getElementById('requestsContainer');
    if (friendRequestsReceived.length === 0) {
      requestsContainer.innerHTML = `<p>No friend requests.</p>`;
    } else {
      // Show each requester name + Accept / Decline buttons
      const requestsHTML = await Promise.all(friendRequestsReceived.map(async requesterUid => {
        const userDoc = await db.collection('users').doc(requesterUid).get();
        const user = userDoc.data() || { name: "Unknown" };
        return `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #eee;">
            <span>${user.name} (${user.email})</span>
            <div>
              <button style="background:#4CAF50;color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;margin-right:5px;"
                onclick="acceptFriend('${requesterUid}')">Accept</button>
              <button style="background:#f44336;color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;"
                onclick="declineFriend('${requesterUid}')">Decline</button>
            </div>
          </div>`;
      }));
      requestsContainer.innerHTML = requestsHTML.join('');
    }

    // Friends list
    const friendUsers = allUsers.filter(u => friends.includes(u.id));
    const friendsContainer = document.getElementById('friendsContainer');
    if (friendUsers.length === 0) {
      friendsContainer.innerHTML = `<p>You have no friends yet.</p>`;
    } else {
      friendsContainer.innerHTML = friendUsers.map(u => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #eee;">
          <span>${u.name} (${u.email})</span>
          <button style="background:#f44336;color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;"
            onclick="removeFriend('${u.id}')">Remove</button>
        </div>
      `).join('');
    }

    // Non-friends excluding sent and received requests
    const nonFriendUsers = allUsers.filter(u =>
      !friends.includes(u.id) &&
      !friendRequestsSent.includes(u.id) &&
      !friendRequestsReceived.includes(u.id)
    );

    const usersContainer = document.getElementById('usersContainer');
    if (nonFriendUsers.length === 0) {
      usersContainer.innerHTML = `<p>No other users found.</p>`;
    } else {
      usersContainer.innerHTML = nonFriendUsers.map(u => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #eee;">
          <span>${u.name} (${u.email})</span>
          <button style="background:#2196F3;color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;"
            onclick="sendFriendRequest('${u.id}')">Add Friend</button>
        </div>
      `).join('');
    }

  } catch (err) {
    document.getElementById('app').innerHTML = `<p>Error loading friends: ${err.message}</p>`;
  }
}

async function sendFriendRequest(toUid) {
  const uid = getCurrentUid();
  if (!uid) return;
  if (uid === toUid) return alert("Can't add yourself.");

  const userRef = db.collection('users').doc(uid);
  const toUserRef = db.collection('users').doc(toUid);

  try {
    // Add toUid to current user's friendRequestsSent
    await userRef.update({
      friendRequestsSent: firebase.firestore.FieldValue.arrayUnion(toUid)
    });
    // Add uid to toUid's friendRequestsReceived
    await toUserRef.update({
      friendRequestsReceived: firebase.firestore.FieldValue.arrayUnion(uid)
    });
    alert('Friend request sent.');
    renderFriends();
  } catch (err) {
    alert('Error sending friend request: ' + err.message);
  }
}

async function acceptFriend(fromUid) {
  const uid = getCurrentUid();
  if (!uid) return;

  const userRef = db.collection('users').doc(uid);
  const fromUserRef = db.collection('users').doc(fromUid);

  try {
    // Remove request, add friends mutually
    await userRef.update({
      friendRequestsReceived: firebase.firestore.FieldValue.arrayRemove(fromUid),
      friends: firebase.firestore.FieldValue.arrayUnion(fromUid)
    });
    await fromUserRef.update({
      friendRequestsSent: firebase.firestore.FieldValue.arrayRemove(uid),
      friends: firebase.firestore.FieldValue.arrayUnion(uid)
    });
    alert('Friend request accepted.');
    renderFriends();
  } catch (err) {
    alert('Error accepting friend request: ' + err.message);
  }
}

async function declineFriend(fromUid) {
  const uid = getCurrentUid();
  if (!uid) return;

  const userRef = db.collection('users').doc(uid);
  const fromUserRef = db.collection('users').doc(fromUid);

  try {
    await userRef.update({
      friendRequestsReceived: firebase.firestore.FieldValue.arrayRemove(fromUid)
    });
    await fromUserRef.update({
      friendRequestsSent: firebase.firestore.FieldValue.arrayRemove(uid)
    });
    alert('Friend request declined.');
    renderFriends();
  } catch (err) {
    alert('Error declining friend request: ' + err.message);
  }
}

async function removeFriend(friendUid) {
  const uid = getCurrentUid();
  if (!uid) return;

  const userRef = db.collection('users').doc(uid);
  const friendRef = db.collection('users').doc(friendUid);

  try {
    await userRef.update({
      friends: firebase.firestore.FieldValue.arrayRemove(friendUid)
    });
    await friendRef.update({
      friends: firebase.firestore.FieldValue.arrayRemove(uid)
    });
    alert('Friend removed.');
    renderFriends();
  } catch (err) {
    alert('Error removing friend: ' + err.message);
  }
}

// ===================
// Dummy chat page placeholder
function renderChat() {
  document.getElementById('app').innerHTML = `
    <div class="container card">
      <p>Chat feature coming soon...</p>
    </div>`;
}

function renderSettings() {
  document.getElementById('app').innerHTML = `
    <div class="container card">
      <button onclick="auth.signOut()">Logout</button>
    </div>`;
}

function showPage(page) {
  // Highlight active nav button
  [...document.querySelectorAll('nav button')].forEach(btn => btn.classList.remove('active'));
  const btnMap = {feed:0, friends:1, chat:2, profile:3, settings:4};
  if (btnMap.hasOwnProperty(page)) {
    document.querySelectorAll('nav button')[btnMap[page]].classList.add('active');
  }

  switch(page) {
    case 'feed': renderFeed(); break;
    case 'friends': renderFriends(); break;
    case 'chat': renderChat(); break;
    case 'profile': renderProfile(); break;
    case 'settings': renderSettings(); break;
    default: renderFeed();
  }
}

auth.onAuthStateChanged(user => {
  if (user) {
    showPage('feed');
    document.getElementById('navBar').style.display = 'flex';
  } else {
    renderLogin();
    document.getElementById('navBar').style.display = 'none';
  }
});
</script>

</body>
</html>
